import{_ as e}from"./index-yhO5Pkur.js";import{r as a}from"./roleApi-AgyZA8--.js";import t from"./scopeDefineOrg-BU3kPQ6q.js";import{_ as c,d as l}from"./index-DcffTgQN.js";import{S as o,b as n}from"./ant-design-vendor-CRFwT3Wn.js";import{d as r,f as i,r as s,w as d,a1 as u,a6 as p,V as f,a2 as h,k as v,u as k,Z as g,U as _,G as C,a3 as S,F as E,W as O,_ as x,Y as m,H as y,n as I}from"./vue-vendor-BzDj5Url.js";import"./treeHandler-B8ofjH1e.js";const D={class:"xn-pd8"},L={key:1},P=r({name:"grantResourceForm"}),F=c(Object.assign(P,{emits:{successful:null},setup(c,{expose:r,emit:P}){const F=i(!1),w=i(!1),G=i(null),U=P,b=i(!1);let R=i([]);const z=i(),j=s({searchText:"",searchedColumn:""}),T=i(),N=i({current:1,pageSize:10,total:0,showSizeChanger:!0,defaultPageSize:10,pageSizeOptions:["10","20","50","100"],onChange:()=>{I(()=>{B()})}}),H=i({}),$=i(!1),A=i([]),K=[{key:"prefix",title:"接口前缀",dataIndex:"prefix",width:140,customCell:(e,a)=>{const t=H.value[e.prefix];return a===t[0]?{rowSpan:t.length}:{rowSpan:0}}},{key:"suffix",title:"接口",dataIndex:"suffix",width:290,customFilterDropdown:!0,onFilter:(e,a)=>a.api.includes(e),onFilterDropdownOpenChange:e=>{e&&setTimeout(()=>{T.value.focus()},100)}},{key:"dataScope",title:"数据范围",dataIndex:"dataScope"}],B=()=>{w.value=!0;const e=R.value.filter(e=>{var a;return!j.searchText||0===j.searchText.trim().length||e.api.toUpperCase().includes(null==(a=j.searchText)?void 0:a.toUpperCase())});N.value.total=e.length;const a=(N.value.current-1)*N.value.pageSize,t=a+N.value.pageSize,c=e.slice(a,t);H.value={},null==c||c.forEach((e,a)=>{H.value[e.prefix]?H.value[e.prefix].push(a):H.value[e.prefix]=[a]}),A.value=c,w.value=!1},M=e=>{Object.assign(N.value,e)},V=(e,a)=>{let t=[];return e.forEach(e=>{const c=function(e){const a=e.split("/").filter(Boolean),t="/"+a.slice(0,2).join("/"),c="/"+a.slice(2).join("/");return[t,c]}(e),l={api:e,prefix:c[0],suffix:c[1],dataScope:W(e),check:!1,parentCheck:!1};a.grantInfoList.length>0&&a.grantInfoList.forEach(a=>{a.apiUrl===ae(e)&&(l.check=!0,l.dataScope.forEach(e=>{e.value===a.scopeCategory&&(e.check=!0,"SCOPE_ORG_DEFINE"===a.scopeCategory&&(e.scopeDefineOrgIdList=a.scopeDefineOrgIdList))}))}),t.push(l)}),ne(t)},W=e=>[{id:`SCOPE_ALL_${e}`,title:"全部",value:"SCOPE_ALL",check:!1},{id:`SCOPE_SELF_${e}`,title:"仅自己",value:"SCOPE_SELF",check:!1},{id:`SCOPE_ORG_${e}`,title:"所属组织",value:"SCOPE_ORG",check:!1},{id:`SCOPE_ORG_CHILD_${e}`,title:"所属组织及以下",value:"SCOPE_ORG_CHILD",check:!1},{id:`SCOPE_ORG_DEFINE_${e}`,title:"自定义",value:"SCOPE_ORG_DEFINE",check:!1}],Y=e=>{Z(!0,e.dataScopeId,e.defineOrgIdData.scopeDefineOrgIdList)},Z=(e,a,t)=>{R.value.forEach(c=>{a==="SCOPE_ORG_DEFINE_"+c.api&&c.dataScope.forEach(a=>{"SCOPE_ORG_DEFINE"===a.value&&(a.scopeDefineOrgIdList=e?t:[])})})},q=()=>{R.value=[],z.value="",F.value=!1},J=e=>{$.value=e,w.value=!0,R.value.forEach(a=>{Q(a,e,!1),a.parentCheck=e,w.value=!1})},Q=(e,a,t=!0)=>{if(e.check=a,a){let a=0;for(let t=0;t<e.dataScope.length;t++)e.dataScope[t].check&&a++;0===a&&(e.dataScope[0].check=!0)}else e.dataScope.forEach(e=>{e.check=!1,"SCOPE_ORG_DEFINE"===e.value&&(e.scopeDefineOrgIdList=[])});t&&(R.value=ne(R.value))},X=(e,a)=>{let t=a.target.checked;t?t&&(e.check=t):e.check=!1};let ee={id:"",grantInfoList:[]};const ae=e=>e.indexOf("[")>-1?e.substring(0,e.indexOf("[")):e,te=()=>{const e=(ee.grantInfoList=[],R.value.forEach(e=>{e.check&&e.dataScope.forEach(a=>{if(a.check){const t={apiUrl:ae(e.api),scopeCategory:a.value,scopeDefineOrgIdList:void 0===a.scopeDefineOrgIdList?[]:a.scopeDefineOrgIdList};ee.grantInfoList.push(t)}})}),ee);b.value=!0,a.roleGrantPermission(e).then(()=>{q(),U("successful"),I(()=>{l().refreshUserLoginUserInfo()})}).finally(()=>{b.value=!1})},ce=(e,a)=>{j.searchText=e[0],j.searchedColumn=a,le()},le=()=>{N.value.current=1,I(()=>{B()})},oe=e=>{R.value.forEach(a=>{a.dataScope.forEach(a=>{e.target.value===a.value?a.check=!0:a.check=!1})})},ne=e=>{const a=n(e);return a.forEach(a=>{let t=e.filter(e=>e.prefix===a.prefix);a.parentCheck=t.every(e=>e.check)}),a};return d(R,e=>{const a=e.filter(e=>e.api.toUpperCase().includes(j.searchText.toUpperCase()));N.value.total=a.length;const t=(N.value.current-1)*N.value.pageSize,c=t+N.value.pageSize,l=a.slice(t,c);H.value={},null==l||l.forEach((e,a)=>{H.value[e.prefix]?H.value[e.prefix].push(a):H.value[e.prefix]=[a]}),A.value=l},{deep:!0}),r({onOpen:e=>{ee.id=e.id,F.value=!0,H.value={},N.value.current=1,N.value.pageSize=10,N.value.total=0,$.value=!1,(async()=>{w.value=!0;const e=await a.rolePermissionTreeSelector(),t={id:ee.id},c=await a.roleOwnPermission(t);R.value=V(e,c),N.value.total=R.value.length,$.value=R.value.every(e=>e.parentCheck),w.value=!1,B()})()}}),(a,c)=>{const l=u("a-alert"),n=u("a-checkbox"),r=u("a-radio"),i=u("a-radio-group"),s=u("a-input"),d=u("a-button"),I=u("a-badge"),P=u("a-table"),U=u("a-spin"),H=e;return f(),p(H,{title:"授权权限",width:1050,visible:k(F),"destroy-on-close":!0,"show-pagination":!1,onClose:q},{footer:h(()=>[v(d,{class:"xn-mr8",onClick:q},{default:h(()=>c[11]||(c[11]=[C("关闭")])),_:1}),v(d,{type:"primary",loading:k(b),onClick:te},{default:h(()=>c[12]||(c[12]=[C("保存")])),_:1},8,["loading"])]),default:h(()=>[v(l,{message:"注：此功能界面需要与代码查询条件配合使用，并非所有接口都需设置数据范围，多用于业务模块！",type:"warning",closable:""}),v(U,{spinning:k(w)},{default:h(()=>[v(P,{class:"mt-4",size:"middle",columns:K,"data-source":k(A),"row-key":e=>e.api,pagination:k(N),onChange:M,bordered:""},{headerCell:h(({column:e})=>["prefix"===e.key?(f(),p(n,{key:0,checked:k($),"onUpdate:checked":c[0]||(c[0]=e=>J(e))},{default:h(()=>[C(S(e.title),1)]),_:2},1032,["checked"])):g("",!0),"suffix"===e.key?(f(),p(n,{key:1,checked:k($),"onUpdate:checked":c[1]||(c[1]=e=>J(e))},{default:h(()=>c[3]||(c[3]=[C(" 接口 ")])),_:1},8,["checked"])):g("",!0),"dataScope"===e.key?(f(),_(E,{key:2},[m("span",null,S(e.title),1),v(i,{value:k(z),"onUpdate:value":c[2]||(c[2]=e=>y(z)?z.value=e:null),onChange:oe,style:{padding:"0 10px"}},{default:h(()=>[v(r,{value:"SCOPE_ALL"},{default:h(()=>c[4]||(c[4]=[C(" 全部 ")])),_:1}),v(r,{value:"SCOPE_SELF"},{default:h(()=>c[5]||(c[5]=[C(" 仅自已 ")])),_:1}),v(r,{value:"SCOPE_ORG"},{default:h(()=>c[6]||(c[6]=[C(" 所属组织 ")])),_:1}),v(r,{value:"SCOPE_ORG_CHILD"},{default:h(()=>c[7]||(c[7]=[C(" 所属组织及以下 ")])),_:1})]),_:1},8,["value"])],64)):g("",!0)]),customFilterDropdown:h(({setSelectedKeys:e,selectedKeys:a,clearFilters:t,column:l})=>[m("div",D,[v(s,{ref_key:"searchInput",ref:T,placeholder:"请输入接口或接口名称",value:a[0],class:"xn-jk-line",onChange:a=>e(a.target.value?[a.target.value]:[]),onPressEnter:e=>ce(a,l.dataIndex)},null,8,["value","onChange","onPressEnter"]),v(d,{type:"primary",size:"small",class:"xn-wd90 xn-mr8",onClick:e=>ce(a,l.dataIndex)},{icon:h(()=>[v(k(o))]),default:h(()=>[c[8]||(c[8]=C(" 搜索 "))]),_:2},1032,["onClick"]),v(d,{size:"small",class:"xn-wd90",onClick:e=>(e=>{e(),j.searchText="",j.searchedColumn="",le()})(t)},{default:h(()=>c[9]||(c[9]=[C(" 重置 ")])),_:2},1032,["onClick"])])]),customFilterIcon:h(({filtered:e})=>{var a;return[v(I,{dot:(null==(a=k(j).searchText)?void 0:a.trim().length)>0,status:"processing"},{default:h(()=>[v(k(o),{style:x({color:e?"#108ee9":void 0})},null,8,["style"])]),_:2},1032,["dot"])]}),bodyCell:h(({column:e,record:a})=>["prefix"===e.dataIndex?(f(),p(n,{key:0,checked:a.parentCheck,"onUpdate:checked":e=>((e,a)=>{R.value.forEach(t=>{t.prefix===e.prefix&&(t.check=a,t.parentCheck=a,a?t.dataScope.some(e=>e.check)||(t.dataScope[0].check=!0):t.dataScope.forEach(e=>{e.check=!1}),t.dataScope.forEach(e=>{"SCOPE_ORG_DEFINE"===e.value&&(e.scopeDefineOrgIdList=[])}))}),$.value=R.value.every(e=>e.parentCheck)})(a,e)},{default:h(()=>[C(S(a.prefix),1)]),_:2},1032,["checked","onUpdate:checked"])):g("",!0),"suffix"===e.dataIndex?(f(),p(n,{key:1,checked:a.check,"onUpdate:checked":e=>Q(a,e)},{default:h(()=>[C(S(a.suffix),1)]),_:2},1032,["checked","onUpdate:checked"])):g("",!0),"dataScope"===e.dataIndex?(f(),_(E,{key:2},[a.dataScope.length>0?(f(),_(E,{key:0},[(f(!0),_(E,null,O(a.dataScope,e=>(f(),p(r,{key:e.id+a.api,checked:e.check,"onUpdate:checked":a=>e.check=a,name:e.title,onChange:e=>((e,a)=>{const t=a.target.name;e.dataScope.forEach(e=>{e.title!==t&&(e.check=!1)}),X(e,a)})(a,e)},{default:h(()=>["SCOPE_ORG_DEFINE"===e.value&a.dataScope[4].check&void 0!==e.scopeDefineOrgIdList?(f(),p(I,{key:0,count:e.scopeDefineOrgIdList.length,"number-style":{backgroundColor:"#52c41a"}},{default:h(()=>[C(S(e.title),1)]),_:2},1032,["count"])):(f(),_("div",L,S(e.title),1))]),_:2},1032,["checked","onUpdate:checked","name","onChange"]))),128)),a.dataScope[4].check?(f(),p(d,{key:0,type:"link",size:"small",onClick:e=>(e=>{const a=e.dataScope.find(e=>"SCOPE_ORG_DEFINE"===e.value);if(a.check){const t=e.dataScope[4].scopeDefineOrgIdList;G.value.onOpen(a.id,t)}else Z(!1,a.id,null)})(a)},{default:h(()=>c[10]||(c[10]=[C("选择组织")])),_:2},1032,["onClick"])):g("",!0)],64)):g("",!0)],64)):g("",!0)]),_:1},8,["data-source","row-key","pagination"])]),_:1},8,["spinning"]),v(t,{ref_key:"scopeDefineOrgModal",ref:G,onClick:Y},null,512)]),_:1},8,["visible"])}}}),[["__scopeId","data-v-39bc35f9"]]);export{F as default};
