import{_ as e}from"./index-yhO5Pkur.js";import{u as a}from"./userApi-BNWGxnHS.js";import{r as t}from"./roleApi-AgyZA8--.js";import c from"./scopeDefineOrg-DrvmDkXq.js";import{_ as l,d as o}from"./index-DcffTgQN.js";import{S as n,b as r}from"./ant-design-vendor-CRFwT3Wn.js";import{d as s,f as i,r as u,w as d,a1 as p,a6 as f,V as h,a2 as v,k,u as g,Z as _,U as C,G as S,a3 as E,F as O,W as x,_ as m,Y as y,H as I,n as D}from"./vue-vendor-BzDj5Url.js";import"./treeHandler-B8ofjH1e.js";const L={class:"xn-pd8"},P={key:1},F=s({name:"grantResourceForm"}),w=l(Object.assign(F,{emits:{successful:null},setup(l,{expose:s,emit:F}){const w=i(!1),G=i(!1),U=i(null),R=F,b=i(!1),j=i([]),z=i(),T=u({searchText:"",searchedColumn:""}),N=i(),H=i({current:1,pageSize:10,total:0,showSizeChanger:!0,defaultPageSize:10,pageSizeOptions:["10","20","50","100"],onChange:()=>{D(()=>{M()})}}),A=i({}),$=i(!1),K=i([]),B=[{key:"prefix",title:"接口前缀",dataIndex:"prefix",width:140,customCell:(e,a)=>{const t=A.value[e.prefix];return a===t[0]?{rowSpan:t.length}:{rowSpan:0}}},{key:"suffix",title:"接口",dataIndex:"suffix",width:290,customFilterDropdown:!0,onFilter:(e,a)=>a.api.includes(e),onFilterDropdownOpenChange:e=>{e&&setTimeout(()=>{N.value.focus()},100)}},{key:"dataScope",title:"数据范围",dataIndex:"dataScope"}],M=()=>{G.value=!0;const e=j.value.filter(e=>{var a;return!T.searchText||0===T.searchText.trim().length||e.api.toUpperCase().includes(null==(a=T.searchText)?void 0:a.toUpperCase())});H.value.total=e.length;const a=(H.value.current-1)*H.value.pageSize,t=a+H.value.pageSize,c=e.slice(a,t);A.value={},null==c||c.forEach((e,a)=>{A.value[e.prefix]?A.value[e.prefix].push(a):A.value[e.prefix]=[a]}),K.value=c,G.value=!1},V=e=>{Object.assign(H.value,e)},W=(e,a)=>{let t=[];return e.forEach(e=>{const c=function(e){const a=e.split("/").filter(Boolean),t="/"+a.slice(0,2).join("/"),c="/"+a.slice(2).join("/");return[t,c]}(e),l={api:e,prefix:c[0],suffix:c[1],dataScope:Y(e),check:!1,parentCheck:!1};a.grantInfoList.length>0&&a.grantInfoList.forEach(a=>{a.apiUrl===te(e)&&(l.check=!0,l.dataScope.forEach(e=>{e.value===a.scopeCategory&&(e.check=!0,"SCOPE_ORG_DEFINE"===a.scopeCategory&&(e.scopeDefineOrgIdList=a.scopeDefineOrgIdList))}))}),t.push(l)}),re(t)},Y=e=>[{id:`SCOPE_ALL_${e}`,title:"全部",value:"SCOPE_ALL",check:!1},{id:`SCOPE_SELF_${e}`,title:"仅自己",value:"SCOPE_SELF",check:!1},{id:`SCOPE_ORG_${e}`,title:"所属组织",value:"SCOPE_ORG",check:!1},{id:`SCOPE_ORG_CHILD_${e}`,title:"所属组织及以下",value:"SCOPE_ORG_CHILD",check:!1},{id:`SCOPE_ORG_DEFINE_${e}`,title:"自定义",value:"SCOPE_ORG_DEFINE",check:!1}],Z=e=>{q(!0,e.dataScopeId,e.defineOrgIdData.scopeDefineOrgIdList)},q=(e,a,t)=>{j.value.forEach(c=>{a==="SCOPE_ORG_DEFINE_"+c.api&&c.dataScope.forEach(a=>{"SCOPE_ORG_DEFINE"===a.value&&(a.scopeDefineOrgIdList=e?t:[])})})},J=()=>{j.value=[],z.value="",w.value=!1},Q=e=>{$.value=e,G.value=!0,j.value.forEach(a=>{X(a,e,!1),a.parentCheck=e,G.value=!1})},X=(e,a,t=!0)=>{if(e.check=a,a){let a=0;for(let t=0;t<e.dataScope.length;t++)e.dataScope[t].check&&a++;0===a&&(e.dataScope[0].check=!0)}else e.dataScope.forEach(e=>{e.check=!1,"SCOPE_ORG_DEFINE"===e.value&&(e.scopeDefineOrgIdList=[])});t&&(j.value=re(j.value))},ee=(e,a)=>{let t=a.target.checked;t?t&&(e.check=t):e.check=!1};let ae={id:"",grantInfoList:[]};const te=e=>e.indexOf("[")>-1?e.substring(0,e.indexOf("[")):e,ce=()=>{const e=(ae.grantInfoList=[],j.value.forEach(e=>{e.check&&e.dataScope.forEach(a=>{if(a.check){const t={apiUrl:te(e.api),scopeCategory:a.value,scopeDefineOrgIdList:void 0===a.scopeDefineOrgIdList?[]:a.scopeDefineOrgIdList};ae.grantInfoList.push(t)}})}),ae);b.value=!0,a.userGrantPermission(e).then(()=>{J(),R("successful"),D(()=>{o().refreshUserLoginUserInfo()})}).finally(()=>{b.value=!1})},le=(e,a)=>{T.searchText=e[0],T.searchedColumn=a,oe()},oe=()=>{H.value.current=1,D(()=>{M()})},ne=e=>{j.value.forEach(a=>{a.dataScope.forEach(a=>{e.target.value===a.value?a.check=!0:a.check=!1})})},re=e=>{const a=r(e);return a.forEach(a=>{let t=e.filter(e=>e.prefix===a.prefix);a.parentCheck=t.every(e=>e.check)}),a};return d(j,e=>{const a=e.filter(e=>e.api.toUpperCase().includes(T.searchText.toUpperCase()));H.value.total=a.length;const t=(H.value.current-1)*H.value.pageSize,c=t+H.value.pageSize,l=a.slice(t,c);A.value={},null==l||l.forEach((e,a)=>{A.value[e.prefix]?A.value[e.prefix].push(a):A.value[e.prefix]=[a]}),K.value=l},{deep:!0}),s({onOpen:e=>{ae.id=e.id,w.value=!0,A.value={},H.value.current=1,H.value.pageSize=10,H.value.total=0,$.value=!1,(async()=>{G.value=!0;const e=await t.rolePermissionTreeSelector(),c={id:ae.id},l=await a.userOwnPermission(c);j.value=W(e,l),H.value.total=j.value.length,$.value=j.value.every(e=>e.parentCheck),G.value=!1,M()})()}}),(a,t)=>{const l=p("a-alert"),o=p("a-checkbox"),r=p("a-radio"),s=p("a-radio-group"),i=p("a-input"),u=p("a-button"),d=p("a-badge"),D=p("a-table"),F=p("a-spin"),R=e;return h(),f(R,{title:"授权权限",width:1050,visible:g(w),"destroy-on-close":!0,"show-pagination":!1,onClose:J},{footer:v(()=>[k(u,{class:"xn-mr8",onClick:J},{default:v(()=>t[11]||(t[11]=[S("关闭")])),_:1}),k(u,{type:"primary",loading:g(b),onClick:ce},{default:v(()=>t[12]||(t[12]=[S("保存")])),_:1},8,["loading"])]),default:v(()=>[k(l,{message:"注：此功能界面需要与代码查询条件配合使用，并非所有接口都需设置数据范围，多用于业务模块！",type:"warning",closable:""}),k(F,{spinning:g(G)},{default:v(()=>[k(D,{class:"mt-4",size:"middle",columns:B,"data-source":g(K),bordered:"","row-key":e=>e.api,pagination:g(H),onChange:V},{headerCell:v(({column:e})=>["prefix"===e.key?(h(),f(o,{key:0,checked:g($),"onUpdate:checked":t[0]||(t[0]=e=>Q(e))},{default:v(()=>[S(E(e.title),1)]),_:2},1032,["checked"])):_("",!0),"suffix"===e.key?(h(),f(o,{key:1,checked:g($),"onUpdate:checked":t[1]||(t[1]=e=>Q(e))},{default:v(()=>t[3]||(t[3]=[S(" 接口 ")])),_:1},8,["checked"])):_("",!0),"dataScope"===e.key?(h(),C(O,{key:2},[y("span",null,E(e.title),1),k(s,{value:g(z),"onUpdate:value":t[2]||(t[2]=e=>I(z)?z.value=e:null),onChange:ne,style:{padding:"0 10px"}},{default:v(()=>[k(r,{value:"SCOPE_ALL"},{default:v(()=>t[4]||(t[4]=[S(" 全部 ")])),_:1}),k(r,{value:"SCOPE_SELF"},{default:v(()=>t[5]||(t[5]=[S(" 仅自已 ")])),_:1}),k(r,{value:"SCOPE_ORG"},{default:v(()=>t[6]||(t[6]=[S(" 所属组织 ")])),_:1}),k(r,{value:"SCOPE_ORG_CHILD"},{default:v(()=>t[7]||(t[7]=[S(" 所属组织及以下 ")])),_:1})]),_:1},8,["value"])],64)):_("",!0)]),customFilterDropdown:v(({setSelectedKeys:e,selectedKeys:a,clearFilters:c,column:l})=>[y("div",L,[k(i,{ref_key:"searchInput",ref:N,placeholder:"请输入接口或接口名称",value:a[0],class:"xn-jk-line",onChange:a=>e(a.target.value?[a.target.value]:[]),onPressEnter:e=>le(a,l.dataIndex)},null,8,["value","onChange","onPressEnter"]),k(u,{type:"primary",size:"small",class:"xn-wd90 xn-mr8",onClick:e=>le(a,l.dataIndex)},{icon:v(()=>[k(g(n))]),default:v(()=>[t[8]||(t[8]=S(" 搜索 "))]),_:2},1032,["onClick"]),k(u,{size:"small",class:"xn-wd90",onClick:e=>(e=>{e(),T.searchText="",T.searchedColumn="",oe()})(c)},{default:v(()=>t[9]||(t[9]=[S(" 重置 ")])),_:2},1032,["onClick"])])]),customFilterIcon:v(({filtered:e})=>{var a;return[k(d,{dot:(null==(a=g(T).searchText)?void 0:a.trim().length)>0,status:"processing"},{default:v(()=>[k(g(n),{style:m({color:e?"#108ee9":void 0})},null,8,["style"])]),_:2},1032,["dot"])]}),bodyCell:v(({column:e,record:a})=>["prefix"===e.dataIndex?(h(),f(o,{key:0,checked:a.parentCheck,"onUpdate:checked":e=>((e,a)=>{j.value.forEach(t=>{t.prefix===e.prefix&&(t.check=a,t.parentCheck=a,a?t.dataScope.some(e=>e.check)||(t.dataScope[0].check=!0):t.dataScope.forEach(e=>{e.check=!1}),t.dataScope.forEach(e=>{"SCOPE_ORG_DEFINE"===e.value&&(e.scopeDefineOrgIdList=[])}))}),$.value=j.value.every(e=>e.parentCheck)})(a,e)},{default:v(()=>[S(E(a.prefix),1)]),_:2},1032,["checked","onUpdate:checked"])):_("",!0),"suffix"===e.dataIndex?(h(),f(o,{key:1,checked:a.check,"onUpdate:checked":e=>X(a,e)},{default:v(()=>[S(E(a.suffix),1)]),_:2},1032,["checked","onUpdate:checked"])):_("",!0),"dataScope"===e.dataIndex?(h(),C(O,{key:2},[a.dataScope.length>0?(h(),C(O,{key:0},[(h(!0),C(O,null,x(a.dataScope,e=>(h(),f(r,{key:e.id+a.api,checked:e.check,"onUpdate:checked":a=>e.check=a,name:e.title,onChange:e=>((e,a)=>{const t=a.target.name;e.dataScope.forEach(e=>{e.title!==t&&(e.check=!1)}),ee(e,a)})(a,e)},{default:v(()=>["SCOPE_ORG_DEFINE"===e.value&a.dataScope[4].check&void 0!==e.scopeDefineOrgIdList?(h(),f(d,{key:0,count:e.scopeDefineOrgIdList.length,"number-style":{backgroundColor:"#52c41a"}},{default:v(()=>[S(E(e.title),1)]),_:2},1032,["count"])):(h(),C("div",P,E(e.title),1))]),_:2},1032,["checked","onUpdate:checked","name","onChange"]))),128)),a.dataScope[4].check?(h(),f(u,{key:0,type:"link",size:"small",onClick:e=>(e=>{const a=e.dataScope.find(e=>"SCOPE_ORG_DEFINE"===e.value);if(a.check){const t=e.dataScope[4].scopeDefineOrgIdList;U.value.onOpen(a.id,t)}else q(!1,a.id,null)})(a)},{default:v(()=>t[10]||(t[10]=[S("选择组织")])),_:2},1032,["onClick"])):_("",!0)],64)):_("",!0)],64)):_("",!0)]),_:1},8,["data-source","row-key","pagination"])]),_:1},8,["spinning"]),k(c,{ref_key:"scopeDefineOrgModal",ref:U,onClick:Z},null,512)]),_:1},8,["visible"])}}}),[["__scopeId","data-v-6aa06f4c"]]);export{w as default};
