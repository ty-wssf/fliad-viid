/*! For license information please see 4010.3b67d3cb.js.LICENSE.txt */
(self.webpackChunk_flowgram_ai_demo_free_layout=self.webpackChunk_flowgram_ai_demo_free_layout||[]).push([["4010"],{94083:function(e,t,r){"use strict";e=r.nmd(e);let a=(e=0)=>t=>`\u001B[${38+e};5;${t}m`,i=(e=0)=>(t,r,a)=>`\u001B[${38+e};2;${t};${r};${a}m`;Object.defineProperty(e,"exports",{enumerable:!0,get:function(){let e=new Map,t={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};for(let[r,a]of(t.color.gray=t.color.blackBright,t.bgColor.bgGray=t.bgColor.bgBlackBright,t.color.grey=t.color.blackBright,t.bgColor.bgGrey=t.bgColor.bgBlackBright,Object.entries(t))){for(let[r,i]of Object.entries(a))t[r]={open:`\u001B[${i[0]}m`,close:`\u001B[${i[1]}m`},a[r]=t[r],e.set(i[0],i[1]);Object.defineProperty(t,r,{value:a,enumerable:!1})}return Object.defineProperty(t,"codes",{value:e,enumerable:!1}),t.color.close="\x1b[39m",t.bgColor.close="\x1b[49m",t.color.ansi256=a(),t.color.ansi16m=i(),t.bgColor.ansi256=a(10),t.bgColor.ansi16m=i(10),Object.defineProperties(t,{rgbToAnsi256:{value:(e,t,r)=>e===t&&t===r?e<8?16:e>248?231:Math.round((e-8)/247*24)+232:16+36*Math.round(e/255*5)+6*Math.round(t/255*5)+Math.round(r/255*5),enumerable:!1},hexToRgb:{value:e=>{let t=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(e.toString(16));if(!t)return[0,0,0];let{colorString:r}=t.groups;3===r.length&&(r=r.split("").map(e=>e+e).join(""));let a=Number.parseInt(r,16);return[a>>16&255,a>>8&255,255&a]},enumerable:!1},hexToAnsi256:{value:e=>t.rgbToAnsi256(...t.hexToRgb(e)),enumerable:!1}}),t}})},67526:function(e,t){"use strict";t.byteLength=function(e){var t=l(e),r=t[0],a=t[1];return(r+a)*3/4-a},t.toByteArray=function(e){var t,r,n=l(e),s=n[0],o=n[1],u=new i((s+o)*3/4-o),c=0,d=o>0?s-4:s;for(r=0;r<d;r+=4)t=a[e.charCodeAt(r)]<<18|a[e.charCodeAt(r+1)]<<12|a[e.charCodeAt(r+2)]<<6|a[e.charCodeAt(r+3)],u[c++]=t>>16&255,u[c++]=t>>8&255,u[c++]=255&t;return 2===o&&(t=a[e.charCodeAt(r)]<<2|a[e.charCodeAt(r+1)]>>4,u[c++]=255&t),1===o&&(t=a[e.charCodeAt(r)]<<10|a[e.charCodeAt(r+1)]<<4|a[e.charCodeAt(r+2)]>>2,u[c++]=t>>8&255,u[c++]=255&t),u},t.fromByteArray=function(e){for(var t,a=e.length,i=a%3,n=[],s=0,o=a-i;s<o;s+=16383)n.push(function(e,t,a){for(var i,n=[],s=t;s<a;s+=3)i=(e[s]<<16&0xff0000)+(e[s+1]<<8&65280)+(255&e[s+2]),n.push(r[i>>18&63]+r[i>>12&63]+r[i>>6&63]+r[63&i]);return n.join("")}(e,s,s+16383>o?o:s+16383));return 1===i?n.push(r[(t=e[a-1])>>2]+r[t<<4&63]+"=="):2===i&&n.push(r[(t=(e[a-2]<<8)+e[a-1])>>10]+r[t>>4&63]+r[t<<2&63]+"="),n.join("")};for(var r=[],a=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",s=0,o=n.length;s<o;++s)r[s]=n[s],a[n.charCodeAt(s)]=s;function l(e){var t=e.length;if(t%4>0)throw Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");-1===r&&(r=t);var a=r===t?0:4-r%4;return[r,a]}a[45]=62,a[95]=63},12729:function(e){"use strict";let t=/[\p{Lu}]/u,r=/[\p{Ll}]/u,a=/^[\p{Lu}](?![\p{Lu}])/gu,i=/([\p{Alpha}\p{N}_]|$)/u,n=/[_.\- ]+/,s=RegExp("^"+n.source),o=RegExp(n.source+i.source,"gu"),l=RegExp("\\d+"+i.source,"gu"),u=(e,i)=>{var n,u;if(!("string"==typeof e||Array.isArray(e)))throw TypeError("Expected the input to be `string | string[]`");if(i={pascalCase:!1,preserveConsecutiveUppercase:!1,...i},0===(e=Array.isArray(e)?e.map(e=>e.trim()).filter(e=>e.length).join("-"):e.trim()).length)return"";let c=!1===i.locale?e=>e.toLowerCase():e=>e.toLocaleLowerCase(i.locale),d=!1===i.locale?e=>e.toUpperCase():e=>e.toLocaleUpperCase(i.locale);return 1===e.length?i.pascalCase?d(e):c(e):((e!==c(e)&&(e=((e,a,i)=>{let n=!1,s=!1,o=!1;for(let l=0;l<e.length;l++){let u=e[l];n&&t.test(u)?(e=e.slice(0,l)+"-"+e.slice(l),n=!1,o=s,s=!0,l++):s&&o&&r.test(u)?(e=e.slice(0,l-1)+"-"+e.slice(l-1),o=s,s=!1,n=!0):(n=a(u)===u&&i(u)!==u,o=s,s=i(u)===u&&a(u)!==u)}return e})(e,c,d)),e=e.replace(s,""),i.preserveConsecutiveUppercase)?(n=e,a.lastIndex=0,e=n.replace(a,e=>c(e))):e=c(e),i.pascalCase&&(e=d(e.charAt(0))+e.slice(1)),u=e,o.lastIndex=0,l.lastIndex=0,u.replace(o,(e,t)=>d(t)).replace(l,e=>d(e)))};e.exports=u,e.exports.default=u},79478:function(e){"use strict";e.exports=function(e,t){if("string"!=typeof e)throw TypeError("Expected a string");return t=void 0===t?"_":t,e.replace(/([a-z\d])([A-Z])/g,"$1"+t+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+t+"$2").toLowerCase()}},30228:function(e){"use strict";var t=Object.prototype.hasOwnProperty,r="~";function a(){}function i(e,t,r){this.fn=e,this.context=t,this.once=r||!1}function n(e,t,a,n,s){if("function"!=typeof a)throw TypeError("The listener must be a function");var o=new i(a,n||e,s),l=r?r+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function s(e,t){0==--e._eventsCount?e._events=new a:delete e._events[t]}function o(){this._events=new a,this._eventsCount=0}Object.create&&(a.prototype=Object.create(null),new a().__proto__||(r=!1)),o.prototype.eventNames=function(){var e,a,i=[];if(0===this._eventsCount)return i;for(a in e=this._events)t.call(e,a)&&i.push(r?a.slice(1):a);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},o.prototype.listeners=function(e){var t=r?r+e:e,a=this._events[t];if(!a)return[];if(a.fn)return[a.fn];for(var i=0,n=a.length,s=Array(n);i<n;i++)s[i]=a[i].fn;return s},o.prototype.listenerCount=function(e){var t=r?r+e:e,a=this._events[t];return a?a.fn?1:a.length:0},o.prototype.emit=function(e,t,a,i,n,s){var o=r?r+e:e;if(!this._events[o])return!1;var l,u,c=this._events[o],d=arguments.length;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),d){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,t),!0;case 3:return c.fn.call(c.context,t,a),!0;case 4:return c.fn.call(c.context,t,a,i),!0;case 5:return c.fn.call(c.context,t,a,i,n),!0;case 6:return c.fn.call(c.context,t,a,i,n,s),!0}for(u=1,l=Array(d-1);u<d;u++)l[u-1]=arguments[u];c.fn.apply(c.context,l)}else{var h,p=c.length;for(u=0;u<p;u++)switch(c[u].once&&this.removeListener(e,c[u].fn,void 0,!0),d){case 1:c[u].fn.call(c[u].context);break;case 2:c[u].fn.call(c[u].context,t);break;case 3:c[u].fn.call(c[u].context,t,a);break;case 4:c[u].fn.call(c[u].context,t,a,i);break;default:if(!l)for(h=1,l=Array(d-1);h<d;h++)l[h-1]=arguments[h];c[u].fn.apply(c[u].context,l)}}return!0},o.prototype.on=function(e,t,r){return n(this,e,t,r,!1)},o.prototype.once=function(e,t,r){return n(this,e,t,r,!0)},o.prototype.removeListener=function(e,t,a,i){var n=r?r+e:e;if(!this._events[n])return this;if(!t)return s(this,n),this;var o=this._events[n];if(o.fn)o.fn!==t||i&&!o.once||a&&o.context!==a||s(this,n);else{for(var l=0,u=[],c=o.length;l<c;l++)(o[l].fn!==t||i&&!o[l].once||a&&o[l].context!==a)&&u.push(o[l]);u.length?this._events[n]=1===u.length?u[0]:u:s(this,n)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&s(this,t)):(this._events=new a,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=r,o.EventEmitter=o,e.exports=o},96635:function(e,t,r){"use strict";let a=Symbol("SemVer ANY");class i{static get ANY(){return a}constructor(e,t){if(t=n(t),e instanceof i)if(!!t.loose===e.loose)return e;else e=e.value;u("comparator",e=e.trim().split(/\s+/).join(" "),t),this.options=t,this.loose=!!t.loose,this.parse(e),this.semver===a?this.value="":this.value=this.operator+this.semver.version,u("comp",this)}parse(e){let t=this.options.loose?s[o.COMPARATORLOOSE]:s[o.COMPARATOR],r=e.match(t);if(!r)throw TypeError(`Invalid comparator: ${e}`);this.operator=void 0!==r[1]?r[1]:"","="===this.operator&&(this.operator=""),r[2]?this.semver=new c(r[2],this.options.loose):this.semver=a}toString(){return this.value}test(e){if(u("Comparator.test",e,this.options.loose),this.semver===a||e===a)return!0;if("string"==typeof e)try{e=new c(e,this.options)}catch(e){return!1}return l(e,this.operator,this.semver,this.options)}intersects(e,t){if(!(e instanceof i))throw TypeError("a Comparator is required");return""===this.operator?""===this.value||new d(e.value,t).test(this.value):""===e.operator?""===e.value||new d(this.value,t).test(e.semver):!((t=n(t)).includePrerelease&&("<0.0.0-0"===this.value||"<0.0.0-0"===e.value)||!t.includePrerelease&&(this.value.startsWith("<0.0.0")||e.value.startsWith("<0.0.0")))&&!!(this.operator.startsWith(">")&&e.operator.startsWith(">")||this.operator.startsWith("<")&&e.operator.startsWith("<")||this.semver.version===e.semver.version&&this.operator.includes("=")&&e.operator.includes("=")||l(this.semver,"<",e.semver,t)&&this.operator.startsWith(">")&&e.operator.startsWith("<")||l(this.semver,">",e.semver,t)&&this.operator.startsWith("<")&&e.operator.startsWith(">"))}}e.exports=i;let n=r(46588),{safeRe:s,t:o}=r(30487),l=r(1534),u=r(96735),c=r(74899),d=r(9558)},9558:function(e,t,r){"use strict";let a=/\s+/g;class i{constructor(e,t){if(t=s(t),e instanceof i)if(!!t.loose===e.loose&&!!t.includePrerelease===e.includePrerelease)return e;else return new i(e.raw,t);if(e instanceof o)return this.raw=e.value,this.set=[[e]],this.formatted=void 0,this;if(this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease,this.raw=e.trim().replace(a," "),this.set=this.raw.split("||").map(e=>this.parseRange(e.trim())).filter(e=>e.length),!this.set.length)throw TypeError(`Invalid SemVer Range: ${this.raw}`);if(this.set.length>1){let e=this.set[0];if(this.set=this.set.filter(e=>!y(e[0])),0===this.set.length)this.set=[e];else if(this.set.length>1){for(let e of this.set)if(1===e.length&&b(e[0])){this.set=[e];break}}}this.formatted=void 0}get range(){if(void 0===this.formatted){this.formatted="";for(let e=0;e<this.set.length;e++){e>0&&(this.formatted+="||");let t=this.set[e];for(let e=0;e<t.length;e++)e>0&&(this.formatted+=" "),this.formatted+=t[e].toString().trim()}}return this.formatted}format(){return this.range}toString(){return this.range}parseRange(e){let t=((this.options.includePrerelease&&m)|(this.options.loose&&g))+":"+e,r=n.get(t);if(r)return r;let a=this.options.loose,i=a?c[d.HYPHENRANGELOOSE]:c[d.HYPHENRANGE];l("hyphen replace",e=e.replace(i,T(this.options.includePrerelease))),l("comparator trim",e=e.replace(c[d.COMPARATORTRIM],h)),l("tilde trim",e=e.replace(c[d.TILDETRIM],p)),l("caret trim",e=e.replace(c[d.CARETTRIM],f));let s=e.split(" ").map(e=>w(e,this.options)).join(" ").split(/\s+/).map(e=>A(e,this.options));a&&(s=s.filter(e=>(l("loose invalid filter",e,this.options),!!e.match(c[d.COMPARATORLOOSE])))),l("range list",s);let u=new Map;for(let e of s.map(e=>new o(e,this.options))){if(y(e))return[e];u.set(e.value,e)}u.size>1&&u.has("")&&u.delete("");let b=[...u.values()];return n.set(t,b),b}intersects(e,t){if(!(e instanceof i))throw TypeError("a Range is required");return this.set.some(r=>_(r,t)&&e.set.some(e=>_(e,t)&&r.every(r=>e.every(e=>r.intersects(e,t)))))}test(e){if(!e)return!1;if("string"==typeof e)try{e=new u(e,this.options)}catch(e){return!1}for(let t=0;t<this.set.length;t++)if(P(this.set[t],e,this.options))return!0;return!1}}e.exports=i;let n=new(r(70639)),s=r(46588),o=r(96635),l=r(96735),u=r(74899),{safeRe:c,t:d,comparatorTrimReplace:h,tildeTrimReplace:p,caretTrimReplace:f}=r(30487),{FLAG_INCLUDE_PRERELEASE:m,FLAG_LOOSE:g}=r(26261),y=e=>"<0.0.0-0"===e.value,b=e=>""===e.value,_=(e,t)=>{let r=!0,a=e.slice(),i=a.pop();for(;r&&a.length;)r=a.every(e=>i.intersects(e,t)),i=a.pop();return r},w=(e,t)=>(l("comp",e,t),l("caret",e=k(e,t)),l("tildes",e=E(e,t)),l("xrange",e=x(e,t)),l("stars",e=I(e,t)),e),v=e=>!e||"x"===e.toLowerCase()||"*"===e,E=(e,t)=>e.trim().split(/\s+/).map(e=>O(e,t)).join(" "),O=(e,t)=>{let r=t.loose?c[d.TILDELOOSE]:c[d.TILDE];return e.replace(r,(t,r,a,i,n)=>{let s;return l("tilde",e,t,r,a,i,n),v(r)?s="":v(a)?s=`>=${r}.0.0 <${+r+1}.0.0-0`:v(i)?s=`>=${r}.${a}.0 <${r}.${+a+1}.0-0`:n?(l("replaceTilde pr",n),s=`>=${r}.${a}.${i}-${n} <${r}.${+a+1}.0-0`):s=`>=${r}.${a}.${i} <${r}.${+a+1}.0-0`,l("tilde return",s),s})},k=(e,t)=>e.trim().split(/\s+/).map(e=>S(e,t)).join(" "),S=(e,t)=>{l("caret",e,t);let r=t.loose?c[d.CARETLOOSE]:c[d.CARET],a=t.includePrerelease?"-0":"";return e.replace(r,(t,r,i,n,s)=>{let o;return l("caret",e,t,r,i,n,s),v(r)?o="":v(i)?o=`>=${r}.0.0${a} <${+r+1}.0.0-0`:v(n)?o="0"===r?`>=${r}.${i}.0${a} <${r}.${+i+1}.0-0`:`>=${r}.${i}.0${a} <${+r+1}.0.0-0`:s?(l("replaceCaret pr",s),o="0"===r?"0"===i?`>=${r}.${i}.${n}-${s} <${r}.${i}.${+n+1}-0`:`>=${r}.${i}.${n}-${s} <${r}.${+i+1}.0-0`:`>=${r}.${i}.${n}-${s} <${+r+1}.0.0-0`):(l("no pr"),o="0"===r?"0"===i?`>=${r}.${i}.${n}${a} <${r}.${i}.${+n+1}-0`:`>=${r}.${i}.${n}${a} <${r}.${+i+1}.0-0`:`>=${r}.${i}.${n} <${+r+1}.0.0-0`),l("caret return",o),o})},x=(e,t)=>(l("replaceXRanges",e,t),e.split(/\s+/).map(e=>$(e,t)).join(" ")),$=(e,t)=>{e=e.trim();let r=t.loose?c[d.XRANGELOOSE]:c[d.XRANGE];return e.replace(r,(r,a,i,n,s,o)=>{l("xRange",e,r,a,i,n,s,o);let u=v(i),c=u||v(n),d=c||v(s);return"="===a&&d&&(a=""),o=t.includePrerelease?"-0":"",u?r=">"===a||"<"===a?"<0.0.0-0":"*":a&&d?(c&&(n=0),s=0,">"===a?(a=">=",c?(i=+i+1,n=0):n=+n+1,s=0):"<="===a&&(a="<",c?i=+i+1:n=+n+1),"<"===a&&(o="-0"),r=`${a+i}.${n}.${s}${o}`):c?r=`>=${i}.0.0${o} <${+i+1}.0.0-0`:d&&(r=`>=${i}.${n}.0${o} <${i}.${+n+1}.0-0`),l("xRange return",r),r})},I=(e,t)=>(l("replaceStars",e,t),e.trim().replace(c[d.STAR],"")),A=(e,t)=>(l("replaceGTE0",e,t),e.trim().replace(c[t.includePrerelease?d.GTE0PRE:d.GTE0],"")),T=e=>(t,r,a,i,n,s,o,l,u,c,d,h)=>(r=v(a)?"":v(i)?`>=${a}.0.0${e?"-0":""}`:v(n)?`>=${a}.${i}.0${e?"-0":""}`:s?`>=${r}`:`>=${r}${e?"-0":""}`,l=v(u)?"":v(c)?`<${+u+1}.0.0-0`:v(d)?`<${u}.${+c+1}.0-0`:h?`<=${u}.${c}.${d}-${h}`:e?`<${u}.${c}.${+d+1}-0`:`<=${l}`,`${r} ${l}`.trim()),P=(e,t,r)=>{for(let r=0;r<e.length;r++)if(!e[r].test(t))return!1;if(t.prerelease.length&&!r.includePrerelease){for(let r=0;r<e.length;r++)if(l(e[r].semver),e[r].semver!==o.ANY&&e[r].semver.prerelease.length>0){let a=e[r].semver;if(a.major===t.major&&a.minor===t.minor&&a.patch===t.patch)return!0}return!1}return!0}},74899:function(e,t,r){"use strict";let a=r(96735),{MAX_LENGTH:i,MAX_SAFE_INTEGER:n}=r(26261),{safeRe:s,t:o}=r(30487),l=r(46588),{compareIdentifiers:u}=r(70204);class c{constructor(e,t){if(t=l(t),e instanceof c)if(!!t.loose===e.loose&&!!t.includePrerelease===e.includePrerelease)return e;else e=e.version;else if("string"!=typeof e)throw TypeError(`Invalid version. Must be a string. Got type "${typeof e}".`);if(e.length>i)throw TypeError(`version is longer than ${i} characters`);a("SemVer",e,t),this.options=t,this.loose=!!t.loose,this.includePrerelease=!!t.includePrerelease;let r=e.trim().match(t.loose?s[o.LOOSE]:s[o.FULL]);if(!r)throw TypeError(`Invalid Version: ${e}`);if(this.raw=e,this.major=+r[1],this.minor=+r[2],this.patch=+r[3],this.major>n||this.major<0)throw TypeError("Invalid major version");if(this.minor>n||this.minor<0)throw TypeError("Invalid minor version");if(this.patch>n||this.patch<0)throw TypeError("Invalid patch version");r[4]?this.prerelease=r[4].split(".").map(e=>{if(/^[0-9]+$/.test(e)){let t=+e;if(t>=0&&t<n)return t}return e}):this.prerelease=[],this.build=r[5]?r[5].split("."):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(".")}`),this.version}toString(){return this.version}compare(e){if(a("SemVer.compare",this.version,this.options,e),!(e instanceof c)){if("string"==typeof e&&e===this.version)return 0;e=new c(e,this.options)}return e.version===this.version?0:this.compareMain(e)||this.comparePre(e)}compareMain(e){return e instanceof c||(e=new c(e,this.options)),u(this.major,e.major)||u(this.minor,e.minor)||u(this.patch,e.patch)}comparePre(e){if(e instanceof c||(e=new c(e,this.options)),this.prerelease.length&&!e.prerelease.length)return -1;if(!this.prerelease.length&&e.prerelease.length)return 1;if(!this.prerelease.length&&!e.prerelease.length)return 0;let t=0;do{let r=this.prerelease[t],i=e.prerelease[t];if(a("prerelease compare",t,r,i),void 0===r&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===r)return -1;else if(r===i)continue;else return u(r,i)}while(++t)}compareBuild(e){e instanceof c||(e=new c(e,this.options));let t=0;do{let r=this.build[t],i=e.build[t];if(a("build compare",t,r,i),void 0===r&&void 0===i)return 0;if(void 0===i)return 1;if(void 0===r)return -1;else if(r===i)continue;else return u(r,i)}while(++t)}inc(e,t,r){if(e.startsWith("pre")){if(!t&&!1===r)throw Error("invalid increment argument: identifier is empty");if(t){let e=`-${t}`.match(this.options.loose?s[o.PRERELEASELOOSE]:s[o.PRERELEASE]);if(!e||e[1]!==t)throw Error(`invalid identifier: ${t}`)}}switch(e){case"premajor":this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc("pre",t,r);break;case"preminor":this.prerelease.length=0,this.patch=0,this.minor++,this.inc("pre",t,r);break;case"prepatch":this.prerelease.length=0,this.inc("patch",t,r),this.inc("pre",t,r);break;case"prerelease":0===this.prerelease.length&&this.inc("patch",t,r),this.inc("pre",t,r);break;case"release":if(0===this.prerelease.length)throw Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case"major":(0!==this.minor||0!==this.patch||0===this.prerelease.length)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case"minor":(0!==this.patch||0===this.prerelease.length)&&this.minor++,this.patch=0,this.prerelease=[];break;case"patch":0===this.prerelease.length&&this.patch++,this.prerelease=[];break;case"pre":{let e=+!!Number(r);if(0===this.prerelease.length)this.prerelease=[e];else{let a=this.prerelease.length;for(;--a>=0;)"number"==typeof this.prerelease[a]&&(this.prerelease[a]++,a=-2);if(-1===a){if(t===this.prerelease.join(".")&&!1===r)throw Error("invalid increment argument: identifier already exists");this.prerelease.push(e)}}if(t){let a=[t,e];!1===r&&(a=[t]),0===u(this.prerelease[0],t)?isNaN(this.prerelease[1])&&(this.prerelease=a):this.prerelease=a}break}default:throw Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(".")}`),this}}e.exports=c},79855:function(e,t,r){"use strict";let a=r(77737);e.exports=(e,t)=>{let r=a(e.trim().replace(/^[=v]+/,""),t);return r?r.version:null}},1534:function(e,t,r){"use strict";let a=r(30818),i=r(69606),n=r(12559),s=r(57372),o=r(34056),l=r(56133);e.exports=(e,t,r,u)=>{switch(t){case"===":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e===r;case"!==":return"object"==typeof e&&(e=e.version),"object"==typeof r&&(r=r.version),e!==r;case"":case"=":case"==":return a(e,r,u);case"!=":return i(e,r,u);case">":return n(e,r,u);case">=":return s(e,r,u);case"<":return o(e,r,u);case"<=":return l(e,r,u);default:throw TypeError(`Invalid operator: ${t}`)}}},66945:function(e,t,r){"use strict";let a=r(74899),i=r(77737),{safeRe:n,t:s}=r(30487);e.exports=(e,t)=>{if(e instanceof a)return e;if("number"==typeof e&&(e=String(e)),"string"!=typeof e)return null;let r=null;if((t=t||{}).rtl){let a,i=t.includePrerelease?n[s.COERCERTLFULL]:n[s.COERCERTL];for(;(a=i.exec(e))&&(!r||r.index+r[0].length!==e.length);)r&&a.index+a[0].length===r.index+r[0].length||(r=a),i.lastIndex=a.index+a[1].length+a[2].length;i.lastIndex=-1}else r=e.match(t.includePrerelease?n[s.COERCEFULL]:n[s.COERCE]);if(null===r)return null;let o=r[2],l=r[3]||"0",u=r[4]||"0",c=t.includePrerelease&&r[5]?`-${r[5]}`:"",d=t.includePrerelease&&r[6]?`+${r[6]}`:"";return i(`${o}.${l}.${u}${c}${d}`,t)}},48136:function(e,t,r){"use strict";let a=r(74899);e.exports=(e,t,r)=>{let i=new a(e,r),n=new a(t,r);return i.compare(n)||i.compareBuild(n)}},13042:function(e,t,r){"use strict";let a=r(84621);e.exports=(e,t)=>a(e,t,!0)},84621:function(e,t,r){"use strict";let a=r(74899);e.exports=(e,t,r)=>new a(e,r).compare(new a(t,r))},77119:function(e,t,r){"use strict";let a=r(77737);e.exports=(e,t)=>{let r=a(e,null,!0),i=a(t,null,!0),n=r.compare(i);if(0===n)return null;let s=n>0,o=s?r:i,l=s?i:r,u=!!o.prerelease.length;if(l.prerelease.length&&!u){if(!l.patch&&!l.minor)return"major";if(0===l.compareMain(o))return l.minor&&!l.patch?"minor":"patch"}let c=u?"pre":"";return r.major!==i.major?c+"major":r.minor!==i.minor?c+"minor":r.patch!==i.patch?c+"patch":"prerelease"}},30818:function(e,t,r){"use strict";let a=r(84621);e.exports=(e,t,r)=>0===a(e,t,r)},12559:function(e,t,r){"use strict";let a=r(84621);e.exports=(e,t,r)=>a(e,t,r)>0},57372:function(e,t,r){"use strict";let a=r(84621);e.exports=(e,t,r)=>a(e,t,r)>=0},84106:function(e,t,r){"use strict";let a=r(74899);e.exports=(e,t,r,i,n)=>{"string"==typeof r&&(n=i,i=r,r=void 0);try{return new a(e instanceof a?e.version:e,r).inc(t,i,n).version}catch(e){return null}}},34056:function(e,t,r){"use strict";let a=r(84621);e.exports=(e,t,r)=>0>a(e,t,r)},56133:function(e,t,r){"use strict";let a=r(84621);e.exports=(e,t,r)=>0>=a(e,t,r)},6148:function(e,t,r){"use strict";let a=r(74899);e.exports=(e,t)=>new a(e,t).major},40547:function(e,t,r){"use strict";let a=r(74899);e.exports=(e,t)=>new a(e,t).minor},69606:function(e,t,r){"use strict";let a=r(84621);e.exports=(e,t,r)=>0!==a(e,t,r)},77737:function(e,t,r){"use strict";let a=r(74899);e.exports=(e,t,r=!1)=>{if(e instanceof a)return e;try{return new a(e,t)}catch(e){if(!r)return null;throw e}}},29196:function(e,t,r){"use strict";let a=r(74899);e.exports=(e,t)=>new a(e,t).patch},83690:function(e,t,r){"use strict";let a=r(77737);e.exports=(e,t)=>{let r=a(e,t);return r&&r.prerelease.length?r.prerelease:null}},22469:function(e,t,r){"use strict";let a=r(84621);e.exports=(e,t,r)=>a(t,e,r)},39056:function(e,t,r){"use strict";let a=r(48136);e.exports=(e,t)=>e.sort((e,r)=>a(r,e,t))},90995:function(e,t,r){"use strict";let a=r(9558);e.exports=(e,t,r)=>{try{t=new a(t,r)}catch(e){return!1}return t.test(e)}},96856:function(e,t,r){"use strict";let a=r(48136);e.exports=(e,t)=>e.sort((e,r)=>a(e,r,t))},84004:function(e,t,r){"use strict";let a=r(77737);e.exports=(e,t)=>{let r=a(e,t);return r?r.version:null}},41251:function(e,t,r){"use strict";let a=r(30487),i=r(26261),n=r(74899),s=r(70204),o=r(77737),l=r(84004),u=r(79855),c=r(84106),d=r(77119),h=r(6148),p=r(40547),f=r(29196),m=r(83690),g=r(84621),y=r(22469),b=r(13042),_=r(48136),w=r(96856),v=r(39056),E=r(12559),O=r(34056),k=r(30818),S=r(69606),x=r(57372),$=r(56133),I=r(1534),A=r(66945),T=r(96635),P=r(9558),j=r(90995),N=r(90534),R=r(15985),C=r(19499),L=r(23602),M=r(22153),U=r(76592),D=r(34076),z=r(64453),F=r(50753);e.exports={parse:o,valid:l,clean:u,inc:c,diff:d,major:h,minor:p,patch:f,prerelease:m,compare:g,rcompare:y,compareLoose:b,compareBuild:_,sort:w,rsort:v,gt:E,lt:O,eq:k,neq:S,gte:x,lte:$,cmp:I,coerce:A,Comparator:T,Range:P,satisfies:j,toComparators:N,maxSatisfying:R,minSatisfying:C,minVersion:L,validRange:M,outside:U,gtr:D,ltr:z,intersects:F,simplifyRange:r(21620),subset:r(19881),SemVer:n,re:a.re,src:a.src,tokens:a.t,SEMVER_SPEC_VERSION:i.SEMVER_SPEC_VERSION,RELEASE_TYPES:i.RELEASE_TYPES,compareIdentifiers:s.compareIdentifiers,rcompareIdentifiers:s.rcompareIdentifiers}},26261:function(e){"use strict";e.exports={MAX_LENGTH:256,MAX_SAFE_COMPONENT_LENGTH:16,MAX_SAFE_BUILD_LENGTH:250,MAX_SAFE_INTEGER:Number.MAX_SAFE_INTEGER||0x1fffffffffffff,RELEASE_TYPES:["major","premajor","minor","preminor","patch","prepatch","prerelease"],SEMVER_SPEC_VERSION:"2.0.0",FLAG_INCLUDE_PRERELEASE:1,FLAG_LOOSE:2}},96735:function(e){"use strict";e.exports="object"==typeof process&&process.env&&process.env.NODE_DEBUG&&/\bsemver\b/i.test(process.env.NODE_DEBUG)?(...e)=>console.error("SEMVER",...e):()=>{}},70204:function(e){"use strict";let t=/^[0-9]+$/,r=(e,r)=>{let a=t.test(e),i=t.test(r);return a&&i&&(e*=1,r*=1),e===r?0:a&&!i?-1:i&&!a?1:e<r?-1:1};e.exports={compareIdentifiers:r,rcompareIdentifiers:(e,t)=>r(t,e)}},70639:function(e){"use strict";e.exports=class{constructor(){this.max=1e3,this.map=new Map}get(e){let t=this.map.get(e);if(void 0!==t)return this.map.delete(e),this.map.set(e,t),t}delete(e){return this.map.delete(e)}set(e,t){if(!this.delete(e)&&void 0!==t){if(this.map.size>=this.max){let e=this.map.keys().next().value;this.delete(e)}this.map.set(e,t)}return this}}},46588:function(e){"use strict";let t=Object.freeze({loose:!0}),r=Object.freeze({});e.exports=e=>e?"object"!=typeof e?t:e:r},30487:function(e,t,r){"use strict";let{MAX_SAFE_COMPONENT_LENGTH:a,MAX_SAFE_BUILD_LENGTH:i,MAX_LENGTH:n}=r(26261),s=r(96735),o=(t=e.exports={}).re=[],l=t.safeRe=[],u=t.src=[],c=t.safeSrc=[],d=t.t={},h=0,p="[a-zA-Z0-9-]",f=[["\\s",1],["\\d",n],[p,i]],m=(e,t,r)=>{let a=(e=>{for(let[t,r]of f)e=e.split(`${t}*`).join(`${t}{0,${r}}`).split(`${t}+`).join(`${t}{1,${r}}`);return e})(t),i=h++;s(e,i,t),d[e]=i,u[i]=t,c[i]=a,o[i]=new RegExp(t,r?"g":void 0),l[i]=new RegExp(a,r?"g":void 0)};m("NUMERICIDENTIFIER","0|[1-9]\\d*"),m("NUMERICIDENTIFIERLOOSE","\\d+"),m("NONNUMERICIDENTIFIER",`\\d*[a-zA-Z-]${p}*`),m("MAINVERSION",`(${u[d.NUMERICIDENTIFIER]})\\.(${u[d.NUMERICIDENTIFIER]})\\.(${u[d.NUMERICIDENTIFIER]})`),m("MAINVERSIONLOOSE",`(${u[d.NUMERICIDENTIFIERLOOSE]})\\.(${u[d.NUMERICIDENTIFIERLOOSE]})\\.(${u[d.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASEIDENTIFIER",`(?:${u[d.NONNUMERICIDENTIFIER]}|${u[d.NUMERICIDENTIFIER]})`),m("PRERELEASEIDENTIFIERLOOSE",`(?:${u[d.NONNUMERICIDENTIFIER]}|${u[d.NUMERICIDENTIFIERLOOSE]})`),m("PRERELEASE",`(?:-(${u[d.PRERELEASEIDENTIFIER]}(?:\\.${u[d.PRERELEASEIDENTIFIER]})*))`),m("PRERELEASELOOSE",`(?:-?(${u[d.PRERELEASEIDENTIFIERLOOSE]}(?:\\.${u[d.PRERELEASEIDENTIFIERLOOSE]})*))`),m("BUILDIDENTIFIER",`${p}+`),m("BUILD",`(?:\\+(${u[d.BUILDIDENTIFIER]}(?:\\.${u[d.BUILDIDENTIFIER]})*))`),m("FULLPLAIN",`v?${u[d.MAINVERSION]}${u[d.PRERELEASE]}?${u[d.BUILD]}?`),m("FULL",`^${u[d.FULLPLAIN]}$`),m("LOOSEPLAIN",`[v=\\s]*${u[d.MAINVERSIONLOOSE]}${u[d.PRERELEASELOOSE]}?${u[d.BUILD]}?`),m("LOOSE",`^${u[d.LOOSEPLAIN]}$`),m("GTLT","((?:<|>)?=?)"),m("XRANGEIDENTIFIERLOOSE",`${u[d.NUMERICIDENTIFIERLOOSE]}|x|X|\\*`),m("XRANGEIDENTIFIER",`${u[d.NUMERICIDENTIFIER]}|x|X|\\*`),m("XRANGEPLAIN",`[v=\\s]*(${u[d.XRANGEIDENTIFIER]})(?:\\.(${u[d.XRANGEIDENTIFIER]})(?:\\.(${u[d.XRANGEIDENTIFIER]})(?:${u[d.PRERELEASE]})?${u[d.BUILD]}?)?)?`),m("XRANGEPLAINLOOSE",`[v=\\s]*(${u[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[d.XRANGEIDENTIFIERLOOSE]})(?:\\.(${u[d.XRANGEIDENTIFIERLOOSE]})(?:${u[d.PRERELEASELOOSE]})?${u[d.BUILD]}?)?)?`),m("XRANGE",`^${u[d.GTLT]}\\s*${u[d.XRANGEPLAIN]}$`),m("XRANGELOOSE",`^${u[d.GTLT]}\\s*${u[d.XRANGEPLAINLOOSE]}$`),m("COERCEPLAIN",`(^|[^\\d])(\\d{1,${a}})(?:\\.(\\d{1,${a}}))?(?:\\.(\\d{1,${a}}))?`),m("COERCE",`${u[d.COERCEPLAIN]}(?:$|[^\\d])`),m("COERCEFULL",u[d.COERCEPLAIN]+`(?:${u[d.PRERELEASE]})?`+`(?:${u[d.BUILD]})?`+"(?:$|[^\\d])"),m("COERCERTL",u[d.COERCE],!0),m("COERCERTLFULL",u[d.COERCEFULL],!0),m("LONETILDE","(?:~>?)"),m("TILDETRIM",`(\\s*)${u[d.LONETILDE]}\\s+`,!0),t.tildeTrimReplace="$1~",m("TILDE",`^${u[d.LONETILDE]}${u[d.XRANGEPLAIN]}$`),m("TILDELOOSE",`^${u[d.LONETILDE]}${u[d.XRANGEPLAINLOOSE]}$`),m("LONECARET","(?:\\^)"),m("CARETTRIM",`(\\s*)${u[d.LONECARET]}\\s+`,!0),t.caretTrimReplace="$1^",m("CARET",`^${u[d.LONECARET]}${u[d.XRANGEPLAIN]}$`),m("CARETLOOSE",`^${u[d.LONECARET]}${u[d.XRANGEPLAINLOOSE]}$`),m("COMPARATORLOOSE",`^${u[d.GTLT]}\\s*(${u[d.LOOSEPLAIN]})$|^$`),m("COMPARATOR",`^${u[d.GTLT]}\\s*(${u[d.FULLPLAIN]})$|^$`),m("COMPARATORTRIM",`(\\s*)${u[d.GTLT]}\\s*(${u[d.LOOSEPLAIN]}|${u[d.XRANGEPLAIN]})`,!0),t.comparatorTrimReplace="$1$2$3",m("HYPHENRANGE",`^\\s*(${u[d.XRANGEPLAIN]})\\s+-\\s+(${u[d.XRANGEPLAIN]})\\s*$`),m("HYPHENRANGELOOSE",`^\\s*(${u[d.XRANGEPLAINLOOSE]})\\s+-\\s+(${u[d.XRANGEPLAINLOOSE]})\\s*$`),m("STAR","(<|>)?=?\\s*\\*"),m("GTE0","^\\s*>=\\s*0\\.0\\.0\\s*$"),m("GTE0PRE","^\\s*>=\\s*0\\.0\\.0-0\\s*$")},34076:function(e,t,r){"use strict";let a=r(76592);e.exports=(e,t,r)=>a(e,t,">",r)},50753:function(e,t,r){"use strict";let a=r(9558);e.exports=(e,t,r)=>(e=new a(e,r),t=new a(t,r),e.intersects(t,r))},64453:function(e,t,r){"use strict";let a=r(76592);e.exports=(e,t,r)=>a(e,t,"<",r)},15985:function(e,t,r){"use strict";let a=r(74899),i=r(9558);e.exports=(e,t,r)=>{let n=null,s=null,o=null;try{o=new i(t,r)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(!n||-1===s.compare(e))&&(s=new a(n=e,r))}),n}},19499:function(e,t,r){"use strict";let a=r(74899),i=r(9558);e.exports=(e,t,r)=>{let n=null,s=null,o=null;try{o=new i(t,r)}catch(e){return null}return e.forEach(e=>{o.test(e)&&(!n||1===s.compare(e))&&(s=new a(n=e,r))}),n}},23602:function(e,t,r){"use strict";let a=r(74899),i=r(9558),n=r(12559);e.exports=(e,t)=>{e=new i(e,t);let r=new a("0.0.0");if(e.test(r)||(r=new a("0.0.0-0"),e.test(r)))return r;r=null;for(let t=0;t<e.set.length;++t){let i=e.set[t],s=null;i.forEach(e=>{let t=new a(e.semver.version);switch(e.operator){case">":0===t.prerelease.length?t.patch++:t.prerelease.push(0),t.raw=t.format();case"":case">=":(!s||n(t,s))&&(s=t);break;case"<":case"<=":break;default:throw Error(`Unexpected operation: ${e.operator}`)}}),s&&(!r||n(r,s))&&(r=s)}return r&&e.test(r)?r:null}},76592:function(e,t,r){"use strict";let a=r(74899),i=r(96635),{ANY:n}=i,s=r(9558),o=r(90995),l=r(12559),u=r(34056),c=r(56133),d=r(57372);e.exports=(e,t,r,h)=>{let p,f,m,g,y;switch(e=new a(e,h),t=new s(t,h),r){case">":p=l,f=c,m=u,g=">",y=">=";break;case"<":p=u,f=d,m=l,g="<",y="<=";break;default:throw TypeError('Must provide a hilo val of "<" or ">"')}if(o(e,t,h))return!1;for(let r=0;r<t.set.length;++r){let a=t.set[r],s=null,o=null;if(a.forEach(e=>{e.semver===n&&(e=new i(">=0.0.0")),s=s||e,o=o||e,p(e.semver,s.semver,h)?s=e:m(e.semver,o.semver,h)&&(o=e)}),s.operator===g||s.operator===y||(!o.operator||o.operator===g)&&f(e,o.semver)||o.operator===y&&m(e,o.semver))return!1}return!0}},21620:function(e,t,r){"use strict";let a=r(90995),i=r(84621);e.exports=(e,t,r)=>{let n=[],s=null,o=null,l=e.sort((e,t)=>i(e,t,r));for(let e of l)a(e,t,r)?(o=e,s||(s=e)):(o&&n.push([s,o]),o=null,s=null);s&&n.push([s,null]);let u=[];for(let[e,t]of n)e===t?u.push(e):t||e!==l[0]?t?e===l[0]?u.push(`<=${t}`):u.push(`${e} - ${t}`):u.push(`>=${e}`):u.push("*");let c=u.join(" || "),d="string"==typeof t.raw?t.raw:String(t);return c.length<d.length?c:t}},19881:function(e,t,r){"use strict";let a=r(9558),i=r(96635),{ANY:n}=i,s=r(90995),o=r(84621),l=[new i(">=0.0.0-0")],u=[new i(">=0.0.0")],c=(e,t,r)=>{let a,i,c,p,f,m,g;if(e===t)return!0;if(1===e.length&&e[0].semver===n)if(1===t.length&&t[0].semver===n)return!0;else e=r.includePrerelease?l:u;if(1===t.length&&t[0].semver===n)if(r.includePrerelease)return!0;else t=u;let y=new Set;for(let t of e)">"===t.operator||">="===t.operator?a=d(a,t,r):"<"===t.operator||"<="===t.operator?i=h(i,t,r):y.add(t.semver);if(y.size>1)return null;if(a&&i&&((c=o(a.semver,i.semver,r))>0||0===c&&(">="!==a.operator||"<="!==i.operator)))return null;for(let e of y){if(a&&!s(e,String(a),r)||i&&!s(e,String(i),r))return null;for(let a of t)if(!s(e,String(a),r))return!1;return!0}let b=!!i&&!r.includePrerelease&&!!i.semver.prerelease.length&&i.semver,_=!!a&&!r.includePrerelease&&!!a.semver.prerelease.length&&a.semver;for(let e of(b&&1===b.prerelease.length&&"<"===i.operator&&0===b.prerelease[0]&&(b=!1),t)){if(g=g||">"===e.operator||">="===e.operator,m=m||"<"===e.operator||"<="===e.operator,a){if(_&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===_.major&&e.semver.minor===_.minor&&e.semver.patch===_.patch&&(_=!1),">"===e.operator||">="===e.operator){if((p=d(a,e,r))===e&&p!==a)return!1}else if(">="===a.operator&&!s(a.semver,String(e),r))return!1}if(i){if(b&&e.semver.prerelease&&e.semver.prerelease.length&&e.semver.major===b.major&&e.semver.minor===b.minor&&e.semver.patch===b.patch&&(b=!1),"<"===e.operator||"<="===e.operator){if((f=h(i,e,r))===e&&f!==i)return!1}else if("<="===i.operator&&!s(i.semver,String(e),r))return!1}if(!e.operator&&(i||a)&&0!==c)return!1}return(!a||!m||!!i||0===c)&&(!i||!g||!!a||0===c)&&!_&&!b&&!0},d=(e,t,r)=>{if(!e)return t;let a=o(e.semver,t.semver,r);return a>0?e:a<0||">"===t.operator&&">="===e.operator?t:e},h=(e,t,r)=>{if(!e)return t;let a=o(e.semver,t.semver,r);return a<0?e:a>0||"<"===t.operator&&"<="===e.operator?t:e};e.exports=(e,t,r={})=>{if(e===t)return!0;e=new a(e,r),t=new a(t,r);let i=!1;e:for(let a of e.set){for(let e of t.set){let t=c(a,e,r);if(i=i||null!==t,t)continue e}if(i)return!1}return!0}},90534:function(e,t,r){"use strict";let a=r(9558);e.exports=(e,t)=>new a(e,t).set.map(e=>e.map(e=>e.value).join(" ").trim().split(" "))},22153:function(e,t,r){"use strict";let a=r(9558);e.exports=(e,t)=>{try{return new a(e,t).range||"*"}catch(e){return null}}},44617:function(e){"use strict";e.exports=(e,t)=>(t=t||(()=>{}),e.then(e=>new Promise(e=>{e(t())}).then(()=>e),e=>new Promise(e=>{e(t())}).then(()=>{throw e})))},73290:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let a=r(30228),i=r(56641),n=r(54774),s=()=>{},o=new i.TimeoutError;t.default=class extends a{constructor(e){var t,r,a,i;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=s,this._resolveIdle=s,!("number"==typeof(e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:n.default},e)).intervalCap&&e.intervalCap>=1))throw TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${null!=(r=null==(t=e.intervalCap)?void 0:t.toString())?r:""}\` (${typeof e.intervalCap})`);if(void 0===e.interval||!(Number.isFinite(e.interval)&&e.interval>=0))throw TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${null!=(i=null==(a=e.interval)?void 0:a.toString())?i:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||0===e.interval,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=!0===e.throwOnTimeout,this._isPaused=!1===e.autoStart}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=s,0===this._pendingCount&&(this._resolveIdle(),this._resolveIdle=s,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(void 0===this._intervalId){let t=this._intervalEnd-e;if(!(t<0))return void 0===this._timeoutId&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0;this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0}return!1}_tryToStartAnother(){if(0===this._queue.size)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return!!t&&(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0)}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||void 0!==this._intervalId||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){0===this._intervalCount&&0===this._pendingCount&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!("number"==typeof e&&e>=1))throw TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{let n=async()=>{this._pendingCount++,this._intervalCount++;try{let n=void 0===this._timeout&&void 0===t.timeout?e():i.default(Promise.resolve(e()),void 0===t.timeout?this._timeout:t.timeout,()=>{(void 0===t.throwOnTimeout?this._throwOnTimeout:t.throwOnTimeout)&&a(o)});r(await n)}catch(e){a(e)}this._next()};this._queue.enqueue(n,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async e=>this.add(e,t)))}start(){return this._isPaused&&(this._isPaused=!1,this._processQueue()),this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(0!==this._queue.size)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(0!==this._pendingCount||0!==this._queue.size)return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}},79998:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r){let a=0,i=e.length;for(;i>0;){let n=i/2|0,s=a+n;0>=r(e[s],t)?(a=++s,i-=n+1):i=n}return a}},54774:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let a=r(79998);t.default=class{constructor(){this._queue=[]}enqueue(e,t){let r={priority:(t=Object.assign({priority:0},t)).priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority)return void this._queue.push(r);let i=a.default(this._queue,r,(e,t)=>t.priority-e.priority);this._queue.splice(i,0,r)}dequeue(){let e=this._queue.shift();return null==e?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(e=>e.run)}get size(){return this._queue.length}}},24116:function(e,t,r){"use strict";let a=r(75617),i=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class n extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}let s=(e,t)=>new Promise((r,s)=>{t={onFailedAttempt:()=>{},retries:10,...t};let o=a.operation(t);o.attempt(async a=>{try{r(await e(a))}catch(e){if(!(e instanceof Error))return void s(TypeError(`Non-error was thrown: "${e}". You should only throw errors.`));if(e instanceof n)o.stop(),s(e.originalError);else{let r;if(e instanceof TypeError&&(r=e.message,!i.includes(r)))o.stop(),s(e);else{((e,t,r)=>{let a=r.retries-(t-1);return e.attemptNumber=t,e.retriesLeft=a})(e,a,t);try{await t.onFailedAttempt(e)}catch(e){s(e);return}o.retry(e)||s(o.mainError())}}}})});e.exports=s,e.exports.default=s,e.exports.AbortError=n},56641:function(e,t,r){"use strict";let a=r(44617);class i extends Error{constructor(e){super(e),this.name="TimeoutError"}}let n=(e,t,r)=>new Promise((n,s)=>{if("number"!=typeof t||t<0)throw TypeError("Expected `milliseconds` to be a positive number");if(t===1/0)return void n(e);let o=setTimeout(()=>{if("function"==typeof r){try{n(r())}catch(e){s(e)}return}let a="string"==typeof r?r:`Promise timed out after ${t} milliseconds`,o=r instanceof Error?r:new i(a);"function"==typeof e.cancel&&e.cancel(),s(o)},t);a(e.then(n,s),()=>{clearTimeout(o)})});e.exports=n,e.exports.default=n,e.exports.TimeoutError=i},75617:function(e,t,r){e.exports=r(58303)},58303:function(e,t,r){var a=r(93961);t.operation=function(e){return new a(t.timeouts(e),{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw Error("minTimeout is greater than maxTimeout");for(var a=[],i=0;i<t.retries;i++)a.push(this.createTimeout(i,t));return e&&e.forever&&!a.length&&a.push(this.createTimeout(i,t)),a.sort(function(e,t){return e-t}),a},t.createTimeout=function(e,t){var r=Math.round((t.randomize?Math.random()+1:1)*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return Math.min(r,t.maxTimeout)},t.wrap=function(e,r,a){if(r instanceof Array&&(a=r,r=null),!a)for(var i in a=[],e)"function"==typeof e[i]&&a.push(i);for(var n=0;n<a.length;n++){var s=a[n],o=e[s];e[s]=(function(a){var i=t.operation(r),n=Array.prototype.slice.call(arguments,1),s=n.pop();n.push(function(e){i.retry(e)||(e&&(arguments[0]=i.mainError()),s.apply(this,arguments))}),i.attempt(function(){a.apply(e,n)})}).bind(e,o),e[s].options=r}}},93961:function(e){function t(e,t){"boolean"==typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}e.exports=t,t.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},t.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},t.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=new Date().getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r)if(!this._cachedTimeouts)return!1;else this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1);var a=this;return this._timer=setTimeout(function(){a._attempts++,a._operationTimeoutCb&&(a._timeout=setTimeout(function(){a._operationTimeoutCb(a._attempts)},a._operationTimeout),a._options.unref&&a._timeout.unref()),a._fn(a._attempts)},r),this._options.unref&&this._timer.unref(),!0},t.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){r._operationTimeoutCb()},r._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)},t.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},t.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},t.prototype.start=t.prototype.try,t.prototype.errors=function(){return this._errors},t.prototype.attempts=function(){return this._attempts},t.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,a=0;a<this._errors.length;a++){var i=this._errors[a],n=i.message,s=(e[n]||0)+1;e[n]=s,s>=r&&(t=i,r=s)}return t}},26945:function(e,t,r){"use strict";let a,i,n,s,o,l,u,c,d,h,p,f,m,g;r.d(t,{TaskRunAPI:()=>d$,TaskValidateAPI:()=>dx,TaskCancelAPI:()=>dT,TaskResultAPI:()=>dI,TaskReportAPI:()=>dA});var y,b,_,w,v,E,O,k,S,x,$,I,A,T,P,j,N,R,C,L,M,U,D,z,F,B,q,H,W,J,G,Z,V,Y,K,X,Q,ee,et,er,ea,ei,en,es,eo,el,eu,ec,ed,eh,ep,ef,em,eg,ey,eb,e_,ew,ev,eE,eO,ek,eS,ex,e$,eI,eA,eT,eP,ej,eN,eR,eC,eL,eM,eU,eD,ez,eF,eB,eq,eH,eW,eJ,eG,eZ,eV,eY,eK,eX,eQ,e0,e1,e2,e5,e4,e9,e3={};r.r(e3),r.d(e3,{JsonPatchError:()=>iK,_areEquals:()=>i6,applyOperation:()=>i2,applyPatch:()=>i5,applyReducer:()=>i4,deepClone:()=>iX,getValueByPointer:()=>i1,validate:()=>i3,validator:()=>i9});var e6=r(82481);let e8=function(e){return null==e},e7="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),te=new Uint8Array(16),tt=[];for(let e=0;e<256;++e)tt.push((e+256).toString(16).slice(1));function tr(e,t,r,a,i){if("m"===a)throw TypeError("Private method is not writable");if("a"===a&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===a?i.call(e,r):i?i.value=r:t.set(e,r),r}function ta(e,t,r,a){if("a"===r&&!a)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!a:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?a:"a"===r?a.call(e):a?a.value:t.get(e)}let ti=function(){let{crypto:e}=globalThis;if(e?.randomUUID)return ti=e.randomUUID.bind(e),e.randomUUID();let t=new Uint8Array(1),r=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^r()&15>>e/4).toString(16))};function tn(e){return"object"==typeof e&&null!==e&&("name"in e&&"AbortError"===e.name||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}let ts=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e){try{if("[object Error]"===Object.prototype.toString.call(e)){let t=Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return Error(JSON.stringify(e))}catch{}}return Error(e)};class to extends Error{}class tl extends to{constructor(e,t,r,a){super(`${tl.makeMessage(e,t,r)}`),this.status=e,this.headers=a,this.requestID=a?.get("x-request-id"),this.error=t,this.code=t?.code,this.param=t?.param,this.type=t?.type}static makeMessage(e,t,r){let a=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e||!a)return new tc({message:r,cause:ts(t)});let i=t?.error;return 400===e?new th(e,i,r,a):401===e?new tp(e,i,r,a):403===e?new tf(e,i,r,a):404===e?new tm(e,i,r,a):409===e?new tg(e,i,r,a):422===e?new ty(e,i,r,a):429===e?new tb(e,i,r,a):e>=500?new t_(e,i,r,a):new tl(e,i,r,a)}}class tu extends tl{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class tc extends tl{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class td extends tc{constructor({message:e}={}){super({message:e??"Request timed out."})}}class th extends tl{}class tp extends tl{}class tf extends tl{}class tm extends tl{}class tg extends tl{}class ty extends tl{}class tb extends tl{}class t_ extends tl{}class tw extends to{constructor(){super("Could not parse response content as the length limit was reached")}}class tv extends to{constructor(){super("Could not parse response content as the request was rejected by the content filter")}}class tE extends Error{constructor(e){super(e)}}let tO=/^[a-z][a-z0-9+.-]*:/i,tk=e=>(tk=Array.isArray)(e),tS=tk;function tx(e){return"object"!=typeof e?{}:e??{}}function t$(e){return null!=e&&"object"==typeof e&&!Array.isArray(e)}let tI=e=>new Promise(t=>setTimeout(t,e)),tA="5.16.0",tT=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",tP=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";function tj(...e){let t=globalThis.ReadableStream;if(void 0===t)throw Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function tN(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return tj({start(){},async pull(e){let{done:r,value:a}=await t.next();r?e.close():e.enqueue(a)},async cancel(){await t.return?.()}})}function tR(e){if(e[Symbol.asyncIterator])return e;let t=e.getReader();return{async next(){try{let e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){let e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function tC(e){if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator])return void await e[Symbol.asyncIterator]().return?.();let t=e.getReader(),r=t.cancel();t.releaseLock(),await r}let tL=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)}),tM="RFC3986",tU=e=>String(e),tD={RFC1738:e=>String(e).replace(/%20/g,"+"),RFC3986:tU},tz=(e,t)=>(tz=Object.hasOwn??Function.prototype.call.bind(Object.prototype.hasOwnProperty))(e,t),tF=(()=>{let e=[];for(let t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e})();function tB(e,t){if(tk(e)){let r=[];for(let a=0;a<e.length;a+=1)r.push(t(e[a]));return r}return t(e)}let tq={brackets:e=>String(e)+"[]",comma:"comma",indices:(e,t)=>String(e)+"["+t+"]",repeat:e=>String(e)},tH=function(e,t){Array.prototype.push.apply(e,tk(t)?t:[t])},tW={addQueryPrefix:!1,allowDots:!1,allowEmptyArrays:!1,arrayFormat:"indices",charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encodeDotInKeys:!1,encoder:(e,t,r,a,i)=>{if(0===e.length)return e;let n=e;if("symbol"==typeof e?n=Symbol.prototype.toString.call(e):"string"!=typeof e&&(n=String(e)),"iso-8859-1"===r)return escape(n).replace(/%u[0-9a-f]{4}/gi,function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"});let s="";for(let e=0;e<n.length;e+=1024){let t=n.length>=1024?n.slice(e,e+1024):n,r=[];for(let e=0;e<t.length;++e){let a=t.charCodeAt(e);if(45===a||46===a||95===a||126===a||a>=48&&a<=57||a>=65&&a<=90||a>=97&&a<=122||"RFC1738"===i&&(40===a||41===a)){r[r.length]=t.charAt(e);continue}if(a<128){r[r.length]=tF[a];continue}if(a<2048){r[r.length]=tF[192|a>>6]+tF[128|63&a];continue}if(a<55296||a>=57344){r[r.length]=tF[224|a>>12]+tF[128|a>>6&63]+tF[128|63&a];continue}e+=1,a=65536+((1023&a)<<10|1023&t.charCodeAt(e)),r[r.length]=tF[240|a>>18]+tF[128|a>>12&63]+tF[128|a>>6&63]+tF[128|63&a]}s+=r.join("")}return s},encodeValuesOnly:!1,format:tM,formatter:tU,indices:!1,serializeDate:e=>(n??(n=Function.prototype.call.bind(Date.prototype.toISOString)))(e),skipNulls:!1,strictNullHandling:!1},tJ={};function tG(e){let t;return(s??(s=(t=new globalThis.TextEncoder).encode.bind(t)))(e)}function tZ(e){let t;return(o??(o=(t=new globalThis.TextDecoder).decode.bind(t)))(e)}class tV{constructor(){P.set(this,void 0),j.set(this,void 0),tr(this,P,new Uint8Array,"f"),tr(this,j,null,"f")}decode(e){let t;if(null==e)return[];let r=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?tG(e):e;tr(this,P,function(e){let t=0;for(let r of e)t+=r.length;let r=new Uint8Array(t),a=0;for(let t of e)r.set(t,a),a+=t.length;return r}([ta(this,P,"f"),r]),"f");let a=[];for(;null!=(t=function(e,t){for(let r=t??0;r<e.length;r++){if(10===e[r])return{preceding:r,index:r+1,carriage:!1};if(13===e[r])return{preceding:r,index:r+1,carriage:!0}}return null}(ta(this,P,"f"),ta(this,j,"f")));){if(t.carriage&&null==ta(this,j,"f")){tr(this,j,t.index,"f");continue}if(null!=ta(this,j,"f")&&(t.index!==ta(this,j,"f")+1||t.carriage)){a.push(tZ(ta(this,P,"f").subarray(0,ta(this,j,"f")-1))),tr(this,P,ta(this,P,"f").subarray(ta(this,j,"f")),"f"),tr(this,j,null,"f");continue}let e=null!==ta(this,j,"f")?t.preceding-1:t.preceding,r=tZ(ta(this,P,"f").subarray(0,e));a.push(r),tr(this,P,ta(this,P,"f").subarray(t.index),"f"),tr(this,j,null,"f")}return a}flush(){return ta(this,P,"f").length?this.decode("\n"):[]}}P=new WeakMap,j=new WeakMap,tV.NEWLINE_CHARS=new Set(["\n","\r"]),tV.NEWLINE_REGEXP=/\r\n|[\n\r]/g;let tY={off:0,error:200,warn:300,info:400,debug:500},tK=(e,t,r)=>{if(e){if(Object.prototype.hasOwnProperty.call(tY,e))return e;t2(r).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(tY))}`)}};function tX(){}function tQ(e,t,r){return!t||tY[e]>tY[r]?tX:t[e].bind(t)}let t0={error:tX,warn:tX,info:tX,debug:tX},t1=new WeakMap;function t2(e){let t=e.logger,r=e.logLevel??"off";if(!t)return t0;let a=t1.get(t);if(a&&a[0]===r)return a[1];let i={error:tQ("error",t,r),warn:tQ("warn",t,r),info:tQ("info",t,r),debug:tQ("debug",t,r)};return t1.set(t,[r,i]),i}let t5=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);class t4{constructor(e,t,r){this.iterator=e,N.set(this,void 0),this.controller=t,tr(this,N,r,"f")}static fromSSEResponse(e,t,r){let a=!1,i=r?t2(r):console;async function*n(){if(a)throw new to("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");a=!0;let r=!1;try{for await(let a of t9(e,t))if(!r){if(a.data.startsWith("[DONE]")){r=!0;continue}if(null!==a.event&&a.event.startsWith("thread.")){let e;try{e=JSON.parse(a.data)}catch(e){throw console.error("Could not parse message into JSON:",a.data),console.error("From chunk:",a.raw),e}if("error"==a.event)throw new tl(void 0,e.error,e.message,void 0);yield{event:a.event,data:e}}else{let t;try{t=JSON.parse(a.data)}catch(e){throw i.error("Could not parse message into JSON:",a.data),i.error("From chunk:",a.raw),e}if(t&&t.error)throw new tl(void 0,t.error,void 0,e.headers);yield t}}r=!0}catch(e){if(tn(e))return;throw e}finally{r||t.abort()}}return new t4(n,t,r)}static fromReadableStream(e,t,r){let a=!1;async function*i(){let t=new tV;for await(let r of tR(e))for(let e of t.decode(r))yield e;for(let e of t.flush())yield e}return new t4(async function*(){if(a)throw new to("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");a=!0;let e=!1;try{for await(let t of i())!e&&t&&(yield JSON.parse(t));e=!0}catch(e){if(tn(e))return;throw e}finally{e||t.abort()}},t,r)}[(N=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),a=a=>({next:()=>{if(0===a.length){let a=r.next();e.push(a),t.push(a)}return a.shift()}});return[new t4(()=>a(e),this.controller,ta(this,N,"f")),new t4(()=>a(t),this.controller,ta(this,N,"f"))]}toReadableStream(){let e,t=this;return tj({async start(){e=t[Symbol.asyncIterator]()},async pull(t){try{let{value:r,done:a}=await e.next();if(a)return t.close();let i=tG(JSON.stringify(r)+"\n");t.enqueue(i)}catch(e){t.error(e)}},async cancel(){await e.return?.()}})}}async function*t9(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new to("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new to("Attempted to iterate over a response with no body")}let r=new t6,a=new tV;for await(let t of t3(tR(e.body)))for(let e of a.decode(t)){let t=r.decode(e);t&&(yield t)}for(let e of a.flush()){let t=r.decode(e);t&&(yield t)}}async function*t3(e){let t=new Uint8Array;for await(let r of e){let e;if(null==r)continue;let a=r instanceof ArrayBuffer?new Uint8Array(r):"string"==typeof r?tG(r):r,i=new Uint8Array(t.length+a.length);for(i.set(t),i.set(a,t.length),t=i;-1!==(e=function(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1]||13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return -1}(t));)yield t.slice(0,e),t=t.slice(e)}t.length>0&&(yield t)}class t6{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=function(e,t){let r=e.indexOf(":");return -1!==r?[e.substring(0,r),t,e.substring(r+t.length)]:[e,"",""]}(e,":");return a.startsWith(" ")&&(a=a.substring(1)),"event"===t?this.event=a:"data"===t&&this.data.push(a),null}}async function t8(e,t){let{response:r,requestLogID:a,retryOfRequestLogID:i,startTime:n}=t,s=await (async()=>{if(t.options.stream)return(t2(e).debug("response",r.status,r.url,r.headers,r.body),t.options.__streamClass)?t.options.__streamClass.fromSSEResponse(r,t.controller,e):t4.fromSSEResponse(r,t.controller,e);if(204===r.status)return null;if(t.options.__binaryResponse)return r;let a=r.headers.get("content-type"),i=a?.split(";")[0]?.trim();return i?.includes("application/json")||i?.endsWith("+json")?t7(await r.json(),r):await r.text()})();return t2(e).debug(`[${a}] response parsed`,t5({retryOfRequestLogID:i,url:r.url,status:r.status,body:s,durationMs:Date.now()-n})),s}function t7(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("x-request-id"),enumerable:!1})}class re extends Promise{constructor(e,t,r=t8){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=r,R.set(this,void 0),tr(this,R,e,"f")}_thenUnwrap(e){return new re(ta(this,R,"f"),this.responsePromise,async(t,r)=>t7(e(await this.parseResponse(t,r),r),r.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("x-request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(ta(this,R,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}R=new WeakMap;class rt{constructor(e,t,r,a){C.set(this,void 0),tr(this,C,e,"f"),this.options=a,this.response=t,this.body=r}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new to("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await ta(this,C,"f").requestAPIList(this.constructor,e)}async *iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async *[(C=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}}class rr extends re{constructor(e,t,r){super(e,t,async(e,t)=>new r(e,t.response,await t8(e,t),t.options))}async *[Symbol.asyncIterator](){for await(let e of(await this))yield e}}class ra extends rt{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageRequestOptions(){return null}}class ri extends rt{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.has_more=r.has_more||!1}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){let e=this.getPaginatedItems(),t=e[e.length-1]?.id;return t?{...this.options,query:{...tx(this.options.query),after:t}}:null}}class rn extends rt{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.has_more=r.has_more||!1,this.last_id=r.last_id||""}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){let e=this.last_id;return e?{...this.options,query:{...tx(this.options.query),after:e}}:null}}let rs=()=>{if("undefined"==typeof File){let{process:e}=globalThis;throw Error("`File` is not defined as a global, which is required for file uploads."+("string"==typeof e?.versions?.node&&20>parseInt(e.versions.node.split("."))?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function ro(e,t,r){return rs(),new File(e,t??"unknown_file",r)}function rl(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}let ru=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],rc=async(e,t)=>({...e,body:await rh(e.body,t)}),rd=new WeakMap,rh=async(e,t)=>{if(!await function(e){let t="function"==typeof e?e:e.fetch,r=rd.get(t);if(r)return r;let a=(async()=>{try{let e="Response"in t?t.Response:(await t("data:,")).constructor,r=new FormData;if(r.toString()===await new e(r).text())return!1;return!0}catch{return!0}})();return rd.set(t,a),a}(t))throw TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let r=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>rm(r,e,t))),r},rp=e=>e instanceof Blob&&"name"in e,rf=e=>{if("object"==typeof e&&null!==e&&(e instanceof Response||ru(e)||rp(e)))return!0;if(Array.isArray(e))return e.some(rf);if(e&&"object"==typeof e){for(let t in e)if(rf(e[t]))return!0}return!1},rm=async(e,t,r)=>{if(void 0!==r){if(null==r)throw TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof r||"number"==typeof r||"boolean"==typeof r)e.append(t,String(r));else if(r instanceof Response)e.append(t,ro([await r.blob()],rl(r)));else if(ru(r))e.append(t,ro([await new Response(tN(r)).blob()],rl(r)));else if(rp(r))e.append(t,r,rl(r));else if(Array.isArray(r))await Promise.all(r.map(r=>rm(e,t+"[]",r)));else if("object"==typeof r)await Promise.all(Object.entries(r).map(([r,a])=>rm(e,`${t}[${r}]`,a)));else throw TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${r} instead`)}},rg=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function ry(e,t,r){let a,i;if(rs(),null!=(a=e=await e)&&"object"==typeof a&&"string"==typeof a.name&&"number"==typeof a.lastModified&&rg(a))return e instanceof File?e:ro([await e.arrayBuffer()],e.name);if(null!=(i=e)&&"object"==typeof i&&"string"==typeof i.url&&"function"==typeof i.blob){let a=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),ro(await rb(a),t,r)}let n=await rb(e);if(t||(t=rl(e)),!r?.type){let e=n.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(r={...r,type:e})}return ro(n,t,r)}async function rb(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(rg(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else if(ru(e))for await(let r of e)t.push(...await rb(r));else{let t=e?.constructor?.name;throw Error(`Unexpected data type: ${typeof e}${t?`; constructor: ${t}`:""}${function(e){if("object"!=typeof e||null===e)return"";let t=Object.getOwnPropertyNames(e);return`; props: [${t.map(e=>`"${e}"`).join(", ")}]`}(e)}`)}return t}class r_{constructor(e){this._client=e}}function rw(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}let rv=Object.freeze(Object.create(null)),rE=((e=rw)=>function(t,...r){let a;if(1===t.length)return t[0];let i=!1,n=[],s=t.reduce((t,a,s)=>{/[?#]/.test(a)&&(i=!0);let o=r[s],l=(i?encodeURIComponent:e)(""+o);return s!==r.length&&(null==o||"object"==typeof o&&o.toString===Object.getPrototypeOf(Object.getPrototypeOf(o.hasOwnProperty??rv)??rv)?.toString)&&(l=o+"",n.push({start:t.length+a.length,length:l.length,error:`Value of type ${Object.prototype.toString.call(o).slice(8,-1)} is not a valid path parameter`})),t+a+(s===r.length?"":l)},""),o=s.split(/[?#]/,1)[0],l=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;for(;null!==(a=l.exec(o));)n.push({start:a.index,length:a[0].length,error:`Value "${a[0]}" can't be safely passed as a path parameter`});if(n.sort((e,t)=>e.start-t.start),n.length>0){let e=0,t=n.reduce((t,r)=>{let a=" ".repeat(r.start-e),i="^".repeat(r.length);return e=r.start+r.length,t+a+i},"");throw new to(`Path parameters result in path with invalid segments:
${n.map(e=>e.error).join("\n")}
${s}
${t}`)}return s})(rw);class rO extends r_{list(e,t={},r){return this._client.getAPIList(rE`/chat/completions/${e}/messages`,ri,{query:t,...r})}}function rk(e){return void 0!==e&&"function"in e&&void 0!==e.function}function rS(e){return e?.$brand==="auto-parseable-response-format"}function rx(e){return e?.$brand==="auto-parseable-tool"}function r$(e,t){let r=e.choices.map(e=>{var r,a;if("length"===e.finish_reason)throw new tw;if("content_filter"===e.finish_reason)throw new tv;return rA(e.message.tool_calls),{...e,message:{...e.message,...e.message.tool_calls?{tool_calls:e.message.tool_calls?.map(e=>(function(e,t){let r=e.tools?.find(e=>rk(e)&&e.function?.name===t.function.name);return{...t,function:{...t.function,parsed_arguments:rx(r)?r.$parseRaw(t.function.arguments):r?.function.strict?JSON.parse(t.function.arguments):null}}})(t,e))??void 0}:void 0,parsed:e.message.content&&!e.message.refusal?(r=t,a=e.message.content,r.response_format?.type!=="json_schema"?null:r.response_format?.type==="json_schema"?"$parseRaw"in r.response_format?r.response_format.$parseRaw(a):JSON.parse(a):null):null}}});return{...e,choices:r}}function rI(e){return!!rS(e.response_format)||(e.tools?.some(e=>rx(e)||"function"===e.type&&!0===e.function.strict)??!1)}function rA(e){for(let t of e||[])if("function"!==t.type)throw new to(`Currently only \`function\` tool calls are supported; Received \`${t.type}\``)}let rT=e=>e?.role==="assistant",rP=e=>e?.role==="tool";class rj{constructor(){L.add(this),this.controller=new AbortController,M.set(this,void 0),U.set(this,()=>{}),D.set(this,()=>{}),z.set(this,void 0),F.set(this,()=>{}),B.set(this,()=>{}),q.set(this,{}),H.set(this,!1),W.set(this,!1),J.set(this,!1),G.set(this,!1),tr(this,M,new Promise((e,t)=>{tr(this,U,e,"f"),tr(this,D,t,"f")}),"f"),tr(this,z,new Promise((e,t)=>{tr(this,F,e,"f"),tr(this,B,t,"f")}),"f"),ta(this,M,"f").catch(()=>{}),ta(this,z,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},ta(this,L,"m",Z).bind(this))},0)}_connected(){this.ended||(ta(this,U,"f").call(this),this._emit("connect"))}get ended(){return ta(this,H,"f")}get errored(){return ta(this,W,"f")}get aborted(){return ta(this,J,"f")}abort(){this.controller.abort()}on(e,t){return(ta(this,q,"f")[e]||(ta(this,q,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=ta(this,q,"f")[e];if(!r)return this;let a=r.findIndex(e=>e.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(ta(this,q,"f")[e]||(ta(this,q,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{tr(this,G,!0,"f"),"error"!==e&&this.once("error",r),this.once(e,t)})}async done(){tr(this,G,!0,"f"),await ta(this,z,"f")}_emit(e,...t){if(ta(this,H,"f"))return;"end"===e&&(tr(this,H,!0,"f"),ta(this,F,"f").call(this));let r=ta(this,q,"f")[e];if(r&&(ta(this,q,"f")[e]=r.filter(e=>!e.once),r.forEach(({listener:e})=>e(...t))),"abort"===e){let e=t[0];ta(this,G,"f")||r?.length||Promise.reject(e),ta(this,D,"f").call(this,e),ta(this,B,"f").call(this,e),this._emit("end");return}if("error"===e){let e=t[0];ta(this,G,"f")||r?.length||Promise.reject(e),ta(this,D,"f").call(this,e),ta(this,B,"f").call(this,e),this._emit("end")}}_emitFinal(){}}M=new WeakMap,U=new WeakMap,D=new WeakMap,z=new WeakMap,F=new WeakMap,B=new WeakMap,q=new WeakMap,H=new WeakMap,W=new WeakMap,J=new WeakMap,G=new WeakMap,L=new WeakSet,Z=function(e){if(tr(this,W,!0,"f"),e instanceof Error&&"AbortError"===e.name&&(e=new tu),e instanceof tu)return tr(this,J,!0,"f"),this._emit("abort",e);if(e instanceof to)return this._emit("error",e);if(e instanceof Error){let t=new to(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new to(String(e)))};class rN extends rj{constructor(){super(...arguments),V.add(this),this._chatCompletions=[],this.messages=[]}_addChatCompletion(e){this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=e.choices[0]?.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),rP(e)&&e.content)this._emit("functionToolCallResult",e.content);else if(rT(e)&&e.tool_calls)for(let t of e.tool_calls)"function"===t.type&&this._emit("functionToolCall",t.function)}}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new to("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),ta(this,V,"m",Y).call(this)}async finalMessage(){return await this.done(),ta(this,V,"m",K).call(this)}async finalFunctionToolCall(){return await this.done(),ta(this,V,"m",X).call(this)}async finalFunctionToolCallResult(){return await this.done(),ta(this,V,"m",Q).call(this)}async totalUsage(){return await this.done(),ta(this,V,"m",ee).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=ta(this,V,"m",K).call(this);t&&this._emit("finalMessage",t);let r=ta(this,V,"m",Y).call(this);r&&this._emit("finalContent",r);let a=ta(this,V,"m",X).call(this);a&&this._emit("finalFunctionToolCall",a);let i=ta(this,V,"m",Q).call(this);null!=i&&this._emit("finalFunctionToolCallResult",i),this._chatCompletions.some(e=>e.usage)&&this._emit("totalUsage",ta(this,V,"m",ee).call(this))}async _createChatCompletion(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),ta(this,V,"m",et).call(this,t);let i=await e.chat.completions.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(r$(i,t))}async _runChatCompletion(e,t,r){for(let e of t.messages)this._addMessage(e,!1);return await this._createChatCompletion(e,t,r)}async _runTools(e,t,r){let a="tool",{tool_choice:i="auto",stream:n,...s}=t,o="string"!=typeof i&&"function"===i.type&&i?.function?.name,{maxChatCompletions:l=10}=r||{},u=t.tools.map(e=>{if(rx(e)){if(!e.$callback)throw new to("Tool given to `.runTools()` that does not have an associated function");return{type:"function",function:{function:e.$callback,name:e.function.name,description:e.function.description||"",parameters:e.function.parameters,parse:e.$parseRaw,strict:!0}}}return e}),c={};for(let e of u)"function"===e.type&&(c[e.function.name||e.function.function.name]=e.function);let d="tools"in t?u.map(e=>"function"===e.type?{type:"function",function:{name:e.function.name||e.function.function.name,parameters:e.function.parameters,description:e.function.description,strict:e.function.strict}}:e):void 0;for(let e of t.messages)this._addMessage(e,!1);for(let t=0;t<l;++t){let t=await this._createChatCompletion(e,{...s,tool_choice:i,tools:d,messages:[...this.messages]},r),n=t.choices[0]?.message;if(!n)throw new to("missing message in ChatCompletion response");if(!n.tool_calls?.length)break;for(let e of n.tool_calls){let t;if("function"!==e.type)continue;let r=e.id,{name:i,arguments:n}=e.function,s=c[i];if(s){if(o&&o!==i){let e=`Invalid tool_call: ${JSON.stringify(i)}. ${JSON.stringify(o)} requested. Please try again`;this._addMessage({role:a,tool_call_id:r,content:e});continue}}else{let e=`Invalid tool_call: ${JSON.stringify(i)}. Available options are: ${Object.keys(c).map(e=>JSON.stringify(e)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:r,content:e});continue}try{t="function"==typeof s.parse?await s.parse(n):n}catch(t){let e=t instanceof Error?t.message:String(t);this._addMessage({role:a,tool_call_id:r,content:e});continue}let l=await s.function(t,this),u=ta(this,V,"m",er).call(this,l);if(this._addMessage({role:a,tool_call_id:r,content:u}),o)return}}}}V=new WeakSet,Y=function(){return ta(this,V,"m",K).call(this).content??null},K=function(){let e=this.messages.length;for(;e-- >0;){let t=this.messages[e];if(rT(t))return{...t,content:t.content??null,refusal:t.refusal??null}}throw new to("stream ended without producing a ChatCompletionMessage with role=assistant")},X=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(rT(t)&&t?.tool_calls?.length)return t.tool_calls.filter(e=>"function"===e.type).at(-1)?.function}},Q=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(rP(t)&&null!=t.content&&"string"==typeof t.content&&this.messages.some(e=>"assistant"===e.role&&e.tool_calls?.some(e=>"function"===e.type&&e.id===t.tool_call_id)))return t.content}},ee=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},et=function(e){if(null!=e.n&&e.n>1)throw new to("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},er=function(e){return"string"==typeof e?e:void 0===e?"undefined":JSON.stringify(e)};class rR extends rN{static runTools(e,t,r){let a=new rR,i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,i)),a}_addMessage(e,t=!0){super._addMessage(e,t),rT(e)&&e.content&&this._emit("content",e.content)}}let rC=511;class rL extends Error{}class rM extends Error{}let rU=e=>(function(e,t=rC){if("string"!=typeof e)throw TypeError(`expecting str, got ${typeof e}`);if(!e.trim())throw Error(`${e} is empty`);return((e,t)=>{let r=e.length,a=0,i=e=>{throw new rL(`${e} at position ${a}`)},n=e=>{throw new rM(`${e} at position ${a}`)},s=()=>(d(),a>=r&&i("Unexpected end of input"),'"'===e[a])?o():"{"===e[a]?l():"["===e[a]?u():"null"===e.substring(a,a+4)||16&t&&r-a<4&&"null".startsWith(e.substring(a))?(a+=4,null):"true"===e.substring(a,a+4)||32&t&&r-a<4&&"true".startsWith(e.substring(a))?(a+=4,!0):"false"===e.substring(a,a+5)||32&t&&r-a<5&&"false".startsWith(e.substring(a))?(a+=5,!1):"Infinity"===e.substring(a,a+8)||128&t&&r-a<8&&"Infinity".startsWith(e.substring(a))?(a+=8,1/0):"-Infinity"===e.substring(a,a+9)||256&t&&1<r-a&&r-a<9&&"-Infinity".startsWith(e.substring(a))?(a+=9,-1/0):"NaN"===e.substring(a,a+3)||64&t&&r-a<3&&"NaN".startsWith(e.substring(a))?(a+=3,NaN):c(),o=()=>{let s=a,o=!1;for(a++;a<r&&('"'!==e[a]||o&&"\\"===e[a-1]);)o="\\"===e[a]&&!o,a++;if('"'==e.charAt(a))try{return JSON.parse(e.substring(s,++a-Number(o)))}catch(e){n(String(e))}else if(1&t)try{return JSON.parse(e.substring(s,a-Number(o))+'"')}catch(t){return JSON.parse(e.substring(s,e.lastIndexOf("\\"))+'"')}i("Unterminated string literal")},l=()=>{a++,d();let n={};try{for(;"}"!==e[a];){if(d(),a>=r&&8&t)return n;let i=o();d(),a++;try{let e=s();Object.defineProperty(n,i,{value:e,writable:!0,enumerable:!0,configurable:!0})}catch(e){if(8&t)return n;throw e}d(),","===e[a]&&a++}}catch(e){if(8&t)return n;i("Expected '}' at end of object")}return a++,n},u=()=>{a++;let r=[];try{for(;"]"!==e[a];)r.push(s()),d(),","===e[a]&&a++}catch(e){if(4&t)return r;i("Expected ']' at end of array")}return a++,r},c=()=>{if(0===a){"-"===e&&2&t&&i("Not sure what '-' is");try{return JSON.parse(e)}catch(r){if(2&t)try{if("."===e[e.length-1])return JSON.parse(e.substring(0,e.lastIndexOf(".")));return JSON.parse(e.substring(0,e.lastIndexOf("e")))}catch(e){}n(String(r))}}let s=a;for("-"===e[a]&&a++;e[a]&&!",]}".includes(e[a]);)a++;a!=r||2&t||i("Unterminated number literal");try{return JSON.parse(e.substring(s,a))}catch(r){"-"===e.substring(s,a)&&2&t&&i("Not sure what '-' is");try{return JSON.parse(e.substring(s,e.lastIndexOf("e")))}catch(e){n(String(e))}}},d=()=>{for(;a<r&&" \n\r	".includes(e[a]);)a++};return s()})(e.trim(),t)})(e,2^rC);class rD extends rN{constructor(e){super(),ea.add(this),ei.set(this,void 0),en.set(this,void 0),es.set(this,void 0),tr(this,ei,e,"f"),tr(this,en,[],"f")}get currentChatCompletionSnapshot(){return ta(this,es,"f")}static fromReadableStream(e){let t=new rD(null);return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let a=new rD(t);return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,r){super._createChatCompletion;let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),ta(this,ea,"m",eo).call(this);let i=await e.chat.completions.create({...t,stream:!0},{...r,signal:this.controller.signal});for await(let e of(this._connected(),i))ta(this,ea,"m",eu).call(this,e);if(i.controller.signal?.aborted)throw new tu;return this._addChatCompletion(ta(this,ea,"m",eh).call(this))}async _fromReadableStream(e,t){let r,a=t?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),ta(this,ea,"m",eo).call(this),this._connected();let i=t4.fromReadableStream(e,this.controller);for await(let e of i)r&&r!==e.id&&this._addChatCompletion(ta(this,ea,"m",eh).call(this)),ta(this,ea,"m",eu).call(this,e),r=e.id;if(i.controller.signal?.aborted)throw new tu;return this._addChatCompletion(ta(this,ea,"m",eh).call(this))}[(ei=new WeakMap,en=new WeakMap,es=new WeakMap,ea=new WeakSet,eo=function(){this.ended||tr(this,es,void 0,"f")},el=function(e){let t=ta(this,en,"f")[e.index];return t||(t={content_done:!1,refusal_done:!1,logprobs_content_done:!1,logprobs_refusal_done:!1,done_tool_calls:new Set,current_tool_call_index:null},ta(this,en,"f")[e.index]=t),t},eu=function(e){if(this.ended)return;let t=ta(this,ea,"m",ef).call(this,e);for(let r of(this._emit("chunk",e,t),e.choices)){let e=t.choices[r.index];null!=r.delta.content&&e.message?.role==="assistant"&&e.message?.content&&(this._emit("content",r.delta.content,e.message.content),this._emit("content.delta",{delta:r.delta.content,snapshot:e.message.content,parsed:e.message.parsed})),null!=r.delta.refusal&&e.message?.role==="assistant"&&e.message?.refusal&&this._emit("refusal.delta",{delta:r.delta.refusal,snapshot:e.message.refusal}),r.logprobs?.content!=null&&e.message?.role==="assistant"&&this._emit("logprobs.content.delta",{content:r.logprobs?.content,snapshot:e.logprobs?.content??[]}),r.logprobs?.refusal!=null&&e.message?.role==="assistant"&&this._emit("logprobs.refusal.delta",{refusal:r.logprobs?.refusal,snapshot:e.logprobs?.refusal??[]});let a=ta(this,ea,"m",el).call(this,e);for(let t of(e.finish_reason&&(ta(this,ea,"m",ed).call(this,e),null!=a.current_tool_call_index&&ta(this,ea,"m",ec).call(this,e,a.current_tool_call_index)),r.delta.tool_calls??[]))a.current_tool_call_index!==t.index&&(ta(this,ea,"m",ed).call(this,e),null!=a.current_tool_call_index&&ta(this,ea,"m",ec).call(this,e,a.current_tool_call_index)),a.current_tool_call_index=t.index;for(let t of r.delta.tool_calls??[]){let r=e.message.tool_calls?.[t.index];r?.type&&(r?.type==="function"?this._emit("tool_calls.function.arguments.delta",{name:r.function?.name,index:t.index,arguments:r.function.arguments,parsed_arguments:r.function.parsed_arguments,arguments_delta:t.function?.arguments??""}):r?.type)}}},ec=function(e,t){if(ta(this,ea,"m",el).call(this,e).done_tool_calls.has(t))return;let r=e.message.tool_calls?.[t];if(!r)throw Error("no tool call snapshot");if(!r.type)throw Error("tool call snapshot missing `type`");if("function"===r.type){let e=ta(this,ei,"f")?.tools?.find(e=>rk(e)&&e.function.name===r.function.name);this._emit("tool_calls.function.arguments.done",{name:r.function.name,index:t,arguments:r.function.arguments,parsed_arguments:rx(e)?e.$parseRaw(r.function.arguments):e?.function.strict?JSON.parse(r.function.arguments):null})}else r.type},ed=function(e){let t=ta(this,ea,"m",el).call(this,e);if(e.message.content&&!t.content_done){t.content_done=!0;let r=ta(this,ea,"m",ep).call(this);this._emit("content.done",{content:e.message.content,parsed:r?r.$parseRaw(e.message.content):null})}e.message.refusal&&!t.refusal_done&&(t.refusal_done=!0,this._emit("refusal.done",{refusal:e.message.refusal})),e.logprobs?.content&&!t.logprobs_content_done&&(t.logprobs_content_done=!0,this._emit("logprobs.content.done",{content:e.logprobs.content})),e.logprobs?.refusal&&!t.logprobs_refusal_done&&(t.logprobs_refusal_done=!0,this._emit("logprobs.refusal.done",{refusal:e.logprobs.refusal}))},eh=function(){if(this.ended)throw new to("stream has ended, this shouldn't happen");let e=ta(this,es,"f");if(!e)throw new to("request ended without sending any chunks");return tr(this,es,void 0,"f"),tr(this,en,[],"f"),function(e,t){var r;let{id:a,choices:i,created:n,model:s,system_fingerprint:o,...l}=e;return r={...l,id:a,choices:i.map(({message:t,finish_reason:r,index:a,logprobs:i,...n})=>{if(!r)throw new to(`missing finish_reason for choice ${a}`);let{content:s=null,function_call:o,tool_calls:l,...u}=t,c=t.role;if(!c)throw new to(`missing role for choice ${a}`);if(o){let{arguments:e,name:l}=o;if(null==e)throw new to(`missing function_call.arguments for choice ${a}`);if(!l)throw new to(`missing function_call.name for choice ${a}`);return{...n,message:{content:s,function_call:{arguments:e,name:l},role:c,refusal:t.refusal??null},finish_reason:r,index:a,logprobs:i}}return l?{...n,index:a,finish_reason:r,logprobs:i,message:{...u,role:c,content:s,refusal:t.refusal??null,tool_calls:l.map((t,r)=>{let{function:i,type:n,id:s,...o}=t,{arguments:l,name:u,...c}=i||{};if(null==s)throw new to(`missing choices[${a}].tool_calls[${r}].id
${rz(e)}`);if(null==n)throw new to(`missing choices[${a}].tool_calls[${r}].type
${rz(e)}`);if(null==u)throw new to(`missing choices[${a}].tool_calls[${r}].function.name
${rz(e)}`);if(null==l)throw new to(`missing choices[${a}].tool_calls[${r}].function.arguments
${rz(e)}`);return{...o,id:s,type:n,function:{...c,name:u,arguments:l}}})}}:{...n,message:{...u,content:s,role:c,refusal:t.refusal??null},finish_reason:r,index:a,logprobs:i}}),created:n,model:s,object:"chat.completion",...o?{system_fingerprint:o}:{}},t&&rI(t)?r$(r,t):{...r,choices:r.choices.map(e=>(rA(e.message.tool_calls),{...e,message:{...e.message,parsed:null,...e.message.tool_calls?{tool_calls:e.message.tool_calls}:void 0}}))}}(e,ta(this,ei,"f"))},ep=function(){let e=ta(this,ei,"f")?.response_format;return rS(e)?e:null},ef=function(e){var t,r,a,i;let n=ta(this,es,"f"),{choices:s,...o}=e;for(let{delta:s,finish_reason:l,index:u,logprobs:c=null,...d}of(n?Object.assign(n,o):n=tr(this,es,{...o,choices:[]},"f"),e.choices)){let e=n.choices[u];if(e||(e=n.choices[u]={finish_reason:l,index:u,message:{},logprobs:c,...d}),c)if(e.logprobs){let{content:a,refusal:i,...n}=c;Object.assign(e.logprobs,n),a&&((t=e.logprobs).content??(t.content=[]),e.logprobs.content.push(...a)),i&&((r=e.logprobs).refusal??(r.refusal=[]),e.logprobs.refusal.push(...i))}else e.logprobs=Object.assign({},c);if(l&&(e.finish_reason=l,ta(this,ei,"f")&&rI(ta(this,ei,"f")))){if("length"===l)throw new tw;if("content_filter"===l)throw new tv}if(Object.assign(e,d),!s)continue;let{content:o,refusal:h,function_call:p,role:f,tool_calls:m,...g}=s;if(Object.assign(e.message,g),h&&(e.message.refusal=(e.message.refusal||"")+h),f&&(e.message.role=f),p&&(e.message.function_call?(p.name&&(e.message.function_call.name=p.name),p.arguments&&((a=e.message.function_call).arguments??(a.arguments=""),e.message.function_call.arguments+=p.arguments)):e.message.function_call=p),o&&(e.message.content=(e.message.content||"")+o,!e.message.refusal&&ta(this,ea,"m",ep).call(this)&&(e.message.parsed=rU(e.message.content))),m)for(let{index:t,id:r,type:a,function:n,...s}of(e.message.tool_calls||(e.message.tool_calls=[]),m)){let o=(i=e.message.tool_calls)[t]??(i[t]={});Object.assign(o,s),r&&(o.id=r),a&&(o.type=a),n&&(o.function??(o.function={name:n.name??"",arguments:""})),n?.name&&(o.function.name=n.name),n?.arguments&&(o.function.arguments+=n.arguments,function(e,t){if(!e||!("tools"in e)||!e.tools)return!1;let r=e.tools?.find(e=>rk(e)&&e.function?.name===t.function.name);return rk(r)&&(rx(r)||r?.function.strict||!1)}(ta(this,ei,"f"),o)&&(o.function.parsed_arguments=rU(o.function.arguments)))}}return n},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",r=>{let a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{for(let e of(r=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),this.on("error",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new t4(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function rz(e){return JSON.stringify(e)}class rF extends rD{static fromReadableStream(e){let t=new rF(null);return t._run(()=>t._fromReadableStream(e)),t}static runTools(e,t,r){let a=new rF(t),i={...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,i)),a}}class rB extends r_{constructor(){super(...arguments),this.messages=new rO(this._client)}create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}retrieve(e,t){return this._client.get(rE`/chat/completions/${e}`,t)}update(e,t,r){return this._client.post(rE`/chat/completions/${e}`,{body:t,...r})}list(e={},t){return this._client.getAPIList("/chat/completions",ri,{query:e,...t})}delete(e,t){return this._client.delete(rE`/chat/completions/${e}`,t)}parse(e,t){for(let t of e.tools??[]){if("function"!==t.type)throw new to(`Currently only \`function\` tool types support auto-parsing; Received \`${t.type}\``);if(!0!==t.function.strict)throw new to(`The \`${t.function.name}\` tool is not marked with \`strict: true\`. Only strict function tools can be auto-parsed`)}return this._client.chat.completions.create(e,{...t,headers:{...t?.headers,"X-Stainless-Helper-Method":"chat.completions.parse"}})._thenUnwrap(t=>r$(t,e))}runTools(e,t){return e.stream?rF.runTools(this._client,e,t):rR.runTools(this._client,e,t)}stream(e,t){return rD.createChatCompletion(this._client,e,t)}}rB.Messages=rO;class rq extends r_{constructor(){super(...arguments),this.completions=new rB(this._client)}}rq.Completions=rB;let rH=Symbol("brand.privateNullableHeaders"),rW=e=>{let t=new Headers,r=new Set;for(let a of e){let e=new Set;for(let[i,n]of function*(e){let t;if(!e)return;if(rH in e){let{values:t,nulls:r}=e;for(let e of(yield*t.entries(),r))yield[e,null];return}let r=!1;for(let a of(e instanceof Headers?t=e.entries():tS(e)?t=e:(r=!0,t=Object.entries(e??{})),t)){let e=a[0];if("string"!=typeof e)throw TypeError("expected header name to be a string");let t=tS(a[1])?a[1]:[a[1]],i=!1;for(let a of t)void 0!==a&&(r&&!i&&(i=!0,yield[e,null]),yield[e,a])}}(a)){let a=i.toLowerCase();e.has(a)||(t.delete(i),e.add(a)),null===n?(t.delete(i),r.add(a)):(t.append(i,n),r.delete(a))}}return{[rH]:!0,values:t,nulls:r}};class rJ extends r_{create(e,t){return this._client.post("/audio/speech",{body:e,...t,headers:rW([{Accept:"application/octet-stream"},t?.headers]),__binaryResponse:!0})}}class rG extends r_{create(e,t){return this._client.post("/audio/transcriptions",rc({body:e,...t,stream:e.stream??!1,__metadata:{model:e.model}},this._client))}}class rZ extends r_{create(e,t){return this._client.post("/audio/translations",rc({body:e,...t,__metadata:{model:e.model}},this._client))}}class rV extends r_{constructor(){super(...arguments),this.transcriptions=new rG(this._client),this.translations=new rZ(this._client),this.speech=new rJ(this._client)}}rV.Transcriptions=rG,rV.Translations=rZ,rV.Speech=rJ;class rY extends r_{create(e,t){return this._client.post("/batches",{body:e,...t})}retrieve(e,t){return this._client.get(rE`/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/batches",ri,{query:e,...t})}cancel(e,t){return this._client.post(rE`/batches/${e}/cancel`,t)}}class rK extends r_{create(e,t){return this._client.post("/assistants",{body:e,...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(rE`/assistants/${e}`,{...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,r){return this._client.post(rE`/assistants/${e}`,{body:t,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e={},t){return this._client.getAPIList("/assistants",ri,{query:e,...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(rE`/assistants/${e}`,{...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class rX extends r_{create(e,t){return this._client.post("/realtime/sessions",{body:e,...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class rQ extends r_{create(e,t){return this._client.post("/realtime/transcription_sessions",{body:e,...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}}class r0 extends r_{constructor(){super(...arguments),this.sessions=new rX(this._client),this.transcriptionSessions=new rQ(this._client)}}r0.Sessions=rX,r0.TranscriptionSessions=rQ;class r1 extends r_{create(e,t,r){return this._client.post(rE`/threads/${e}/messages`,{body:t,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}retrieve(e,t,r){let{thread_id:a}=t;return this._client.get(rE`/threads/${a}/messages/${e}`,{...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}update(e,t,r){let{thread_id:a,...i}=t;return this._client.post(rE`/threads/${a}/messages/${e}`,{body:i,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e,t={},r){return this._client.getAPIList(rE`/threads/${e}/messages`,ri,{query:t,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}delete(e,t,r){let{thread_id:a}=t;return this._client.delete(rE`/threads/${a}/messages/${e}`,{...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}}class r2 extends r_{retrieve(e,t,r){let{thread_id:a,run_id:i,...n}=t;return this._client.get(rE`/threads/${a}/runs/${i}/steps/${e}`,{query:n,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e,t,r){let{thread_id:a,...i}=t;return this._client.getAPIList(rE`/threads/${a}/runs/${e}/steps`,ri,{query:i,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}}let r5=e=>void 0!==globalThis.process?globalThis.process.env?.[e]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(e)?.trim():void 0;class r4 extends rj{constructor(){super(...arguments),em.add(this),ey.set(this,[]),eb.set(this,{}),e_.set(this,{}),ew.set(this,void 0),ev.set(this,void 0),eE.set(this,void 0),eO.set(this,void 0),ek.set(this,void 0),eS.set(this,void 0),ex.set(this,void 0),e$.set(this,void 0),eI.set(this,void 0)}[(ey=new WeakMap,eb=new WeakMap,e_=new WeakMap,ew=new WeakMap,ev=new WeakMap,eE=new WeakMap,eO=new WeakMap,ek=new WeakMap,eS=new WeakMap,ex=new WeakMap,e$=new WeakMap,eI=new WeakMap,em=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",r=>{let a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{for(let e of(r=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),this.on("error",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}static fromReadableStream(e){let t=new eg;return t._run(()=>t._fromReadableStream(e)),t}async _fromReadableStream(e,t){let r=t?.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),this._connected();let a=t4.fromReadableStream(e,this.controller);for await(let e of a)ta(this,em,"m",eA).call(this,e);if(a.controller.signal?.aborted)throw new tu;return this._addRun(ta(this,em,"m",eT).call(this))}toReadableStream(){return new t4(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,a){let i=new eg;return i._run(()=>i._runToolAssistantStream(e,t,r,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,a){let i=a?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let n={...r,stream:!0},s=await e.submitToolOutputs(t,n,{...a,signal:this.controller.signal});for await(let e of(this._connected(),s))ta(this,em,"m",eA).call(this,e);if(s.controller.signal?.aborted)throw new tu;return this._addRun(ta(this,em,"m",eT).call(this))}static createThreadAssistantStream(e,t,r){let a=new eg;return a._run(()=>a._threadAssistantStream(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}static createAssistantStream(e,t,r,a){let i=new eg;return i._run(()=>i._runAssistantStream(e,t,r,{...a,headers:{...a?.headers,"X-Stainless-Helper-Method":"stream"}})),i}currentEvent(){return ta(this,ex,"f")}currentRun(){return ta(this,e$,"f")}currentMessageSnapshot(){return ta(this,ew,"f")}currentRunStepSnapshot(){return ta(this,eI,"f")}async finalRunSteps(){return await this.done(),Object.values(ta(this,eb,"f"))}async finalMessages(){return await this.done(),Object.values(ta(this,e_,"f"))}async finalRun(){if(await this.done(),!ta(this,ev,"f"))throw Error("Final run was not received.");return ta(this,ev,"f")}async _createThreadAssistantStream(e,t,r){let a=r?.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let i={...t,stream:!0},n=await e.createAndRun(i,{...r,signal:this.controller.signal});for await(let e of(this._connected(),n))ta(this,em,"m",eA).call(this,e);if(n.controller.signal?.aborted)throw new tu;return this._addRun(ta(this,em,"m",eT).call(this))}async _createAssistantStream(e,t,r,a){let i=a?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let n={...r,stream:!0},s=await e.create(t,n,{...a,signal:this.controller.signal});for await(let e of(this._connected(),s))ta(this,em,"m",eA).call(this,e);if(s.controller.signal?.aborted)throw new tu;return this._addRun(ta(this,em,"m",eT).call(this))}static accumulateDelta(e,t){for(let[r,a]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=a;continue}let t=e[r];if(null==t||"index"===r||"type"===r){e[r]=a;continue}if("string"==typeof t&&"string"==typeof a)t+=a;else if("number"==typeof t&&"number"==typeof a)t+=a;else if(t$(t)&&t$(a))t=this.accumulateDelta(t,a);else if(Array.isArray(t)&&Array.isArray(a)){if(t.every(e=>"string"==typeof e||"number"==typeof e)){t.push(...a);continue}for(let e of a){if(!t$(e))throw Error(`Expected array delta entry to be an object but got: ${e}`);let r=e.index;if(null==r)throw console.error(e),Error("Expected array delta entry to have an `index` property");if("number"!=typeof r)throw Error(`Expected array delta entry \`index\` property to be a number but got ${r}`);let a=t[r];null==a?t.push(e):t[r]=this.accumulateDelta(a,e)}continue}else throw Error(`Unhandled record type: ${r}, deltaValue: ${a}, accValue: ${t}`);e[r]=t}return e}_addRun(e){return e}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,a){return await this._createAssistantStream(t,e,r,a)}async _runToolAssistantStream(e,t,r,a){return await this._createToolAssistantStream(t,e,r,a)}}eg=r4,eA=function(e){if(!this.ended)switch(tr(this,ex,e,"f"),ta(this,em,"m",eN).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.incomplete":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":ta(this,em,"m",eM).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":ta(this,em,"m",ej).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":ta(this,em,"m",eP).call(this,e);break;case"error":throw Error("Encountered an error event in event processing - errors should be processed earlier")}},eT=function(){if(this.ended)throw new to("stream has ended, this shouldn't happen");if(!ta(this,ev,"f"))throw Error("Final run has not been received");return ta(this,ev,"f")},eP=function(e){let[t,r]=ta(this,em,"m",eC).call(this,e,ta(this,ew,"f"));for(let e of(tr(this,ew,t,"f"),ta(this,e_,"f")[t.id]=t,r)){let r=t.content[e.index];r?.type=="text"&&this._emit("textCreated",r.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let r of e.data.delta.content){if("text"==r.type&&r.text){let e=r.text,a=t.content[r.index];if(a&&"text"==a.type)this._emit("textDelta",e,a.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(r.index!=ta(this,eE,"f")){if(ta(this,eO,"f"))switch(ta(this,eO,"f").type){case"text":this._emit("textDone",ta(this,eO,"f").text,ta(this,ew,"f"));break;case"image_file":this._emit("imageFileDone",ta(this,eO,"f").image_file,ta(this,ew,"f"))}tr(this,eE,r.index,"f")}tr(this,eO,t.content[r.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(void 0!==ta(this,eE,"f")){let t=e.data.content[ta(this,eE,"f")];if(t)switch(t.type){case"image_file":this._emit("imageFileDone",t.image_file,ta(this,ew,"f"));break;case"text":this._emit("textDone",t.text,ta(this,ew,"f"))}}ta(this,ew,"f")&&this._emit("messageDone",e.data),tr(this,ew,void 0,"f")}},ej=function(e){let t=ta(this,em,"m",eR).call(this,e);switch(tr(this,eI,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&"tool_calls"==r.step_details.type&&r.step_details.tool_calls&&"tool_calls"==t.step_details.type)for(let e of r.step_details.tool_calls)e.index==ta(this,ek,"f")?this._emit("toolCallDelta",e,t.step_details.tool_calls[e.index]):(ta(this,eS,"f")&&this._emit("toolCallDone",ta(this,eS,"f")),tr(this,ek,e.index,"f"),tr(this,eS,t.step_details.tool_calls[e.index],"f"),ta(this,eS,"f")&&this._emit("toolCallCreated",ta(this,eS,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":tr(this,eI,void 0,"f"),"tool_calls"==e.data.step_details.type&&ta(this,eS,"f")&&(this._emit("toolCallDone",ta(this,eS,"f")),tr(this,eS,void 0,"f")),this._emit("runStepDone",e.data,t)}},eN=function(e){ta(this,ey,"f").push(e),this._emit("event",e)},eR=function(e){switch(e.event){case"thread.run.step.created":return ta(this,eb,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=ta(this,eb,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let a=eg.accumulateDelta(t,r.delta);ta(this,eb,"f")[e.data.id]=a}return ta(this,eb,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":ta(this,eb,"f")[e.data.id]=e.data}if(ta(this,eb,"f")[e.data.id])return ta(this,eb,"f")[e.data.id];throw Error("No snapshot available")},eC=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let a=e.data;if(a.delta.content)for(let e of a.delta.content)if(e.index in t.content){let r=t.content[e.index];t.content[e.index]=ta(this,em,"m",eL).call(this,e,r)}else t.content[e.index]=e,r.push(e);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},eL=function(e,t){return eg.accumulateDelta(t,e)},eM=function(e){switch(tr(this,e$,e.data,"f"),e.event){case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":case"thread.run.incomplete":tr(this,ev,e.data,"f"),ta(this,eS,"f")&&(this._emit("toolCallDone",ta(this,eS,"f")),tr(this,eS,void 0,"f"))}};class r9 extends r_{constructor(){super(...arguments),this.steps=new r2(this._client)}create(e,t,r){let{include:a,...i}=t;return this._client.post(rE`/threads/${e}/runs`,{query:{include:a},body:i,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers]),stream:t.stream??!1})}retrieve(e,t,r){let{thread_id:a}=t;return this._client.get(rE`/threads/${a}/runs/${e}`,{...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}update(e,t,r){let{thread_id:a,...i}=t;return this._client.post(rE`/threads/${a}/runs/${e}`,{body:i,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e,t={},r){return this._client.getAPIList(rE`/threads/${e}/runs`,ri,{query:t,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}cancel(e,t,r){let{thread_id:a}=t;return this._client.post(rE`/threads/${a}/runs/${e}/cancel`,{...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(a.id,{thread_id:e},r)}createAndStream(e,t,r){return r4.createAssistantStream(e,this._client.beta.threads.runs,t,r)}async poll(e,t,r){let a=rW([r?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":r?.pollIntervalMs?.toString()??void 0}]);for(;;){let{data:i,response:n}=await this.retrieve(e,t,{...r,headers:{...r?.headers,...a}}).withResponse();switch(i.status){case"queued":case"in_progress":case"cancelling":let s=5e3;if(r?.pollIntervalMs)s=r.pollIntervalMs;else{let e=n.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(s=t)}}await tI(s);break;case"requires_action":case"incomplete":case"cancelled":case"completed":case"failed":case"expired":return i}}}stream(e,t,r){return r4.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r){let{thread_id:a,...i}=t;return this._client.post(rE`/threads/${a}/runs/${e}/submit_tool_outputs`,{body:i,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers]),stream:t.stream??!1})}async submitToolOutputsAndPoll(e,t,r){let a=await this.submitToolOutputs(e,t,r);return await this.poll(a.id,t,r)}submitToolOutputsStream(e,t,r){return r4.createToolAssistantStream(e,this._client.beta.threads.runs,t,r)}}r9.Steps=r2;class r3 extends r_{constructor(){super(...arguments),this.runs=new r9(this._client),this.messages=new r1(this._client)}create(e={},t){return this._client.post("/threads",{body:e,...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(rE`/threads/${e}`,{...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,r){return this._client.post(rE`/threads/${e}`,{body:t,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}delete(e,t){return this._client.delete(rE`/threads/${e}`,{...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers]),stream:e.stream??!1})}async createAndRunPoll(e,t){let r=await this.createAndRun(e,t);return await this.runs.poll(r.id,{thread_id:r.thread_id},t)}createAndRunStream(e,t){return r4.createThreadAssistantStream(e,this._client.beta.threads,t)}}r3.Runs=r9,r3.Messages=r1;class r6 extends r_{constructor(){super(...arguments),this.realtime=new r0(this._client),this.assistants=new rK(this._client),this.threads=new r3(this._client)}}r6.Realtime=r0,r6.Assistants=rK,r6.Threads=r3;class r8 extends r_{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}class r7 extends r_{retrieve(e,t,r){let{container_id:a}=t;return this._client.get(rE`/containers/${a}/files/${e}/content`,{...r,headers:rW([{Accept:"application/binary"},r?.headers]),__binaryResponse:!0})}}class ae extends r_{constructor(){super(...arguments),this.content=new r7(this._client)}create(e,t,r){return this._client.post(rE`/containers/${e}/files`,rc({body:t,...r},this._client))}retrieve(e,t,r){let{container_id:a}=t;return this._client.get(rE`/containers/${a}/files/${e}`,r)}list(e,t={},r){return this._client.getAPIList(rE`/containers/${e}/files`,ri,{query:t,...r})}delete(e,t,r){let{container_id:a}=t;return this._client.delete(rE`/containers/${a}/files/${e}`,{...r,headers:rW([{Accept:"*/*"},r?.headers])})}}ae.Content=r7;class at extends r_{constructor(){super(...arguments),this.files=new ae(this._client)}create(e,t){return this._client.post("/containers",{body:e,...t})}retrieve(e,t){return this._client.get(rE`/containers/${e}`,t)}list(e={},t){return this._client.getAPIList("/containers",ri,{query:e,...t})}delete(e,t){return this._client.delete(rE`/containers/${e}`,{...t,headers:rW([{Accept:"*/*"},t?.headers])})}}at.Files=ae;class ar extends r_{create(e,t,r){let{include:a,...i}=t;return this._client.post(rE`/conversations/${e}/items`,{query:{include:a},body:i,...r})}retrieve(e,t,r){let{conversation_id:a,...i}=t;return this._client.get(rE`/conversations/${a}/items/${e}`,{query:i,...r})}list(e,t={},r){return this._client.getAPIList(rE`/conversations/${e}/items`,rn,{query:t,...r})}delete(e,t,r){let{conversation_id:a}=t;return this._client.delete(rE`/conversations/${a}/items/${e}`,r)}}class aa extends r_{constructor(){super(...arguments),this.items=new ar(this._client)}create(e,t){return this._client.post("/conversations",{body:e,...t})}retrieve(e,t){return this._client.get(rE`/conversations/${e}`,t)}update(e,t,r){return this._client.post(rE`/conversations/${e}`,{body:t,...r})}delete(e,t){return this._client.delete(rE`/conversations/${e}`,t)}}aa.Items=ar;class ai extends r_{create(e,t){let r=!!e.encoding_format,a=r?e.encoding_format:"base64";r&&t2(this._client).debug("embeddings/user defined encoding_format:",e.encoding_format);let i=this._client.post("/embeddings",{body:{...e,encoding_format:a},...t});return r?i:(t2(this._client).debug("embeddings/decoding base64 embeddings from base64"),i._thenUnwrap(e=>(e&&e.data&&e.data.forEach(e=>{let t=e.embedding;e.embedding=(e=>{if("undefined"!=typeof Buffer){let t=Buffer.from(e,"base64");return Array.from(new Float32Array(t.buffer,t.byteOffset,t.length/Float32Array.BYTES_PER_ELEMENT))}{let t=atob(e),r=t.length,a=new Uint8Array(r);for(let e=0;e<r;e++)a[e]=t.charCodeAt(e);return Array.from(new Float32Array(a.buffer))}})(t)}),e)))}}class an extends r_{retrieve(e,t,r){let{eval_id:a,run_id:i}=t;return this._client.get(rE`/evals/${a}/runs/${i}/output_items/${e}`,r)}list(e,t,r){let{eval_id:a,...i}=t;return this._client.getAPIList(rE`/evals/${a}/runs/${e}/output_items`,ri,{query:i,...r})}}class as extends r_{constructor(){super(...arguments),this.outputItems=new an(this._client)}create(e,t,r){return this._client.post(rE`/evals/${e}/runs`,{body:t,...r})}retrieve(e,t,r){let{eval_id:a}=t;return this._client.get(rE`/evals/${a}/runs/${e}`,r)}list(e,t={},r){return this._client.getAPIList(rE`/evals/${e}/runs`,ri,{query:t,...r})}delete(e,t,r){let{eval_id:a}=t;return this._client.delete(rE`/evals/${a}/runs/${e}`,r)}cancel(e,t,r){let{eval_id:a}=t;return this._client.post(rE`/evals/${a}/runs/${e}`,r)}}as.OutputItems=an;class ao extends r_{constructor(){super(...arguments),this.runs=new as(this._client)}create(e,t){return this._client.post("/evals",{body:e,...t})}retrieve(e,t){return this._client.get(rE`/evals/${e}`,t)}update(e,t,r){return this._client.post(rE`/evals/${e}`,{body:t,...r})}list(e={},t){return this._client.getAPIList("/evals",ri,{query:e,...t})}delete(e,t){return this._client.delete(rE`/evals/${e}`,t)}}ao.Runs=as;class al extends r_{create(e,t){return this._client.post("/files",rc({body:e,...t},this._client))}retrieve(e,t){return this._client.get(rE`/files/${e}`,t)}list(e={},t){return this._client.getAPIList("/files",ri,{query:e,...t})}delete(e,t){return this._client.delete(rE`/files/${e}`,t)}content(e,t){return this._client.get(rE`/files/${e}/content`,{...t,headers:rW([{Accept:"application/binary"},t?.headers]),__binaryResponse:!0})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=18e5}={}){let a=new Set(["processed","error","deleted"]),i=Date.now(),n=await this.retrieve(e);for(;!n.status||!a.has(n.status);)if(await tI(t),n=await this.retrieve(e),Date.now()-i>r)throw new td({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return n}}class au extends r_{}class ac extends r_{run(e,t){return this._client.post("/fine_tuning/alpha/graders/run",{body:e,...t})}validate(e,t){return this._client.post("/fine_tuning/alpha/graders/validate",{body:e,...t})}}class ad extends r_{constructor(){super(...arguments),this.graders=new ac(this._client)}}ad.Graders=ac;class ah extends r_{create(e,t,r){return this._client.getAPIList(rE`/fine_tuning/checkpoints/${e}/permissions`,ra,{body:t,method:"post",...r})}retrieve(e,t={},r){return this._client.get(rE`/fine_tuning/checkpoints/${e}/permissions`,{query:t,...r})}delete(e,t,r){let{fine_tuned_model_checkpoint:a}=t;return this._client.delete(rE`/fine_tuning/checkpoints/${a}/permissions/${e}`,r)}}class ap extends r_{constructor(){super(...arguments),this.permissions=new ah(this._client)}}ap.Permissions=ah;class af extends r_{list(e,t={},r){return this._client.getAPIList(rE`/fine_tuning/jobs/${e}/checkpoints`,ri,{query:t,...r})}}class am extends r_{constructor(){super(...arguments),this.checkpoints=new af(this._client)}create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(rE`/fine_tuning/jobs/${e}`,t)}list(e={},t){return this._client.getAPIList("/fine_tuning/jobs",ri,{query:e,...t})}cancel(e,t){return this._client.post(rE`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return this._client.getAPIList(rE`/fine_tuning/jobs/${e}/events`,ri,{query:t,...r})}pause(e,t){return this._client.post(rE`/fine_tuning/jobs/${e}/pause`,t)}resume(e,t){return this._client.post(rE`/fine_tuning/jobs/${e}/resume`,t)}}am.Checkpoints=af;class ag extends r_{constructor(){super(...arguments),this.methods=new au(this._client),this.jobs=new am(this._client),this.checkpoints=new ap(this._client),this.alpha=new ad(this._client)}}ag.Methods=au,ag.Jobs=am,ag.Checkpoints=ap,ag.Alpha=ad;class ay extends r_{}class ab extends r_{constructor(){super(...arguments),this.graderModels=new ay(this._client)}}ab.GraderModels=ay;class a_ extends r_{createVariation(e,t){return this._client.post("/images/variations",rc({body:e,...t},this._client))}edit(e,t){return this._client.post("/images/edits",rc({body:e,...t,stream:e.stream??!1},this._client))}generate(e,t){return this._client.post("/images/generations",{body:e,...t,stream:e.stream??!1})}}class aw extends r_{retrieve(e,t){return this._client.get(rE`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",ra,e)}delete(e,t){return this._client.delete(rE`/models/${e}`,t)}}class av extends r_{create(e,t){return this._client.post("/moderations",{body:e,...t})}}function aE(e,t){let r=e.output.map(e=>{if("function_call"===e.type)return{...e,parsed_arguments:function(e,t){var r,a;let i=(r=e.tools??[],a=t.name,r.find(e=>"function"===e.type&&e.name===a));return{...t,...t,parsed_arguments:i?.$brand==="auto-parseable-tool"?i.$parseRaw(t.arguments):i?.strict?JSON.parse(t.arguments):null}}(t,e)};if("message"===e.type){let r=e.content.map(e=>{var r,a;return"output_text"===e.type?{...e,parsed:(r=t,a=e.text,r.text?.format?.type!=="json_schema"?null:"$parseRaw"in r.text?.format?(r.text?.format).$parseRaw(a):JSON.parse(a))}:e});return{...e,content:r}}return e}),a=Object.assign({},e,{output:r});return Object.getOwnPropertyDescriptor(e,"output_text")||aO(a),Object.defineProperty(a,"output_parsed",{enumerable:!0,get(){for(let e of a.output)if("message"===e.type){for(let t of e.content)if("output_text"===t.type&&null!==t.parsed)return t.parsed}return null}}),a}function aO(e){let t=[];for(let r of e.output)if("message"===r.type)for(let e of r.content)"output_text"===e.type&&t.push(e.text);e.output_text=t.join("")}class ak extends rj{constructor(e){super(),eU.add(this),eD.set(this,void 0),ez.set(this,void 0),eF.set(this,void 0),tr(this,eD,e,"f")}static createResponse(e,t,r){let a=new ak(t);return a._run(()=>a._createOrRetrieveResponse(e,t,{...r,headers:{...r?.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createOrRetrieveResponse(e,t,r){let a,i=r?.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort())),ta(this,eU,"m",eB).call(this);let n=null;for await(let i of("response_id"in t?(a=await e.responses.retrieve(t.response_id,{stream:!0},{...r,signal:this.controller.signal,stream:!0}),n=t.starting_after??null):a=await e.responses.create({...t,stream:!0},{...r,signal:this.controller.signal}),this._connected(),a))ta(this,eU,"m",eq).call(this,i,n);if(a.controller.signal?.aborted)throw new tu;return ta(this,eU,"m",eH).call(this)}[(eD=new WeakMap,ez=new WeakMap,eF=new WeakMap,eU=new WeakSet,eB=function(){this.ended||tr(this,ez,void 0,"f")},eq=function(e,t){if(this.ended)return;let r=(e,r)=>{(null==t||r.sequence_number>t)&&this._emit(e,r)},a=ta(this,eU,"m",eW).call(this,e);switch(r("event",e),e.type){case"response.output_text.delta":{let t=a.output[e.output_index];if(!t)throw new to(`missing output at index ${e.output_index}`);if("message"===t.type){let a=t.content[e.content_index];if(!a)throw new to(`missing content at index ${e.content_index}`);if("output_text"!==a.type)throw new to(`expected content to be 'output_text', got ${a.type}`);r("response.output_text.delta",{...e,snapshot:a.text})}break}case"response.function_call_arguments.delta":{let t=a.output[e.output_index];if(!t)throw new to(`missing output at index ${e.output_index}`);"function_call"===t.type&&r("response.function_call_arguments.delta",{...e,snapshot:t.arguments});break}default:r(e.type,e)}},eH=function(){if(this.ended)throw new to("stream has ended, this shouldn't happen");let e=ta(this,ez,"f");if(!e)throw new to("request ended without sending any events");tr(this,ez,void 0,"f");let t=function(e,t){var r;return t&&(r=t,rS(r.text?.format))?aE(e,t):{...e,output_parsed:null,output:e.output.map(e=>"function_call"===e.type?{...e,parsed_arguments:null}:"message"===e.type?{...e,content:e.content.map(e=>({...e,parsed:null}))}:e)}}(e,ta(this,eD,"f"));return tr(this,eF,t,"f"),t},eW=function(e){let t=ta(this,ez,"f");if(!t){if("response.created"!==e.type)throw new to(`When snapshot hasn't been set yet, expected 'response.created' event, got ${e.type}`);return tr(this,ez,e.response,"f")}switch(e.type){case"response.output_item.added":t.output.push(e.item);break;case"response.content_part.added":{let r=t.output[e.output_index];if(!r)throw new to(`missing output at index ${e.output_index}`);"message"===r.type&&r.content.push(e.part);break}case"response.output_text.delta":{let r=t.output[e.output_index];if(!r)throw new to(`missing output at index ${e.output_index}`);if("message"===r.type){let t=r.content[e.content_index];if(!t)throw new to(`missing content at index ${e.content_index}`);if("output_text"!==t.type)throw new to(`expected content to be 'output_text', got ${t.type}`);t.text+=e.delta}break}case"response.function_call_arguments.delta":{let r=t.output[e.output_index];if(!r)throw new to(`missing output at index ${e.output_index}`);"function_call"===r.type&&(r.arguments+=e.delta);break}case"response.completed":tr(this,ez,e.response,"f")}return t},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",r=>{let a=t.shift();a?a.resolve(r):e.push(r)}),this.on("end",()=>{for(let e of(r=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),this.on("error",e=>{for(let a of(r=!0,t))a.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((e,r)=>t.push({resolve:e,reject:r})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}async finalResponse(){await this.done();let e=ta(this,eF,"f");if(!e)throw new to("stream ended without producing a ChatCompletion");return e}}class aS extends r_{list(e,t={},r){return this._client.getAPIList(rE`/responses/${e}/input_items`,ri,{query:t,...r})}}class ax extends r_{constructor(){super(...arguments),this.inputItems=new aS(this._client)}create(e,t){return this._client.post("/responses",{body:e,...t,stream:e.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&aO(e),e))}retrieve(e,t={},r){return this._client.get(rE`/responses/${e}`,{query:t,...r,stream:t?.stream??!1})._thenUnwrap(e=>("object"in e&&"response"===e.object&&aO(e),e))}delete(e,t){return this._client.delete(rE`/responses/${e}`,{...t,headers:rW([{Accept:"*/*"},t?.headers])})}parse(e,t){return this._client.responses.create(e,t)._thenUnwrap(t=>aE(t,e))}stream(e,t){return ak.createResponse(this._client,e,t)}cancel(e,t){return this._client.post(rE`/responses/${e}/cancel`,t)}}ax.InputItems=aS;class a$ extends r_{create(e,t,r){return this._client.post(rE`/uploads/${e}/parts`,rc({body:t,...r},this._client))}}class aI extends r_{constructor(){super(...arguments),this.parts=new a$(this._client)}create(e,t){return this._client.post("/uploads",{body:e,...t})}cancel(e,t){return this._client.post(rE`/uploads/${e}/cancel`,t)}complete(e,t,r){return this._client.post(rE`/uploads/${e}/complete`,{body:t,...r})}}aI.Parts=a$;let aA=async e=>{let t=await Promise.allSettled(e),r=t.filter(e=>"rejected"===e.status);if(r.length){for(let e of r)console.error(e.reason);throw Error(`${r.length} promise(s) failed - see the above errors`)}let a=[];for(let e of t)"fulfilled"===e.status&&a.push(e.value);return a};class aT extends r_{create(e,t,r){return this._client.post(rE`/vector_stores/${e}/file_batches`,{body:t,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}retrieve(e,t,r){let{vector_store_id:a}=t;return this._client.get(rE`/vector_stores/${a}/file_batches/${e}`,{...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}cancel(e,t,r){let{vector_store_id:a}=t;return this._client.post(rE`/vector_stores/${a}/file_batches/${e}/cancel`,{...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}async createAndPoll(e,t,r){let a=await this.create(e,t);return await this.poll(e,a.id,r)}listFiles(e,t,r){let{vector_store_id:a,...i}=t;return this._client.getAPIList(rE`/vector_stores/${a}/file_batches/${e}/files`,ri,{query:i,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}async poll(e,t,r){let a=rW([r?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":r?.pollIntervalMs?.toString()??void 0}]);for(;;){let{data:i,response:n}=await this.retrieve(t,{vector_store_id:e},{...r,headers:a}).withResponse();switch(i.status){case"in_progress":let s=5e3;if(r?.pollIntervalMs)s=r.pollIntervalMs;else{let e=n.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(s=t)}}await tI(s);break;case"failed":case"cancelled":case"completed":return i}}}async uploadAndPoll(e,{files:t,fileIds:r=[]},a){if(null==t||0==t.length)throw Error("No `files` provided to process. If you've already uploaded files you should use `.createAndPoll()` instead");let i=Math.min(a?.maxConcurrency??5,t.length),n=this._client,s=t.values(),o=[...r];async function l(e){for(let t of e){let e=await n.files.create({file:t,purpose:"assistants"},a);o.push(e.id)}}let u=Array(i).fill(s).map(l);return await aA(u),await this.createAndPoll(e,{file_ids:o})}}class aP extends r_{create(e,t,r){return this._client.post(rE`/vector_stores/${e}/files`,{body:t,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}retrieve(e,t,r){let{vector_store_id:a}=t;return this._client.get(rE`/vector_stores/${a}/files/${e}`,{...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}update(e,t,r){let{vector_store_id:a,...i}=t;return this._client.post(rE`/vector_stores/${a}/files/${e}`,{body:i,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e,t={},r){return this._client.getAPIList(rE`/vector_stores/${e}/files`,ri,{query:t,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}delete(e,t,r){let{vector_store_id:a}=t;return this._client.delete(rE`/vector_stores/${a}/files/${e}`,{...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}async createAndPoll(e,t,r){let a=await this.create(e,t,r);return await this.poll(e,a.id,r)}async poll(e,t,r){let a=rW([r?.headers,{"X-Stainless-Poll-Helper":"true","X-Stainless-Custom-Poll-Interval":r?.pollIntervalMs?.toString()??void 0}]);for(;;){let i=await this.retrieve(t,{vector_store_id:e},{...r,headers:a}).withResponse(),n=i.data;switch(n.status){case"in_progress":let s=5e3;if(r?.pollIntervalMs)s=r.pollIntervalMs;else{let e=i.response.headers.get("openai-poll-after-ms");if(e){let t=parseInt(e);isNaN(t)||(s=t)}}await tI(s);break;case"failed":case"completed":return n}}}async upload(e,t,r){let a=await this._client.files.create({file:t,purpose:"assistants"},r);return this.create(e,{file_id:a.id},r)}async uploadAndPoll(e,t,r){let a=await this.upload(e,t,r);return await this.poll(e,a.id,r)}content(e,t,r){let{vector_store_id:a}=t;return this._client.getAPIList(rE`/vector_stores/${a}/files/${e}/content`,ra,{...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}}class aj extends r_{constructor(){super(...arguments),this.files=new aP(this._client),this.fileBatches=new aT(this._client)}create(e,t){return this._client.post("/vector_stores",{body:e,...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}retrieve(e,t){return this._client.get(rE`/vector_stores/${e}`,{...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}update(e,t,r){return this._client.post(rE`/vector_stores/${e}`,{body:t,...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}list(e={},t){return this._client.getAPIList("/vector_stores",ri,{query:e,...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}delete(e,t){return this._client.delete(rE`/vector_stores/${e}`,{...t,headers:rW([{"OpenAI-Beta":"assistants=v2"},t?.headers])})}search(e,t,r){return this._client.getAPIList(rE`/vector_stores/${e}/search`,ra,{body:t,method:"post",...r,headers:rW([{"OpenAI-Beta":"assistants=v2"},r?.headers])})}}aj.Files=aP,aj.FileBatches=aT;class aN extends r_{constructor(){super(...arguments),eJ.add(this)}async unwrap(e,t,r=this._client.webhookSecret,a=300){return await this.verifySignature(e,t,r,a),JSON.parse(e)}async verifySignature(e,t,r=this._client.webhookSecret,a=300){if("undefined"==typeof crypto||"function"!=typeof crypto.subtle.importKey||"function"!=typeof crypto.subtle.verify)throw Error("Webhook signature verification is only supported when the `crypto` global is defined");ta(this,eJ,"m",eG).call(this,r);let i=rW([t]).values,n=ta(this,eJ,"m",eZ).call(this,i,"webhook-signature"),s=ta(this,eJ,"m",eZ).call(this,i,"webhook-timestamp"),o=ta(this,eJ,"m",eZ).call(this,i,"webhook-id"),l=parseInt(s,10);if(isNaN(l))throw new tE("Invalid webhook timestamp format");let u=Math.floor(Date.now()/1e3);if(u-l>a)throw new tE("Webhook timestamp is too old");if(l>u+a)throw new tE("Webhook timestamp is too new");let c=n.split(" ").map(e=>e.startsWith("v1,")?e.substring(3):e),d=r.startsWith("whsec_")?Buffer.from(r.replace("whsec_",""),"base64"):Buffer.from(r,"utf-8"),h=o?`${o}.${s}.${e}`:`${s}.${e}`,p=await crypto.subtle.importKey("raw",d,{name:"HMAC",hash:"SHA-256"},!1,["verify"]);for(let e of c)try{let t=Buffer.from(e,"base64");if(await crypto.subtle.verify("HMAC",p,t,new TextEncoder().encode(h)))return}catch{continue}throw new tE("The given webhook signature does not match the expected signature")}}eJ=new WeakSet,eG=function(e){if("string"!=typeof e||0===e.length)throw Error("The webhook secret must either be set using the env var, OPENAI_WEBHOOK_SECRET, on the client class, OpenAI({ webhookSecret: '123' }), or passed to this function")},eZ=function(e,t){if(!e)throw Error("Headers are required");let r=e.get(t);if(null==r)throw Error(`Missing required header: ${t}`);return r};class aR{constructor({baseURL:e=r5("OPENAI_BASE_URL"),apiKey:t=r5("OPENAI_API_KEY"),organization:r=r5("OPENAI_ORG_ID")??null,project:a=r5("OPENAI_PROJECT_ID")??null,webhookSecret:i=r5("OPENAI_WEBHOOK_SECRET")??null,...n}={}){if(eV.add(this),eK.set(this,void 0),this.completions=new r8(this),this.chat=new rq(this),this.embeddings=new ai(this),this.files=new al(this),this.images=new a_(this),this.audio=new rV(this),this.moderations=new av(this),this.models=new aw(this),this.fineTuning=new ag(this),this.graders=new ab(this),this.vectorStores=new aj(this),this.webhooks=new aN(this),this.beta=new r6(this),this.batches=new rY(this),this.uploads=new aI(this),this.responses=new ax(this),this.conversations=new aa(this),this.evals=new ao(this),this.containers=new at(this),void 0===t)throw new to("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let s={apiKey:t,organization:r,project:a,webhookSecret:i,...n,baseURL:e||"https://api.openai.com/v1"};if(!s.dangerouslyAllowBrowser&&"undefined"!=typeof window&&void 0!==window.document&&"undefined"!=typeof navigator)throw new to("It looks like you're running in a browser-like environment.\n\nThis is disabled by default, as it risks exposing your secret API credentials to attackers.\nIf you understand the risks and have appropriate mitigations in place,\nyou can set the `dangerouslyAllowBrowser` option to `true`, e.g.,\n\nnew OpenAI({ apiKey, dangerouslyAllowBrowser: true });\n\nhttps://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety\n");this.baseURL=s.baseURL,this.timeout=s.timeout??eY.DEFAULT_TIMEOUT,this.logger=s.logger??console;let o="warn";this.logLevel=o,this.logLevel=tK(s.logLevel,"ClientOptions.logLevel",this)??tK(r5("OPENAI_LOG"),"process.env['OPENAI_LOG']",this)??o,this.fetchOptions=s.fetchOptions,this.maxRetries=s.maxRetries??2,this.fetch=s.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new OpenAI({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),tr(this,eK,tL,"f"),this._options=s,this.apiKey=t,this.organization=r,this.project=a,this.webhookSecret=i}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,organization:this.organization,project:this.project,webhookSecret:this.webhookSecret,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){}async authHeaders(e){return rW([{Authorization:`Bearer ${this.apiKey}`}])}stringifyQuery(e){return function(e,t={}){let r,a=e,i=function(e=tW){let t;if(void 0!==e.allowEmptyArrays&&"boolean"!=typeof e.allowEmptyArrays)throw TypeError("`allowEmptyArrays` option can only be `true` or `false`, when provided");if(void 0!==e.encodeDotInKeys&&"boolean"!=typeof e.encodeDotInKeys)throw TypeError("`encodeDotInKeys` option can only be `true` or `false`, when provided");if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw TypeError("Encoder has to be a function.");let r=e.charset||tW.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");let a=tM;if(void 0!==e.format){if(!tz(tD,e.format))throw TypeError("Unknown format option provided.");a=e.format}let i=tD[a],n=tW.filter;if(("function"==typeof e.filter||tk(e.filter))&&(n=e.filter),t=e.arrayFormat&&e.arrayFormat in tq?e.arrayFormat:"indices"in e?e.indices?"indices":"repeat":tW.arrayFormat,"commaRoundTrip"in e&&"boolean"!=typeof e.commaRoundTrip)throw TypeError("`commaRoundTrip` must be a boolean, or absent");let s=void 0===e.allowDots?!0==!!e.encodeDotInKeys||tW.allowDots:!!e.allowDots;return{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:tW.addQueryPrefix,allowDots:s,allowEmptyArrays:"boolean"==typeof e.allowEmptyArrays?!!e.allowEmptyArrays:tW.allowEmptyArrays,arrayFormat:t,charset:r,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:tW.charsetSentinel,commaRoundTrip:!!e.commaRoundTrip,delimiter:void 0===e.delimiter?tW.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:tW.encode,encodeDotInKeys:"boolean"==typeof e.encodeDotInKeys?e.encodeDotInKeys:tW.encodeDotInKeys,encoder:"function"==typeof e.encoder?e.encoder:tW.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:tW.encodeValuesOnly,filter:n,format:a,formatter:i,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:tW.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:tW.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:tW.strictNullHandling}}(t);"function"==typeof i.filter?a=(0,i.filter)("",a):tk(i.filter)&&(r=i.filter);let n=[];if("object"!=typeof a||null===a)return"";let s=tq[i.arrayFormat],o="comma"===s&&i.commaRoundTrip;r||(r=Object.keys(a)),i.sort&&r.sort(i.sort);let l=new WeakMap;for(let e=0;e<r.length;++e){let t=r[e];i.skipNulls&&null===a[t]||tH(n,function e(t,r,a,i,n,s,o,l,u,c,d,h,p,f,m,g,y,b){var _,w;let v,E=t,O=b,k=0,S=!1;for(;void 0!==(O=O.get(tJ))&&!S;){let e=O.get(t);if(k+=1,void 0!==e)if(e===k)throw RangeError("Cyclic object value");else S=!0;void 0===O.get(tJ)&&(k=0)}if("function"==typeof c?E=c(r,E):E instanceof Date?E=p?.(E):"comma"===a&&tk(E)&&(E=tB(E,function(e){return e instanceof Date?p?.(e):e})),null===E){if(s)return u&&!g?u(r,tW.encoder,y,"key",f):r;E=""}if("string"==typeof(_=E)||"number"==typeof _||"boolean"==typeof _||"symbol"==typeof _||"bigint"==typeof _||(w=E)&&"object"==typeof w&&w.constructor&&w.constructor.isBuffer&&w.constructor.isBuffer(w)){if(u){let e=g?r:u(r,tW.encoder,y,"key",f);return[m?.(e)+"="+m?.(u(E,tW.encoder,y,"value",f))]}return[m?.(r)+"="+m?.(String(E))]}let x=[];if(void 0===E)return x;if("comma"===a&&tk(E))g&&u&&(E=tB(E,u)),v=[{value:E.length>0?E.join(",")||null:void 0}];else if(tk(c))v=c;else{let e=Object.keys(E);v=d?e.sort(d):e}let $=l?String(r).replace(/\./g,"%2E"):String(r),I=i&&tk(E)&&1===E.length?$+"[]":$;if(n&&tk(E)&&0===E.length)return I+"[]";for(let r=0;r<v.length;++r){let _=v[r],w="object"==typeof _&&void 0!==_.value?_.value:E[_];if(o&&null===w)continue;let O=h&&l?_.replace(/\./g,"%2E"):_,S=tk(E)?"function"==typeof a?a(I,O):I:I+(h?"."+O:"["+O+"]");b.set(t,k);let $=new WeakMap;$.set(tJ,b),tH(x,e(w,S,a,i,n,s,o,l,"comma"===a&&g&&tk(E)?null:u,c,d,h,p,f,m,g,y,$))}return x}(a[t],t,s,o,i.allowEmptyArrays,i.strictNullHandling,i.skipNulls,i.encodeDotInKeys,i.encode?i.encoder:null,i.filter,i.sort,i.allowDots,i.serializeDate,i.format,i.formatter,i.encodeValuesOnly,i.charset,l))}let u=n.join(i.delimiter),c=!0===i.addQueryPrefix?"?":"";return i.charsetSentinel&&("iso-8859-1"===i.charset?c+="utf8=%26%2310003%3B&":c+="utf8=%E2%9C%93&"),u.length>0?c+u:""}(e,{arrayFormat:"brackets"})}getUserAgent(){return`${this.constructor.name}/JS ${tA}`}defaultIdempotencyKey(){return`stainless-node-retry-${ti()}`}makeStatusError(e,t,r,a){return tl.generate(e,t,r,a)}buildURL(e,t,r){let a=!ta(this,eV,"m",eX).call(this)&&r||this.baseURL,i=new URL(tO.test(e)?e:a+(a.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),n=this.defaultQuery();return!function(e){if(!e)return!0;for(let t in e)return!1;return!0}(n)&&(t={...n,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(r=>({method:e,path:t,...r})))}request(e,t=null){return new re(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,r){let a=await e,i=a.maxRetries??this.maxRetries;null==t&&(t=i),await this.prepareOptions(a);let{req:n,url:s,timeout:o}=await this.buildRequest(a,{retryCount:i-t});await this.prepareRequest(n,{url:s,options:a});let l="log_"+(0x1000000*Math.random()|0).toString(16).padStart(6,"0"),u=void 0===r?"":`, retryOf: ${r}`,c=Date.now();if(t2(this).debug(`[${l}] sending request`,t5({retryOfRequestLogID:r,method:a.method,url:s,options:a,headers:n.headers})),a.signal?.aborted)throw new tu;let d=new AbortController,h=await this.fetchWithTimeout(s,n,o,d).catch(ts),p=Date.now();if(h instanceof Error){let e=`retrying, ${t} attempts remaining`;if(a.signal?.aborted)throw new tu;let i=tn(h)||/timed? ?out/i.test(String(h)+("cause"in h?String(h.cause):""));if(t)return t2(this).info(`[${l}] connection ${i?"timed out":"failed"} - ${e}`),t2(this).debug(`[${l}] connection ${i?"timed out":"failed"} (${e})`,t5({retryOfRequestLogID:r,url:s,durationMs:p-c,message:h.message})),this.retryRequest(a,t,r??l);if(t2(this).info(`[${l}] connection ${i?"timed out":"failed"} - error; no more retries left`),t2(this).debug(`[${l}] connection ${i?"timed out":"failed"} (error; no more retries left)`,t5({retryOfRequestLogID:r,url:s,durationMs:p-c,message:h.message})),i)throw new td;throw new tc({cause:h})}let f=[...h.headers.entries()].filter(([e])=>"x-request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join(""),m=`[${l}${u}${f}] ${n.method} ${s} ${h.ok?"succeeded":"failed"} with status ${h.status} in ${p-c}ms`;if(!h.ok){let e=await this.shouldRetry(h);if(t&&e){let e=`retrying, ${t} attempts remaining`;return await tC(h.body),t2(this).info(`${m} - ${e}`),t2(this).debug(`[${l}] response error (${e})`,t5({retryOfRequestLogID:r,url:h.url,status:h.status,headers:h.headers,durationMs:p-c})),this.retryRequest(a,t,r??l,h.headers)}let i=e?"error; no more retries left":"error; not retryable";t2(this).info(`${m} - ${i}`);let n=await h.text().catch(e=>ts(e).message),s=(e=>{try{return JSON.parse(e)}catch(e){return}})(n),o=s?void 0:n;throw t2(this).debug(`[${l}] response error (${i})`,t5({retryOfRequestLogID:r,url:h.url,status:h.status,headers:h.headers,message:o,durationMs:Date.now()-c})),this.makeStatusError(h.status,s,o,h.headers)}return t2(this).info(m),t2(this).debug(`[${l}] response start`,t5({retryOfRequestLogID:r,url:h.url,status:h.status,headers:h.headers,durationMs:p-c})),{response:h,options:a,controller:d,requestLogID:l,retryOfRequestLogID:r,startTime:c}}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}requestAPIList(e,t){return new rr(this,this.makeRequest(t,null,void 0),e)}async fetchWithTimeout(e,t,r,a){let{signal:i,method:n,...s}=t||{};i&&i.addEventListener("abort",()=>a.abort());let o=setTimeout(()=>a.abort(),r),l=globalThis.ReadableStream&&s.body instanceof globalThis.ReadableStream||"object"==typeof s.body&&null!==s.body&&Symbol.asyncIterator in s.body,u={signal:a.signal,...l?{duplex:"half"}:{},method:"GET",...s};n&&(u.method=n.toUpperCase());try{return await this.fetch.call(void 0,e,u)}finally{clearTimeout(o)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||!!(e.status>=500))}async retryRequest(e,t,r,a){let i,n=a?.get("retry-after-ms");if(n){let e=parseFloat(n);Number.isNaN(e)||(i=e)}let s=a?.get("retry-after");if(s&&!i){let e=parseFloat(s);i=Number.isNaN(e)?Date.parse(s)-Date.now():1e3*e}if(!(i&&0<=i&&i<6e4)){let r=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,r)}return await tI(i),this.makeRequest(e,t-1,r)}calculateDefaultRetryTimeoutMillis(e,t){return Math.min(.5*Math.pow(2,t-e),8)*(1-.25*Math.random())*1e3}async buildRequest(e,{retryCount:t=0}={}){let r={...e},{method:a,path:i,query:n,defaultBaseURL:s}=r,o=this.buildURL(i,n,s);"timeout"in r&&((e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new to(`${e} must be an integer`);if(t<0)throw new to(`${e} must be a positive integer`)})("timeout",r.timeout),r.timeout=r.timeout??this.timeout;let{bodyHeaders:l,body:u}=this.buildBody({options:r}),c=await this.buildHeaders({options:e,method:a,bodyHeaders:l,retryCount:t});return{req:{method:a,headers:c,...r.signal&&{signal:r.signal},...globalThis.ReadableStream&&u instanceof globalThis.ReadableStream&&{duplex:"half"},...u&&{body:u},...this.fetchOptions??{},...r.fetchOptions??{}},url:o,timeout:r.timeout}}async buildHeaders({options:e,method:t,bodyHeaders:r,retryCount:a}){let n={};this.idempotencyHeader&&"get"!==t&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),n[this.idempotencyHeader]=e.idempotencyKey);let s=rW([n,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(a),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...i??(i=(()=>{let e="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":tA,"X-Stainless-OS":tP(Deno.build.os),"X-Stainless-Arch":tT(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":tA,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":tA,"X-Stainless-OS":tP(globalThis.process.platform??"unknown"),"X-Stainless-Arch":tT(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};let t=function(){if("undefined"==typeof navigator||!navigator)return null;for(let{key:e,pattern:t}of[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}]){let r=t.exec(navigator.userAgent);if(r){let t=r[1]||0,a=r[2]||0,i=r[3]||0;return{browser:e,version:`${t}.${a}.${i}`}}}return null}();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":tA,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":tA,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),"OpenAI-Organization":this.organization,"OpenAI-Project":this.project},await this.authHeaders(e),this._options.defaultHeaders,r,e.headers]);return this.validateHeaders(s),s.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let r=rW([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&r.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:tN(e)}:ta(this,eK,"f").call(this,{body:e,headers:r})}}eY=aR,eK=new WeakMap,eV=new WeakSet,eX=function(){return"https://api.openai.com/v1"!==this.baseURL},aR.OpenAI=eY,aR.DEFAULT_TIMEOUT=6e5,aR.OpenAIError=to,aR.APIError=tl,aR.APIConnectionError=tc,aR.APIConnectionTimeoutError=td,aR.APIUserAbortError=tu,aR.NotFoundError=tm,aR.ConflictError=tg,aR.RateLimitError=tb,aR.BadRequestError=th,aR.AuthenticationError=tp,aR.InternalServerError=t_,aR.PermissionDeniedError=tf,aR.UnprocessableEntityError=ty,aR.InvalidWebhookSignatureError=tE,aR.toFile=ry,aR.Completions=r8,aR.Chat=rq,aR.Embeddings=ai,aR.Files=al,aR.Images=a_,aR.Audio=rV,aR.Moderations=av,aR.Models=aw,aR.FineTuning=ag,aR.Graders=ab,aR.VectorStores=aj,aR.Webhooks=aN,aR.Beta=r6,aR.Batches=rY,aR.Uploads=aI,aR.Responses=ax,aR.Conversations=aa,aR.Evals=ao,aR.Containers=at,Symbol("ZodOutput"),Symbol("ZodInput");class aC{constructor(){this._map=new Map,this._idmap=new Map}add(e,...t){let r=t[0];if(this._map.set(e,r),r&&"object"==typeof r&&"id"in r){if(this._idmap.has(r.id))throw Error(`ID ${r.id} already exists in the registry`);this._idmap.set(r.id,e)}return this}clear(){return this._map=new Map,this._idmap=new Map,this}remove(e){let t=this._map.get(e);return t&&"object"==typeof t&&"id"in t&&this._idmap.delete(t.id),this._map.delete(e),this}get(e){let t=e._zod.parent;if(t){let r={...this.get(t)??{}};return delete r.id,{...r,...this._map.get(e)}}return this._map.get(e)}has(e){return this._map.has(e)}}let aL=new aC;function aM(e,t){return"bigint"==typeof t?t.toString():t}let aU=Error.captureStackTrace?Error.captureStackTrace:(...e)=>{};function aD(e,t,r){let a=new e._zod.constr(t??e._zod.def);return(!t||r?.parent)&&(a._zod.parent=e),a}function az(e,t=0){for(let r=t;r<e.issues.length;r++)if(e.issues[r]?.continue!==!0)return!0;return!1}function aF(e){return"string"==typeof e?e:e?.message}function aB(e,t,r){let a={...e,path:e.path??[]};return e.message||(a.message=aF(e.inst?._zod.def?.error?.(e))??aF(t?.error?.(e))??aF(r.customError?.(e))??aF(r.localeError?.(e))??"Invalid input"),delete a.inst,delete a.continue,t?.reportInput||delete a.input,a}class aq{constructor(e){this.counter=0,this.metadataRegistry=e?.metadata??aL,this.target=e?.target??"draft-2020-12",this.unrepresentable=e?.unrepresentable??"throw",this.override=e?.override??(()=>{}),this.io=e?.io??"output",this.seen=new Map}process(e,t={path:[],schemaPath:[]}){var r;let a=e._zod.def,i=this.seen.get(e);if(i)return i.count++,t.schemaPath.includes(e)&&(i.cycle=t.path),i.schema;let n={schema:{},count:1,cycle:void 0,path:t.path};this.seen.set(e,n);let s=e._zod.toJSONSchema?.();if(s)n.schema=s;else{let r={...t,schemaPath:[...t.schemaPath,e],path:t.path},i=e._zod.parent;if(i)n.ref=i,this.process(i,r),this.seen.get(i).isParent=!0;else{let t=n.schema;switch(a.type){case"string":{t.type="string";let{minimum:r,maximum:a,format:i,patterns:s,contentEncoding:o}=e._zod.bag;if("number"==typeof r&&(t.minLength=r),"number"==typeof a&&(t.maxLength=a),i&&(t.format=({guid:"uuid",url:"uri",datetime:"date-time",json_string:"json-string",regex:""})[i]??i,""===t.format&&delete t.format),o&&(t.contentEncoding=o),s&&s.size>0){let e=[...s];1===e.length?t.pattern=e[0].source:e.length>1&&(n.schema.allOf=[...e.map(e=>({..."draft-7"===this.target?{type:"string"}:{},pattern:e.source}))])}break}case"number":{let{minimum:r,maximum:a,format:i,multipleOf:n,exclusiveMaximum:s,exclusiveMinimum:o}=e._zod.bag;"string"==typeof i&&i.includes("int")?t.type="integer":t.type="number","number"==typeof o&&(t.exclusiveMinimum=o),"number"==typeof r&&(t.minimum=r,"number"==typeof o&&(o>=r?delete t.minimum:delete t.exclusiveMinimum)),"number"==typeof s&&(t.exclusiveMaximum=s),"number"==typeof a&&(t.maximum=a,"number"==typeof s&&(s<=a?delete t.maximum:delete t.exclusiveMaximum)),"number"==typeof n&&(t.multipleOf=n);break}case"boolean":case"success":t.type="boolean";break;case"bigint":if("throw"===this.unrepresentable)throw Error("BigInt cannot be represented in JSON Schema");break;case"symbol":if("throw"===this.unrepresentable)throw Error("Symbols cannot be represented in JSON Schema");break;case"null":t.type="null";break;case"any":case"unknown":break;case"undefined":if("throw"===this.unrepresentable)throw Error("Undefined cannot be represented in JSON Schema");break;case"void":if("throw"===this.unrepresentable)throw Error("Void cannot be represented in JSON Schema");break;case"never":t.not={};break;case"date":if("throw"===this.unrepresentable)throw Error("Date cannot be represented in JSON Schema");break;case"array":{let{minimum:i,maximum:n}=e._zod.bag;"number"==typeof i&&(t.minItems=i),"number"==typeof n&&(t.maxItems=n),t.type="array",t.items=this.process(a.element,{...r,path:[...r.path,"items"]});break}case"object":{t.type="object",t.properties={};let e=a.shape;for(let a in e)t.properties[a]=this.process(e[a],{...r,path:[...r.path,"properties",a]});let i=new Set([...new Set(Object.keys(e))].filter(e=>{let t=a.shape[e]._zod;return"input"===this.io?void 0===t.optin:void 0===t.optout}));i.size>0&&(t.required=Array.from(i)),a.catchall?._zod.def.type==="never"?t.additionalProperties=!1:a.catchall?a.catchall&&(t.additionalProperties=this.process(a.catchall,{...r,path:[...r.path,"additionalProperties"]})):"output"===this.io&&(t.additionalProperties=!1);break}case"union":t.anyOf=a.options.map((e,t)=>this.process(e,{...r,path:[...r.path,"anyOf",t]}));break;case"intersection":{let e=this.process(a.left,{...r,path:[...r.path,"allOf",0]}),i=this.process(a.right,{...r,path:[...r.path,"allOf",1]}),n=e=>"allOf"in e&&1===Object.keys(e).length;t.allOf=[...n(e)?e.allOf:[e],...n(i)?i.allOf:[i]];break}case"tuple":{t.type="array";let i=a.items.map((e,t)=>this.process(e,{...r,path:[...r.path,"prefixItems",t]}));if("draft-2020-12"===this.target?t.prefixItems=i:t.items=i,a.rest){let e=this.process(a.rest,{...r,path:[...r.path,"items"]});"draft-2020-12"===this.target?t.items=e:t.additionalItems=e}a.rest&&(t.items=this.process(a.rest,{...r,path:[...r.path,"items"]}));let{minimum:n,maximum:s}=e._zod.bag;"number"==typeof n&&(t.minItems=n),"number"==typeof s&&(t.maxItems=s);break}case"record":t.type="object",t.propertyNames=this.process(a.keyType,{...r,path:[...r.path,"propertyNames"]}),t.additionalProperties=this.process(a.valueType,{...r,path:[...r.path,"additionalProperties"]});break;case"map":if("throw"===this.unrepresentable)throw Error("Map cannot be represented in JSON Schema");break;case"set":if("throw"===this.unrepresentable)throw Error("Set cannot be represented in JSON Schema");break;case"enum":{let e=function(e){let t=Object.values(e).filter(e=>"number"==typeof e);return Object.entries(e).filter(([e,r])=>-1===t.indexOf(+e)).map(([e,t])=>t)}(a.entries);e.every(e=>"number"==typeof e)&&(t.type="number"),e.every(e=>"string"==typeof e)&&(t.type="string"),t.enum=e;break}case"literal":{let e=[];for(let t of a.values)if(void 0===t){if("throw"===this.unrepresentable)throw Error("Literal `undefined` cannot be represented in JSON Schema")}else if("bigint"==typeof t)if("throw"===this.unrepresentable)throw Error("BigInt literals cannot be represented in JSON Schema");else e.push(Number(t));else e.push(t);if(0===e.length);else if(1===e.length){let r=e[0];t.type=null===r?"null":typeof r,t.const=r}else e.every(e=>"number"==typeof e)&&(t.type="number"),e.every(e=>"string"==typeof e)&&(t.type="string"),e.every(e=>"boolean"==typeof e)&&(t.type="string"),e.every(e=>null===e)&&(t.type="null"),t.enum=e;break}case"file":{let r={type:"string",format:"binary",contentEncoding:"binary"},{minimum:a,maximum:i,mime:n}=e._zod.bag;void 0!==a&&(r.minLength=a),void 0!==i&&(r.maxLength=i),n?1===n.length?(r.contentMediaType=n[0],Object.assign(t,r)):t.anyOf=n.map(e=>({...r,contentMediaType:e})):Object.assign(t,r);break}case"transform":if("throw"===this.unrepresentable)throw Error("Transforms cannot be represented in JSON Schema");break;case"nullable":t.anyOf=[this.process(a.innerType,r),{type:"null"}];break;case"nonoptional":case"promise":case"optional":this.process(a.innerType,r),n.ref=a.innerType;break;case"default":this.process(a.innerType,r),n.ref=a.innerType,t.default=JSON.parse(JSON.stringify(a.defaultValue));break;case"prefault":this.process(a.innerType,r),n.ref=a.innerType,"input"===this.io&&(t._prefault=JSON.parse(JSON.stringify(a.defaultValue)));break;case"catch":{let e;this.process(a.innerType,r),n.ref=a.innerType;try{e=a.catchValue(void 0)}catch{throw Error("Dynamic catch values are not supported in JSON Schema")}t.default=e;break}case"nan":if("throw"===this.unrepresentable)throw Error("NaN cannot be represented in JSON Schema");break;case"template_literal":{let r=e._zod.pattern;if(!r)throw Error("Pattern not found in template literal");t.type="string",t.pattern=r.source;break}case"pipe":{let e="input"===this.io?"transform"===a.in._zod.def.type?a.out:a.in:a.out;this.process(e,r),n.ref=e;break}case"readonly":this.process(a.innerType,r),n.ref=a.innerType,t.readOnly=!0;break;case"lazy":{let t=e._zod.innerType;this.process(t,r),n.ref=t;break}case"custom":if("throw"===this.unrepresentable)throw Error("Custom types cannot be represented in JSON Schema")}}}let o=this.metadataRegistry.get(e);return o&&Object.assign(n.schema,o),"input"===this.io&&function e(t,r){let a=r??{seen:new Set};if(a.seen.has(t))return!1;a.seen.add(t);let i=t._zod.def;switch(i.type){case"string":case"number":case"bigint":case"boolean":case"date":case"symbol":case"undefined":case"null":case"any":case"unknown":case"never":case"void":case"literal":case"enum":case"nan":case"file":case"template_literal":case"custom":case"success":case"catch":return!1;case"array":return e(i.element,a);case"object":for(let t in i.shape)if(e(i.shape[t],a))return!0;return!1;case"union":for(let t of i.options)if(e(t,a))return!0;return!1;case"intersection":return e(i.left,a)||e(i.right,a);case"tuple":for(let t of i.items)if(e(t,a))return!0;if(i.rest&&e(i.rest,a))return!0;return!1;case"record":case"map":return e(i.keyType,a)||e(i.valueType,a);case"set":return e(i.valueType,a);case"promise":case"optional":case"nonoptional":case"nullable":case"readonly":case"default":case"prefault":return e(i.innerType,a);case"lazy":return e(i.getter(),a);case"transform":return!0;case"pipe":return e(i.in,a)||e(i.out,a)}throw Error(`Unknown schema type: ${i.type}`)}(e)&&(delete n.schema.examples,delete n.schema.default),"input"===this.io&&n.schema._prefault&&((r=n.schema).default??(r.default=n.schema._prefault)),delete n.schema._prefault,this.seen.get(e).schema}emit(e,t){let r={cycles:t?.cycles??"ref",reused:t?.reused??"inline",external:t?.external??void 0},a=this.seen.get(e);if(!a)throw Error("Unprocessed schema. This is a bug in Zod.");let i=e=>{let t="draft-2020-12"===this.target?"$defs":"definitions";if(r.external){let a=r.external.registry.get(e[0])?.id,i=r.external.uri??(e=>e);if(a)return{ref:i(a)};let n=e[1].defId??e[1].schema.id??`schema${this.counter++}`;return e[1].defId=n,{defId:n,ref:`${i("__shared")}#/${t}/${n}`}}if(e[1]===a)return{ref:"#"};let i=`#/${t}/`,n=e[1].schema.id??`__schema${this.counter++}`;return{defId:n,ref:i+n}},n=e=>{if(e[1].schema.$ref)return;let t=e[1],{ref:r,defId:a}=i(e);t.def={...t.schema},a&&(t.defId=a);let n=t.schema;for(let e in n)delete n[e];n.$ref=r};if("throw"===r.cycles)for(let e of this.seen.entries()){let t=e[1];if(t.cycle)throw Error(`Cycle detected: #/${t.cycle?.join("/")}/<root>

Set the \`cycles\` parameter to \`"ref"\` to resolve cyclical schemas with defs.`)}for(let t of this.seen.entries()){let a=t[1];if(e===t[0]){n(t);continue}if(r.external){let a=r.external.registry.get(t[0])?.id;if(e!==t[0]&&a){n(t);continue}}if(this.metadataRegistry.get(t[0])?.id||a.cycle||a.count>1&&"ref"===r.reused){n(t);continue}}let s=(e,t)=>{let r=this.seen.get(e),a=r.def??r.schema,i={...a};if(null===r.ref)return;let n=r.ref;if(r.ref=null,n){s(n,t);let e=this.seen.get(n).schema;e.$ref&&"draft-7"===t.target?(a.allOf=a.allOf??[],a.allOf.push(e)):(Object.assign(a,e),Object.assign(a,i))}r.isParent||this.override({zodSchema:e,jsonSchema:a,path:r.path??[]})};for(let e of[...this.seen.entries()].reverse())s(e[0],{target:this.target});let o={};if("draft-2020-12"===this.target?o.$schema="https://json-schema.org/draft/2020-12/schema":"draft-7"===this.target?o.$schema="http://json-schema.org/draft-07/schema#":console.warn(`Invalid target: ${this.target}`),r.external?.uri){let t=r.external.registry.get(e)?.id;if(!t)throw Error("Schema is missing an `id` property");o.$id=r.external.uri(t)}Object.assign(o,a.def);let l=r.external?.defs??{};for(let e of this.seen.entries()){let t=e[1];t.def&&t.defId&&(l[t.defId]=t.def)}r.external||Object.keys(l).length>0&&("draft-2020-12"===this.target?o.$defs=l:o.definitions=l);try{return JSON.parse(JSON.stringify(o))}catch(e){throw Error("Error converting schema to JSON.")}}}function aH(e,t){if(e instanceof aC){let r=new aq(t),a={};for(let t of e._idmap.entries()){let[e,a]=t;r.process(a)}let i={},n={registry:e,uri:t?.uri,defs:a};for(let a of e._idmap.entries()){let[e,s]=a;i[e]=r.emit(s,{...t,external:n})}return Object.keys(a).length>0&&(i.__shared={["draft-2020-12"===r.target?"$defs":"definitions"]:a}),{schemas:i}}let r=new aq(t);return r.process(e),r.emit(e,t)}function aW(e,t,r){function a(r,a){var i;for(let n in Object.defineProperty(r,"_zod",{value:r._zod??{},enumerable:!1}),(i=r._zod).traits??(i.traits=new Set),r._zod.traits.add(e),t(r,a),s.prototype)n in r||Object.defineProperty(r,n,{value:s.prototype[n].bind(r)});r._zod.constr=s,r._zod.def=a}let i=r?.Parent??Object;class n extends i{}function s(e){var t;let i=r?.Parent?new n:this;for(let r of(a(i,e),(t=i._zod).deferred??(t.deferred=[]),i._zod.deferred))r();return i}return Object.defineProperty(n,"name",{value:e}),Object.defineProperty(s,"init",{value:a}),Object.defineProperty(s,Symbol.hasInstance,{value:t=>!!r?.Parent&&t instanceof r.Parent||t?._zod?.traits?.has(e)}),Object.defineProperty(s,"name",{value:e}),s}Object.freeze({status:"aborted"}),Symbol("zod_brand");class aJ extends Error{constructor(){super("Encountered Promise during synchronous parse. Use .parseAsync() instead.")}}let aG={};function aZ(e){return e&&Object.assign(aG,e),aG}let aV=(e,t)=>{e.name="$ZodError",Object.defineProperty(e,"_zod",{value:e._zod,enumerable:!1}),Object.defineProperty(e,"issues",{value:t,enumerable:!1}),Object.defineProperty(e,"message",{get:()=>JSON.stringify(t,aM,2),enumerable:!0}),Object.defineProperty(e,"toString",{value:()=>e.message,enumerable:!1})},aY=aW("$ZodError",aV),aK=aW("$ZodError",aV,{Parent:Error}),aX=(e,t,r,a)=>{let i=r?Object.assign(r,{async:!1}):{async:!1},n=e._zod.run({value:t,issues:[]},i);if(n instanceof Promise)throw new aJ;if(n.issues.length){let e=new(a?.Err??aK)(n.issues.map(e=>aB(e,i,aZ())));throw aU(e,a?.callee),e}return n.value},aQ=async(e,t,r,a)=>{let i=r?Object.assign(r,{async:!0}):{async:!0},n=e._zod.run({value:t,issues:[]},i);if(n instanceof Promise&&(n=await n),n.issues.length){let e=new(a?.Err??aK)(n.issues.map(e=>aB(e,i,aZ())));throw aU(e,a?.callee),e}return n.value},a0=(e,t,r)=>{let a=r?{...r,async:!1}:{async:!1},i=e._zod.run({value:t,issues:[]},a);if(i instanceof Promise)throw new aJ;return i.issues.length?{success:!1,error:new(aK??aY)(i.issues.map(e=>aB(e,a,aZ())))}:{success:!0,data:i.value}},a1=async(e,t,r)=>{let a=r?Object.assign(r,{async:!0}):{async:!0},i=e._zod.run({value:t,issues:[]},a);return i instanceof Promise&&(i=await i),i.issues.length?{success:!1,error:new aK(i.issues.map(e=>aB(e,a,aZ())))}:{success:!0,data:i.value}};function a2(e,t=a5){let r=(e=e.trim()).indexOf("```");if(-1===r)return t(e);let a=e.substring(r+3);a.startsWith("json\n")?a=a.substring(5):a.startsWith("json")?a=a.substring(4):a.startsWith("\n")&&(a=a.substring(1));let i=a.indexOf("```"),n=a;return -1!==i&&(n=a.substring(0,i)),t(n.trim())}function a5(e){if(void 0===e)return null;try{return JSON.parse(e)}catch(e){}let t="",r=[],a=!1,i=!1;for(let n of e){if(a)'"'!==n||i?"\n"!==n||i?i="\\"===n&&!i:n="\\n":a=!1;else if('"'===n)a=!0,i=!1;else if("{"===n)r.push("}");else if("["===n)r.push("]");else if("}"===n||"]"===n)if(!r||r[r.length-1]!==n)return null;else r.pop();t+=n}a&&(t+='"');for(let e=r.length-1;e>=0;e-=1)t+=r[e];try{return JSON.parse(t)}catch(e){return null}}var a4=r(79478);function a9(e,t){return t?.[e]||a4(e)}function a3(e){return Array.isArray(e)?[...e]:{...e}}function a6(e){let t=Object.getPrototypeOf(e);return"function"==typeof e.lc_name&&("function"!=typeof t.lc_name||e.lc_name()!==t.lc_name())?e.lc_name():e.name}r(12729);class a8{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,a6(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),void 0!==this.lc_serializable_keys?this.lc_kwargs=Object.fromEntries(Object.entries(e||{}).filter(([e])=>this.lc_serializable_keys?.includes(e))):this.lc_kwargs=e??{}}toJSON(){if(!this.lc_serializable||this.lc_kwargs instanceof a8||"object"!=typeof this.lc_kwargs||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((e,t)=>(e[t]=t in this?this[t]:this.lc_kwargs[t],e),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(e=>{let t=this,a=r,[i,...n]=e.split(".").reverse();for(let e of n.reverse()){if(!(e in t)||void 0===t[e])return;e in a&&void 0!==a[e]||("object"==typeof t[e]&&null!=t[e]?a[e]={}:Array.isArray(t[e])&&(a[e]=[])),t=t[e],a=a[e]}i in t&&void 0!==t[i]&&(a[i]=a[i]||t[i])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:function(e,t,r){let a={};for(let i in e)Object.hasOwn(e,i)&&(a[t(i,r)]=e[i]);return a}(Object.keys(t).length?function(e,t){let r=a3(e);for(let[e,a]of Object.entries(t)){let[t,...i]=e.split(".").reverse(),n=r;for(let e of i.reverse()){if(void 0===n[e])break;n[e]=a3(n[e]),n=n[e]}void 0!==n[t]&&(n[t]={lc:1,type:"secret",id:[a]})}return r}(r,t):r,a9,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function a7(e){return"object"==typeof e&&null!==e&&"type"in e&&"string"==typeof e.type&&"source_type"in e&&("url"===e.source_type||"base64"===e.source_type||"text"===e.source_type||"id"===e.source_type)}function ie(e){let t=e.split(";")[0].split("/");if(2!==t.length)throw Error(`Invalid mime type: "${e}" - does not match type/subtype format.`);let r=t[0].trim(),a=t[1].trim();if(""===r||""===a)throw Error(`Invalid mime type: "${e}" - type or subtype is empty.`);let i={};for(let t of e.split(";").slice(1)){let r=t.split("=");if(2!==r.length)throw Error(`Invalid parameter syntax in mime type: "${e}".`);let a=r[0].trim(),n=r[1].trim();if(""===a)throw Error(`Invalid parameter syntax in mime type: "${e}".`);i[a]=n}return{type:r,subtype:a,parameters:i}}function it({dataUrl:e,asTypedArray:t=!1}){let r=e.match(/^data:(\w+\/\w+);base64,([A-Za-z0-9+/]+=*)$/);if(r)return{mime_type:r[1].toLowerCase(),data:t?Uint8Array.from(atob(r[2]),e=>e.charCodeAt(0)):r[2]}}function ir(e,t){if("text"===e.type){if(!t.fromStandardTextBlock)throw Error(`Converter for ${t.providerName} does not implement \`fromStandardTextBlock\` method.`);return t.fromStandardTextBlock(e)}if("image"===e.type){if(!t.fromStandardImageBlock)throw Error(`Converter for ${t.providerName} does not implement \`fromStandardImageBlock\` method.`);return t.fromStandardImageBlock(e)}if("audio"===e.type){if(!t.fromStandardAudioBlock)throw Error(`Converter for ${t.providerName} does not implement \`fromStandardAudioBlock\` method.`);return t.fromStandardAudioBlock(e)}if("file"===e.type){if(!t.fromStandardFileBlock)throw Error(`Converter for ${t.providerName} does not implement \`fromStandardFileBlock\` method.`);return t.fromStandardFileBlock(e)}throw Error(`Unable to convert content block type '${e.type}' to provider-specific format: not recognized.`)}function ia(e,t){return"string"==typeof e?""===e?t:"string"==typeof t?e+t:Array.isArray(t)&&t.some(e=>a7(e))?[{type:"text",source_type:"text",text:e},...t]:[{type:"text",text:e},...t]:Array.isArray(t)?io(e,t)??[...e,...t]:""===t?e:Array.isArray(e)&&e.some(e=>a7(e))?[...e,{type:"file",source_type:"text",text:t}]:[...e,{type:"text",text:t}]}class ii extends a8{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return"string"==typeof this.content?this.content:Array.isArray(this.content)?this.content.map(e=>"string"==typeof e?e:"text"===e.type?e.text:"").join(""):""}getType(){return this._getType()}constructor(e,t){"string"==typeof e&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata,this.id=e.id}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}static lc_name(){return"BaseMessage"}get _printableFields(){return{id:this.id,content:this.content,name:this.name,additional_kwargs:this.additional_kwargs,response_metadata:this.response_metadata}}_updateId(e){this.id=e,this.lc_kwargs.id=e}get[Symbol.toStringTag](){return this.constructor.lc_name()}[Symbol.for("nodejs.util.inspect.custom")](e){var t,r;if(null===e)return this;let a=(t=this._printableFields,r=Math.max(4,e),JSON.stringify(function e(t,a){if("object"!=typeof t||null==t)return t;if(a>=r)return Array.isArray(t)?"[Array]":"[Object]";if(Array.isArray(t))return t.map(t=>e(t,a+1));let i={};for(let r of Object.keys(t))i[r]=e(t[r],a+1);return i}(t,0),null,2));return`${this.constructor.lc_name()} ${a}`}}function is(e,t){let r={...e};for(let[e,a]of Object.entries(t))if(null==r[e])r[e]=a;else if(null==a)continue;else if(typeof r[e]!=typeof a||Array.isArray(r[e])!==Array.isArray(a))throw Error(`field[${e}] already exists in the message chunk, but with a different type.`);else if("string"==typeof r[e]){if("type"===e)continue;r[e]+=a}else if("object"!=typeof r[e]||Array.isArray(r[e]))if(Array.isArray(r[e]))r[e]=io(r[e],a);else{if(r[e]===a)continue;console.warn(`field[${e}] already exists in this message chunk and value has unsupported type.`)}else r[e]=is(r[e],a);return r}function io(e,t){if(void 0!==e||void 0!==t){if(void 0===e||void 0===t)return e||t;let r=[...e];for(let e of t)if("object"==typeof e&&"index"in e&&"number"==typeof e.index){let t=r.findIndex(t=>t.index===e.index);-1!==t?r[t]=is(r[t],e):r.push(e)}else{if("object"==typeof e&&"text"in e&&""===e.text)continue;r.push(e)}return r}}class il extends ii{}function iu(e){return"function"==typeof e?._getType}class ic extends ii{static lc_name(){return"ToolMessage"}get lc_aliases(){return{tool_call_id:"tool_call_id"}}constructor(e,t,r){"string"==typeof e&&(e={content:e,name:r,tool_call_id:t}),super(e),Object.defineProperty(this,"lc_direct_tool_output",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status,this.metadata=e.metadata}_getType(){return"tool"}static isInstance(e){return"tool"===e._getType()}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class id extends il{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"artifact",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id,this.artifact=e.artifact,this.status=e.status}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){var t,r;return new id({content:ia(this.content,e.content),additional_kwargs:is(this.additional_kwargs,e.additional_kwargs),response_metadata:is(this.response_metadata,e.response_metadata),artifact:function(e,t){if(!e&&!t)throw Error("Cannot merge two undefined objects.");if(!e||!t)return e||t;if(typeof e!=typeof t)throw Error(`Cannot merge objects of different types.
Left ${typeof e}
Right ${typeof t}`);if("string"==typeof e&&"string"==typeof t)return e+t;if(Array.isArray(e)&&Array.isArray(t))return io(e,t);if("object"==typeof e&&"object"==typeof t)return is(e,t);else if(e===t)return e;else throw Error(`Can not merge objects of different types.
Left ${e}
Right ${t}`)}(this.artifact,e.artifact),tool_call_id:this.tool_call_id,id:this.id??e.id,status:(t=this.status,r=e.status,"error"===t||"error"===r?"error":"success")})}get _printableFields(){return{...super._printableFields,tool_call_id:this.tool_call_id,artifact:this.artifact}}}class ih extends ii{get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls"}}constructor(e,t){let r;if("string"==typeof e)r={content:e,tool_calls:[],invalid_tool_calls:[],additional_kwargs:t??{}};else{r=e;let t=r.additional_kwargs?.tool_calls,a=r.tool_calls;null!=t&&t.length>0&&(void 0===a||0===a.length)&&console.warn("New LangChain packages are available that more efficiently handle tool calling.\n\nPlease upgrade your packages to versions that set message tool calls. e.g., `yarn add @langchain/anthropic`, yarn add @langchain/openai`, etc.");try{if(null!=t&&void 0===a){let[e,a]=function(e){let t=[],r=[];for(let a of e)if(!a.function)continue;else{let e=a.function.name;try{let r=JSON.parse(a.function.arguments),i={name:e||"",args:r||{},id:a.id};t.push(i)}catch(t){r.push({name:e,args:a.function.arguments,id:a.id,error:"Malformed args."})}}return[t,r]}(t);r.tool_calls=e??[],r.invalid_tool_calls=a??[]}else r.tool_calls=r.tool_calls??[],r.invalid_tool_calls=r.invalid_tool_calls??[]}catch(e){r.tool_calls=[],r.invalid_tool_calls=[]}}super(r),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"string"!=typeof r&&(this.tool_calls=r.tool_calls??this.tool_calls,this.invalid_tool_calls=r.invalid_tool_calls??this.invalid_tool_calls),this.usage_metadata=r.usage_metadata}static lc_name(){return"AIMessage"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}}function ip(e){return"ai"===e._getType()}function im(e){return"ai"===e._getType()}class ig extends il{constructor(e){let t;if("string"==typeof e)t={content:e,tool_calls:[],invalid_tool_calls:[],tool_call_chunks:[]};else if(void 0===e.tool_call_chunks)t={...e,tool_calls:e.tool_calls??[],invalid_tool_calls:[],tool_call_chunks:[],usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0};else{let r=e.tool_call_chunks.reduce((e,t)=>{let r=t.id||`fallback-${t.index||0}`;return e[r]=e[r]??[],e[r].push(t),e},{}),a=[],i=[];for(let[e,t]of Object.entries(r)){let r={},n=t[0]?.name??"",s=t.map(e=>e.args||"").join(""),o=s.length?s:"{}",l=t[0]?.id||e;try{if(r=a5(o),null===r||"object"!=typeof r||Array.isArray(r))throw Error("Malformed tool call chunk args.");a.push({name:n,args:r,id:l,type:"tool_call"})}catch(e){i.push({name:n,args:o,id:l,error:"Malformed args.",type:"invalid_tool_call"})}}t={...e,tool_calls:a,invalid_tool_calls:i,usage_metadata:void 0!==e.usage_metadata?e.usage_metadata:void 0}}super(t),Object.defineProperty(this,"tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"invalid_tool_calls",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tool_call_chunks",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"usage_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_chunks=t.tool_call_chunks??this.tool_call_chunks,this.tool_calls=t.tool_calls??this.tool_calls,this.invalid_tool_calls=t.invalid_tool_calls??this.invalid_tool_calls,this.usage_metadata=t.usage_metadata}get lc_aliases(){return{...super.lc_aliases,tool_calls:"tool_calls",invalid_tool_calls:"invalid_tool_calls",tool_call_chunks:"tool_call_chunks"}}static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}get _printableFields(){return{...super._printableFields,tool_calls:this.tool_calls,tool_call_chunks:this.tool_call_chunks,invalid_tool_calls:this.invalid_tool_calls,usage_metadata:this.usage_metadata}}concat(e){let t={content:ia(this.content,e.content),additional_kwargs:is(this.additional_kwargs,e.additional_kwargs),response_metadata:is(this.response_metadata,e.response_metadata),tool_call_chunks:[],id:this.id??e.id};if(void 0!==this.tool_call_chunks||void 0!==e.tool_call_chunks){let r=io(this.tool_call_chunks,e.tool_call_chunks);void 0!==r&&r.length>0&&(t.tool_call_chunks=r)}if(void 0!==this.usage_metadata||void 0!==e.usage_metadata){let r={...(this.usage_metadata?.input_token_details?.audio!==void 0||e.usage_metadata?.input_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.input_token_details?.audio??0)+(e.usage_metadata?.input_token_details?.audio??0)},...(this.usage_metadata?.input_token_details?.cache_read!==void 0||e.usage_metadata?.input_token_details?.cache_read!==void 0)&&{cache_read:(this.usage_metadata?.input_token_details?.cache_read??0)+(e.usage_metadata?.input_token_details?.cache_read??0)},...(this.usage_metadata?.input_token_details?.cache_creation!==void 0||e.usage_metadata?.input_token_details?.cache_creation!==void 0)&&{cache_creation:(this.usage_metadata?.input_token_details?.cache_creation??0)+(e.usage_metadata?.input_token_details?.cache_creation??0)}},a={...(this.usage_metadata?.output_token_details?.audio!==void 0||e.usage_metadata?.output_token_details?.audio!==void 0)&&{audio:(this.usage_metadata?.output_token_details?.audio??0)+(e.usage_metadata?.output_token_details?.audio??0)},...(this.usage_metadata?.output_token_details?.reasoning!==void 0||e.usage_metadata?.output_token_details?.reasoning!==void 0)&&{reasoning:(this.usage_metadata?.output_token_details?.reasoning??0)+(e.usage_metadata?.output_token_details?.reasoning??0)}},i=this.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0},n=e.usage_metadata??{input_tokens:0,output_tokens:0,total_tokens:0};t.usage_metadata={input_tokens:i.input_tokens+n.input_tokens,output_tokens:i.output_tokens+n.output_tokens,total_tokens:i.total_tokens+n.total_tokens,...Object.keys(r).length>0&&{input_token_details:r},...Object.keys(a).length>0&&{output_token_details:a}}}return new ig(t)}}class iy extends ii{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return iy}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return"generic"===e._getType()}get _printableFields(){return{...super._printableFields,role:this.role}}}class ib extends il{static lc_name(){return"ChatMessageChunk"}constructor(e,t){"string"==typeof e&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new ib({content:ia(this.content,e.content),additional_kwargs:is(this.additional_kwargs,e.additional_kwargs),response_metadata:is(this.response_metadata,e.response_metadata),role:this.role,id:this.id??e.id})}get _printableFields(){return{...super._printableFields,role:this.role}}}class i_ extends il{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new i_({content:ia(this.content,e.content),additional_kwargs:is(this.additional_kwargs,e.additional_kwargs),response_metadata:is(this.response_metadata,e.response_metadata),name:this.name??"",id:this.id??e.id})}}class iw extends ii{static lc_name(){return"HumanMessage"}_getType(){return"human"}constructor(e,t){super(e,t)}}class iv extends il{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}constructor(e,t){super(e,t)}concat(e){return new iv({content:ia(this.content,e.content),additional_kwargs:is(this.additional_kwargs,e.additional_kwargs),response_metadata:is(this.response_metadata,e.response_metadata),id:this.id??e.id})}}class iE extends ii{static lc_name(){return"SystemMessage"}_getType(){return"system"}constructor(e,t){super(e,t)}}class iO extends il{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}constructor(e,t){super(e,t)}concat(e){return new iO({content:ia(this.content,e.content),additional_kwargs:is(this.additional_kwargs,e.additional_kwargs),response_metadata:is(this.response_metadata,e.response_metadata),id:this.id??e.id})}}function ik(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}function iS(e){return!!(e&&"object"==typeof e&&"type"in e&&"tool_call"===e.type)}class ix extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}}function i$(e){return iS(e)?e:"string"==typeof e.id&&"function"===e.type&&"object"==typeof e.function&&null!==e.function&&"arguments"in e.function&&"string"==typeof e.function.arguments&&"name"in e.function&&"string"==typeof e.function.name?{id:e.id,args:JSON.parse(e.function.arguments),name:e.function.name,type:"tool_call"}:e}function iI(e){let t,r;if("object"==typeof e&&null!=e&&1===e.lc&&Array.isArray(e.id)&&null!=e.kwargs&&"object"==typeof e.kwargs){let a=e.id.at(-1);t="HumanMessage"===a||"HumanMessageChunk"===a?"user":"AIMessage"===a||"AIMessageChunk"===a?"assistant":"SystemMessage"===a||"SystemMessageChunk"===a?"system":"FunctionMessage"===a||"FunctionMessageChunk"===a?"function":"ToolMessage"===a||"ToolMessageChunk"===a?"tool":"unknown",r=e.kwargs}else{let{type:a,...i}=e;t=a,r=i}if("human"===t||"user"===t)return new iw(r);if("ai"===t||"assistant"===t){let{tool_calls:e,...t}=r;if(!Array.isArray(e))return new ih(r);let a=e.map(i$);return new ih({...t,tool_calls:a})}if("system"===t)return new iE(r);if("developer"===t)return new iE({...r,additional_kwargs:{...r.additional_kwargs,__openai_role__:"developer"}});if("tool"===t&&"tool_call_id"in r)return new ic({...r,content:r.content,tool_call_id:r.tool_call_id,name:r.name});throw ik(Error(`Unable to coerce message from array: only human, AI, system, developer, or tool message coercion is currently supported.

Received: ${JSON.stringify(e,null,2)}`),"MESSAGE_COERCION_FAILURE")}function iA(e){if("string"==typeof e)return new iw(e);if(iu(e))return e;if(Array.isArray(e)){let[t,r]=e;return iI({type:t,content:r})}if("string"!=typeof e.role)return iI(e);{let{role:t,...r}=e;return iI({...r,type:t})}}function iT(e,t="Human",r="AI"){let a=[];for(let i of e){let e;if("human"===i._getType())e=t;else if("ai"===i._getType())e=r;else if("system"===i._getType())e="System";else if("function"===i._getType())e="Function";else if("tool"===i._getType())e="Tool";else if("generic"===i._getType())e=i.role;else throw Error(`Got unsupported message type: ${i._getType()}`);let n=i.name?`${i.name}, `:"",s="string"==typeof i.content?i.content:JSON.stringify(i.content,null,2);a.push(`${e}: ${n}${s}`)}return a.join("\n")}var iP=r(33692),ij=r(24116);let iN="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);for(var iR=new Uint8Array(16),iC=[],iL=0;iL<256;++iL)iC.push((iL+256).toString(16).slice(1));let iM=function(e,t,r){if(iN&&!t&&!e)return iN();var a=(e=e||{}).random||(e.rng||function(){if(!eQ&&!(eQ="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return eQ(iR)})();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(var i=0;i<16;++i)t[r+i]=a[i];return t}return function(e,t=0){return(iC[e[t+0]]+iC[e[t+1]]+iC[e[t+2]]+iC[e[t+3]]+"-"+iC[e[t+4]]+iC[e[t+5]]+"-"+iC[e[t+6]]+iC[e[t+7]]+"-"+iC[e[t+8]]+iC[e[t+9]]+"-"+iC[e[t+10]]+iC[e[t+11]]+iC[e[t+12]]+iC[e[t+13]]+iC[e[t+14]]+iC[e[t+15]]).toLowerCase()}(a)},iU=Symbol.for("ls:tracing_async_local_storage"),iD=new class{getStore(){}run(e,t){return t()}},iz=new class{getInstance(){return globalThis[iU]??iD}initializeGlobalInstance(e){void 0===globalThis[iU]&&(globalThis[iU]=e)}};function iF(e){return"function"==typeof e&&"langsmith:traceable"in e}Symbol.for("langsmith:traceable:root");let iB=Object.prototype.hasOwnProperty;function iq(e,t){return iB.call(e,t)}function iH(e){if(Array.isArray(e)){let t=Array(e.length);for(let e=0;e<t.length;e++)t[e]=""+e;return t}if(Object.keys)return Object.keys(e);let t=[];for(let r in e)iq(e,r)&&t.push(r);return t}function iW(e){switch(typeof e){case"object":return JSON.parse(JSON.stringify(e));case"undefined":return null;default:return e}}function iJ(e){let t,r=0,a=e.length;for(;r<a;){if((t=e.charCodeAt(r))>=48&&t<=57){r++;continue}return!1}return!0}function iG(e){return -1===e.indexOf("/")&&-1===e.indexOf("~")?e:e.replace(/~/g,"~0").replace(/\//g,"~1")}function iZ(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function iV(e,t){let r=[e];for(let e in t){let a="object"==typeof t[e]?JSON.stringify(t[e],null,2):t[e];void 0!==a&&r.push(`${e}: ${a}`)}return r.join("\n")}class iY extends Error{constructor(e,t,r,a,i){super(iV(e,{name:t,index:r,operation:a,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=iV(e,{name:t,index:r,operation:a,tree:i})}}let iK=iY,iX=iW,iQ={add:function(e,t,r){return e[t]=this.value,{newDocument:r}},remove:function(e,t,r){var a=e[t];return delete e[t],{newDocument:r,removed:a}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:function(e,t,r){let a=i1(r,this.path);a&&(a=iW(a));let i=i2(r,{op:"remove",path:this.from}).removed;return i2(r,{op:"add",path:this.path,value:i}),{newDocument:r,removed:a}},copy:function(e,t,r){let a=i1(r,this.from);return i2(r,{op:"add",path:this.path,value:iW(a)}),{newDocument:r}},test:function(e,t,r){return{newDocument:r,test:i6(e[t],this.value)}},_get:function(e,t,r){return this.value=e[t],{newDocument:r}}};var i0={add:function(e,t,r){return iJ(t)?e.splice(t,0,this.value):e[t]=this.value,{newDocument:r,index:t}},remove:function(e,t,r){return{newDocument:r,removed:e.splice(t,1)[0]}},replace:function(e,t,r){var a=e[t];return e[t]=this.value,{newDocument:r,removed:a}},move:iQ.move,copy:iQ.copy,test:iQ.test,_get:iQ._get};function i1(e,t){if(""==t)return e;var r={op:"_get",path:t};return i2(e,r),r.value}function i2(e,t,r=!1,a=!0,i=!0,n=0){if(r&&("function"==typeof r?r(t,0,e,t.path):i9(t,0)),""===t.path){let a={newDocument:e};if("add"===t.op)return a.newDocument=t.value,a;if("replace"===t.op)return a.newDocument=t.value,a.removed=e,a;if("move"===t.op||"copy"===t.op)return a.newDocument=i1(e,t.from),"move"===t.op&&(a.removed=e),a;else if("test"===t.op){if(a.test=i6(e,t.value),!1===a.test)throw new iK("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return a.newDocument=e,a}else if("remove"===t.op)return a.removed=e,a.newDocument=null,a;else if("_get"===t.op)return t.value=e,a;else if(!r)return a;else throw new iK("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",n,t,e)}{let s,o,l;a||(e=iW(e));let u=(t.path||"").split("/"),c=e,d=1,h=u.length;for(o="function"==typeof r?r:i9;;){if((s=u[d])&&-1!=s.indexOf("~")&&(s=iZ(s)),i&&("__proto__"==s||"prototype"==s&&d>0&&"constructor"==u[d-1]))throw TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(r&&void 0===l&&(void 0===c[s]?l=u.slice(0,d).join("/"):d==h-1&&(l=t.path),void 0!==l&&o(t,0,e,l)),d++,Array.isArray(c)){if("-"===s)s=c.length;else if(r&&!iJ(s))throw new iK("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",n,t,e);else iJ(s)&&(s=~~s);if(d>=h){if(r&&"add"===t.op&&s>c.length)throw new iK("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",n,t,e);let a=i0[t.op].call(t,c,s,e);if(!1===a.test)throw new iK("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return a}}else if(d>=h){let r=iQ[t.op].call(t,c,s,e);if(!1===r.test)throw new iK("Test operation failed","TEST_OPERATION_FAILED",n,t,e);return r}if(c=c[s],r&&d<h&&(!c||"object"!=typeof c))throw new iK("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",n,t,e)}}}function i5(e,t,r,a=!0,i=!0){if(r&&!Array.isArray(t))throw new iK("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");a||(e=iW(e));let n=Array(t.length);for(let a=0,s=t.length;a<s;a++)n[a]=i2(e,t[a],r,!0,i,a),e=n[a].newDocument;return n.newDocument=e,n}function i4(e,t,r){let a=i2(e,t);if(!1===a.test)throw new iK("Test operation failed","TEST_OPERATION_FAILED",r,t,e);return a.newDocument}function i9(e,t,r,a){if("object"!=typeof e||null===e||Array.isArray(e))throw new iK("Operation is not an object","OPERATION_NOT_AN_OBJECT",t,e,r);if(iQ[e.op]){if("string"!=typeof e.path)throw new iK("Operation `path` property is not a string","OPERATION_PATH_INVALID",t,e,r);else if(0!==e.path.indexOf("/")&&e.path.length>0)throw new iK('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",t,e,r);else if(("move"===e.op||"copy"===e.op)&&"string"!=typeof e.from)throw new iK("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",t,e,r);else if(("add"===e.op||"replace"===e.op||"test"===e.op)&&void 0===e.value)throw new iK("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",t,e,r);else if(("add"===e.op||"replace"===e.op||"test"===e.op)&&function e(t){if(void 0===t)return!0;if(t){if(Array.isArray(t)){for(let r=0,a=t.length;r<a;r++)if(e(t[r]))return!0}else if("object"==typeof t){let a=iH(t),i=a.length;for(var r=0;r<i;r++)if(e(t[a[r]]))return!0}}return!1}(e.value))throw new iK("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",t,e,r);else if(r){if("add"==e.op){var i=e.path.split("/").length,n=a.split("/").length;if(i!==n+1&&i!==n)throw new iK("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",t,e,r)}else if("replace"===e.op||"remove"===e.op||"_get"===e.op){if(e.path!==a)throw new iK("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",t,e,r)}else if("move"===e.op||"copy"===e.op){var s=i3([{op:"_get",path:e.from,value:void 0}],r);if(s&&"OPERATION_PATH_UNRESOLVABLE"===s.name)throw new iK("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",t,e,r)}}}else throw new iK("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",t,e,r)}function i3(e,t,r){try{if(!Array.isArray(e))throw new iK("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(t)i5(iW(t),iW(e),r||!0);else{r=r||i9;for(var a=0;a<e.length;a++)r(e[a],a,t,void 0)}}catch(e){if(e instanceof iK)return e;throw e}}function i6(e,t){if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t){var r,a,i,n=Array.isArray(e),s=Array.isArray(t);if(n&&s){if((a=e.length)!=t.length)return!1;for(r=a;0!=r--;)if(!i6(e[r],t[r]))return!1;return!0}if(n!=s)return!1;var o=Object.keys(e);if((a=o.length)!==Object.keys(t).length)return!1;for(r=a;0!=r--;)if(!t.hasOwnProperty(o[r]))return!1;for(r=a;0!=r--;)if(!i6(e[i=o[r]],t[i]))return!1;return!0}return e!=e&&t!=t}new WeakMap,{...e3,JsonPatchError:iY,deepClone:iW,escapePathComponent:iG,unescapePathComponent:iZ};let i8="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);for(var i7=new Uint8Array(16),ne=[],nt=0;nt<256;++nt)ne.push((nt+256).toString(16).slice(1));function nr(e,t=0){return(ne[e[t+0]]+ne[e[t+1]]+ne[e[t+2]]+ne[e[t+3]]+"-"+ne[e[t+4]]+ne[e[t+5]]+"-"+ne[e[t+6]]+ne[e[t+7]]+"-"+ne[e[t+8]]+ne[e[t+9]]+"-"+ne[e[t+10]]+ne[e[t+11]]+ne[e[t+12]]+ne[e[t+13]]+ne[e[t+14]]+ne[e[t+15]]).toLowerCase()}let na=function(e,t,r){if(i8&&!t&&!e)return i8();var a=(e=e||{}).random||(e.rng||function(){if(!e0&&!(e0="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return e0(i7)})();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t){r=r||0;for(var i=0;i<16;++i)t[r+i]=a[i];return t}return nr(a)},ni=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,nn=function(e){if(!("string"==typeof e&&ni.test(e)))throw TypeError("Invalid UUID");var t,r=new Uint8Array(16);return r[0]=(t=parseInt(e.slice(0,8),16))>>>24,r[1]=t>>>16&255,r[2]=t>>>8&255,r[3]=255&t,r[4]=(t=parseInt(e.slice(9,13),16))>>>8,r[5]=255&t,r[6]=(t=parseInt(e.slice(14,18),16))>>>8,r[7]=255&t,r[8]=(t=parseInt(e.slice(19,23),16))>>>8,r[9]=255&t,r[10]=(t=parseInt(e.slice(24,36),16))/0x10000000000&255,r[11]=t/0x100000000&255,r[12]=t>>>24&255,r[13]=t>>>16&255,r[14]=t>>>8&255,r[15]=255&t,r};function ns(e,t){return e<<t|e>>>32-t}var no=function(e,t,r){function a(e,t,a,i){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],r=0;r<e.length;++r)t.push(e.charCodeAt(r));return t}(e)),"string"==typeof t&&(t=nn(t)),(null==(n=t)?void 0:n.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var n,s=new Uint8Array(16+e.length);if(s.set(t),s.set(e,t.length),(s=r(s))[6]=15&s[6]|80,s[8]=63&s[8]|128,a){i=i||0;for(var o=0;o<16;++o)a[i+o]=s[o];return a}return nr(s)}try{a.name="v5"}catch(e){}return a.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",a.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",a}(0,0,function(e){var t=[0x5a827999,0x6ed9eba1,0x8f1bbcdc,0xca62c1d6],r=[0x67452301,0xefcdab89,0x98badcfe,0x10325476,0xc3d2e1f0];if("string"==typeof e){var a=unescape(encodeURIComponent(e));e=[];for(var i=0;i<a.length;++i)e.push(a.charCodeAt(i))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var n=Math.ceil((e.length/4+2)/16),s=Array(n),o=0;o<n;++o){for(var l=new Uint32Array(16),u=0;u<16;++u)l[u]=e[64*o+4*u]<<24|e[64*o+4*u+1]<<16|e[64*o+4*u+2]<<8|e[64*o+4*u+3];s[o]=l}s[n-1][14]=(e.length-1)*8/0x100000000,s[n-1][14]=Math.floor(s[n-1][14]),s[n-1][15]=(e.length-1)*8|0;for(var c=0;c<n;++c){for(var d=new Uint32Array(80),h=0;h<16;++h)d[h]=s[c][h];for(var p=16;p<80;++p)d[p]=ns(d[p-3]^d[p-8]^d[p-14]^d[p-16],1);for(var f=r[0],m=r[1],g=r[2],y=r[3],b=r[4],_=0;_<80;++_){var w=Math.floor(_/20),v=ns(f,5)+function(e,t,r,a){switch(e){case 0:return t&r^~t&a;case 1:case 3:return t^r^a;case 2:return t&r^t&a^r&a}}(w,m,g,y)+b+t[w]+d[_]>>>0;b=y,y=g,g=ns(m,30)>>>0,m=f,f=v}r[0]=r[0]+f>>>0,r[1]=r[1]+m>>>0,r[2]=r[2]+g>>>0,r[3]=r[3]+y>>>0,r[4]=r[4]+b>>>0}return[r[0]>>24&255,r[0]>>16&255,r[0]>>8&255,255&r[0],r[1]>>24&255,r[1]>>16&255,r[1]>>8&255,255&r[1],r[2]>>24&255,r[2]>>16&255,r[2]>>8&255,255&r[2],r[3]>>24&255,r[3]>>16&255,r[3]>>8&255,255&r[3],r[4]>>24&255,r[4]>>16&255,r[4]>>8&255,255&r[4]]});let nl="gen_ai.request.model",nu="gen_ai.usage.input_tokens",nc="gen_ai.usage.output_tokens",nd="gen_ai.usage.total_tokens",nh="langsmith.span.tags",np=Symbol.for("ls:fetch_implementation"),nf=()=>n_("PROJECT")??nb("LANGCHAIN_SESSION")??"default",nm="0.3.65",ng=()=>l||(l="undefined"!=typeof Bun?"bun":"undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||"undefined"!=typeof Deno?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&navigator.userAgent.includes("jsdom")?"jsdom":"undefined"!=typeof Deno?"deno":"other":"node");function ny(){return void 0===u&&(u={library:"langsmith",runtime:ng(),sdk:"langsmith-js",sdk_version:nm,...function(){if(void 0!==c)return c;let e={};for(let t of["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"]){let r=nb(t);void 0!==r&&(e[t]=r)}return c=e,e}()}),u}function nb(e){try{return"undefined"!=typeof process?process.env?.[e]:void 0}catch(e){return}}function n_(e){return nb(`LANGSMITH_${e}`)||nb(`LANGCHAIN_${e}`)}function nw(){return"true"===nb("OTEL_ENABLED")||"true"===n_("OTEL_ENABLED")}class nv{constructor(){Object.defineProperty(this,"hasWarned",{enumerable:!0,configurable:!0,writable:!0,value:!1})}startActiveSpan(e,...t){let r;if(!this.hasWarned&&nw()&&(console.warn('You have enabled OTEL export via the `OTEL_ENABLED` or `LANGSMITH_OTEL_ENABLED` environment variable, but have not initialized the required OTEL instances. Please add:\n```\nimport { initializeOTEL } from "langsmith/experimental/otel/setup";\ninitializeOTEL();\n```\nat the beginning of your code.'),this.hasWarned=!0),1===t.length&&"function"==typeof t[0]?r=t[0]:2===t.length&&"function"==typeof t[1]?r=t[1]:3===t.length&&"function"==typeof t[2]&&(r=t[2]),"function"==typeof r)return r()}}let nE=Symbol.for("ls:otel_trace"),nO=Symbol.for("ls:otel_context"),nk=Symbol.for("ls:otel_get_default_otlp_tracer_provider"),nS=new class{constructor(){Object.defineProperty(this,"mockTracer",{enumerable:!0,configurable:!0,writable:!0,value:new nv})}getTracer(e,t){return this.mockTracer}getActiveSpan(){}setSpan(e,t){return e}getSpan(e){}setSpanContext(e,t){return e}getTracerProvider(){}setGlobalTracerProvider(e){return!1}},nx=new class{active(){return{}}with(e,t){return t()}},n$=new class{getTraceInstance(){return globalThis[nE]??nS}getContextInstance(){return globalThis[nO]??nx}initializeGlobalInstances(e){void 0===globalThis[nE]&&(globalThis[nE]=e.trace),void 0===globalThis[nO]&&(globalThis[nO]=e.context)}setDefaultOTLPTracerComponents(e){globalThis[nk]=e}getDefaultOTLPTracerComponents(){return globalThis[nk]??void 0}};function nI(){return n$.getTraceInstance()}let nA={llm:"chat",tool:"execute_tool",retriever:"embeddings",embedding:"embeddings",prompt:"chat"};class nT{constructor(){Object.defineProperty(this,"spans",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}exportBatch(e,t){for(let r of e)try{if(!r.run)continue;if("post"===r.operation){let e=this.createSpanForRun(r,r.run,t.get(r.id));e&&!r.run.end_time&&this.spans.set(r.id,e)}else this.updateSpanForRun(r,r.run)}catch(e){console.error(`Error processing operation ${r.id}:`,e)}}createSpanForRun(e,t,r){let a=r&&nI().getSpan(r);if(a)try{return this.finishSpanSetup(a,t,e)}catch(t){console.error(`Failed to create span for run ${e.id}:`,t);return}}finishSpanSetup(e,t,r){return this.setSpanAttributes(e,t,r),t.error?(e.setStatus({code:2}),e.recordException(Error(t.error))):e.setStatus({code:1}),t.end_time&&e.end(new Date(t.end_time)),e}updateSpanForRun(e,t){try{let r=this.spans.get(e.id);if(!r)return void console.debug(`No span found for run ${e.id} during update`);this.setSpanAttributes(r,t,e),t.error?(r.setStatus({code:2}),r.recordException(Error(t.error))):r.setStatus({code:1});let a=t.end_time;a&&(r.end(new Date(a)),this.spans.delete(e.id))}catch(t){console.error(`Failed to update span for run ${e.id}:`,t)}}extractModelName(e){if(e.extra?.metadata){let t=e.extra.metadata;if(t.ls_model_name)return t.ls_model_name;if(t.invocation_params){let e=t.invocation_params;if(e.model)return e.model;if(e.model_name)return e.model_name}}}setSpanAttributes(e,t,r){if("run_type"in t&&t.run_type){var a;e.setAttribute("langsmith.span.kind",t.run_type);let r=nA[a=t.run_type||"chain"]||a;e.setAttribute("gen_ai.operation.name",r)}"name"in t&&t.name&&e.setAttribute("langsmith.trace.name",t.name),"session_id"in t&&t.session_id&&e.setAttribute("langsmith.trace.session_id",t.session_id),"session_name"in t&&t.session_name&&e.setAttribute("langsmith.trace.session_name",t.session_name),this.setGenAiSystem(e,t);let i=this.extractModelName(t);for(let[r,a]of(i&&e.setAttribute(nl,i),"prompt_tokens"in t&&"number"==typeof t.prompt_tokens&&e.setAttribute(nu,t.prompt_tokens),"completion_tokens"in t&&"number"==typeof t.completion_tokens&&e.setAttribute(nc,t.completion_tokens),"total_tokens"in t&&"number"==typeof t.total_tokens&&e.setAttribute(nd,t.total_tokens),this.setInvocationParameters(e,t),Object.entries(t.extra?.metadata||{})))null!=a&&e.setAttribute(`langsmith.metadata.${r}`,String(a));let n=t.tags;if(n&&Array.isArray(n)?e.setAttribute(nh,n.join(", ")):n&&e.setAttribute(nh,String(n)),"serialized"in t&&"object"==typeof t.serialized){let r=t.serialized;r.name&&e.setAttribute("gen_ai.serialized.name",String(r.name)),r.signature&&e.setAttribute("gen_ai.serialized.signature",String(r.signature)),r.doc&&e.setAttribute("gen_ai.serialized.doc",String(r.doc))}this.setIOAttributes(e,r)}setGenAiSystem(e,t){let r="langchain",a=this.extractModelName(t);if(a){let e=a.toLowerCase();e.includes("anthropic")||e.startsWith("claude")?r="anthropic":e.includes("bedrock")?r="aws.bedrock":e.includes("azure")&&e.includes("openai")?r="az.ai.openai":e.includes("azure")&&e.includes("inference")?r="az.ai.inference":e.includes("cohere")?r="cohere":e.includes("deepseek")?r="deepseek":e.includes("gemini")?r="gemini":e.includes("groq")?r="groq":e.includes("watson")||e.includes("ibm")?r="ibm.watsonx.ai":e.includes("mistral")?r="mistral_ai":e.includes("gpt")||e.includes("openai")?r="openai":e.includes("perplexity")||e.includes("sonar")?r="perplexity":e.includes("vertex")?r="vertex_ai":(e.includes("xai")||e.includes("grok"))&&(r="xai")}e.setAttribute("gen_ai.system",r)}setInvocationParameters(e,t){if(!t.extra?.metadata?.invocation_params)return;let r=t.extra.metadata.invocation_params;void 0!==r.max_tokens&&e.setAttribute("gen_ai.request.max_tokens",r.max_tokens),void 0!==r.temperature&&e.setAttribute("gen_ai.request.temperature",r.temperature),void 0!==r.top_p&&e.setAttribute("gen_ai.request.top_p",r.top_p),void 0!==r.frequency_penalty&&e.setAttribute("gen_ai.request.frequency_penalty",r.frequency_penalty),void 0!==r.presence_penalty&&e.setAttribute("gen_ai.request.presence_penalty",r.presence_penalty)}setIOAttributes(e,t){if(t.run.inputs)try{let r=t.run.inputs;"object"==typeof r&&null!==r&&(r.model&&Array.isArray(r.messages)&&e.setAttribute(nl,r.model),void 0!==r.stream&&e.setAttribute("langsmith.request.streaming",r.stream),r.extra_headers&&e.setAttribute("langsmith.request.headers",JSON.stringify(r.extra_headers)),r.extra_query&&e.setAttribute("gen_ai.request.extra_query",JSON.stringify(r.extra_query)),r.extra_body&&e.setAttribute("gen_ai.request.extra_body",JSON.stringify(r.extra_body))),e.setAttribute("gen_ai.prompt",JSON.stringify(r))}catch(e){console.debug(`Failed to process inputs for run ${t.id}`,e)}if(t.run.outputs)try{let r=t.run.outputs,a=this.getUnifiedRunTokens(r);if(a&&(e.setAttribute(nu,a[0]),e.setAttribute(nc,a[1]),e.setAttribute(nd,a[0]+a[1])),r&&"object"==typeof r){if(r.model&&e.setAttribute("gen_ai.response.model",String(r.model)),r.id&&e.setAttribute("gen_ai.response.id",r.id),r.choices&&Array.isArray(r.choices)){let t=r.choices.map(e=>e.finish_reason).filter(e=>e).map(String);t.length>0&&e.setAttribute("gen_ai.response.finish_reasons",t.join(", "))}if(r.service_tier&&e.setAttribute("gen_ai.response.service_tier",r.service_tier),r.system_fingerprint&&e.setAttribute("gen_ai.response.system_fingerprint",r.system_fingerprint),r.usage_metadata&&"object"==typeof r.usage_metadata){let t=r.usage_metadata;t.input_token_details&&e.setAttribute("gen_ai.usage.input_token_details",JSON.stringify(t.input_token_details)),t.output_token_details&&e.setAttribute("gen_ai.usage.output_token_details",JSON.stringify(t.output_token_details))}}e.setAttribute("gen_ai.completion",JSON.stringify(r))}catch(e){console.debug(`Failed to process outputs for run ${t.id}`,e)}}getUnifiedRunTokens(e){if(!e)return null;let t=this.extractUnifiedRunTokens(e.usage_metadata);if(t)return t;for(let r of Object.keys(e)){let a=e[r];if(a&&"object"==typeof a&&((t=this.extractUnifiedRunTokens(a.usage_metadata))||1===a.lc&&a.kwargs&&"object"==typeof a.kwargs&&(t=this.extractUnifiedRunTokens(a.kwargs.usage_metadata))))return t}let r=e.generations||[];if(!Array.isArray(r))return null;for(let e of Array.isArray(r[0])?r.flat():r)if("object"==typeof e&&e.message&&"object"==typeof e.message&&e.message.kwargs&&"object"==typeof e.message.kwargs&&(t=this.extractUnifiedRunTokens(e.message.kwargs.usage_metadata)))return t;return null}extractUnifiedRunTokens(e){return e&&"object"==typeof e&&"number"==typeof e.input_tokens&&"number"==typeof e.output_tokens?[e.input_tokens,e.output_tokens]:null}}var nP=r(73290);let nj=[429,500,502,503,504];class nN{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,"default"in nP?this.queue=new nP.default({concurrency:this.maxConcurrency}):this.queue=new nP({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e?.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>ij(()=>e(...t).catch(e=>{if(e instanceof Error)throw e;throw Error(e)}),{async onFailedAttempt(e){if(e.message.startsWith("Cancel")||e.message.startsWith("TimeoutError")||"TimeoutError"===e.name||e.message.startsWith("AbortError")||e?.code==="ECONNABORTED")throw e;let t=e?.response;if(r&&await r(t))return;let a=t?.status??e?.status;if(a&&!nj.includes(+a))throw e},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((t,r)=>{e.signal?.addEventListener("abort",()=>{r(Error("AbortError"))})})]):this.call(t,...r)}}function nR(e){return"function"==typeof e?._getType}function nC(e){let t={type:e._getType(),data:{content:e.content}};return e?.additional_kwargs&&Object.keys(e.additional_kwargs).length>0&&(t.data.additional_kwargs={...e.additional_kwargs}),t}let nL=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;function nM(e,t){if(!nL.test(e))throw Error(void 0!==t?`Invalid UUID for ${t}: ${e}`:`Invalid UUID: ${e}`);return e}let nU={};function nD(e){nU[e]||(console.warn(e),nU[e]=!0)}function nz(e){if(!e||e.split("/").length>2||e.startsWith("/")||e.endsWith("/")||e.split(":").length>2)throw Error(`Invalid identifier format: ${e}`);let[t,r]=e.split(":"),a=r||"latest";if(t.includes("/")){let[r,i]=t.split("/",2);if(!r||!i)throw Error(`Invalid identifier format: ${e}`);return[r,i,a]}if(!t)throw Error(`Invalid identifier format: ${e}`);return["-",t,a]}r(41251);class nF extends Error{constructor(e){super(e),Object.defineProperty(this,"status",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="LangSmithConflictError",this.status=409}}async function nB(e,t,r){let a;if(e.ok){r&&(a=await e.text());return}if(403===e.status)try{let t=await e.json(),r=t?.error;if("org_scoped_key_requires_workspace"===r)throw Error("This API key is org-scoped and requires workspace specification. Please provide 'workspaceId' parameter, or set LANGSMITH_WORKSPACE_ID environment variable.")}catch(t){throw Error(`${e.status} ${e.statusText}`)}a=await e.text();let i=`Failed to ${t}. Received status [${e.status}]: ${e.statusText}. Server response: ${a}`;if(409===e.status)throw new nF(i);let n=Error(i);throw n.status=e.status,n}let nq="ERR_CONFLICTING_ENDPOINTS";class nH extends Error{constructor(){super("You cannot provide both LANGSMITH_ENDPOINT / LANGCHAIN_ENDPOINT and LANGSMITH_RUNS_ENDPOINTS."),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:nq}),this.name="ConflictingEndpointsError"}}var nW={result:"[Circular]"},nJ=[],nG=[];let nZ=new TextEncoder;function nV(e){return nZ.encode(e)}function nY(e){if(e&&"object"==typeof e&&null!==e){if(e instanceof Map)return Object.fromEntries(e);else if(e instanceof Set)return Array.from(e);else if(e instanceof Date)return e.toISOString();else if(e instanceof RegExp)return e.toString();else if(e instanceof Error)return{name:e.name,message:e.message}}else if("bigint"==typeof e)return e.toString();return e}function nK(e,t,r,a,i){try{let t=JSON.stringify(e,function(e,t){if(r){let a=r.call(this,e,t);if(void 0!==a)return a}return nY(t)},a);return nV(t)}catch(o){let s;if(!o.message?.includes("Converting circular structure to JSON"))return console.warn(`[WARNING]: LangSmith received unserializable value.${t?`
Context: ${t}`:""}`),nV("[Unserializable]");"true"!==n_("SUPPRESS_CIRCULAR_JSON_WARNINGS")&&console.warn(`[WARNING]: LangSmith received circular JSON. This will decrease tracer performance. ${t?`
Context: ${t}`:""}`),void 0===i&&(i={depthLimit:Number.MAX_SAFE_INTEGER,edgesLimit:Number.MAX_SAFE_INTEGER}),function e(t,r,a,i,n,s,o){if(s+=1,"object"==typeof t&&null!==t){for(l=0;l<i.length;l++)if(i[l]===t)return void nX(nW,t,r,n);if(void 0!==o.depthLimit&&s>o.depthLimit||void 0!==o.edgesLimit&&a+1>o.edgesLimit)return void nX("[...]",t,r,n);if(i.push(t),Array.isArray(t))for(l=0;l<t.length;l++)e(t[l],l,l,i,t,s,o);else{var l,u=Object.keys(t=nY(t));for(l=0;l<u.length;l++){var c=u[l];e(t[c],c,l,i,t,s,o)}}i.pop()}}(e,"",0,[],void 0,0,i);try{var n;s=0===nG.length?JSON.stringify(e,r,a):JSON.stringify(e,(n=r,n=void 0!==n?n:function(e,t){return t},function(e,t){if(nG.length>0)for(var r=0;r<nG.length;r++){var a=nG[r];if(a[1]===e&&a[0]===t){t=a[2],nG.splice(r,1);break}}return n.call(this,e,t)}),a)}catch(e){return nV("[unable to serialize, circular reference is too complex to analyze]")}finally{for(;0!==nJ.length;){let e=nJ.pop();4===e.length?Object.defineProperty(e[0],e[1],e[3]):e[0][e[1]]=e[2]}}return nV(s)}}function nX(e,t,r,a){var i=Object.getOwnPropertyDescriptor(a,r);void 0!==i.get?i.configurable?(Object.defineProperty(a,r,{value:e}),nJ.push([a,r,t,i])):nG.push([t,r,e]):(a[r]=e,nJ.push([a,r,t]))}function nQ(e){let t=ny(),r=function(){let e=function(){try{if("undefined"!=typeof process&&process.env)return Object.entries(process.env).reduce((e,[t,r])=>(e[t]=String(r),e),{});return}catch(e){return}}()||{},t={},r=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION","LANGSMITH_API_KEY","LANGSMITH_ENDPOINT","LANGSMITH_TRACING_V2","LANGSMITH_PROJECT","LANGSMITH_SESSION"];for(let[a,i]of Object.entries(e))(a.startsWith("LANGCHAIN_")||a.startsWith("LANGSMITH_"))&&"string"==typeof i&&!r.includes(a)&&!a.toLowerCase().includes("key")&&!a.toLowerCase().includes("secret")&&!a.toLowerCase().includes("token")&&("LANGCHAIN_REVISION_ID"===a?t.revision_id=i:t[a]=i);return t}(),a=e.extra??{},i=a.metadata;return e.extra={...a,runtime:{...t,...a?.runtime},metadata:{...r,...r.revision_id||"revision_id"in e&&e.revision_id?{revision_id:("revision_id"in e?e.revision_id:void 0)??r.revision_id}:{},...i}},e}async function n0(e){let t=[];for await(let r of e)t.push(r);return t}function n1(e){if(void 0!==e)return e.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}let n2=async e=>{if(e?.status===429){let t=1e3*parseInt(e.headers.get("retry-after")??"10",10);if(t>0)return await new Promise(e=>setTimeout(e,t)),!0}return!1};function n5(e){return"number"==typeof e?Number(e.toFixed(4)):e}class n4{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"sizeBytes",{enumerable:!0,configurable:!0,writable:!0,value:0})}peek(){return this.items[0]}push(e){let t,r=new Promise(e=>{t=e}),a=nK(e.item,`Serializing run with id: ${e.item.id}`).length;return this.items.push({action:e.action,payload:e.item,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl,itemPromiseResolve:t,itemPromise:r,size:a}),this.sizeBytes+=a,r}pop(e){if(e<1)throw Error("Number of bytes to pop off may not be less than 1.");let t=[],r=0;for(;r+(this.peek()?.size??0)<e&&this.items.length>0;){let e=this.items.shift();e&&(t.push(e),r+=e.size,this.sizeBytes-=e.size)}if(0===t.length&&this.items.length>0){let e=this.items.shift();t.push(e),r+=e.size,this.sizeBytes-=e.size}return[t.map(e=>({action:e.action,item:e.payload,otelContext:e.otelContext,apiKey:e.apiKey,apiUrl:e.apiUrl})),()=>t.forEach(e=>e.itemPromiseResolve())]}}let n9="https://api.smith.langchain.com";class n3{get _fetch(){let e;return this.fetchImplementation||(e=this.debug,async(...t)=>{if(e||"true"===n_("DEBUG")){let[e,r]=t;console.log(` ${r?.method||"GET"} ${e}`)}let r=await (globalThis[np]??((...e)=>fetch(...e)))(...t);return(e||"true"===n_("DEBUG"))&&console.log(` ${r.status} ${r.statusText} ${r.url}`),r})}constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"workspaceId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filteredPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new n4}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"batchSizeBytesLimit",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"blockOnRootRunFinalization",{enumerable:!0,configurable:!0,writable:!0,value:"false"===nb("LANGSMITH_TRACING_BACKGROUND")}),Object.defineProperty(this,"traceBatchConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:5}),Object.defineProperty(this,"_serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_getServerInfoPromise",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"manualFlushMode",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"langSmithToOTELTranslator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchImplementation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"multipartStreamingDisabled",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"debug",{enumerable:!0,configurable:!0,writable:!0,value:"true"===nb("LANGSMITH_DEBUG")});let t=n3.getDefaultClientConfig();if(this.tracingSampleRate=(e=>{let t=e?.toString()??n_("TRACING_SAMPLING_RATE");if(void 0===t)return;let r=parseFloat(t);if(r<0||r>1)throw Error(`LANGSMITH_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${r}`);return r})(e.tracingSamplingRate),this.apiUrl=n1(e.apiUrl??t.apiUrl)??"",this.apiUrl.endsWith("/")&&(this.apiUrl=this.apiUrl.slice(0,-1)),this.apiKey=n1(e.apiKey??t.apiKey),this.webUrl=n1(e.webUrl??t.webUrl),this.webUrl?.endsWith("/")&&(this.webUrl=this.webUrl.slice(0,-1)),this.workspaceId=n1(e.workspaceId??n_("WORKSPACE_ID")),this.timeout_ms=e.timeout_ms??9e4,this.caller=new nN({...e.callerOptions??{},maxRetries:4,debug:e.debug??this.debug}),this.traceBatchConcurrency=e.traceBatchConcurrency??this.traceBatchConcurrency,this.traceBatchConcurrency<1)throw Error("Trace batch concurrency must be positive.");this.debug=e.debug??this.debug,this.fetchImplementation=e.fetchImplementation,this.batchIngestCaller=new nN({maxRetries:2,maxConcurrency:this.traceBatchConcurrency,...e.callerOptions??{},onFailedResponseHook:n2,debug:e.debug??this.debug}),this.hideInputs=e.hideInputs??e.anonymizer??t.hideInputs,this.hideOutputs=e.hideOutputs??e.anonymizer??t.hideOutputs,this.autoBatchTracing=e.autoBatchTracing??this.autoBatchTracing,this.blockOnRootRunFinalization=e.blockOnRootRunFinalization??this.blockOnRootRunFinalization,this.batchSizeBytesLimit=e.batchSizeBytesLimit,this.fetchOptions=e.fetchOptions||{},this.manualFlushMode=e.manualFlushMode??this.manualFlushMode,nw()&&(this.langSmithToOTELTranslator=new nT)}static getDefaultClientConfig(){let e=n_("API_KEY"),t=n_("ENDPOINT")??n9;return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:"true"===n_("HIDE_INPUTS"),hideOutputs:"true"===n_("HIDE_OUTPUTS")}}getHostUrl(){if(this.webUrl)return this.webUrl;if((e=>{let t=e.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return"localhost"===t||"127.0.0.1"===t||"::1"===t})(this.apiUrl))return this.webUrl="http://localhost:3000",this.webUrl;if(this.apiUrl.endsWith("/api/v1"))return this.webUrl=this.apiUrl.replace("/api/v1",""),this.webUrl;if(this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api"))return this.webUrl=this.apiUrl.replace("/api",""),this.webUrl;if(this.apiUrl.split(".",1)[0].includes("dev"))return this.webUrl="https://dev.smith.langchain.com",this.webUrl;else if(this.apiUrl.split(".",1)[0].includes("eu"))return this.webUrl="https://eu.smith.langchain.com",this.webUrl;else if(this.apiUrl.split(".",1)[0].includes("beta"))return this.webUrl="https://beta.smith.langchain.com",this.webUrl;else return this.webUrl="https://smith.langchain.com",this.webUrl}get headers(){let e={"User-Agent":`langsmith-js/${nm}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),this.workspaceId&&(e["x-tenant-id"]=this.workspaceId),e}_getPlatformEndpointPath(e){return"/v1"!==this.apiUrl.slice(-3)&&"/v1/"!==this.apiUrl.slice(-4)?`/v1/platform/${e}`:`/platform/${e}`}async processInputs(e){return!1===this.hideInputs?e:!0===this.hideInputs?{}:"function"==typeof this.hideInputs?this.hideInputs(e):e}async processOutputs(e){return!1===this.hideOutputs?e:!0===this.hideOutputs?{}:"function"==typeof this.hideOutputs?this.hideOutputs(e):e}async prepareRunCreateOrUpdateInputs(e){let t={...e};return void 0!==t.inputs&&(t.inputs=await this.processInputs(t.inputs)),void 0!==t.outputs&&(t.outputs=await this.processOutputs(t.outputs)),t}async _getResponse(e,t){let r=t?.toString()??"",a=`${this.apiUrl}${e}?${r}`;return await this.caller.call(async()=>{let t=await this._fetch(a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,`Failed to fetch ${e}`),t})}async _get(e,t){return(await this._getResponse(e,t)).json()}async *_getPaginated(e,t=new URLSearchParams,r){let a=Number(t.get("offset"))||0,i=Number(t.get("limit"))||100;for(;;){t.set("offset",String(a)),t.set("limit",String(i));let n=`${this.apiUrl}${e}?${t}`,s=await this.caller.call(async()=>{let t=await this._fetch(n,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,`Failed to fetch ${e}`),t}),o=r?r(await s.json()):await s.json();if(0===o.length||(yield o,o.length<i))break;a+=o.length}}async *_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let i=t?{...t}:{};for(;;){let t=JSON.stringify(i),n=await this.caller.call(async()=>{let a=await this._fetch(`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:t});return await nB(a,`Failed to fetch ${e}`),a}),s=await n.json();if(!s||!s[a])break;yield s[a];let o=s.cursors;if(!o||!o.next)break;i.cursor=o.next}}_shouldSample(){return void 0===this.tracingSampleRate||Math.random()<this.tracingSampleRate}_filterForSampling(e,t=!1){if(void 0===this.tracingSampleRate)return e;if(t){let t=[];for(let r of e)this.filteredPostUuids.has(r.trace_id)?r.id===r.trace_id&&this.filteredPostUuids.delete(r.trace_id):t.push(r);return t}{let t=[];for(let r of e){let e=r.trace_id??r.id;this.filteredPostUuids.has(e)||(r.id===e?this._shouldSample()?t.push(r):this.filteredPostUuids.add(e):t.push(r))}return t}}async _getBatchSizeLimitBytes(){let e=await this._ensureServerInfo();return this.batchSizeBytesLimit??e.batch_ingest_config?.size_limit_bytes??0x1800000}async _getDatasetExamplesMultiPartSupport(){let e=await this._ensureServerInfo();return e.instance_flags?.dataset_examples_multipart_enabled??!1}drainAutoBatchQueue(e){let t=[];for(;this.autoBatchQueue.items.length>0;){let[r,a]=this.autoBatchQueue.pop(e);if(!r.length){a();break}let i=r.reduce((e,t)=>{let r=t.apiUrl??this.apiUrl,a=t.apiKey??this.apiKey,i=t.apiKey===this.apiKey&&t.apiUrl===this.apiUrl?"default":`${r}|${a}`;return e[i]||(e[i]=[]),e[i].push(t),e},{}),n=[];for(let[e,t]of Object.entries(i)){let r=this._processBatch(t,{apiUrl:"default"===e?void 0:e.split("|")[0],apiKey:"default"===e?void 0:e.split("|")[1]});n.push(r)}let s=Promise.all(n).finally(a);t.push(s)}return Promise.all(t)}async _processBatch(e,t){if(e.length)try{if(void 0!==this.langSmithToOTELTranslator)this._sendBatchToOTELTranslator(e);else{let r={runCreates:e.filter(e=>"create"===e.action).map(e=>e.item),runUpdates:e.filter(e=>"update"===e.action).map(e=>e.item)},a=await this._ensureServerInfo();if(a?.batch_ingest_config?.use_multipart_endpoint){let e=a?.instance_flags?.gzip_body_enabled;await this.multipartIngestRuns(r,{...t,useGzip:e})}else await this.batchIngestRuns(r,t)}}catch(e){console.error("Error exporting batch:",e)}}_sendBatchToOTELTranslator(e){if(void 0!==this.langSmithToOTELTranslator){let t=new Map,r=[];for(let a of e)a.item.id&&a.otelContext&&(t.set(a.item.id,a.otelContext),"create"===a.action?r.push({operation:"post",id:a.item.id,trace_id:a.item.trace_id??a.item.id,run:a.item}):r.push({operation:"patch",id:a.item.id,trace_id:a.item.trace_id??a.item.id,run:a.item}));this.langSmithToOTELTranslator.exportBatch(r,t)}}async processRunOperation(e){clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0,e.item=nQ(e.item);let t=this.autoBatchQueue.push(e);if(this.manualFlushMode)return t;let r=await this._getBatchSizeLimitBytes();return this.autoBatchQueue.sizeBytes>r&&this.drainAutoBatchQueue(r),this.autoBatchQueue.items.length>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue(r)},this.autoBatchAggregationDelayMs)),t}async _getServerInfo(){let e=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(1e4),...this.fetchOptions});return await nB(e,"get server info"),e}),t=await e.json();return this.debug&&console.log("\n=== LangSmith Server Configuration ===\n"+JSON.stringify(t,null,2)+"\n"),t}async _ensureServerInfo(){return void 0===this._getServerInfoPromise&&(this._getServerInfoPromise=(async()=>{if(void 0===this._serverInfo)try{this._serverInfo=await this._getServerInfo()}catch(e){console.warn(`[LANGSMITH]: Failed to fetch info on supported operations. Falling back to batch operations and default limits. Info: ${e.status??"Unspecified status code"} ${e.message}`)}return this._serverInfo??{}})()),this._getServerInfoPromise.then(e=>(void 0===this._serverInfo&&(this._getServerInfoPromise=void 0),e))}async _getSettings(){return this.settings||(this.settings=this._get("/settings")),await this.settings}async flush(){let e=await this._getBatchSizeLimitBytes();await this.drainAutoBatchQueue(e)}_cloneCurrentOTELContext(){let e=nI(),t=n$.getContextInstance();if(void 0!==this.langSmithToOTELTranslator){let r=e.getActiveSpan();if(r)return e.setSpan(t.active(),r)}}async createRun(e,t){if(!this._filterForSampling([e]).length)return;let r={...this.headers,"Content-Type":"application/json"},a=e.project_name;delete e.project_name;let i=await this.prepareRunCreateOrUpdateInputs({session_name:a,...e,start_time:e.start_time??Date.now()});if(this.autoBatchTracing&&void 0!==i.trace_id&&void 0!==i.dotted_order){let e=this._cloneCurrentOTELContext();this.processRunOperation({action:"create",item:i,otelContext:e,apiKey:t?.apiKey,apiUrl:t?.apiUrl}).catch(console.error);return}let n=nQ(i);t?.apiKey!==void 0&&(r["x-api-key"]=t.apiKey),t?.workspaceId!==void 0&&(r["x-tenant-id"]=t.workspaceId);let s=nK(n,`Creating run with id: ${n.id}`);await this.caller.call(async()=>{let e=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await nB(e,"create run",!0),e})}async batchIngestRuns({runCreates:e,runUpdates:t},r){if(void 0===e&&void 0===t)return;let a=await Promise.all(e?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[]),i=await Promise.all(t?.map(e=>this.prepareRunCreateOrUpdateInputs(e))??[]);if(a.length>0&&i.length>0){let e=a.reduce((e,t)=>(t.id&&(e[t.id]=t),e),{}),t=[];for(let r of i)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);a=Object.values(e),i=t}let n={post:a,patch:i};if(!n.post.length&&!n.patch.length)return;let s={post:[],patch:[]};for(let e of["post","patch"]){let t=n[e].reverse(),r=t.pop();for(;void 0!==r;)s[e].push(r),r=t.pop()}if(s.post.length>0||s.patch.length>0){let e=s.post.map(e=>e.id).concat(s.patch.map(e=>e.id)).join(",");await this._postBatchIngestRuns(nK(s,`Ingesting runs with ids: ${e}`),r)}}async _postBatchIngestRuns(e,t){let r={...this.headers,"Content-Type":"application/json",Accept:"application/json"};t?.apiKey!==void 0&&(r["x-api-key"]=t.apiKey),await this.batchIngestCaller.call(async()=>{let a=await this._fetch(`${t?.apiUrl??this.apiUrl}/runs/batch`,{method:"POST",headers:r,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await nB(a,"batch create run",!0),a})}async multipartIngestRuns({runCreates:e,runUpdates:t},r){if(void 0===e&&void 0===t)return;let a={},i=[];for(let t of e??[]){let e=await this.prepareRunCreateOrUpdateInputs(t);void 0!==e.id&&void 0!==e.attachments&&(a[e.id]=e.attachments),delete e.attachments,i.push(e)}let n=[];for(let e of t??[])n.push(await this.prepareRunCreateOrUpdateInputs(e));if(void 0!==i.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when creating a run');if(void 0!==n.find(e=>void 0===e.trace_id||void 0===e.dotted_order))throw Error('Multipart ingest requires "trace_id" and "dotted_order" to be set when updating a run');if(i.length>0&&n.length>0){let e=i.reduce((e,t)=>(t.id&&(e[t.id]=t),e),{}),t=[];for(let r of n)void 0!==r.id&&e[r.id]?e[r.id]={...e[r.id],...r}:t.push(r);i=Object.values(e),n=t}if(0===i.length&&0===n.length)return;let s=[],o=[];for(let[e,t]of[["post",i],["patch",n]])for(let r of t){let{inputs:t,outputs:i,events:n,extra:l,error:u,serialized:c,attachments:d,...h}=r,p={inputs:t,outputs:i,events:n,extra:l,error:u,serialized:c},f=nK(h,`Serializing for multipart ingestion of run with id: ${h.id}`);for(let[t,r]of(o.push({name:`${e}.${h.id}`,payload:new Blob([f],{type:`application/json; length=${f.length}`})}),Object.entries(p))){if(void 0===r)continue;let a=nK(r,`Serializing ${t} for multipart ingestion of run with id: ${h.id}`);o.push({name:`${e}.${h.id}.${t}`,payload:new Blob([a],{type:`application/json; length=${a.length}`})})}if(void 0!==h.id){let e=a[h.id];if(e)for(let[t,r]of(delete a[h.id],Object.entries(e))){let e,a;if(Array.isArray(r)?[e,a]=r:(e=r.mimeType,a=r.data),t.includes(".")){console.warn(`Skipping attachment '${t}' for run ${h.id}: Invalid attachment name. Attachment names must not contain periods ('.'). Please rename the attachment and try again.`);continue}o.push({name:`attachment.${h.id}.${t}`,payload:new Blob([a],{type:`${e}; length=${a.byteLength}`})})}}s.push(`trace=${h.trace_id},id=${h.id}`)}await this._sendMultipartRequest(o,s.join("; "),r)}async _createNodeFetchBody(e,t){let r=[];for(let a of e)r.push(new Blob([`--${t}\r
`])),r.push(new Blob([`Content-Disposition: form-data; name="${a.name}"\r
`,`Content-Type: ${a.payload.type}\r
\r
`])),r.push(a.payload),r.push(new Blob(["\r\n"]));r.push(new Blob([`--${t}--\r
`]));let a=new Blob(r);return await a.arrayBuffer()}async _createMultipartStream(e,t){let r=new TextEncoder;return new ReadableStream({async start(a){let i=async e=>{"string"==typeof e?a.enqueue(r.encode(e)):a.enqueue(e)};for(let r of e){await i(`--${t}\r
`),await i(`Content-Disposition: form-data; name="${r.name}"\r
`),await i(`Content-Type: ${r.payload.type}\r
\r
`);let e=r.payload.stream().getReader();try{let t;for(;!(t=await e.read()).done;)a.enqueue(t.value)}finally{e.releaseLock()}await i("\r\n")}await i(`--${t}--\r
`),a.close()}})}async _sendMultipartRequest(e,t,r){let a="----LangSmithFormBoundary"+Math.random().toString(36).slice(2),i=(()=>{let e=globalThis[np];return!!e&&"function"==typeof e&&"Headers"in e&&"Request"in e&&"Response"in e})(),n=()=>this._createNodeFetchBody(e,a),s=()=>this._createMultipartStream(e,a),o=async e=>this.batchIngestCaller.call(async()=>{let t=await e(),i={...this.headers,"Content-Type":`multipart/form-data; boundary=${a}`};r?.apiKey!==void 0&&(i["x-api-key"]=r.apiKey);let n=t;r?.useGzip&&"object"==typeof t&&"pipeThrough"in t&&(n=t.pipeThrough(new CompressionStream("gzip")),i["Content-Encoding"]="gzip");let s=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/multipart`,{method:"POST",headers:i,body:n,duplex:"half",signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(s,"Failed to send multipart request",!0),s});try{let e,a=!1;i||this.multipartStreamingDisabled||"bun"===ng()?e=await o(n):(a=!0,e=await o(s)),(!this.multipartStreamingDisabled||a)&&422===e.status&&(r?.apiUrl??this.apiUrl)!==n9&&(console.warn(`Streaming multipart upload to ${r?.apiUrl??this.apiUrl}/runs/multipart failed. This usually means the host does not support chunked uploads. Retrying with a buffered upload for operation "${t}".`),this.multipartStreamingDisabled=!0,e=await o(n))}catch(e){console.warn(`${e.message.trim()}

Context: ${t}`)}}async updateRun(e,t,r){nM(e),t.inputs&&(t.inputs=await this.processInputs(t.inputs)),t.outputs&&(t.outputs=await this.processOutputs(t.outputs));let a={...t,id:e};if(!this._filterForSampling([a],!0).length)return;if(this.autoBatchTracing&&void 0!==a.trace_id&&void 0!==a.dotted_order){let e=this._cloneCurrentOTELContext();return void 0!==t.end_time&&void 0===a.parent_run_id&&this.blockOnRootRunFinalization&&!this.manualFlushMode?void await this.processRunOperation({action:"update",item:a,otelContext:e,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error):void this.processRunOperation({action:"update",item:a,otelContext:e,apiKey:r?.apiKey,apiUrl:r?.apiUrl}).catch(console.error)}let i={...this.headers,"Content-Type":"application/json"};r?.apiKey!==void 0&&(i["x-api-key"]=r.apiKey),r?.workspaceId!==void 0&&(i["x-tenant-id"]=r.workspaceId);let n=nK(t,`Serializing payload to update run with id: ${e}`);await this.caller.call(async()=>{let t=await this._fetch(`${r?.apiUrl??this.apiUrl}/runs/${e}`,{method:"PATCH",headers:i,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await nB(t,"update run",!0),t})}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){nM(e);let r=await this._get(`/runs/${e}`);return t&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(void 0!==t){let e;e=t.session_id?t.session_id:r?.projectName?(await this.readProject({projectName:r?.projectName})).id:r?.projectId?r?.projectId:(await this.readProject({projectName:n_("PROJECT")||"default"})).id;let a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${e}/r/${t.id}?poll=true`}if(void 0!==e){let t=await this.readRun(e);if(!t.app_path)throw Error(`Run ${e} has no app_path`);let r=this.getHostUrl();return`${r}${t.app_path}`}throw Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await n0(this.listRuns({isRoot:!1,projectId:e.session_id,traceId:e.trace_id})),r={},a={};for(let i of(t.sort((e,t)=>(e?.dotted_order??"").localeCompare(t?.dotted_order??"")),t)){if(null===i.parent_run_id||void 0===i.parent_run_id)throw Error(`Child run ${i.id} has no parent`);i.dotted_order?.startsWith(e.dotted_order??"")&&i.id!==e.id&&(i.parent_run_id in r||(r[i.parent_run_id]=[]),r[i.parent_run_id].push(i),a[i.id]=i)}for(let t in e.child_runs=r[e.id]||[],r)t!==e.id&&(a[t].child_runs=r[t]);return e}async *listRuns(e){let{projectId:t,projectName:r,parentRunId:a,traceId:i,referenceExampleId:n,startTime:s,executionOrder:o,isRoot:l,runType:u,error:c,id:d,query:h,filter:p,traceFilter:f,treeFilter:m,limit:g,select:y,order:b}=e,_=[];if(t&&(_=Array.isArray(t)?t:[t]),r){let e=Array.isArray(r)?r:[r],t=await Promise.all(e.map(e=>this.readProject({projectName:e}).then(e=>e.id)));_.push(...t)}let w={session:_.length?_:null,run_type:u,reference_example:n,query:h,filter:p,trace_filter:f,tree_filter:m,execution_order:o,parent_run:a,start_time:s?s.toISOString():null,error:c,id:d,limit:g,trace:i,select:y||["app_path","completion_cost","completion_tokens","dotted_order","end_time","error","events","extra","feedback_stats","first_token_time","id","inputs","name","outputs","parent_run_id","parent_run_ids","prompt_cost","prompt_tokens","reference_example_id","run_type","session_id","start_time","status","tags","total_cost","total_tokens","trace_id"],is_root:l,order:b},v=0;for await(let e of this._getCursorPaginatedList("/runs/query",w))if(g){if(v>=g)break;if(e.length+v>g){let t=e.slice(0,g-v);yield*t;break}v+=e.length,yield*e}else yield*e}async *listGroupRuns(e){let{projectId:t,projectName:r,groupBy:a,filter:i,startTime:n,endTime:s,limit:o,offset:l}=e,u={session_id:t||(await this.readProject({projectName:r})).id,group_by:a,filter:i,start_time:n?n.toISOString():null,end_time:s?s.toISOString():null,limit:Number(o)||100},c=Number(l)||0,d="/runs/group",h=`${this.apiUrl}${d}`;for(;;){let e=JSON.stringify(Object.fromEntries(Object.entries({...u,offset:c}).filter(([e,t])=>void 0!==t))),t=await this.caller.call(async()=>{let t=await this._fetch(h,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:e});return await nB(t,`Failed to fetch ${d}`),t}),{groups:r,total:a}=await t.json();if(0===r.length)break;for(let e of r)yield e;if((c+=r.length)>=a)break}}async getRunStats({id:e,trace:t,parentRun:r,runType:a,projectNames:i,projectIds:n,referenceExampleIds:s,startTime:o,endTime:l,error:u,query:c,filter:d,traceFilter:h,treeFilter:p,isRoot:f,dataSourceType:m}){let g=n||[];i&&(g=[...n||[],...await Promise.all(i.map(e=>this.readProject({projectName:e}).then(e=>e.id)))]);let y=JSON.stringify(Object.fromEntries(Object.entries({id:e,trace:t,parent_run:r,run_type:a,session:g,reference_example:s,start_time:o,end_time:l,error:u,query:c,filter:d,trace_filter:h,tree_filter:p,is_root:f,data_source_type:m}).filter(([e,t])=>void 0!==t))),b=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/runs/stats`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:y});return await nB(e,"get run stats"),e});return await b.json()}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||na()};nM(e);let a=JSON.stringify(r),i=await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await nB(t,"share run"),t}),n=await i.json();if(null===n||!("share_token"in n))throw Error("Invalid response from server");return`${this.getHostUrl()}/public/${n.share_token}/r`}async unshareRun(e){nM(e),await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"unshare run",!0),t})}async readRunSharedLink(e){nM(e);let t=await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"read run shared link"),t}),r=await t.json();if(null!==r&&"share_token"in r)return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(void 0!==t)for(let e of t)r.append("id",e);nM(e);let a=await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"list shared runs"),t});return await a.json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),nM(e);let r=await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"read dataset shared schema"),t}),a=await r.json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};nM(e);let a=JSON.stringify(r),i=await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:a});return await nB(t,"share dataset"),t}),n=await i.json();return n.url=`${this.getHostUrl()}/public/${n.share_token}/d`,n}async unshareDataset(e){nM(e),await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"unshare dataset",!0),t})}async readSharedDataset(e){nM(e);let t=await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"read shared dataset"),t});return await t.json()}async listSharedExamples(e,t){let r={};t?.exampleIds&&(r.id=t.exampleIds);let a=new URLSearchParams;Object.entries(r).forEach(([e,t])=>{Array.isArray(t)?t.forEach(t=>a.append(e,t)):a.append(e,t)});let i=await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/public/${e}/examples?${a.toString()}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"list shared examples"),t}),n=await i.json();if(!i.ok){if("detail"in n)throw Error(`Failed to list shared examples.
Status: ${i.status}
Message: ${Array.isArray(n.detail)?n.detail.join("\n"):"Unspecified error"}`);throw Error(`Failed to list shared examples: ${i.status} ${i.statusText}`)}return n.map(e=>({...e,_hostUrl:this.getHostUrl()}))}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:i=null,referenceDatasetId:n=null}){let s=`${this.apiUrl}/sessions${a?"?upsert=true":""}`,o=i||{};r&&(o.metadata=r);let l={name:e,extra:o,description:t};null!==n&&(l.reference_dataset_id=n);let u=JSON.stringify(l),c=await this.caller.call(async()=>{let e=await this._fetch(s,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:u});return await nB(e,"create project"),e});return await c.json()}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:i=null,endTime:n=null}){let s=`${this.apiUrl}/sessions/${e}`,o=i;a&&(o={...o||{},metadata:a});let l=JSON.stringify({name:t,extra:o,description:r,end_time:n?new Date(n).toISOString():null}),u=await this.caller.call(async()=>{let e=await this._fetch(s,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await nB(e,"update project"),e});return await u.json()}async hasProject({projectId:e,projectName:t}){let r="/sessions",a=new URLSearchParams;if(void 0!==e&&void 0!==t)throw Error("Must provide either projectName or projectId, not both");if(void 0!==e)nM(e),r+=`/${e}`;else if(void 0!==t)a.append("name",t);else throw Error("Must provide projectName or projectId");let i=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(e,"has project"),e});try{let e=await i.json();if(!i.ok)return!1;if(Array.isArray(e))return e.length>0;return!0}catch(e){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a,i="/sessions",n=new URLSearchParams;if(void 0!==e&&void 0!==t)throw Error("Must provide either projectName or projectId, not both");if(void 0!==e)nM(e),i+=`/${e}`;else if(void 0!==t)n.append("name",t);else throw Error("Must provide projectName or projectId");void 0!==r&&n.append("include_stats",r.toString());let s=await this._get(i,n);if(Array.isArray(s)){if(0===s.length)throw Error(`Project[id=${e}, name=${t}] not found`);a=s[0]}else a=s;return a}async getProjectUrl({projectId:e,projectName:t}){if(void 0===e&&void 0===t)throw Error("Must provide either projectName or projectId");let r=await this.readProject({projectId:e,projectName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${r.id}`}async getDatasetUrl({datasetId:e,datasetName:t}){if(void 0===e&&void 0===t)throw Error("Must provide either datasetName or datasetId");let r=await this.readDataset({datasetId:e,datasetName:t}),a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/datasets/${r.id}`}async _getTenantId(){if(null!==this._tenantId)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw Error("No projects found to resolve tenant.")}async *listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:i,datasetVersion:n,referenceFree:s,metadata:o}={}){let l=new URLSearchParams;if(void 0!==e)for(let t of e)l.append("id",t);if(void 0!==t&&l.append("name",t),void 0!==r&&l.append("name_contains",r),void 0!==a)l.append("reference_dataset",a);else if(void 0!==i){let e=await this.readDataset({datasetName:i});l.append("reference_dataset",e.id)}for await(let e of(void 0!==n&&l.append("dataset_version",n),void 0!==s&&l.append("reference_free",s.toString()),void 0!==o&&l.append("metadata",JSON.stringify(o)),this._getPaginated("/sessions",l)))yield*e}async deleteProject({projectId:e,projectName:t}){let r;if(void 0===e&&void 0===t)throw Error("Must provide projectName or projectId");if(void 0!==e&&void 0!==t)throw Error("Must provide either projectName or projectId, not both");nM(r=void 0===e?(await this.readProject({projectName:t})).id:e),await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(e,`delete session ${r} (${t})`,!0),e})}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:i,dataType:n,name:s}){let o=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach(e=>{l.append("input_keys",e)}),a.forEach(e=>{l.append("output_keys",e)}),i&&l.append("description",i),n&&l.append("data_type",n),s&&l.append("name",s);let u=await this.caller.call(async()=>{let e=await this._fetch(o,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await nB(e,"upload CSV"),e});return await u.json()}async createDataset(e,{description:t,dataType:r,inputsSchema:a,outputsSchema:i,metadata:n}={}){let s={name:e,description:t,extra:n?{metadata:n}:void 0};r&&(s.data_type=r),a&&(s.inputs_schema_definition=a),i&&(s.outputs_schema_definition=i);let o=JSON.stringify(s),l=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await nB(e,"create dataset"),e});return await l.json()}async readDataset({datasetId:e,datasetName:t}){let r,a="/datasets",i=new URLSearchParams({limit:"1"});if(e&&t)throw Error("Must provide either datasetName or datasetId, not both");if(e)nM(e),a+=`/${e}`;else if(t)i.append("name",t);else throw Error("Must provide datasetName or datasetId");let n=await this._get(a,i);if(Array.isArray(n)){if(0===n.length)throw Error(`Dataset[id=${e}, name=${t}] not found`);r=n[0]}else r=n;return r}async hasDataset({datasetId:e,datasetName:t}){try{return await this.readDataset({datasetId:e,datasetName:t}),!0}catch(e){if(e instanceof Error&&e.message.toLocaleLowerCase().includes("not found"))return!1;throw e}}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let i=e;if(void 0===i&&void 0===t)throw Error("Must provide either datasetName or datasetId");if(void 0!==i&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");void 0===i&&(i=(await this.readDataset({datasetName:t})).id);let n=new URLSearchParams({from_version:"string"==typeof r?r:r.toISOString(),to_version:"string"==typeof a?a:a.toISOString()});return await this._get(`/datasets/${i}/versions/diff`,n)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){if(void 0!==e);else if(void 0!==t)e=(await this.readDataset({datasetName:t})).id;else throw Error("Must provide either datasetName or datasetId");let r=await this._getResponse(`/datasets/${e}/openai_ft`);return(await r.text()).trim().split("\n").map(e=>JSON.parse(e))}async *listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:i,metadata:n}={}){let s=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(void 0!==r)for(let e of r)s.append("id",e);for await(let e of(void 0!==a&&s.append("name",a),void 0!==i&&s.append("name_contains",i),void 0!==n&&s.append("metadata",JSON.stringify(n)),this._getPaginated("/datasets",s)))yield*e}async updateDataset(e){let{datasetId:t,datasetName:r,...a}=e;if(!t&&!r)throw Error("Must provide either datasetName or datasetId");let i=t??(await this.readDataset({datasetName:r})).id;nM(i);let n=JSON.stringify(a),s=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/datasets/${i}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await nB(e,"update dataset"),e});return await s.json()}async updateDatasetTag(e){let{datasetId:t,datasetName:r,asOf:a,tag:i}=e;if(!t&&!r)throw Error("Must provide either datasetName or datasetId");let n=t??(await this.readDataset({datasetName:r})).id;nM(n);let s=JSON.stringify({as_of:"string"==typeof a?a:a.toISOString(),tag:i});await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/datasets/${n}/tags`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await nB(e,"update dataset tags",!0),e})}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(void 0!==e&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");if(void 0!==t&&(a=(await this.readDataset({datasetName:t})).id),void 0!==a)nM(a),r+=`/${a}`;else throw Error("Must provide datasetName or datasetId");await this.caller.call(async()=>{let e=await this._fetch(this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(e,`delete ${r}`,!0),e})}async indexDataset({datasetId:e,datasetName:t,tag:r}){let a=e;if(a||t)if(a&&t)throw Error("Must provide either datasetName or datasetId, not both");else a||(a=(await this.readDataset({datasetName:t})).id);else throw Error("Must provide either datasetName or datasetId");nM(a);let i=JSON.stringify({tag:r}),n=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/datasets/${a}/index`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:i});return await nB(e,"index dataset"),e});await n.json()}async similarExamples(e,t,r,{filter:a}={}){let i={limit:r,inputs:e};void 0!==a&&(i.filter=a),nM(t);let n=JSON.stringify(i),s=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/datasets/${t}/search`,{headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,method:"POST",body:n});return await nB(e,"fetch similar examples"),e});return(await s.json()).examples}async createExample(e,t,r){let a;if(n6(e)&&(void 0!==t||void 0!==r))throw Error("Cannot provide outputs or options when using ExampleCreate object");let i=t?r?.datasetId:e.dataset_id,n=t?r?.datasetName:e.dataset_name;if(void 0===i&&void 0===n)throw Error("Must provide either datasetName or datasetId");if(void 0!==i&&void 0!==n)throw Error("Must provide either datasetName or datasetId, not both");void 0===i&&(i=(await this.readDataset({datasetName:n})).id);let s=(t?r?.createdAt:e.created_at)||new Date;a=n6(e)?e:{inputs:e,outputs:t,created_at:s?.toISOString(),id:r?.exampleId,metadata:r?.metadata,split:r?.split,source_run_id:r?.sourceRunId,use_source_run_io:r?.useSourceRunIO,use_source_run_attachments:r?.useSourceRunAttachments,attachments:r?.attachments};let o=await this._uploadExamplesMultipart(i,[a]);return await this.readExample(o.example_ids?.[0]??na())}async createExamples(e){if(Array.isArray(e)){if(0===e.length)return[];let t=e[0].dataset_id,r=e[0].dataset_name;if(void 0===t&&void 0===r)throw Error("Must provide either datasetName or datasetId");if(void 0!==t&&void 0!==r)throw Error("Must provide either datasetName or datasetId, not both");void 0===t&&(t=(await this.readDataset({datasetName:r})).id);let a=await this._uploadExamplesMultipart(t,e);return await Promise.all(a.example_ids.map(e=>this.readExample(e)))}let{inputs:t,outputs:r,metadata:a,splits:i,sourceRunIds:n,useSourceRunIOs:s,useSourceRunAttachments:o,attachments:l,exampleIds:u,datasetId:c,datasetName:d}=e;if(void 0===t)throw Error("Must provide inputs when using legacy parameters");let h=c;if(void 0===h&&void 0===d)throw Error("Must provide either datasetName or datasetId");if(void 0!==h&&void 0!==d)throw Error("Must provide either datasetName or datasetId, not both");void 0===h&&(h=(await this.readDataset({datasetName:d})).id);let p=t.map((e,t)=>({dataset_id:h,inputs:e,outputs:r?.[t],metadata:a?.[t],split:i?.[t],id:u?.[t],attachments:l?.[t],source_run_id:n?.[t],use_source_run_io:s?.[t],use_source_run_attachments:o?.[t]})),f=await this._uploadExamplesMultipart(h,p);return await Promise.all(f.example_ids.map(e=>this.readExample(e)))}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let a=e.map(e=>nR(e)?nC(e):e),i=nR(t)?nC(t):t;return this.createExample({input:a},{output:i},r)}async readExample(e){nM(e);let t=`/examples/${e}`,{attachment_urls:r,...a}=await this._get(t);return r&&(a.attachments=Object.entries(r).reduce((e,[t,r])=>(e[t.slice(11)]={presigned_url:r.presigned_url,mime_type:r.mime_type},e),{})),a}async *listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,splits:i,inlineS3Urls:n,metadata:s,limit:o,offset:l,filter:u,includeAttachments:c}={}){let d;if(void 0!==e&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");if(void 0!==e)d=e;else if(void 0!==t)d=(await this.readDataset({datasetName:t})).id;else throw Error("Must provide a datasetName or datasetId");let h=new URLSearchParams({dataset:d}),p=a?"string"==typeof a?a:a?.toISOString():void 0;if(p&&h.append("as_of",p),h.append("inline_s3_urls",(n??!0).toString()),void 0!==r)for(let e of r)h.append("id",e);if(void 0!==i)for(let e of i)h.append("splits",e);if(void 0!==s){let e=JSON.stringify(s);h.append("metadata",e)}void 0!==o&&h.append("limit",o.toString()),void 0!==l&&h.append("offset",l.toString()),void 0!==u&&h.append("filter",u),!0===c&&["attachment_urls","outputs","metadata"].forEach(e=>h.append("select",e));let f=0;for await(let e of this._getPaginated("/examples",h)){for(let t of e){let{attachment_urls:e,...r}=t;e&&(r.attachments=Object.entries(e).reduce((e,[t,r])=>(e[t.slice(11)]={presigned_url:r.presigned_url,mime_type:r.mime_type||void 0},e),{})),yield r,f++}if(void 0!==o&&f>=o)break}}async deleteExample(e){nM(e);let t=`/examples/${e}`;await this.caller.call(async()=>{let e=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(e,`delete ${t}`,!0),e})}async updateExample(e,t){let r,a,i;return nM(r=t?e:e.id),i=void 0!==(a=t?{id:r,...t}:e).dataset_id?a.dataset_id:(await this.readExample(r)).dataset_id,this._updateExamplesMultipart(i,[a])}async updateExamples(e){let t;return t=void 0===e[0].dataset_id?(await this.readExample(e[0].id)).dataset_id:e[0].dataset_id,this._updateExamplesMultipart(t,e)}async readDatasetVersion({datasetId:e,datasetName:t,asOf:r,tag:a}){let i;if(nM(i=e||(await this.readDataset({datasetName:t})).id),r&&a||!r&&!a)throw Error("Exactly one of asOf and tag must be specified.");let n=new URLSearchParams;void 0!==r&&n.append("as_of","string"==typeof r?r:r.toISOString()),void 0!==a&&n.append("tag",a);let s=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/datasets/${i}/version?${n.toString()}`,{method:"GET",headers:{...this.headers},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(e,"read dataset version"),e});return await s.json()}async listDatasetSplits({datasetId:e,datasetName:t,asOf:r}){let a;if(void 0===e&&void 0===t)throw Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");nM(a=void 0===e?(await this.readDataset({datasetName:t})).id:e);let i=new URLSearchParams,n=r?"string"==typeof r?r:r?.toISOString():void 0;return n&&i.append("as_of",n),await this._get(`/datasets/${a}/splits`,i)}async updateDatasetSplits({datasetId:e,datasetName:t,splitName:r,exampleIds:a,remove:i=!1}){let n;if(void 0===e&&void 0===t)throw Error("Must provide dataset name or ID");if(void 0!==e&&void 0!==t)throw Error("Must provide either datasetName or datasetId, not both");nM(n=void 0===e?(await this.readDataset({datasetName:t})).id:e);let s=JSON.stringify({split_name:r,examples:a.map(e=>(nM(e),e)),remove:i});await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/datasets/${n}/splits`,{method:"PUT",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await nB(e,"update dataset splits",!0),e})}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:i}={loadChildRuns:!1}){let n;if(nD("This method is deprecated and will be removed in future LangSmith versions, use `evaluate` from `langsmith/evaluation` instead."),"string"==typeof e)n=await this.readRun(e,{loadChildRuns:a});else if("object"==typeof e&&"id"in e)n=e;else throw Error(`Invalid run type: ${typeof e}`);null!==n.reference_example_id&&void 0!==n.reference_example_id&&(i=await this.readExample(n.reference_example_id));let s=await t.evaluateRun(n,i),[o,l]=await this._logEvaluationFeedback(s,n,r);return l[0]}async createFeedback(e,t,{score:r,value:a,correction:i,comment:n,sourceInfo:s,feedbackSourceType:o="api",sourceRunId:l,feedbackId:u,feedbackConfig:c,projectId:d,comparativeExperimentId:h}){if(!e&&!d)throw Error("One of runId or projectId must be provided");if(e&&d)throw Error("Only one of runId or projectId can be provided");let p={type:o??"api",metadata:s??{}};void 0===l||p?.metadata===void 0||p.metadata.__run||(p.metadata.__run={run_id:l}),p?.metadata!==void 0&&p.metadata.__run?.run_id!==void 0&&nM(p.metadata.__run.run_id);let f={id:u??na(),run_id:e,key:t,score:n5(r),value:a,correction:i,comment:n,feedback_source:p,comparative_experiment_id:h,feedbackConfig:c,session_id:d},m=JSON.stringify(f),g=`${this.apiUrl}/feedback`;return await this.caller.call(async()=>{let e=await this._fetch(g,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:m});return await nB(e,"create feedback",!0),e}),f}async updateFeedback(e,{score:t,value:r,correction:a,comment:i}){let n={};null!=t&&(n.score=n5(t)),null!=r&&(n.value=r),null!=a&&(n.correction=a),null!=i&&(n.comment=i),nM(e);let s=JSON.stringify(n);await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await nB(t,"update feedback",!0),t})}async readFeedback(e){nM(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){nM(e);let t=`/feedback/${e}`;await this.caller.call(async()=>{let e=await this._fetch(this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(e,`delete ${t}`,!0),e})}async *listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let a=new URLSearchParams;if(e)for(let t of e)nM(t),a.append("run",t);if(t)for(let e of t)a.append("key",e);if(r)for(let e of r)a.append("source",e);for await(let e of this._getPaginated("/feedback",a))yield*e}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){let i={run_id:e,feedback_key:t,feedback_config:a};r?"string"==typeof r?i.expires_at=r:(r?.hours||r?.minutes||r?.days)&&(i.expires_in=r):i.expires_in={hours:3};let n=JSON.stringify(i),s=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await nB(e,"create presigned feedback token"),e});return await s.json()}async createComparativeExperiment({name:e,experimentIds:t,referenceDatasetId:r,createdAt:a,description:i,metadata:n,id:s}){if(0===t.length)throw Error("At least one experiment is required");if(r||(r=(await this.readProject({projectId:t[0]})).reference_dataset_id),null==!r)throw Error("A reference dataset is required");let o={id:s,name:e,experiment_ids:t,reference_dataset_id:r,description:i,created_at:(a??new Date)?.toISOString(),extra:{}};n&&(o.extra.metadata=n);let l=JSON.stringify(o);return(await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/datasets/comparative`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:l});return await nB(e,"create comparative experiment"),e})).json()}async *listPresignedFeedbackTokens(e){nM(e);let t=new URLSearchParams({run_id:e});for await(let e of this._getPaginated("/feedback/tokens",t))yield*e}_selectEvalResults(e){return"results"in e?e.results:Array.isArray(e)?e:[e]}async _logEvaluationFeedback(e,t,r){let a=this._selectEvalResults(e),i=[];for(let e of a){let a=r||{};e.evaluatorInfo&&(a={...e.evaluatorInfo,...a});let n=null;e.targetRunId?n=e.targetRunId:t&&(n=t.id),i.push(await this.createFeedback(n,e.key,{score:e.score,value:e.value,comment:e.comment,correction:e.correction,sourceInfo:a,sourceRunId:e.sourceRunId,feedbackConfig:e.feedbackConfig,feedbackSourceType:"model"}))}return[a,i]}async logEvaluationFeedback(e,t,r){let[a]=await this._logEvaluationFeedback(e,t,r);return a}async *listAnnotationQueues(e={}){let{queueIds:t,name:r,nameContains:a,limit:i}=e,n=new URLSearchParams;t&&t.forEach((e,t)=>{nM(e,`queueIds[${t}]`),n.append("ids",e)}),r&&n.append("name",r),a&&n.append("name_contains",a),n.append("limit",(void 0!==i?Math.min(i,100):100).toString());let s=0;for await(let e of this._getPaginated("/annotation-queues",n))if(yield*e,s++,void 0!==i&&s>=i)break}async createAnnotationQueue(e){let{name:t,description:r,queueId:a,rubricInstructions:i}=e,n=JSON.stringify(Object.fromEntries(Object.entries({name:t,description:r,id:a||na(),rubric_instructions:i}).filter(([e,t])=>void 0!==t)));return(await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/annotation-queues`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await nB(e,"create annotation queue"),e})).json()}async readAnnotationQueue(e){return(await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/annotation-queues/${nM(e,"queueId")}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"read annotation queue"),t})).json()}async updateAnnotationQueue(e,t){let{name:r,description:a,rubricInstructions:i}=t,n=JSON.stringify({name:r,description:a,rubric_instructions:i});await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/annotation-queues/${nM(e,"queueId")}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await nB(t,"update annotation queue",!0),t})}async deleteAnnotationQueue(e){await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/annotation-queues/${nM(e,"queueId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"delete annotation queue",!0),t})}async addRunsToAnnotationQueue(e,t){let r=JSON.stringify(t.map((e,t)=>nM(e,`runIds[${t}]`).toString()));await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/annotation-queues/${nM(e,"queueId")}/runs`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await nB(t,"add runs to annotation queue",!0),t})}async getRunFromAnnotationQueue(e,t){let r=`/annotation-queues/${nM(e,"queueId")}/run`;return(await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}${r}/${t}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(e,"get run from annotation queue"),e})).json()}async deleteRunFromAnnotationQueue(e,t){await this.caller.call(async()=>{let r=await this._fetch(`${this.apiUrl}/annotation-queues/${nM(e,"queueId")}/runs/${nM(t,"queueRunId")}`,{method:"DELETE",headers:{...this.headers,Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(r,"delete run from annotation queue",!0),r})}async getSizeFromAnnotationQueue(e){return(await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/annotation-queues/${nM(e,"queueId")}/size`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"get size from annotation queue"),t})).json()}async _currentTenantIsOwner(e){let t=await this._getSettings();return"-"==e||t.tenant_handle===e}async _ownerConflictError(e,t){let r=await this._getSettings();return Error(`Cannot ${e} for another tenant.

      Current tenant: ${r.tenant_handle}

      Requested tenant: ${t}`)}async _getLatestCommitHash(e){let t=await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}/commits/${e}/?limit=1&offset=0`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(t,"get latest commit hash"),t}),r=await t.json();if(0!==r.commits.length)return r.commits[0].commit_hash}async _likeOrUnlikePrompt(e,t){let[r,a,i]=nz(e),n=JSON.stringify({like:t});return(await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/likes/${r}/${a}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await nB(e,`${t?"like":"unlike"} prompt`),e})).json()}async _getPromptUrl(e){let[t,r,a]=nz(e);if(await this._currentTenantIsOwner(t)){let e=await this._getSettings();return"latest"!==a?`${this.getHostUrl()}/prompts/${r}/${a.substring(0,8)}?organizationId=${e.id}`:`${this.getHostUrl()}/prompts/${r}?organizationId=${e.id}`}return"latest"!==a?`${this.getHostUrl()}/hub/${t}/${r}/${a.substring(0,8)}`:`${this.getHostUrl()}/hub/${t}/${r}`}async promptExists(e){return!!await this.getPrompt(e)}async likePrompt(e){return this._likeOrUnlikePrompt(e,!0)}async unlikePrompt(e){return this._likeOrUnlikePrompt(e,!1)}async *listCommits(e){for await(let t of this._getPaginated(`/commits/${e}/`,new URLSearchParams,e=>e.commits))yield*t}async *listPrompts(e){let t=new URLSearchParams;for await(let r of(t.append("sort_field",e?.sortField??"updated_at"),t.append("sort_direction","desc"),t.append("is_archived",(!!e?.isArchived).toString()),e?.isPublic!==void 0&&t.append("is_public",e.isPublic.toString()),e?.query&&t.append("query",e.query),this._getPaginated("/repos",t,e=>e.repos)))yield*r}async getPrompt(e){let[t,r,a]=nz(e),i=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/repos/${t}/${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return e?.status===404?null:(await nB(e,"get prompt"),e)}),n=await i?.json();return n?.repo?n.repo:null}async createPrompt(e,t){let r=await this._getSettings();if(t?.isPublic&&!r.tenant_handle)throw Error(`Cannot create a public prompt without first

        creating a LangChain Hub handle.
        You can add a handle by creating a public prompt at:

        https://smith.langchain.com/prompts`);let[a,i,n]=nz(e);if(!await this._currentTenantIsOwner(a))throw await this._ownerConflictError("create a prompt",a);let s=JSON.stringify({repo_handle:i,...t?.description&&{description:t.description},...t?.readme&&{readme:t.readme},...t?.tags&&{tags:t.tags},is_public:!!t?.isPublic}),o=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/repos/`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:s});return await nB(e,"create prompt"),e}),{repo:l}=await o.json();return l}async createCommit(e,t,r){if(!await this.promptExists(e))throw Error("Prompt does not exist, you must create it first.");let[a,i,n]=nz(e),s=r?.parentCommitHash!=="latest"&&r?.parentCommitHash?r?.parentCommitHash:await this._getLatestCommitHash(`${a}/${i}`),o=JSON.stringify({manifest:JSON.parse(JSON.stringify(t)),parent_commit:s}),l=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/commits/${a}/${i}`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:o});return await nB(e,"create commit"),e}),u=await l.json();return this._getPromptUrl(`${a}/${i}${u.commit_hash?`:${u.commit_hash}`:""}`)}async updateExamplesMultipart(e,t=[]){return this._updateExamplesMultipart(e,t)}async _updateExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");let r=new FormData;for(let e of t){let t=e.id,a=new Blob([nK({...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split}},`Serializing body for example with id: ${t}`)],{type:"application/json"});if(r.append(t,a),e.inputs){let a=new Blob([nK(e.inputs,`Serializing inputs for example with id: ${t}`)],{type:"application/json"});r.append(`${t}.inputs`,a)}if(e.outputs){let a=new Blob([nK(e.outputs,`Serializing outputs whle updating example with id: ${t}`)],{type:"application/json"});r.append(`${t}.outputs`,a)}if(e.attachments)for(let[a,i]of Object.entries(e.attachments)){let e,n;Array.isArray(i)?[e,n]=i:(e=i.mimeType,n=i.data);let s=new Blob([n],{type:`${e}; length=${n.byteLength}`});r.append(`${t}.attachment.${a}`,s)}if(e.attachments_operations){let a=new Blob([nK(e.attachments_operations,`Serializing attachments while updating example with id: ${t}`)],{type:"application/json"});r.append(`${t}.attachments_operations`,a)}}let a=e??t[0]?.dataset_id;return(await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${a}/examples`)}`,{method:"PATCH",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await nB(e,"update examples"),e})).json()}async uploadExamplesMultipart(e,t=[]){return this._uploadExamplesMultipart(e,t)}async _uploadExamplesMultipart(e,t=[]){if(!await this._getDatasetExamplesMultiPartSupport())throw Error("Your LangSmith deployment does not allow using the multipart examples endpoint, please upgrade your deployment to the latest version.");let r=new FormData;for(let e of t){let t=(e.id??na()).toString(),a=new Blob([nK({created_at:e.created_at,...e.metadata&&{metadata:e.metadata},...e.split&&{split:e.split},...e.source_run_id&&{source_run_id:e.source_run_id},...e.use_source_run_io&&{use_source_run_io:e.use_source_run_io},...e.use_source_run_attachments&&{use_source_run_attachments:e.use_source_run_attachments}},`Serializing body for uploaded example with id: ${t}`)],{type:"application/json"});if(r.append(t,a),e.inputs){let a=new Blob([nK(e.inputs,`Serializing inputs for uploaded example with id: ${t}`)],{type:"application/json"});r.append(`${t}.inputs`,a)}if(e.outputs){let a=new Blob([nK(e.outputs,`Serializing outputs for uploaded example with id: ${t}`)],{type:"application/json"});r.append(`${t}.outputs`,a)}if(e.attachments)for(let[a,i]of Object.entries(e.attachments)){let e,n;Array.isArray(i)?[e,n]=i:(e=i.mimeType,n=i.data);let s=new Blob([n],{type:`${e}; length=${n.byteLength}`});r.append(`${t}.attachment.${a}`,s)}}return(await this.caller.call(async()=>{let t=await this._fetch(`${this.apiUrl}${this._getPlatformEndpointPath(`datasets/${e}/examples`)}`,{method:"POST",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:r});return await nB(t,"upload examples"),t})).json()}async updatePrompt(e,t){if(!await this.promptExists(e))throw Error("Prompt does not exist, you must create it first.");let[r,a]=nz(e);if(!await this._currentTenantIsOwner(r))throw await this._ownerConflictError("update a prompt",r);let i={};if(t?.description!==void 0&&(i.description=t.description),t?.readme!==void 0&&(i.readme=t.readme),t?.tags!==void 0&&(i.tags=t.tags),t?.isPublic!==void 0&&(i.is_public=t.isPublic),t?.isArchived!==void 0&&(i.is_archived=t.isArchived),0===Object.keys(i).length)throw Error("No valid update options provided");let n=JSON.stringify(i);return(await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/repos/${r}/${a}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:n});return await nB(e,"update prompt"),e})).json()}async deletePrompt(e){if(!await this.promptExists(e))throw Error("Prompt does not exist, you must create it first.");let[t,r,a]=nz(e);if(!await this._currentTenantIsOwner(t))throw await this._ownerConflictError("delete a prompt",t);return(await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/repos/${t}/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(e,"delete prompt"),e})).json()}async pullPromptCommit(e,t){let[r,a,i]=nz(e),n=await this.caller.call(async()=>{let e=await this._fetch(`${this.apiUrl}/commits/${r}/${a}/${i}${t?.includeModel?"?include_model=true":""}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await nB(e,"pull prompt commit"),e}),s=await n.json();return{owner:r,repo:a,commit_hash:s.commit_hash,manifest:s.manifest,examples:s.examples}}async _pullPrompt(e,t){return JSON.stringify((await this.pullPromptCommit(e,{includeModel:t?.includeModel})).manifest)}async pushPrompt(e,t){return(await this.promptExists(e)?t&&Object.keys(t).some(e=>"object"!==e)&&await this.updatePrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}):await this.createPrompt(e,{description:t?.description,readme:t?.readme,tags:t?.tags,isPublic:t?.isPublic}),t?.object)?await this.createCommit(e,t?.object,{parentCommitHash:t?.parentCommitHash}):await this._getPromptUrl(e)}async clonePublicDataset(e,t={}){let{sourceApiUrl:r=this.apiUrl,datasetName:a}=t,[i,n]=this.parseTokenOrUrl(e,r),s=new n3({apiUrl:i,apiKey:"placeholder"}),o=await s.readSharedDataset(n),l=a||o.name;try{if(await this.hasDataset({datasetId:l}))return void console.log(`Dataset ${l} already exists in your tenant. Skipping.`)}catch(e){}let u=await s.listSharedExamples(n),c=await this.createDataset(l,{description:o.description,dataType:o.data_type||"kv",inputsSchema:o.inputs_schema_definition??void 0,outputsSchema:o.outputs_schema_definition??void 0});try{await this.createExamples({inputs:u.map(e=>e.inputs),outputs:u.flatMap(e=>e.outputs?[e.outputs]:[]),datasetId:c.id})}catch(e){throw console.error(`An error occurred while creating dataset ${l}. You should delete it manually.`),e}}parseTokenOrUrl(e,t,r=2,a="dataset"){try{return nM(e),[t,e]}catch(e){}try{let i=new URL(e).pathname.split("/").filter(e=>""!==e);if(i.length>=r){let e=i[i.length-r];return[t,e]}throw Error(`Invalid public ${a} URL: ${e}`)}catch(t){throw Error(`Invalid public ${a} URL or token: ${e}`)}}async awaitPendingTraceBatches(){if(this.manualFlushMode)return console.warn("[WARNING]: When tracing in manual flush mode, you must call `await client.flush()` manually to submit trace batches."),Promise.resolve();await Promise.all([...this.autoBatchQueue.items.map(({itemPromise:e})=>e),this.batchIngestCaller.queue.onIdle()]),void 0!==this.langSmithToOTELTranslator&&await n$.getDefaultOTLPTracerComponents()?.DEFAULT_LANGSMITH_SPAN_PROCESSOR?.forceFlush()}}function n6(e){return"dataset_id"in e||"dataset_name"in e}let n8=Symbol.for("lc:context_variables");function n7(e,t,r=1){let a=r.toFixed(0).slice(0,3).padStart(3,"0"),i=`${new Date(e).toISOString().slice(0,-1)}${a}Z`;return{dottedOrder:i.replace(/[-:.]/g,"")+t,microsecondPrecisionDatestring:i}}class se{constructor(e,t,r,a){Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.metadata=e,this.tags=t,this.project_name=r,this.replicas=a}static fromHeader(e){let t,r,a=e.split(","),i={},n=[];for(let e of a){let[a,s]=e.split("="),o=decodeURIComponent(s);"langsmith-metadata"===a?i=JSON.parse(o):"langsmith-tags"===a?n=o.split(","):"langsmith-project"===a?t=o:"langsmith-replicas"===a&&(r=JSON.parse(o))}return new se(i,n,t,r)}toHeader(){let e=[];return this.metadata&&Object.keys(this.metadata).length>0&&e.push(`langsmith-metadata=${encodeURIComponent(JSON.stringify(this.metadata))}`),this.tags&&this.tags.length>0&&e.push(`langsmith-tags=${encodeURIComponent(this.tags.join(","))}`),this.project_name&&e.push(`langsmith-project=${encodeURIComponent(this.project_name)}`),e.join(",")}}class st{constructor(e){if(Object.defineProperty(this,"id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"run_type",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"project_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"parent_run_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_runs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"end_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"extra",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"error",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"serialized",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"inputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reference_example_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"trace_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"dotted_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"child_execution_order",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"attachments",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_serialized_start_time",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),function(e){return null!=e&&"function"==typeof e.createChild&&"function"==typeof e.postRun}(e))return void Object.assign(this,{...e});let t=st.getDefaultConfig(),{metadata:r,...a}=e,i=a.client??st.getSharedClient(),n={...r,...a?.extra?.metadata};if(a.extra={...a.extra,metadata:n},Object.assign(this,{...t,...a,client:i}),this.trace_id||(this.parent_run?this.trace_id=this.parent_run.trace_id??this.id:this.trace_id=this.id),this.replicas=function(e){return e?e.map(e=>Array.isArray(e)?{projectName:e[0],updates:e[1]}:e):function(){let e=nb("LANGSMITH_RUNS_ENDPOINTS");if(!e)return[];try{let r=JSON.parse(e);if(Array.isArray(r)){let e=[];for(let t of r){if("object"!=typeof t||null===t){console.warn(`Invalid item type in LANGSMITH_RUNS_ENDPOINTS: expected object, got ${typeof t}`);continue}if("string"!=typeof t.api_url){console.warn(`Invalid api_url type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof t.api_url}`);continue}if("string"!=typeof t.api_key){console.warn(`Invalid api_key type in LANGSMITH_RUNS_ENDPOINTS: expected string, got ${typeof t.api_key}`);continue}e.push({apiUrl:t.api_url.replace(/\/$/,""),apiKey:t.api_key})}return e}if("object"!=typeof r||null===r)return console.warn(`Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey, got ${typeof r}`),[];{var t=r;if(Object.keys(t).length>0&&n_("ENDPOINT"))throw new nH;let e=[];for(let[t,a]of Object.entries(r)){let r=t.replace(/\/$/,"");if("string"==typeof a)e.push({apiUrl:r,apiKey:a});else{console.warn(`Invalid value type in LANGSMITH_RUNS_ENDPOINTS for URL ${t}: expected string, got ${typeof a}`);continue}}return e}}catch(e){if("object"==typeof e&&null!==e&&e.code===nq)throw e;return console.warn("Invalid LANGSMITH_RUNS_ENDPOINTS  must be valid JSON array of objects with api_url and api_key properties, or object mapping url->apiKey"),[]}}()}(this.replicas),this.execution_order??=1,this.child_execution_order??=1,!this.dotted_order){let{dottedOrder:e,microsecondPrecisionDatestring:t}=n7(this.start_time,this.id,this.execution_order);this.parent_run?this.dotted_order=this.parent_run.dotted_order+"."+e:this.dotted_order=e,this._serialized_start_time=t}}set metadata(e){this.extra={...this.extra,metadata:{...this.extra?.metadata,...e}}}get metadata(){return this.extra?.metadata}static getDefaultConfig(){return{id:na(),run_type:"chain",project_name:nf(),child_runs:[],api_url:nb("LANGCHAIN_ENDPOINT")??"http://localhost:1984",api_key:nb("LANGCHAIN_API_KEY"),caller_options:{},start_time:Date.now(),serialized:{},inputs:{},extra:{}}}static getSharedClient(){return st.sharedClient||(st.sharedClient=new n3),st.sharedClient}createChild(e){var t,r;let a=this.child_execution_order+1,i=new st({...e,parent_run:this,project_name:this.project_name,replicas:this.replicas,client:this.client,tracingEnabled:this.tracingEnabled,execution_order:a,child_execution_order:a});n8 in this&&(i[n8]=this[n8]);let n=Symbol.for("lc:child_config"),s=e.extra?.[n]??this.extra[n];if(null!=(t=s)&&"object"==typeof t.callbacks&&(sa(t.callbacks?.handlers)||sa(t.callbacks))){let e={...s},t="object"==typeof(r=e.callbacks)&&null!=r&&Array.isArray(r.handlers)?e.callbacks.copy?.():void 0;t&&(Object.assign(t,{_parentRunId:i.id}),t.handlers?.find(sr)?.updateFromRunTree?.(i),e.callbacks=t),i.extra[n]=e}let o=new Set,l=this;for(;null!=l&&!o.has(l.id);)o.add(l.id),l.child_execution_order=Math.max(l.child_execution_order,a),l=l.parent_run;return this.child_runs.push(i),i}async end(e,t,r=Date.now(),a){this.outputs=this.outputs??e,this.error=this.error??t,this.end_time=this.end_time??r,a&&Object.keys(a).length>0&&(this.extra=this.extra?{...this.extra,metadata:{...this.extra.metadata,...a}}:{metadata:a})}_convertToCreate(e,t,r=!0){let a,i,n=e.extra??{};if(n?.runtime?.library===void 0&&(n.runtime||(n.runtime={}),t))for(let[e,r]of Object.entries(t))n.runtime[e]||(n.runtime[e]=r);return r?(i=e.parent_run?.id??e.parent_run_id,a=[]):(a=e.child_runs.map(e=>this._convertToCreate(e,t,r)),i=void 0),{id:e.id,name:e.name,start_time:e._serialized_start_time??e.start_time,end_time:e.end_time,run_type:e.run_type,reference_example_id:e.reference_example_id,extra:n,serialized:e.serialized,error:e.error,inputs:e.inputs,outputs:e.outputs,session_name:e.project_name,child_runs:a,parent_run_id:i,trace_id:e.trace_id,dotted_order:e.dotted_order,tags:e.tags,attachments:e.attachments,events:e.events}}_remapForProject(e,t,r=!0){let a,i=this._convertToCreate(this,t,r);if(e===this.project_name)return i;let n=t=>no(`${t}:${e}`,no.DNS),s=n(i.id),o=i.trace_id?n(i.trace_id):void 0,l=i.parent_run_id?n(i.parent_run_id):void 0;if(i.dotted_order){let e=i.dotted_order.split(".").map(e=>{let t=e.slice(0,-36),r=e.slice(-36),a=parseInt(t.slice(0,4)),i=parseInt(t.slice(4,6))-1,n=parseInt(t.slice(6,8)),s=parseInt(t.slice(9,11)),o=parseInt(t.slice(11,13));return[new Date(a,i,n,s,o,parseInt(t.slice(13,15)),parseInt(t.slice(15,21))/1e3),r]}),t=[];for(let r=0;r<e.length-1;r++){let[a,i]=e[r],s=n(i);t.push(a.toISOString().replace(/[-:]/g,"").replace(".","")+s)}let[r]=e[e.length-1];t.push(r.toISOString().replace(/[-:]/g,"").replace(".","")+s),a=t.join(".")}else a=void 0;return{...i,id:s,trace_id:o,parent_run_id:l,dotted_order:a,session_name:e}}async postRun(e=!0){try{let t=ny();if(this.replicas&&this.replicas.length>0)for(let{projectName:e,apiKey:r,apiUrl:a,workspaceId:i}of this.replicas){let n=this._remapForProject(e??this.project_name,t,!0);await this.client.createRun(n,{apiKey:r,apiUrl:a,workspaceId:i})}else{let r=this._convertToCreate(this,t,e);await this.client.createRun(r)}if(!e)for(let e of(nD("Posting with excludeChildRuns=false is deprecated and will be removed in a future version."),this.child_runs))await e.postRun(!1)}catch(e){console.error(`Error in postRun for run ${this.id}:`,e)}}async patchRun(e){if(this.replicas&&this.replicas.length>0)for(let{projectName:t,apiKey:r,apiUrl:a,workspaceId:i,updates:n}of this.replicas){let s=this._remapForProject(t??this.project_name),o={id:s.id,outputs:s.outputs,error:s.error,parent_run_id:s.parent_run_id,session_name:s.session_name,reference_example_id:s.reference_example_id,end_time:s.end_time,dotted_order:s.dotted_order,trace_id:s.trace_id,events:s.events,tags:s.tags,extra:s.extra,attachments:this.attachments,...n};e?.excludeInputs||(o.inputs=s.inputs),await this.client.updateRun(s.id,o,{apiKey:r,apiUrl:a,workspaceId:i})}else try{let t={end_time:this.end_time,error:this.error,outputs:this.outputs,parent_run_id:this.parent_run?.id??this.parent_run_id,reference_example_id:this.reference_example_id,extra:this.extra,events:this.events,dotted_order:this.dotted_order,trace_id:this.trace_id,tags:this.tags,attachments:this.attachments,session_name:this.project_name};e?.excludeInputs||(t.inputs=this.inputs),await this.client.updateRun(this.id,t)}catch(e){console.error(`Error in patchRun for run ${this.id}`,e)}}toJSON(){return this._convertToCreate(this,void 0,!1)}addEvent(e){this.events||(this.events=[]),"string"==typeof e?this.events.push({name:"event",time:new Date().toISOString(),message:e}):this.events.push({...e,time:e.time??new Date().toISOString()})}static fromRunnableConfig(e,t){var r;let a,i,n,s=e?.callbacks,o=void 0!==r?r:!!["TRACING_V2","TRACING"].find(e=>"true"===n_(e));if(s){let e=s?.getParentRunId?.()??"",t=s?.handlers?.find(e=>e?.name=="langchain_tracer");a=t?.getRun?.(e),i=t?.projectName,n=t?.client,o=o||!!t}return a?new st({name:a.name,id:a.id,trace_id:a.trace_id,dotted_order:a.dotted_order,client:n,tracingEnabled:o,project_name:i,tags:[...new Set((a?.tags??[]).concat(e?.tags??[]))],extra:{metadata:{...a?.extra?.metadata,...e?.metadata}}}).createChild(t):new st({...t,client:n,tracingEnabled:o,project_name:i})}static fromDottedOrder(e){return this.fromHeaders({"langsmith-trace":e})}static fromHeaders(e,t){let r="get"in e&&"function"==typeof e.get?{"langsmith-trace":e.get("langsmith-trace"),baggage:e.get("baggage")}:e,a=r["langsmith-trace"];if(!a||"string"!=typeof a)return;let i=a.trim(),n=i.split(".").map(e=>{let[t,r]=e.split("Z");return{strTime:t,time:Date.parse(t+"Z"),uuid:r}}),s=n[0].uuid,o={...t,name:t?.name??"parent",run_type:t?.run_type??"chain",start_time:t?.start_time??Date.now(),id:n.at(-1)?.uuid,trace_id:s,dotted_order:i};if(r.baggage&&"string"==typeof r.baggage){let e=se.fromHeader(r.baggage);o.metadata=e.metadata,o.tags=e.tags,o.project_name=e.project_name,o.replicas=e.replicas}return new st(o)}toHeaders(e){let t={"langsmith-trace":this.dotted_order,baggage:new se(this.extra?.metadata,this.tags,this.project_name,this.replicas).toHeader()};if(e)for(let[r,a]of Object.entries(t))e.set(r,a);return t}}function sr(e){return"object"==typeof e&&null!=e&&"string"==typeof e.name&&"langchain_tracer"===e.name}function sa(e){return Array.isArray(e)&&e.some(e=>sr(e))}function si(e){try{if("undefined"!=typeof process)return process.env?.[e];if("undefined"!=typeof Deno)return Deno?.env.get(e);return}catch(e){return}}Object.defineProperty(st,"sharedClient",{enumerable:!0,configurable:!0,writable:!0,value:null});class sn{}function ss(e){return"lc_prefer_streaming"in e&&e.lc_prefer_streaming}class so extends sn{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}get lc_serializable_keys(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,a6(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreCustomEvent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"raiseError",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:"false"===si("LANGCHAIN_CALLBACKS_BACKGROUND")}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever,this.ignoreCustomEvent=e.ignoreCustomEvent??this.ignoreCustomEvent,this.raiseError=e.raiseError??this.raiseError,this.awaitHandlers=this.raiseError||(e._awaitHandler??this.awaitHandlers))}copy(){return new this.constructor(this)}toJSON(){return a8.prototype.toJSON.call(this)}toJSONNotImplemented(){return a8.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){return new class extends so{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:iM()}),Object.assign(this,e)}}}}let sl=e=>void 0!==e&&"function"==typeof e.copy&&"string"==typeof e.name&&"boolean"==typeof e.awaitHandlers;function su(e,t){return e&&!Array.isArray(e)&&"object"==typeof e?e:{[t]:e}}function sc(e){return"function"==typeof e._addRunToRunMap}class sd extends so{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"runTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!1})}copy(){return this}getRunById(e){if(void 0!==e)return this.usesRunTreeMap?(e=>{if(e)return e.events=e.events??[],e.child_runs=e.child_runs??[],e})(this.runTreeMap.get(e)):this.runMap.get(e)}stringifyError(e){return e instanceof Error?e.message+(e?.stack?`

${e.stack}`:""):"string"==typeof e?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}_addRunToRunMap(e){let{dottedOrder:t,microsecondPrecisionDatestring:r}=n7(new Date(e.start_time).getTime(),e.id,e.execution_order),a={...e},i=this.getRunById(a.parent_run_id);if(void 0!==a.parent_run_id?i&&(this._addChildRun(i,a),i.child_execution_order=Math.max(i.child_execution_order,a.child_execution_order),a.trace_id=i.trace_id,void 0!==i.dotted_order&&(a.dotted_order=[i.dotted_order,t].join("."),a._serialized_start_time=r)):(a.trace_id=a.id,a.dotted_order=t,a._serialized_start_time=r),this.usesRunTreeMap){let e=function e(t,r){if(t)return new st({...t,start_time:t._serialized_start_time??t.start_time,parent_run:e(r),child_runs:t.child_runs.map(t=>e(t)).filter(e=>void 0!==e),extra:{...t.extra,runtime:function(){void 0===d&&(d={library:"langchain-js",runtime:"undefined"!=typeof window&&void 0!==window.document?"browser":"undefined"==typeof process||void 0===process.versions||void 0===process.versions.node||"undefined"!=typeof Deno?"object"==typeof globalThis&&globalThis.constructor&&"DedicatedWorkerGlobalScope"===globalThis.constructor.name?"webworker":"undefined"!=typeof window&&"nodejs"===window.name||"undefined"!=typeof navigator&&navigator.userAgent.includes("jsdom")?"jsdom":"undefined"!=typeof Deno?"deno":"other":"node"});return d}()},tracingEnabled:!1})}(a,i);void 0!==e&&this.runTreeMap.set(a.id,e)}else this.runMap.set(a.id,a);return a}async _endTrace(e){let t=void 0!==e.parent_run_id&&this.getRunById(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),await this.onRunUpdate?.(e),this.usesRunTreeMap?this.runTreeMap.delete(e.id):this.runMap.delete(e.id)}_getExecutionOrder(e){let t=void 0!==e&&this.getRunById(e);return t?t.child_execution_order+1:1}_createRunForLLMStart(e,t,r,a,i,n,s,o){let l=this._getExecutionOrder(a),u=Date.now(),c=s?{...i,metadata:s}:i,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:c??{},tags:n||[]};return this._addRunToRunMap(d)}async handleLLMStart(e,t,r,a,i,n,s,o){let l=this.getRunById(r)??this._createRunForLLMStart(e,t,r,a,i,n,s,o);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}_createRunForChatModelStart(e,t,r,a,i,n,s,o){let l=this._getExecutionOrder(a),u=Date.now(),c=s?{...i,metadata:s}:i,d={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:c??{},tags:n||[]};return this._addRunToRunMap(d)}async handleChatModelStart(e,t,r,a,i,n,s,o){let l=this.getRunById(r)??this._createRunForChatModelStart(e,t,r,a,i,n,s,o);return await this.onRunCreate?.(l),await this.onLLMStart?.(l),l}async handleLLMEnd(e,t,r,a,i){let n=this.getRunById(t);if(!n||n?.run_type!=="llm")throw Error("No LLM run to end.");return n.end_time=Date.now(),n.outputs=e,n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),n.extra={...n.extra,...i},await this.onLLMEnd?.(n),await this._endTrace(n),n}async handleLLMError(e,t,r,a,i){let n=this.getRunById(t);if(!n||n?.run_type!=="llm")throw Error("No LLM run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),n.extra={...n.extra,...i},await this.onLLMError?.(n),await this._endTrace(n),n}_createRunForChainStart(e,t,r,a,i,n,s,o){let l=this._getExecutionOrder(a),u=Date.now(),c={id:r,name:o??e.id[e.id.length-1],parent_run_id:a,start_time:u,serialized:e,events:[{name:"start",time:new Date(u).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:s??"chain",child_runs:[],extra:n?{metadata:n}:{},tags:i||[]};return this._addRunToRunMap(c)}async handleChainStart(e,t,r,a,i,n,s,o){let l=this.getRunById(r)??this._createRunForChainStart(e,t,r,a,i,n,s,o);return await this.onRunCreate?.(l),await this.onChainStart?.(l),l}async handleChainEnd(e,t,r,a,i){let n=this.getRunById(t);if(!n)throw Error("No chain run to end.");return n.end_time=Date.now(),n.outputs=su(e,"output"),n.events.push({name:"end",time:new Date(n.end_time).toISOString()}),i?.inputs!==void 0&&(n.inputs=su(i.inputs,"input")),await this.onChainEnd?.(n),await this._endTrace(n),n}async handleChainError(e,t,r,a,i){let n=this.getRunById(t);if(!n)throw Error("No chain run to end.");return n.end_time=Date.now(),n.error=this.stringifyError(e),n.events.push({name:"error",time:new Date(n.end_time).toISOString()}),i?.inputs!==void 0&&(n.inputs=su(i.inputs,"input")),await this.onChainError?.(n),await this._endTrace(n),n}_createRunForToolStart(e,t,r,a,i,n,s){let o=this._getExecutionOrder(a),l=Date.now(),u={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:o,child_execution_order:o,run_type:"tool",child_runs:[],extra:n?{metadata:n}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleToolStart(e,t,r,a,i,n,s){let o=this.getRunById(r)??this._createRunForToolStart(e,t,r,a,i,n,s);return await this.onRunCreate?.(o),await this.onToolStart?.(o),o}async handleToolEnd(e,t){let r=this.getRunById(t);if(!r||r?.run_type!=="tool")throw Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onToolEnd?.(r),await this._endTrace(r),r}async handleToolError(e,t){let r=this.getRunById(t);if(!r||r?.run_type!=="tool")throw Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onToolError?.(r),await this._endTrace(r),r}async handleAgentAction(e,t){let r=this.getRunById(t);r&&r?.run_type==="chain"&&(r.actions=r.actions||[],r.actions.push(e),r.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentAction?.(r))}async handleAgentEnd(e,t){let r=this.getRunById(t);r&&r?.run_type==="chain"&&(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await this.onAgentEnd?.(r))}_createRunForRetrieverStart(e,t,r,a,i,n,s){let o=this._getExecutionOrder(a),l=Date.now(),u={id:r,name:s??e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:o,child_execution_order:o,run_type:"retriever",child_runs:[],extra:n?{metadata:n}:{},tags:i||[]};return this._addRunToRunMap(u)}async handleRetrieverStart(e,t,r,a,i,n,s){let o=this.getRunById(r)??this._createRunForRetrieverStart(e,t,r,a,i,n,s);return await this.onRunCreate?.(o),await this.onRetrieverStart?.(o),o}async handleRetrieverEnd(e,t){let r=this.getRunById(t);if(!r||r?.run_type!=="retriever")throw Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await this.onRetrieverEnd?.(r),await this._endTrace(r),r}async handleRetrieverError(e,t){let r=this.getRunById(t);if(!r||r?.run_type!=="retriever")throw Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await this.onRetrieverError?.(r),await this._endTrace(r),r}async handleText(e,t){let r=this.getRunById(t);r&&r?.run_type==="chain"&&(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await this.onText?.(r))}async handleLLMNewToken(e,t,r,a,i,n){let s=this.getRunById(r);if(!s||s?.run_type!=="llm")throw Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return s.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:n?.chunk}}),await this.onLLMNewToken?.(s,e,{chunk:n?.chunk}),s}}var sh=r(94083);function sp(e,t){return`${e.open}${t}${e.close}`}function sf(e,t){try{return JSON.stringify(e,null,2)}catch(e){return t}}function sm(e){return"string"==typeof e?e.trim():null==e?e:sf(e,e.toString())}function sg(e){if(!e.end_time)return"";let t=e.end_time-e.start_time;return t<1e3?`${t}ms`:`${(t/1e3).toFixed(2)}s`}let{color:sy}=sh;class sb extends sd{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let e=this.runMap.get(r.parent_run_id);if(e)t.push(e),r=e;else break}return t}getBreadcrumbs(e){let t=[...this.getParents(e).reverse(),e].map((e,t,r)=>{let a=`${e.execution_order}:${e.run_type}:${e.name}`;return t===r.length-1?sp(sh.bold,a):a}).join(" > ");return sp(sy.grey,t)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.green,"[chain/start]")} [${t}] Entering Chain run with input: ${sf(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.cyan,"[chain/end]")} [${t}] [${sg(e)}] Exiting Chain run with output: ${sf(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.red,"[chain/error]")} [${t}] [${sg(e)}] Chain run errored with error: ${sf(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(e=>e.trim())}:e.inputs;console.log(`${sp(sy.green,"[llm/start]")} [${t}] Entering LLM run with input: ${sf(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.cyan,"[llm/end]")} [${t}] [${sg(e)}] Exiting LLM run with output: ${sf(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.red,"[llm/error]")} [${t}] [${sg(e)}] LLM run errored with error: ${sf(e.error,"[error]")}`)}onToolStart(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.green,"[tool/start]")} [${t}] Entering Tool run with input: "${sm(e.inputs.input)}"`)}onToolEnd(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.cyan,"[tool/end]")} [${t}] [${sg(e)}] Exiting Tool run with output: "${sm(e.outputs?.output)}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.red,"[tool/error]")} [${t}] [${sg(e)}] Tool run errored with error: ${sf(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${sf(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.cyan,"[retriever/end]")} [${t}] [${sg(e)}] Exiting Retriever run with output: ${sf(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.red,"[retriever/error]")} [${t}] [${sg(e)}] Retriever run errored with error: ${sf(e.error,"[error]")}`)}onAgentAction(e){let t=this.getBreadcrumbs(e);console.log(`${sp(sy.blue,"[agent/action]")} [${t}] Agent selected action: ${sf(e.actions[e.actions.length-1],"[action]")}`)}}class s_ extends sd{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"replicas",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"usesRunTreeMap",{enumerable:!0,configurable:!0,writable:!0,value:!0});let{exampleId:t,projectName:r,client:a,replicas:i}=e;this.projectName=r??nf(),this.replicas=i,this.exampleId=t,this.client=a??(void 0===h&&(h=new n3("false"===si("LANGCHAIN_CALLBACKS_BACKGROUND")?{blockOnRootRunFinalization:!0}:{})),h);let n=s_.getTraceableRunTree();n&&this.updateFromRunTree(n)}async persistRun(e){}async onRunCreate(e){let t=this.getRunTreeWithTracingConfig(e.id);await t?.postRun()}async onRunUpdate(e){let t=this.getRunTreeWithTracingConfig(e.id);await t?.patchRun()}getRun(e){return this.runTreeMap.get(e)}updateFromRunTree(e){this.runTreeMap.set(e.id,e);let t=e,r=new Set;for(;t.parent_run&&!r.has(t.id)&&(r.add(t.id),t.parent_run);){;t=t.parent_run}r.clear();let a=[t];for(;a.length>0;){let e=a.shift();!(!e||r.has(e.id))&&(r.add(e.id),this.runTreeMap.set(e.id,e),e.child_runs&&a.push(...e.child_runs))}this.client=e.client??this.client,this.replicas=e.replicas??this.replicas,this.projectName=e.project_name??this.projectName,this.exampleId=e.reference_example_id??this.exampleId}getRunTreeWithTracingConfig(e){let t=this.runTreeMap.get(e);if(t)return new st({...t,client:this.client,project_name:this.projectName,replicas:this.replicas,reference_example_id:this.exampleId,tracingEnabled:!0})}static getTraceableRunTree(){try{return function(e=!1){let t=iz.getInstance().getStore();if(!e&&void 0===t)throw Error("Could not get the current run tree.\n\nPlease make sure you are calling this method within a traceable function and that tracing is enabled.");return t}(!0)}catch{return}}}let sw=Symbol.for("ls:tracing_async_local_storage"),sv=Symbol.for("lc:context_variables"),sE=()=>globalThis[sw];async function sO(e,t){if(!0===t){let t=sE();void 0!==t?await t.run(void 0,async()=>e()):await e()}else void 0===p&&(p=new("default"in nP?nP.default:nP)({autoStart:!0,concurrency:1})),p.add(async()=>{let t=sE();void 0!==t?await t.run(void 0,async()=>e()):await e()})}function sk(e){let t=sE();if(void 0===t)return;let r=t.getStore();return r?.[sv]?.[e]}let sS=Symbol("lc:configure_hooks");class sx{setHandler(e){return this.setHandlers([e])}}class s${constructor(e,t,r,a,i,n,s,o){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:n}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:o})}get parentRunId(){return this._parentRunId}async handleText(e){await Promise.all(this.handlers.map(t=>sO(async()=>{try{await t.handleText?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleText: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleCustomEvent(e,t,r,a,i){await Promise.all(this.handlers.map(r=>sO(async()=>{try{await r.handleCustomEvent?.(e,t,this.runId,this.tags,this.metadata)}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleCustomEvent: ${e}`),r.raiseError)throw e}},r.awaitHandlers)))}}class sI extends s${getChild(e){let t=new sj(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>sO(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetriever`),t.raiseError)throw e}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>sO(async()=>{if(!t.ignoreRetriever)try{await t.handleRetrieverError?.(e,this.runId,this._parentRunId,this.tags)}catch(r){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleRetrieverError: ${r}`),t.raiseError)throw e}},t.awaitHandlers)))}}class sA extends s${async handleLLMNewToken(e,t,r,a,i,n){await Promise.all(this.handlers.map(r=>sO(async()=>{if(!r.ignoreLLM)try{await r.handleLLMNewToken?.(e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,n)}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMNewToken: ${e}`),r.raiseError)throw e}},r.awaitHandlers)))}async handleLLMError(e,t,r,a,i){await Promise.all(this.handlers.map(t=>sO(async()=>{if(!t.ignoreLLM)try{await t.handleLLMError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleLLMEnd(e,t,r,a,i){await Promise.all(this.handlers.map(t=>sO(async()=>{if(!t.ignoreLLM)try{await t.handleLLMEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleLLMEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class sT extends s${getChild(e){let t=new sj(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,i){await Promise.all(this.handlers.map(t=>sO(async()=>{if(!t.ignoreChain)try{await t.handleChainError?.(e,this.runId,this._parentRunId,this.tags,i)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleChainEnd(e,t,r,a,i){await Promise.all(this.handlers.map(t=>sO(async()=>{if(!t.ignoreChain)try{await t.handleChainEnd?.(e,this.runId,this._parentRunId,this.tags,i)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleChainEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>sO(async()=>{if(!t.ignoreAgent)try{await t.handleAgentAction?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentAction: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>sO(async()=>{if(!t.ignoreAgent)try{await t.handleAgentEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleAgentEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class sP extends s${getChild(e){let t=new sj(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>sO(async()=>{if(!t.ignoreAgent)try{await t.handleToolError?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolError: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>sO(async()=>{if(!t.ignoreAgent)try{await t.handleToolEnd?.(e,this.runId,this._parentRunId,this.tags)}catch(e){if((t.raiseError?console.error:console.warn)(`Error in handler ${t.constructor.name}, handleToolEnd: ${e}`),t.raiseError)throw e}},t.awaitHandlers)))}}class sj extends sx{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=t?.handlers??this.handlers,this.inheritableHandlers=t?.inheritableHandlers??this.inheritableHandlers,this.tags=t?.tags??this.tags,this.inheritableTags=t?.inheritableTags??this.inheritableTags,this.metadata=t?.metadata??this.metadata,this.inheritableMetadata=t?.inheritableMetadata??this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r,a,i,n,s,o){return Promise.all(t.map(async(t,a)=>{let n=0===a&&r?r:iM();return await Promise.all(this.handlers.map(r=>{if(!r.ignoreLLM)return sc(r)&&r._createRunForLLMStart(e,[t],n,this._parentRunId,i,this.tags,this.metadata,o),sO(async()=>{try{await r.handleLLMStart?.(e,[t],n,this._parentRunId,i,this.tags,this.metadata,o)}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new sA(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r,a,i,n,s,o){return Promise.all(t.map(async(t,a)=>{let n=0===a&&r?r:iM();return await Promise.all(this.handlers.map(r=>{if(!r.ignoreLLM)return sc(r)&&r._createRunForChatModelStart(e,[t],n,this._parentRunId,i,this.tags,this.metadata,o),sO(async()=>{try{if(r.handleChatModelStart)await r.handleChatModelStart?.(e,[t],n,this._parentRunId,i,this.tags,this.metadata,o);else if(r.handleLLMStart){let a=iT(t);await r.handleLLMStart?.(e,[a],n,this._parentRunId,i,this.tags,this.metadata,o)}}catch(e){if((r.raiseError?console.error:console.warn)(`Error in handler ${r.constructor.name}, handleLLMStart: ${e}`),r.raiseError)throw e}},r.awaitHandlers)})),new sA(n,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=iM(),a,i,n,s){return await Promise.all(this.handlers.map(i=>{if(!i.ignoreChain)return sc(i)&&i._createRunForChainStart(e,t,r,this._parentRunId,this.tags,this.metadata,a,s),sO(async()=>{try{await i.handleChainStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,a,s)}catch(e){if((i.raiseError?console.error:console.warn)(`Error in handler ${i.constructor.name}, handleChainStart: ${e}`),i.raiseError)throw e}},i.awaitHandlers)})),new sT(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=iM(),a,i,n,s){return await Promise.all(this.handlers.map(a=>{if(!a.ignoreAgent)return sc(a)&&a._createRunForToolStart(e,t,r,this._parentRunId,this.tags,this.metadata,s),sO(async()=>{try{await a.handleToolStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,s)}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleToolStart: ${e}`),a.raiseError)throw e}},a.awaitHandlers)})),new sP(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=iM(),a,i,n,s){return await Promise.all(this.handlers.map(a=>{if(!a.ignoreRetriever)return sc(a)&&a._createRunForRetrieverStart(e,t,r,this._parentRunId,this.tags,this.metadata,s),sO(async()=>{try{await a.handleRetrieverStart?.(e,t,r,this._parentRunId,this.tags,this.metadata,s)}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleRetrieverStart: ${e}`),a.raiseError)throw e}},a.awaitHandlers)})),new sI(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleCustomEvent(e,t,r,a,i){await Promise.all(this.handlers.map(a=>sO(async()=>{if(!a.ignoreCustomEvent)try{await a.handleCustomEvent?.(e,t,r,this.tags,this.metadata)}catch(e){if((a.raiseError?console.error:console.warn)(`Error in handler ${a.constructor.name}, handleCustomEvent: ${e}`),a.raiseError)throw e}},a.awaitHandlers)))}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){for(let r of(this.handlers=[],this.inheritableHandlers=[],e))this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new sj(this._parentRunId);for(let e of this.handlers){let t=this.inheritableHandlers.includes(e);r.addHandler(e,t)}for(let e of this.tags){let t=this.inheritableTags.includes(e);r.addTags([e],t)}for(let e of Object.keys(this.metadata)){let t=Object.keys(this.inheritableMetadata).includes(e);r.addMetadata({[e]:this.metadata[e]},t)}for(let a of e)r.handlers.filter(e=>"console_callback_handler"===e.name).some(e=>e.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){let t=new this;return t.addHandler(new class extends so{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:iM()}),Object.assign(this,e)}}),t}static configure(e,t,r,a,i,n,s){return this._configureSync(e,t,r,a,i,n,s)}static _configureSync(e,t,r,a,i,n,s){var o;let l;(e||t)&&(Array.isArray(e)||!e?(l=new sj).setHandlers(e?.map(sN)??[],!0):l=e,l=l.copy(Array.isArray(t)?t.map(sN):t?.handlers,!1));let u="true"===si("LANGCHAIN_VERBOSE")||s?.verbose,c=s_.getTraceableRunTree()?.tracingEnabled||(void 0!==o?o:!!["LANGSMITH_TRACING_V2","LANGCHAIN_TRACING_V2","LANGSMITH_TRACING","LANGCHAIN_TRACING"].find(e=>"true"===si(e))),d=c||(si("LANGCHAIN_TRACING")??!1);if(u||d){if(l||(l=new sj),u&&!l.handlers.some(e=>e.name===sb.prototype.name)){let e=new sb;l.addHandler(e,!0)}if(d&&!l.handlers.some(e=>"langchain_tracer"===e.name)&&c){let e=new s_;l.addHandler(e,!0),l._parentRunId=s_.getTraceableRunTree()?.id??l._parentRunId}}for(let{contextVar:e,inheritable:t=!0,handlerClass:r,envVar:a}of sk(sS)||[]){let i,n=a&&"true"===si(a)&&r,s=void 0!==e?sk(e):void 0;s&&sl(s)?i=s:n&&(i=new r({})),void 0!==i&&(l||(l=new sj),l.handlers.some(e=>e.name===i.name)||l.addHandler(i,t))}return(r||a)&&l&&(l.addTags(r??[]),l.addTags(a??[],!1)),(i||n)&&l&&(l.addMetadata(i??{}),l.addMetadata(n??{},!1)),l}}function sN(e){return"name"in e?e:so.fromMethods(e)}let sR=new class{getStore(){}run(e,t){return t()}enterWith(e){}},sC=Symbol.for("lc:child_config"),sL=new class{getInstance(){return sE()??sR}getRunnableConfig(){let e=this.getInstance();return e.getStore()?.extra?.[sC]}runWithConfig(e,t,r){let a,i=sj._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata),n=this.getInstance(),s=n.getStore(),o=i?.getParentRunId(),l=i?.handlers?.find(e=>e?.name==="langchain_tracer");return l&&o?a=l.getRunTreeWithTracingConfig(o):r||(a=new st({name:"<runnable_lambda>",tracingEnabled:!1})),a&&(a.extra={...a.extra,[sC]:e}),void 0!==s&&void 0!==s[sv]&&(void 0===a&&(a={}),a[sv]=s[sv]),n.run(a,t)}initializeGlobalInstance(e){void 0===sE()&&(globalThis[sw]=e)}};async function sM(e){return sj._configureSync(e?.callbacks,void 0,e?.tags,void 0,e?.metadata)}function sU(...e){let t={};for(let r of e.filter(e=>!!e))for(let e of Object.keys(r))if("metadata"===e)t[e]={...t[e],...r[e]};else if("tags"===e){let a=t[e]??[];t[e]=[...new Set(a.concat(r[e]??[]))]}else if("configurable"===e)t[e]={...t[e],...r[e]};else if("timeout"===e)void 0===t.timeout?t.timeout=r.timeout:void 0!==r.timeout&&(t.timeout=Math.min(t.timeout,r.timeout));else if("signal"===e)void 0===t.signal?t.signal=r.signal:void 0!==r.signal&&("any"in AbortSignal?t.signal=AbortSignal.any([t.signal,r.signal]):t.signal=r.signal);else if("callbacks"===e){let e=t.callbacks,a=r.callbacks;if(Array.isArray(a))if(e)if(Array.isArray(e))t.callbacks=e.concat(a);else{let r=e.copy();for(let e of a)r.addHandler(sN(e),!0);t.callbacks=r}else t.callbacks=a;else if(a)if(e)if(Array.isArray(e)){let r=a.copy();for(let t of e)r.addHandler(sN(t),!0);t.callbacks=r}else t.callbacks=new sj(a._parentRunId,{handlers:e.handlers.concat(a.handlers),inheritableHandlers:e.inheritableHandlers.concat(a.inheritableHandlers),tags:Array.from(new Set(e.tags.concat(a.tags))),inheritableTags:Array.from(new Set(e.inheritableTags.concat(a.inheritableTags))),metadata:{...e.metadata,...a.metadata}});else t.callbacks=a}else t[e]=r[e]??t[e];return t}let sD=new Set(["string","number","boolean"]);function sz(e){let t=sL.getRunnableConfig(),r={tags:[],metadata:{},recursionLimit:25,runId:void 0};if(t){let{runId:e,runName:a,...i}=t;r=Object.entries(i).reduce((e,[t,r])=>(void 0!==r&&(e[t]=r),e),r)}if(e&&(r=Object.entries(e).reduce((e,[t,r])=>(void 0!==r&&(e[t]=r),e),r)),r?.configurable)for(let e of Object.keys(r.configurable))sD.has(typeof r.configurable[e])&&!r.metadata?.[e]&&(r.metadata||(r.metadata={}),r.metadata[e]=r.configurable[e]);if(void 0!==r.timeout){if(r.timeout<=0)throw Error("Timeout must be a positive number");let e=AbortSignal.timeout(r.timeout);void 0!==r.signal?"any"in AbortSignal&&(r.signal=AbortSignal.any([r.signal,e])):r.signal=e,delete r.timeout}return r}function sF(e={},{callbacks:t,maxConcurrency:r,recursionLimit:a,runName:i,configurable:n,runId:s}={}){let o=sz(e);return void 0!==t&&(delete o.runName,o.callbacks=t),void 0!==a&&(o.recursionLimit=a),void 0!==r&&(o.maxConcurrency=r),void 0!==i&&(o.runName=i),void 0!==n&&(o.configurable={...o.configurable,...n}),void 0!==s&&delete o.runId,o}function sB(e){return e?{configurable:e.configurable,recursionLimit:e.recursionLimit,callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,maxConcurrency:e.maxConcurrency,timeout:e.timeout,signal:e.signal}:void 0}async function sq(e,t){let r;return void 0===t?e:Promise.race([e.catch(e=>{if(!t?.aborted)throw e}),new Promise((e,a)=>{r=()=>{a(Error("Aborted"))},t.addEventListener("abort",r),t.aborted&&a(Error("Aborted"))})]).finally(()=>t.removeEventListener("abort",r))}class sH extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();if(e.done)return this.reader.releaseLock(),{done:!0,value:void 0};return{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}throw e}[Symbol.asyncIterator](){return this}async [Symbol.asyncDispose](){await this.return()}static fromReadableStream(e){let t=e.getReader();return new sH({start:e=>(function r(){return t.read().then(({done:t,value:a})=>t?void e.close():(e.enqueue(a),r()))})(),cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new sH({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}}function sW(e,t=2){let r=Array.from({length:t},()=>[]);return r.map(async function*(t){for(;;)if(0===t.length){let t=await e.next();for(let e of r)e.push(t)}else{if(t[0].done)return;yield t.shift().value}})}function sJ(e,t){if(Array.isArray(e)&&Array.isArray(t))return e.concat(t);if("string"==typeof e&&"string"==typeof t)return e+t;if("number"==typeof e&&"number"==typeof t)return e+t;if("concat"in e&&"function"==typeof e.concat)return e.concat(t);if("object"==typeof e&&"object"==typeof t){let r={...e};for(let[e,a]of Object.entries(t))e in r&&!Array.isArray(r[e])?r[e]=sJ(r[e],a):r[e]=a;return r}else throw Error(`Cannot concat ${typeof e} and ${typeof t}`)}class sG{constructor(e){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"signal",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e.generator,this.config=e.config,this.signal=e.signal??this.config?.signal,this.setup=new Promise((t,r)=>{sL.runWithConfig(sB(e.config),async()=>{this.firstResult=e.generator.next(),e.startSetup?this.firstResult.then(e.startSetup).then(t,r):this.firstResult.then(e=>t(void 0),r)},!0)})}async next(...e){return(this.signal?.throwIfAborted(),this.firstResultUsed)?sL.runWithConfig(sB(this.config),this.signal?async()=>sq(this.generator.next(...e),this.signal):async()=>this.generator.next(...e),!0):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}async [Symbol.asyncDispose](){await this.return()}}async function sZ(e,t,r,a,...i){let n=new sG({generator:t,startSetup:r,signal:a}),s=await n.setup;return{output:e(n,s,...i),setup:s}}class sV{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops??[]}concat(e){let t=this.ops.concat(e.ops),r=i5({},t);return new sY({ops:t,state:r[r.length-1].newDocument})}}class sY extends sV{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=i5(this.state,e.ops);return new sY({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=i5({},e.ops);return new sY({ops:e.ops,state:t[t.length-1].newDocument})}}let sK=e=>"log_stream_tracer"===e.name;async function sX(e,t){if("original"===t)throw Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:r}=e;return["retriever","llm","prompt"].includes(e.run_type)?r:1!==Object.keys(r).length||r?.input!==""?r.input:void 0}async function sQ(e,t){let{outputs:r}=e;return"original"===t||["retriever","llm","prompt"].includes(e.run_type)?r:void 0!==r&&1===Object.keys(r).length&&r?.output!==void 0?r.output:r}class s0 extends sd{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this._schemaFormat=e?._schemaFormat??this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=sH.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.id===this.rootId)return!1;let t=e.tags??[],r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.run_type)),void 0!==this.includeTags&&(r=r||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.run_type)),void 0!==this.excludeTags&&(r=r&&t.every(e=>!this.excludeTags?.includes(e))),r}async *tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let t=this.keyMapByRunId[e];t&&await this.writer.write(new sV({ops:[{op:"add",path:`/logs/${t}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){if(void 0===this.rootId&&(this.rootId=e.id,await this.writer.write(new sV({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;void 0===this.counterMapByRunName[e.name]&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=1===t?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:e.extra?.metadata??{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};"streaming_events"===this._schemaFormat&&(r.inputs=await sX(e,this._schemaFormat)),await this.writer.write(new sV({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(void 0===t)return;let r=[];"streaming_events"===this._schemaFormat&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await sX(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await sQ(e,this._schemaFormat)}),void 0!==e.end_time&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new sV({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new sV({ops:[{op:"replace",path:"/final_output",value:await sQ(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a,i=this.keyMapByRunId[e.id];if(void 0===i)return;if(void 0!==e.inputs.messages){var n;a=void 0!==(n=r?.chunk)&&void 0!==n.message?r?.chunk:new ig({id:`run-${e.id}`,content:t})}else a=t;let s=new sV({ops:[{op:"add",path:`/logs/${i}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${i}/streamed_output/-`,value:a}]});await this.writer.write(s)}}let s1="__run";class s2{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new s2({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class s5 extends s2{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new s5({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}function s4({name:e,serialized:t}){return void 0!==e?e:t?.name!==void 0?t.name:t?.id!==void 0&&Array.isArray(t?.id)?t.id[t.id.length-1]:"Unnamed"}let s9=e=>"event_stream_tracer"===e.name;class s3 extends sd{constructor(e){super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"runInfoMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"tappedPromises",{enumerable:!0,configurable:!0,writable:!0,value:new Map}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"event_stream_tracer"}),Object.defineProperty(this,"lc_prefer_streaming",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.autoClose=e?.autoClose??!0,this.includeNames=e?.includeNames,this.includeTypes=e?.includeTypes,this.includeTags=e?.includeTags,this.excludeNames=e?.excludeNames,this.excludeTypes=e?.excludeTypes,this.excludeTags=e?.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=sH.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){let t=e.tags??[],r=void 0===this.includeNames&&void 0===this.includeTags&&void 0===this.includeTypes;return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(e.runType)),void 0!==this.includeTags&&(r=r||void 0!==t.find(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(e.runType)),void 0!==this.excludeTags&&(r=r&&t.every(e=>!this.excludeTags?.includes(e))),r}async *tapOutputIterable(e,t){let r=await t.next();if(r.done)return;let a=this.runInfoMap.get(e);if(void 0===a)return void(yield r.value);function i(e,t){return"llm"===e&&"string"==typeof t?new s2({text:t}):t}let n=this.tappedPromises.get(e);if(void 0===n){let s;n=new Promise(e=>{s=e}),this.tappedPromises.set(e,n);try{let n={event:`on_${a.runType}_stream`,run_id:e,name:a.name,tags:a.tags,metadata:a.metadata,data:{}};for await(let e of(await this.send({...n,data:{chunk:i(a.runType,r.value)}},a),yield r.value,t))"tool"!==a.runType&&"retriever"!==a.runType&&await this.send({...n,data:{chunk:i(a.runType,e)}},a),yield e}finally{s()}}else for await(let e of(yield r.value,t))yield e}async send(e,t){this._includeRun(t)&&await this.writer.write(e)}async sendEndEvent(e,t){let r=this.tappedPromises.get(e.run_id);void 0!==r?r.then(()=>{this.send(e,t)}):await this.send(e,t)}async onLLMStart(e){let t=s4(e),r=void 0!==e.inputs.messages?"chat_model":"llm",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:r,inputs:e.inputs};this.runInfoMap.set(e.id,a);let i=`on_${r}_start`;await this.send({event:i,data:{input:e.inputs},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onLLMNewToken(e,t,r){let a,i,n=this.runInfoMap.get(e.id);if(void 0===n)throw Error(`onLLMNewToken: Run ID ${e.id} not found in run map.`);if(1!==this.runInfoMap.size){if("chat_model"===n.runType)i="on_chat_model_stream",a=r?.chunk===void 0?new ig({content:t,id:`run-${e.id}`}):r.chunk.message;else if("llm"===n.runType)i="on_llm_stream",a=r?.chunk===void 0?new s2({text:t}):r.chunk;else throw Error(`Unexpected run type ${n.runType}`);await this.send({event:i,data:{chunk:a},run_id:e.id,name:n.name,tags:n.tags,metadata:n.metadata},n)}}async onLLMEnd(e){let t,r,a=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===a)throw Error(`onLLMEnd: Run ID ${e.id} not found in run map.`);let i=e.outputs?.generations;if("chat_model"===a.runType){for(let e of i??[]){if(void 0!==r)break;r=e[0]?.message}t="on_chat_model_end"}else if("llm"===a.runType)r={generations:i?.map(e=>e.map(e=>({text:e.text,generationInfo:e.generationInfo}))),llmOutput:e.outputs?.llmOutput??{}},t="on_llm_end";else throw Error(`onLLMEnd: Unexpected run type: ${a.runType}`);await this.sendEndEvent({event:t,data:{output:r,input:a.inputs},run_id:e.id,name:a.name,tags:a.tags,metadata:a.metadata},a)}async onChainStart(e){let t=s4(e),r=e.run_type??"chain",a={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:e.run_type},i={};""===e.inputs.input&&1===Object.keys(e.inputs).length?(i={},a.inputs={}):void 0!==e.inputs.input?(i.input=e.inputs.input,a.inputs=e.inputs.input):(i.input=e.inputs,a.inputs=e.inputs),this.runInfoMap.set(e.id,a),await this.send({event:`on_${r}_start`,data:i,name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},a)}async onChainEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw Error(`onChainEnd: Run ID ${e.id} not found in run map.`);let r=`on_${e.run_type}_end`,a=e.inputs??t.inputs??{},i={output:e.outputs?.output??e.outputs,input:a};a.input&&1===Object.keys(a).length&&(i.input=a.input,t.inputs=a.input),await this.sendEndEvent({event:r,data:i,run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata??{}},t)}async onToolStart(e){let t=s4(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"tool",inputs:e.inputs??{}};this.runInfoMap.set(e.id,r),await this.send({event:"on_tool_start",data:{input:e.inputs??{}},name:t,run_id:e.id,tags:e.tags??[],metadata:e.extra?.metadata??{}},r)}async onToolEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw Error(`onToolEnd: Run ID ${e.id} not found in run map.`);if(void 0===t.inputs)throw Error(`onToolEnd: Run ID ${e.id} is a tool call, and is expected to have traced inputs.`);let r=e.outputs?.output===void 0?e.outputs:e.outputs.output;await this.sendEndEvent({event:"on_tool_end",data:{output:r,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async onRetrieverStart(e){let t=s4(e),r={tags:e.tags??[],metadata:e.extra?.metadata??{},name:t,runType:"retriever",inputs:{query:e.inputs.query}};this.runInfoMap.set(e.id,r),await this.send({event:"on_retriever_start",data:{input:{query:e.inputs.query}},name:t,tags:e.tags??[],run_id:e.id,metadata:e.extra?.metadata??{}},r)}async onRetrieverEnd(e){let t=this.runInfoMap.get(e.id);if(this.runInfoMap.delete(e.id),void 0===t)throw Error(`onRetrieverEnd: Run ID ${e.id} not found in run map.`);await this.sendEndEvent({event:"on_retriever_end",data:{output:e.outputs?.documents??e.outputs,input:t.inputs},run_id:e.id,name:t.name,tags:t.tags,metadata:t.metadata},t)}async handleCustomEvent(e,t,r){let a=this.runInfoMap.get(r);if(void 0===a)throw Error(`handleCustomEvent: Run ID ${r} not found in run map.`);await this.send({event:"on_custom_event",run_id:r,name:e,tags:a.tags,metadata:a.metadata,data:t},a)}async finish(){Promise.all([...this.tappedPromises.values()]).finally(()=>{this.writer.close()})}}let s6=[400,401,402,403,404,405,406,407,409],s8=e=>{if(e.message.startsWith("Cancel")||e.message.startsWith("AbortError")||"AbortError"===e.name||e?.code==="ECONNABORTED")throw e;let t=e?.response?.status??e?.status;if(t&&s6.includes(+t))throw e;if(e?.error?.code==="insufficient_quota"){let t=Error(e?.message);throw t.name="InsufficientQuotaError",t}};class s7{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??s8;let t="default"in nP?nP.default:nP;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>ij(()=>e(...t).catch(e=>{if(e instanceof Error)throw e;throw Error(e)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((t,r)=>{e.signal?.addEventListener("abort",()=>{r(Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(e=>e.ok?e:Promise.reject(e)))}}class oe extends sd{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){!this.rootId&&(this.rootId=e.id,this.argOnStart&&await this.argOnStart(e,this.config))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&await this.argOnError(e,this.config):this.argOnEnd&&await this.argOnEnd(e,this.config))}}function ot(e){return!!e&&e.lc_runnable}class or{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){let r=void 0===this.includeNames&&void 0===this.includeTypes&&void 0===this.includeTags,a=e.tags??[];return void 0!==this.includeNames&&(r=r||this.includeNames.includes(e.name)),void 0!==this.includeTypes&&(r=r||this.includeTypes.includes(t)),void 0!==this.includeTags&&(r=r||a.some(e=>this.includeTags?.includes(e))),void 0!==this.excludeNames&&(r=r&&!this.excludeNames.includes(e.name)),void 0!==this.excludeTypes&&(r=r&&!this.excludeTypes.includes(t)),void 0!==this.excludeTags&&(r=r&&a.every(e=>!this.excludeTags?.includes(e))),r}}let oa=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i,oi=function(e){return"string"==typeof e&&oa.test(e)};function on(e){return e.replace(/[^a-zA-Z-_0-9]/g,"_")}let os=["*","_","`"];async function oo(e,t){let{backgroundColor:r="white"}=t??{},a=btoa(e);void 0!==r&&(/^#(?:[0-9a-fA-F]{3}){1,2}$/.test(r)||(r=`!${r}`));let i=`https://mermaid.ink/img/${a}?bgColor=${r}`,n=await fetch(i);if(!n.ok)throw Error(`Failed to render the graph using the Mermaid.INK API.
Status code: ${n.status}
Status text: ${n.statusText}`);return await n.blob()}let ol=Symbol("Let zodToJsonSchema decide on which parser to use"),ou={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",removeAdditionalStrategy:"passthrough",allowedAdditionalProperties:!0,rejectedAdditionalProperties:!1,definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref",openAiAnyTypeName:"OpenAiAnyType"},oc=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")};function od(e){if("openAi"!==e.target)return{};let t=[...e.basePath,e.definitionPath,e.openAiAnyTypeName];return e.flags.hasReferencedOpenAiAnyType=!0,{$ref:"relative"===e.$refStrategy?oc(t,e.currentPath):t.join("/")}}function oh(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function op(e,t,r,a,i){e[t]=r,oh(e,t,a,i)}function of(e,t){return oC(e.type._def,t)}let om=/^[cC][^\s-]{8,}$/,og=/^[0-9a-z]+$/,oy=/^[0-9A-HJKMNP-TV-Z]{26}$/,ob=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,o_=()=>(void 0===m&&(m=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),m),ow=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,ov=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,oE=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,oO=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,ok=/^[a-zA-Z0-9_-]{21}$/,oS=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/;function ox(e,t){let r={type:"string"};if(e.checks)for(let a of e.checks)switch(a.kind){case"min":op(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t);break;case"max":op(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"email":switch(t.emailStrategy){case"format:email":oA(r,"email",a.message,t);break;case"format:idn-email":oA(r,"idn-email",a.message,t);break;case"pattern:zod":oT(r,ob,a.message,t)}break;case"url":oA(r,"uri",a.message,t);break;case"uuid":oA(r,"uuid",a.message,t);break;case"regex":oT(r,a.regex,a.message,t);break;case"cuid":oT(r,om,a.message,t);break;case"cuid2":oT(r,og,a.message,t);break;case"startsWith":oT(r,RegExp(`^${o$(a.value,t)}`),a.message,t);break;case"endsWith":oT(r,RegExp(`${o$(a.value,t)}$`),a.message,t);break;case"datetime":oA(r,"date-time",a.message,t);break;case"date":oA(r,"date",a.message,t);break;case"time":oA(r,"time",a.message,t);break;case"duration":oA(r,"duration",a.message,t);break;case"length":op(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,a.value):a.value,a.message,t),op(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,a.value):a.value,a.message,t);break;case"includes":oT(r,RegExp(o$(a.value,t)),a.message,t);break;case"ip":"v6"!==a.version&&oA(r,"ipv4",a.message,t),"v4"!==a.version&&oA(r,"ipv6",a.message,t);break;case"base64url":oT(r,oO,a.message,t);break;case"jwt":oT(r,oS,a.message,t);break;case"cidr":"v6"!==a.version&&oT(r,ow,a.message,t),"v4"!==a.version&&oT(r,ov,a.message,t);break;case"emoji":oT(r,o_(),a.message,t);break;case"ulid":oT(r,oy,a.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":oA(r,"binary",a.message,t);break;case"contentEncoding:base64":op(r,"contentEncoding","base64",a.message,t);break;case"pattern:zod":oT(r,oE,a.message,t)}break;case"nanoid":oT(r,ok,a.message,t)}return r}function o$(e,t){return"escape"===t.patternStrategy?function(e){let t="";for(let r=0;r<e.length;r++)oI.has(e[r])||(t+="\\"),t+=e[r];return t}(e):e}let oI=new Set("ABCDEFGHIJKLMNOPQRSTUVXYZabcdefghijklmnopqrstuvxyz0123456789");function oA(e,t,r,a){e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):op(e,"format",t,r,a)}function oT(e,t,r,a){e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:oP(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):op(e,"pattern",oP(t,a),r,a)}function oP(e,t){if(!t.applyRegexFlags||!e.flags)return e.source;let r={i:e.flags.includes("i"),m:e.flags.includes("m"),s:e.flags.includes("s")},a=r.i?e.source.toLowerCase():e.source,i="",n=!1,s=!1,o=!1;for(let e=0;e<a.length;e++){if(n){i+=a[e],n=!1;continue}if(r.i){if(s){if(a[e].match(/[a-z]/)){o?(i+=a[e],i+=`${a[e-2]}-${a[e]}`.toUpperCase(),o=!1):"-"===a[e+1]&&a[e+2]?.match(/[a-z]/)?(i+=a[e],o=!0):i+=`${a[e]}${a[e].toUpperCase()}`;continue}}else if(a[e].match(/[a-z]/)){i+=`[${a[e]}${a[e].toUpperCase()}]`;continue}}if(r.m){if("^"===a[e]){i+=`(^|(?<=[\r
]))`;continue}else if("$"===a[e]){i+=`($|(?=[\r
]))`;continue}}if(r.s&&"."===a[e]){i+=s?`${a[e]}\r
`:`[${a[e]}\r
]`;continue}i+=a[e],"\\"===a[e]?n=!0:s&&"]"===a[e]?s=!1:s||"["!==a[e]||(s=!0)}try{new RegExp(i)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),e.source}return i}function oj(e,t){if("openAi"===t.target&&console.warn("Warning: OpenAI may not support records in schemas! Try an array of key-value pairs instead."),"openApi3"===t.target&&e.keyType?._def.typeName===iP.kY.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,a)=>({...r,[a]:oC(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??od(t)}),{}),additionalProperties:t.rejectedAdditionalProperties};let r={type:"object",additionalProperties:oC(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??t.allowedAdditionalProperties};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===iP.kY.ZodString&&e.keyType._def.checks?.length){let{type:a,...i}=ox(e.keyType._def,t);return{...r,propertyNames:i}}if(e.keyType?._def.typeName===iP.kY.ZodEnum)return{...r,propertyNames:{enum:e.keyType._def.values}};if(e.keyType?._def.typeName===iP.kY.ZodBranded&&e.keyType._def.type._def.typeName===iP.kY.ZodString&&e.keyType._def.type._def.checks?.length){let{type:a,...i}=of(e.keyType._def,t);return{...r,propertyNames:i}}return r}let oN={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},oR=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>oC(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0};function oC(e,t,r=!1){let a=t.seen.get(e);if(t.override){let i=t.override?.(e,t,a,r);if(i!==ol)return i}if(a&&!r){let e=oL(a,t);if(void 0!==e)return e}let i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);let n=((e,t,r)=>{switch(t){case iP.kY.ZodString:return ox(e,r);case iP.kY.ZodNumber:let a={type:"number"};if(!e.checks)return a;for(let t of e.checks)switch(t.kind){case"int":a.type="integer",oh(a,"type",t.message,r);break;case"min":"jsonSchema7"===r.target?t.inclusive?op(a,"minimum",t.value,t.message,r):op(a,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(a.exclusiveMinimum=!0),op(a,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?op(a,"maximum",t.value,t.message,r):op(a,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(a.exclusiveMaximum=!0),op(a,"maximum",t.value,t.message,r));break;case"multipleOf":op(a,"multipleOf",t.value,t.message,r)}return a;case iP.kY.ZodObject:return function(e,t){let r="openAi"===t.target,a={type:"object",properties:{}},i=[],n=e.shape();for(let e in n){let s=n[e];if(void 0===s||void 0===s._def)continue;let o=function(e){try{return e.isOptional()}catch{return!0}}(s);o&&r&&("ZodOptional"===s._def.typeName&&(s=s._def.innerType),s.isNullable()||(s=s.nullable()),o=!1);let l=oC(s._def,{...t,currentPath:[...t.currentPath,"properties",e],propertyPath:[...t.currentPath,"properties",e]});void 0!==l&&(a.properties[e]=l,o||i.push(e))}i.length&&(a.required=i);let s=function(e,t){if("ZodNever"!==e.catchall._def.typeName)return oC(e.catchall._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]});switch(e.unknownKeys){case"passthrough":return t.allowedAdditionalProperties;case"strict":return t.rejectedAdditionalProperties;case"strip":return"strict"===t.removeAdditionalStrategy?t.allowedAdditionalProperties:t.rejectedAdditionalProperties}}(e,t);return void 0!==s&&(a.additionalProperties=s),a}(e,r);case iP.kY.ZodBigInt:let i={type:"integer",format:"int64"};if(!e.checks)return i;for(let t of e.checks)switch(t.kind){case"min":"jsonSchema7"===r.target?t.inclusive?op(i,"minimum",t.value,t.message,r):op(i,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(i.exclusiveMinimum=!0),op(i,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?op(i,"maximum",t.value,t.message,r):op(i,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(i.exclusiveMaximum=!0),op(i,"maximum",t.value,t.message,r));break;case"multipleOf":op(i,"multipleOf",t.value,t.message,r)}return i;case iP.kY.ZodBoolean:return{type:"boolean"};case iP.kY.ZodDate:return function e(t,r,a){let i=a??r.dateStrategy;if(Array.isArray(i))return{anyOf:i.map((a,i)=>e(t,r,a))};switch(i){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t,s=r;let o={type:"integer",format:"unix-time"};if("openApi3"===s.target)return o;for(let e of n.checks)switch(e.kind){case"min":op(o,"minimum",e.value,e.message,s);break;case"max":op(o,"maximum",e.value,e.message,s)}return o}}(e,r);case iP.kY.ZodUndefined:return{not:od(r)};case iP.kY.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case iP.kY.ZodArray:let n={type:"array"};return e.type?._def&&e.type?._def?.typeName!==iP.kY.ZodAny&&(n.items=oC(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&op(n,"minItems",e.minLength.value,e.minLength.message,r),e.maxLength&&op(n,"maxItems",e.maxLength.value,e.maxLength.message,r),e.exactLength&&(op(n,"minItems",e.exactLength.value,e.exactLength.message,r),op(n,"maxItems",e.exactLength.value,e.exactLength.message,r)),n;case iP.kY.ZodUnion:case iP.kY.ZodDiscriminatedUnion:if("openApi3"===r.target)return oR(e,r);let s=e.options instanceof Map?Array.from(e.options.values()):e.options;if(s.every(e=>e._def.typeName in oN&&(!e._def.checks||!e._def.checks.length))){let e=s.reduce((e,t)=>{let r=oN[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(s.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=s.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===s.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:s.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(s.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:s.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return oR(e,r);case iP.kY.ZodIntersection:let o=[oC(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),oC(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),l="jsonSchema2019-09"===r.target?{unevaluatedProperties:!1}:void 0,u=[];return o.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)u.push(...e.allOf),void 0===e.unevaluatedProperties&&(l=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}else l=void 0;u.push(t)}}),u.length?{allOf:u,...l}:void 0;case iP.kY.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>oC(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:oC(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>oC(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case iP.kY.ZodRecord:return oj(e,r);case iP.kY.ZodLiteral:let c=typeof e.value;return"bigint"!==c&&"number"!==c&&"boolean"!==c&&"string"!==c?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===r.target?{type:"bigint"===c?"integer":c,enum:[e.value]}:{type:"bigint"===c?"integer":c,const:e.value};case iP.kY.ZodEnum:return{type:"string",enum:Array.from(e.values)};case iP.kY.ZodNativeEnum:let d=e.values,h=Object.keys(e.values).filter(e=>"number"!=typeof d[d[e]]).map(e=>d[e]),p=Array.from(new Set(h.map(e=>typeof e)));return{type:1===p.length?"string"===p[0]?"string":"number":["string","number"],enum:h};case iP.kY.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===r.target?{type:oN[e.innerType._def.typeName],nullable:!0}:{type:[oN[e.innerType._def.typeName],"null"]};if("openApi3"===r.target){let t=oC(e.innerType._def,{...r,currentPath:[...r.currentPath]});return t&&"$ref"in t?{allOf:[t],nullable:!0}:t&&{...t,nullable:!0}}let f=oC(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return f&&{anyOf:[f,{type:"null"}]};case iP.kY.ZodOptional:if(r.currentPath.toString()===r.propertyPath?.toString())return oC(e.innerType._def,r);let m=oC(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return m?{anyOf:[{not:od(r)},m]}:od(r);case iP.kY.ZodMap:if("record"===r.mapStrategy)return oj(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[oC(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||od(r),oC(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||od(r)],minItems:2,maxItems:2}};case iP.kY.ZodSet:let g={type:"array",uniqueItems:!0,items:oC(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})};return e.minSize&&op(g,"minItems",e.minSize.value,e.minSize.message,r),e.maxSize&&op(g,"maxItems",e.maxSize.value,e.maxSize.message,r),g;case iP.kY.ZodLazy:return()=>e.getter()._def;case iP.kY.ZodPromise:return oC(e.type._def,r);case iP.kY.ZodNaN:case iP.kY.ZodNever:return"openAi"===r.target?void 0:{not:od({...r,currentPath:[...r.currentPath,"not"]})};case iP.kY.ZodEffects:return"input"===r.effectStrategy?oC(e.schema._def,r):od(r);case iP.kY.ZodAny:case iP.kY.ZodUnknown:return od(r);case iP.kY.ZodDefault:return{...oC(e.innerType._def,r),default:e.defaultValue()};case iP.kY.ZodBranded:return of(e,r);case iP.kY.ZodReadonly:case iP.kY.ZodCatch:return oC(e.innerType._def,r);case iP.kY.ZodPipeline:if("input"===r.pipeStrategy)return oC(e.in._def,r);if("output"===r.pipeStrategy)return oC(e.out._def,r);let y=oC(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),b=oC(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",y?"1":"0"]});return{allOf:[y,b].filter(e=>void 0!==e)};case iP.kY.ZodFunction:case iP.kY.ZodVoid:case iP.kY.ZodSymbol:default:return}})(e,e.typeName,t),s="function"==typeof n?oC(n(),t):n;if(s&&oM(e,t,s),t.postProcess){let r=t.postProcess(s,e,t);return i.jsonSchema=s,r}return i.jsonSchema=s,s}let oL=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"relative":return{$ref:oc(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),od(t);return"seen"===t.$refStrategy?od(t):void 0}},oM=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r);function oU(e,t){let r=typeof e;if(r!==typeof t)return!1;if(Array.isArray(e)){if(!Array.isArray(t))return!1;let r=e.length;if(r!==t.length)return!1;for(let a=0;a<r;a++)if(!oU(e[a],t[a]))return!1;return!0}if("object"===r){if(!e||!t)return e===t;let r=Object.keys(e),a=Object.keys(t);if(r.length!==a.length)return!1;for(let a of r)if(!oU(e[a],t[a]))return!1;return!0}return e===t}function oD(e){return encodeURI(e.replace(/~/g,"~0").replace(/\//g,"~1"))}let oz={prefixItems:!0,items:!0,allOf:!0,anyOf:!0,oneOf:!0},oF={$defs:!0,definitions:!0,properties:!0,patternProperties:!0,dependentSchemas:!0},oB={id:!0,$id:!0,$ref:!0,$schema:!0,$anchor:!0,$vocabulary:!0,$comment:!0,default:!0,enum:!0,const:!0,required:!0,type:!0,maximum:!0,minimum:!0,exclusiveMaximum:!0,exclusiveMinimum:!0,multipleOf:!0,maxLength:!0,minLength:!0,pattern:!0,format:!0,maxItems:!0,minItems:!0,uniqueItems:!0,maxProperties:!0,minProperties:!0},oq="undefined"!=typeof self&&self.location&&"null"!==self.location.origin?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker"),oH=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,oW=[0,31,28,31,30,31,30,31,31,30,31,30,31],oJ=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i;function oG(e){return e.test.bind(e)}let oZ={date:oV,time:oY.bind(void 0,!1),"date-time":function(e){let t=e.split(oK);return 2==t.length&&oV(t[0])&&oY(!0,t[1])},duration:e=>e.length>1&&e.length<80&&(/^P\d+([.,]\d+)?W$/.test(e)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(e)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(e)),uri:function(e){return oX.test(e)&&oQ.test(e)},"uri-reference":oG(/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i),"uri-template":oG(/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i),url:oG(/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu),email:e=>{if('"'===e[0])return!1;let[t,r,...a]=e.split("@");return!(!t||!r||0!==a.length||t.length>64||r.length>253||"."===t[0]||t.endsWith(".")||t.includes(".."))&&!!/^[a-z0-9.-]+$/i.test(r)&&!!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(t)&&r.split(".").every(e=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(e))},hostname:oG(/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i),ipv4:oG(/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/),ipv6:oG(/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i),regex:function(e){if(o0.test(e))return!1;try{return RegExp(e,"u"),!0}catch(e){return!1}},uuid:oG(/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i),"json-pointer":oG(/^(?:\/(?:[^~/]|~0|~1)*)*$/),"json-pointer-uri-fragment":oG(/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i),"relative-json-pointer":oG(/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/)};function oV(e){var t;let r=e.match(oH);if(!r)return!1;let a=+r[1],i=+r[2],n=+r[3];return i>=1&&i<=12&&n>=1&&n<=(2==i&&(t=a)%4==0&&(t%100!=0||t%400==0)?29:oW[i])}function oY(e,t){let r=t.match(oJ);if(!r)return!1;let a=+r[1],i=+r[2],n=+r[3],s=!!r[5];return(a<=23&&i<=59&&n<=59||23==a&&59==i&&60==n)&&(!e||s)}let oK=/t|\s/i,oX=/\/|:/,oQ=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,o0=/[^\\]\\Z/;(y=e1||(e1={}))[y.Flag=1]="Flag",y[y.Basic=2]="Basic",y[y.Detailed=4]="Detailed";let o1={major:4,minor:0,patch:0},o2=aW("$ZodType",(e,t)=>{var r;e??(e={}),e._zod.def=t,e._zod.bag=e._zod.bag||{},e._zod.version=o1;let a=[...e._zod.def.checks??[]];for(let t of(e._zod.traits.has("$ZodCheck")&&a.unshift(e),a))for(let r of t._zod.onattach)r(e);if(0===a.length)(r=e._zod).deferred??(r.deferred=[]),e._zod.deferred?.push(()=>{e._zod.run=e._zod.parse});else{let t=(e,t,r)=>{let a,i=az(e);for(let n of t){if(n._zod.def.when){if(!n._zod.def.when(e))continue}else if(i)continue;let t=e.issues.length,s=n._zod.check(e);if(s instanceof Promise&&r?.async===!1)throw new aJ;if(a||s instanceof Promise)a=(a??Promise.resolve()).then(async()=>{await s,e.issues.length!==t&&(i||(i=az(e,t)))});else{if(e.issues.length===t)continue;i||(i=az(e,t))}}return a?a.then(()=>e):e};e._zod.run=(r,i)=>{let n=e._zod.parse(r,i);if(n instanceof Promise){if(!1===i.async)throw new aJ;return n.then(e=>t(e,a,i))}return t(n,a,i)}}e["~standard"]={validate:t=>{try{let r=a0(e,t);return r.success?{value:r.data}:{issues:r.error?.issues}}catch(r){return a1(e,t).then(e=>e.success?{value:e.data}:{issues:e.error?.issues})}},vendor:"zod",version:1}}),o5=aW("$ZodNever",(e,t)=>{o2.init(e,t),e._zod.parse=(t,r)=>(t.issues.push({expected:"never",code:"invalid_type",input:t.value,inst:e}),t)});function o4(e){if("object"!=typeof e||null===e||!("_zod"in e))return!1;let t=e._zod;return"object"==typeof t&&null!==t&&"def"in t}function o9(e){if("object"!=typeof e||null===e||!("_def"in e)||"_zod"in e)return!1;let t=e._def;return"object"==typeof t&&null!=t&&"typeName"in t}function o3(e){return!(!e||"object"!=typeof e||Array.isArray(e))&&!!(o4(e)||o9(e))}async function o6(e,t){if(o4(e))try{let r=await aQ(e,t);return{success:!0,data:r}}catch(e){return{success:!1,error:e}}if(o9(e))return e.safeParse(t);throw Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}async function o8(e,t){if(o4(e))return aX(e,t);if(o9(e))return e.parse(t);throw Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}function o7(e){return o4(e)?aL.get(e)?.description:o9(e)||"description"in e&&"string"==typeof e.description?e.description:void 0}function le(e){return!!o4(e)&&("object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"object"===e._zod.def.type||!1)}function lt(e){return!!o4(e)&&("object"==typeof e&&null!==e&&"_zod"in e&&"object"==typeof e._zod&&null!==e._zod&&"def"in e._zod&&"object"==typeof e._zod.def&&null!==e._zod.def&&"type"in e._zod.def&&"array"===e._zod.def.type||!1)}function lr(e){if(o4(e)){let t=function e(t,r=!1){if(o9(t))return o9(t)&&"typeName"in t._def&&"ZodEffects"===t._def.typeName?e(t._def.schema,r):t;if(o4(t)){let a=t;if(o4(t)&&"pipe"===t._zod.def.type&&(a=e(t._zod.def.in,r)),r){if(le(a)){let t=a._zod.def.shape;for(let[i,n]of Object.entries(a._zod.def.shape))t[i]=e(n,r);a=aD(a,{...a._zod.def,shape:t})}else if(lt(a)){let t=e(a._zod.def.element,r);a=aD(a,{...a._zod.def,element:t})}}let i=aL.get(t);return i&&aL.add(a,i),a}throw Error("Schema must be an instance of z3.ZodType or z4.$ZodType")}(e,!0);return le(t)?aH(function e(t,r=!1){if(o9(t))return t.strict();if(le(t)){let a=t._zod.def.shape;if(r)for(let[i,n]of Object.entries(t._zod.def.shape)){if(le(n)){let t=e(n,r);a[i]=t}else if(lt(n)){let t=n._zod.def.element;le(t)&&(t=e(t,r)),a[i]=aD(n,{...n._zod.def,element:t})}else a[i]=n;let t=aL.get(n);t&&aL.add(a[i],t)}let i=aD(t,{...t._zod.def,shape:a,catchall:new o5({type:"never",...function(e){if(!e)return{};if("string"==typeof e)return{error:()=>e};if(e?.message!==void 0){if(e?.error!==void 0)throw Error("Cannot specify both `message` and `error` params");e.error=e.message}return(delete e.message,"string"==typeof e.error)?{...e,error:()=>e.error}:e}(void 0)})}),n=aL.get(t);return n&&aL.add(i,n),i}throw Error("Schema must be an instance of z3.ZodObject or z4.$ZodObject")}(t,!0)):aH(e)}return o9(e)?((e,t)=>{let r=(e=>{let t="string"==typeof e?{...ou,name:e}:{...ou,...e},r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,flags:{hasReferencedOpenAiAnyType:!1},currentPath:r,propertyPath:void 0,seen:new Map(Object.entries(t.definitions).map(([e,r])=>[r._def,{def:r._def,path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t),a="object"==typeof t&&t.definitions?Object.entries(t.definitions).reduce((e,[t,a])=>({...e,[t]:oC(a._def,{...r,currentPath:[...r.basePath,r.definitionPath,t]},!0)??od(r)}),{}):void 0,i="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,n=oC(e._def,void 0===i?r:{...r,currentPath:[...r.basePath,r.definitionPath,i]},!1)??od(r),s="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==s&&(n.title=s),r.flags.hasReferencedOpenAiAnyType&&(a||(a={}),a[r.openAiAnyTypeName]||(a[r.openAiAnyTypeName]={type:["string","number","integer","boolean","array","null"],items:{$ref:"relative"===r.$refStrategy?"1":[...r.basePath,r.definitionPath,r.openAiAnyTypeName].join("/")}}));let o=void 0===i?a?{...n,[r.definitionPath]:a}:n:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,i].join("/"),[r.definitionPath]:{...a,[i]:n}};return"jsonSchema7"===r.target?o.$schema="http://json-schema.org/draft-07/schema#":("jsonSchema2019-09"===r.target||"openAi"===r.target)&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),"openAi"===r.target&&("anyOf"in o||"oneOf"in o||"allOf"in o||"type"in o&&Array.isArray(o.type))&&console.warn("Warning: OpenAI may not support schemas with unions as roots! Try wrapping it in an object property."),o})(e):e}class la{constructor(e){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.nodes=e?.nodes??this.nodes,this.edges=e?.edges??this.edges}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=oi(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...ot(t.data)?{type:"runnable",data:{id:t.data.lc_id,name:t.data.getName()}}:{type:"schema",data:{...lr(t.data.schema),title:t.data.name}}})),edges:this.edges.map(t=>{let r={source:e[t.source],target:e[t.target]};return void 0!==t.data&&(r.data=t.data),void 0!==t.conditional&&(r.conditional=t.conditional),r})}}addNode(e,t,r){if(void 0!==t&&void 0!==this.nodes[t])throw Error(`Node with id ${t} already exists`);let a=t??iM(),i={id:a,data:e,name:function(e,t){if(void 0!==e&&!oi(e))return e;if(!ot(t))return t.name??"UnknownSchema";try{let e=t.getName();return e=e.startsWith("Runnable")?e.slice(8):e}catch(e){return t.getName()}}(t,e),metadata:r};return this.nodes[a]=i,i}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r,a){if(void 0===this.nodes[e.id])throw Error(`Source node ${e.id} not in graph`);if(void 0===this.nodes[t.id])throw Error(`Target node ${t.id} not in graph`);let i={source:e.id,target:t.id,data:r,conditional:a};return this.edges.push(i),i}firstNode(){return li(this)}lastNode(){return ln(this)}extend(e,t=""){let r=t;Object.values(e.nodes).map(e=>e.id).every(oi)&&(r="");let a=e=>r?`${r}:${e}`:e;Object.entries(e.nodes).forEach(([e,t])=>{this.nodes[a(e)]={...t,id:a(e)}});let i=e.edges.map(e=>({...e,source:a(e.source),target:a(e.target)}));this.edges=[...this.edges,...i];let n=e.firstNode(),s=e.lastNode();return[n?{id:a(n.id),data:n.data}:void 0,s?{id:a(s.id),data:s.data}:void 0]}trimFirstNode(){let e=this.firstNode();e&&li(this,[e.id])&&this.removeNode(e)}trimLastNode(){let e=this.lastNode();e&&ln(this,[e.id])&&this.removeNode(e)}reid(){let e=Object.fromEntries(Object.values(this.nodes).map(e=>[e.id,e.name])),t=new Map;Object.values(e).forEach(e=>{t.set(e,(t.get(e)||0)+1)});let r=r=>{let a=e[r];return oi(r)&&1===t.get(a)?a:r};return new la({nodes:Object.fromEntries(Object.entries(this.nodes).map(([e,t])=>[r(e),{...t,id:r(e)}])),edges:this.edges.map(e=>({...e,source:r(e.source),target:r(e.target)}))})}drawMermaid(e){let{withStyles:t,curveStyle:r,nodeColors:a={default:"fill:#f2f0ff,line-height:1.2",first:"fill-opacity:0",last:"fill:#bfb6fc"},wrapLabelNWords:i}=e??{},n=this.reid(),s=n.firstNode(),o=n.lastNode();return function(e,t,r){let{firstNode:a,lastNode:i,nodeColors:n,withStyles:s=!0,curveStyle:o="linear",wrapLabelNWords:l=9}=r??{},u=s?`%%{init: {'flowchart': {'curve': '${o}'}}}%%
graph TD;
`:"graph TD;\n";if(s){let t="default",r={[t]:"{0}({1})"};for(let[n,s]of(void 0!==a&&(r[a]="{0}([{1}]):::first"),void 0!==i&&(r[i]="{0}([{1}]):::last"),Object.entries(e))){let e=s.name.split(":").pop()??"",a=os.some(t=>e.startsWith(t)&&e.endsWith(t))?`<p>${e}</p>`:e;Object.keys(s.metadata??{}).length&&(a+=`<hr/><small><em>${Object.entries(s.metadata??{}).map(([e,t])=>`${e} = ${t}`).join("\n")}</em></small>`);let i=(r[n]??r[t]).replace("{0}",on(n)).replace("{1}",a);u+=`	${i}
`}}let c={};for(let e of t){let t=e.source.split(":"),r=e.target.split(":"),a=t.filter((e,t)=>e===r[t]).join(":");c[a]||(c[a]=[]),c[a].push(e)}let d=new Set;function h(e,t){let r=1===e.length&&e[0].source===e[0].target;if(t&&!r){let e=t.split(":").pop();if(d.has(e))throw Error(`Found duplicate subgraph '${e}' -- this likely means that you're reusing a subgraph node with the same name. Please adjust your graph to have subgraph nodes with unique names.`);d.add(e),u+=`	subgraph ${e}
`}for(let t of e){let{source:e,target:r,data:a,conditional:i}=t,n="";if(void 0!==a){let e=a,t=e.split(" ");t.length>l&&(e=Array.from({length:Math.ceil(t.length/l)},(e,r)=>t.slice(r*l,(r+1)*l).join(" ")).join("&nbsp;<br>&nbsp;")),n=i?` -. &nbsp;${e}&nbsp; .-> `:` -- &nbsp;${e}&nbsp; --> `}else n=i?" -.-> ":" --\x3e ";u+=`	${on(e)}${n}${on(r)};
`}for(let e in c)e.startsWith(`${t}:`)&&e!==t&&h(c[e],e);t&&!r&&(u+="	end\n")}for(let e in h(c[""]??[],""),c)e.includes(":")||""===e||h(c[e],e);return s&&(u+=function(e){let t="";for(let[r,a]of Object.entries(e))t+=`	classDef ${r} ${a};
`;return t}(n??{})),u}(n.nodes,n.edges,{firstNode:s?.id,lastNode:o?.id,withStyles:t,curveStyle:r,nodeColors:a,wrapLabelNWords:i})}async drawMermaidPng(e){return oo(this.drawMermaid(e),{backgroundColor:e?.backgroundColor})}}function li(e,t=[]){let r=new Set(e.edges.filter(e=>!t.includes(e.source)).map(e=>e.target)),a=[];for(let i of Object.values(e.nodes))t.includes(i.id)||r.has(i.id)||a.push(i);return 1===a.length?a[0]:void 0}function ln(e,t=[]){let r=new Set(e.edges.filter(e=>!t.includes(e.target)).map(e=>e.source)),a=[];for(let i of Object.values(e.nodes))t.includes(i.id)||r.has(i.id)||a.push(i);return 1===a.length?a[0]:void 0}function ls(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.iterator]&&"function"==typeof e.next}function lo(e){return"object"==typeof e&&null!==e&&"function"==typeof e[Symbol.asyncIterator]}function*ll(e,t){for(;;){let{value:r,done:a}=sL.runWithConfig(sB(e),t.next.bind(t),!0);if(a)break;yield r}}async function*lu(e,t){let r=t[Symbol.asyncIterator]();for(;;){let{value:a,done:i}=await sL.runWithConfig(sB(e),r.next.bind(t),!0);if(i)break;yield a}}function lc(e,t){return!e||Array.isArray(e)||e instanceof Date||"object"!=typeof e?{[t]:e}:e}class ld extends a8{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){let t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new lh({bound:this,kwargs:e,config:{}})}map(){return new lp({bound:this})}withRetry(e){return new lf({bound:this,kwargs:{},config:{},maxAttemptNumber:e?.stopAfterAttempt,...e})}withConfig(e){return new lh({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new l_({runnable:this,fallbacks:Array.isArray(e)?e:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)&&e.length!==t)throw Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);if(Array.isArray(e))return e.map(sz);if(t>1&&!Array.isArray(e)&&e.runId){console.warn("Provided runId will be used only for the first element of the batch.");let r=Object.fromEntries(Object.entries(e).filter(([e])=>"runId"!==e));return Array.from({length:t},(t,a)=>sz(0===a?e:r))}return Array.from({length:t},()=>sz(e))}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),i=new s7({maxConcurrency:a[0]?.maxConcurrency??r?.maxConcurrency,onFailedAttempt:e=>{throw e}});return Promise.all(e.map((e,t)=>i.call(async()=>{try{return await this.invoke(e,a[t])}catch(e){if(r?.returnExceptions)return e;throw e}})))}async *_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=sz(t),a=new sG({generator:this._streamIterator(e,r),config:r});return await a.setup,sH.fromAsyncGenerator(a)}_separateRunnableConfigFromCallOptions(e){let t;t=void 0===e?sz(e):sz({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency,runId:e.runId,timeout:e.timeout,signal:e.signal});let r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,delete r.runId,delete r.timeout,delete r.signal,[t,r]}async _callWithConfig(e,t,r){let a,i=sz(r),n=await sM(i),s=await n?.handleChainStart(this.toJSON(),lc(t,"input"),i.runId,i?.runType,void 0,void 0,i?.runName??this.getName());delete i.runId;try{let n=e.call(this,t,i,s);a=await sq(n,r?.signal)}catch(e){throw await s?.handleChainError(e),e}return await s?.handleChainEnd(lc(a,"output")),a}async _batchWithConfig(e,t,r,a){let i,n=this._getOptionsList(r??{},t.length),s=await Promise.all(n.map(sM)),o=await Promise.all(s.map(async(e,r)=>{let a=await e?.handleChainStart(this.toJSON(),lc(t[r],"input"),n[r].runId,n[r].runType,void 0,void 0,n[r].runName??this.getName());return delete n[r].runId,a}));try{let r=e.call(this,t,n,o,a);i=await sq(r,n?.[0]?.signal)}catch(e){throw await Promise.all(o.map(t=>t?.handleChainError(e))),e}return await Promise.all(o.map(e=>e?.handleChainEnd(lc(i,"output")))),i}_concatOutputChunks(e,t){return sJ(e,t)}async *_transformStreamWithConfig(e,t,r){let a,i,n,s=!0,o=!0,l=sz(r),u=await sM(l),c=this;async function*d(){for await(let t of e){if(s)if(void 0===a)a=t;else try{a=c._concatOutputChunks(a,t)}catch{a=void 0,s=!1}yield t}}try{let e=await sZ(t.bind(this),d(),async()=>u?.handleChainStart(this.toJSON(),{input:""},l.runId,l.runType,void 0,void 0,l.runName??this.getName()),r?.signal,l);delete l.runId,n=e.setup;let a=n?.handlers.find(s9),s=e.output;void 0!==a&&void 0!==n&&(s=a.tapOutputIterable(n.runId,s));let c=n?.handlers.find(sK);for await(let e of(void 0!==c&&void 0!==n&&(s=c.tapOutputIterable(n.runId,s)),s))if(yield e,o)if(void 0===i)i=e;else try{i=this._concatOutputChunks(i,e)}catch{i=void 0,o=!1}}catch(e){throw await n?.handleChainError(e,void 0,void 0,void 0,{inputs:lc(a,"input")}),e}await n?.handleChainEnd(i??{},void 0,void 0,void 0,{inputs:lc(a,"input")})}getGraph(e){let t=new la,r=t.addNode({name:`${this.getName()}Input`,schema:iP.bz()}),a=t.addNode(this),i=t.addNode({name:`${this.getName()}Output`,schema:iP.bz()});return t.addEdge(r,a),t.addEdge(a,i),t}pipe(e){return new lm({first:this,last:lw(e)})}pick(e){return this.pipe(new lE(e))}assign(e){return this.pipe(new lv(new lg({steps:e})))}async *transform(e,t){let r;for await(let t of e)r=void 0===r?t:this._concatOutputChunks(r,t);yield*this._streamIterator(r,sz(t))}async *streamLog(e,t,r){let a=new s0({...r,autoClose:!1,_schemaFormat:"original"}),i=sz(t);yield*this._streamLog(e,a,i)}async *_streamLog(e,t,r){let{callbacks:a}=r;if(void 0===a)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let e=a.copy();e.addHandler(t,!0),r.callbacks=e}let i=this.stream(e,r),n=async function(){try{for await(let e of(await i)){let r=new sV({ops:[{op:"add",path:"/streamed_output/-",value:e}]});await t.writer.write(r)}}finally{await t.writer.close()}}();try{for await(let e of t)yield e}finally{await n}}streamEvents(e,t,r){let a;if("v1"===t.version)a=this._streamEventsV1(e,t,r);else if("v2"===t.version)a=this._streamEventsV2(e,t,r);else throw Error('Only versions "v1" and "v2" of the schema are currently supported.');if("text/event-stream"!==t.encoding)return sH.fromAsyncGenerator(a);var i=a;let n=new TextEncoder,s=new ReadableStream({async start(e){for await(let t of i)e.enqueue(n.encode(`event: data
data: ${JSON.stringify(t)}

`));e.enqueue(n.encode("event: end\n\n")),e.close()}});return sH.fromReadableStream(s)}async *_streamEventsV2(e,t,r){let a,i=new s3({...r,autoClose:!1}),n=sz(t),s=n.runId??iM();n.runId=s;let o=n.callbacks;if(void 0===o)n.callbacks=[i];else if(Array.isArray(o))n.callbacks=o.concat(i);else{let e=o.copy();e.addHandler(i,!0),n.callbacks=e}let l=new AbortController,u=this,c=async function(){let r,a=null;try{t?.signal?"any"in AbortSignal?r=AbortSignal.any([l.signal,t.signal]):(r=t.signal,a=()=>{l.abort()},t.signal.addEventListener("abort",a,{once:!0})):r=l.signal;let o=await u.stream(e,{...n,signal:r});for await(let e of i.tapOutputIterable(s,o))if(l.signal.aborted)break}finally{await i.finish(),r&&a&&r.removeEventListener("abort",a)}}(),d=!1;try{for await(let t of i){if(!d){t.data.input=e,d=!0,a=t.run_id,yield t;continue}t.run_id===a&&t.event.endsWith("_end")&&t.data?.input&&delete t.data.input,yield t}}finally{l.abort(),await c}}async *_streamEventsV1(e,t,r){let a,i=!1,n=sz(t),s=n.tags??[],o=n.metadata??{},l=n.runName??this.getName(),u=new s0({...r,autoClose:!1,_schemaFormat:"streaming_events"}),c=new or({...r});for await(let t of this._streamLog(e,u,n)){if(void 0===(a=a?a.concat(t):sY.fromRunLogPatch(t)).state)throw Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!i){i=!0;let t={...a.state},r={run_id:t.id,event:`on_${t.type}_start`,name:l,tags:s,metadata:o,data:{input:e}};c.includeEvent(r,t.type)&&(yield r)}for(let e of[...new Set(t.ops.filter(e=>e.path.startsWith("/logs/")).map(e=>e.path.split("/")[2]))]){let t,r={},i=a.state.logs[e];if("start"==(t=void 0===i.end_time?i.streamed_output.length>0?"stream":"start":"end"))void 0!==i.inputs&&(r.input=i.inputs);else if("end"===t)void 0!==i.inputs&&(r.input=i.inputs),r.output=i.final_output;else if("stream"===t){let e=i.streamed_output.length;if(1!==e)throw Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${i.name}"`);r={chunk:i.streamed_output[0]},i.streamed_output=[]}yield{event:`on_${i.type}_${t}`,name:i.name,run_id:i.id,tags:i.tags,metadata:i.metadata,data:r}}let{state:r}=a;if(r.streamed_output.length>0){let e=r.streamed_output.length;if(1!==e)throw Error(`Expected exactly one chunk of streamed output, got ${e} instead. Encountered in: "${r.name}"`);let t={chunk:r.streamed_output[0]};r.streamed_output=[];let a={event:`on_${r.type}_stream`,run_id:r.id,tags:s,metadata:o,name:l,data:t};c.includeEvent(a,r.type)&&(yield a)}}let d=a?.state;if(void 0!==d){let e={event:`on_${d.type}_end`,name:l,run_id:d.id,tags:s,metadata:o,data:{output:d.final_output}};c.includeEvent(e,d.type)&&(yield e)}}static isRunnable(e){return ot(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new lh({bound:this,config:{},configFactories:[a=>({callbacks:[new oe({config:a,onStart:e,onEnd:t,onError:r})]})]})}asTool(e){return function(e,t){var r;let a=t.name??e.getName(),i=t.description??o7(t.schema);return new lO(o3(r=t.schema)&&(o9(r)?"ZodString"===r._def.typeName:!!o4(r)&&"string"===r._zod.def.type)?{name:a,description:i,schema:iP.Ik({input:iP.Yj()}).transform(e=>e.input),bound:e}:{name:a,description:i,schema:t.schema,bound:e})}(this,e)}}class lh extends ld{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=sU(this.config,...e);return sU(t,...this.configFactories?await Promise.all(this.configFactories.map(async e=>await e(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new lf({bound:this.bound,kwargs:this.kwargs,config:this.config,maxAttemptNumber:e?.stopAfterAttempt,...e})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(sz(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async e=>this._mergeConfig(sz(e),this.kwargs))):await this._mergeConfig(sz(t),this.kwargs);return this.bound.batch(e,a,r)}_concatOutputChunks(e,t){return this.bound._concatOutputChunks(e,t)}async *_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(sz(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(sz(t),this.kwargs))}async *transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(sz(t),this.kwargs))}streamEvents(e,t,r){let a=this,i=async function*(){yield*a.bound.streamEvents(e,{...await a._mergeConfig(sz(t),a.kwargs),version:t.version},r)};return sH.fromAsyncGenerator(i())}static isRunnableBinding(e){return e.bound&&ld.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new lh({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new oe({config:a,onStart:e,onEnd:t,onError:r})]})]})}}class lp extends ld{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new lp({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _invoke(e,t,r){return this.bound.batch(e,sF(t,{callbacks:r?.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new lp({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class lf extends lh{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return sF(t,{callbacks:r?.getChild(a)})}async _invoke(e,t,r){return ij(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:t=>this.onFailedAttempt(t,e),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async _batch(e,t,r,a){let i={};try{await ij(async n=>{let s,o=e.map((e,t)=>t).filter(e=>void 0===i[e.toString()]||i[e.toString()]instanceof Error),l=o.map(t=>e[t]),u=o.map(e=>this._patchConfigForRetry(n,t?.[e],r?.[e])),c=await super.batch(l,u,{...a,returnExceptions:!0});for(let e=0;e<c.length;e+=1){let t=c[e],r=o[e];t instanceof Error&&void 0===s&&((s=t).input=l[e]),i[r.toString()]=t}if(s)throw s;return c},{onFailedAttempt:e=>this.onFailedAttempt(e,e.input),retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(e){if(a?.returnExceptions!==!0)throw e}return Object.keys(i).sort((e,t)=>parseInt(e,10)-parseInt(t,10)).map(e=>i[parseInt(e,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class lm extends ld{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"omitSequenceTags",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name,this.omitSequenceTags=e.omitSequenceTags??this.omitSequenceTags}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r,a=sz(t),i=await sM(a),n=await i?.handleChainStart(this.toJSON(),lc(e,"input"),a.runId,void 0,void 0,void 0,a?.runName);delete a.runId;let s=e;try{let e=[this.first,...this.middle];for(let r=0;r<e.length;r+=1){let i=e[r].invoke(s,sF(a,{callbacks:n?.getChild(this.omitSequenceTags?void 0:`seq:step:${r+1}`)}));s=await sq(i,t?.signal)}if(t?.signal?.aborted)throw Error("Aborted");r=await this.last.invoke(s,sF(a,{callbacks:n?.getChild(this.omitSequenceTags?void 0:`seq:step:${this.steps.length}`)}))}catch(e){throw await n?.handleChainError(e),e}return await n?.handleChainEnd(lc(r,"output")),r}async batch(e,t,r){let a=this._getOptionsList(t??{},e.length),i=await Promise.all(a.map(sM)),n=await Promise.all(i.map(async(t,r)=>{let i=await t?.handleChainStart(this.toJSON(),lc(e[r],"input"),a[r].runId,void 0,void 0,void 0,a[r].runName);return delete a[r].runId,i})),s=e;try{for(let e=0;e<this.steps.length;e+=1){let t=this.steps[e].batch(s,n.map((t,r)=>{let i=t?.getChild(this.omitSequenceTags?void 0:`seq:step:${e+1}`);return sF(a[r],{callbacks:i})}),r);s=await sq(t,a[0]?.signal)}}catch(e){throw await Promise.all(n.map(t=>t?.handleChainError(e))),e}return await Promise.all(n.map(e=>e?.handleChainEnd(lc(s,"output")))),s}_concatOutputChunks(e,t){return this.last._concatOutputChunks(e,t)}async *_streamIterator(e,t){let r,a=await sM(t),{runId:i,...n}=t??{},s=await a?.handleChainStart(this.toJSON(),lc(e,"input"),i,void 0,void 0,void 0,n?.runName),o=[this.first,...this.middle,this.last],l=!0;async function*u(){yield e}try{let e=o[0].transform(u(),sF(n,{callbacks:s?.getChild(this.omitSequenceTags?void 0:"seq:step:1")}));for(let t=1;t<o.length;t+=1){let r=o[t];e=await r.transform(e,sF(n,{callbacks:s?.getChild(this.omitSequenceTags?void 0:`seq:step:${t+1}`)}))}for await(let a of e)if(t?.signal?.throwIfAborted(),yield a,l)if(void 0===r)r=a;else try{r=this._concatOutputChunks(r,a)}catch(e){r=void 0,l=!1}}catch(e){throw await s?.handleChainError(e),e}await s?.handleChainEnd(lc(r,"output"))}getGraph(e){let t=new la,r=null;return this.steps.forEach((a,i)=>{let n=a.getGraph(e);0!==i&&n.trimFirstNode(),i!==this.steps.length-1&&n.trimLastNode(),t.extend(n);let s=n.firstNode();if(!s)throw Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,s),r=n.lastNode()}),t}pipe(e){return new lm(lm.isRunnableSequence(e)?{first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}:{first:this.first,middle:[...this.middle,this.last],last:lw(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&ld.isRunnable(e)}static from([e,...t],r){let a={};return"string"==typeof r?a.name=r:void 0!==r&&(a=r),new lm({...a,first:lw(e),middle:t.slice(0,-1).map(lw),last:lw(t[t.length-1])})}}class lg extends ld{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){for(let[t,r]of(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={},Object.entries(e.steps)))this.steps[t]=lw(r)}static from(e){return new lg({steps:e})}async invoke(e,t){let r=sz(t),a=await sM(r),i=await a?.handleChainStart(this.toJSON(),{input:e},r.runId,void 0,void 0,void 0,r?.runName);delete r.runId;let n={};try{let a=Object.entries(this.steps).map(async([t,a])=>{n[t]=await a.invoke(e,sF(r,{callbacks:i?.getChild(`map:key:${t}`)}))});await sq(Promise.all(a),t?.signal)}catch(e){throw await i?.handleChainError(e),e}return await i?.handleChainEnd(n),n}async *_transform(e,t,r){let a={...this.steps},i=sW(e,Object.keys(a).length),n=new Map(Object.entries(a).map(([e,a],n)=>{let s=a.transform(i[n],sF(r,{callbacks:t?.getChild(`map:key:${e}`)}));return[e,s.next().then(t=>({key:e,gen:s,result:t}))]}));for(;n.size;){let e=Promise.race(n.values()),{key:t,result:a,gen:i}=await sq(e,r?.signal);n.delete(t),a.done||(yield{[t]:a.value},n.set(t,i.next().then(e=>({key:t,gen:i,result:e}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=sz(t),i=new sG({generator:this.transform(r(),a),config:a});return await i.setup,sH.fromAsyncGenerator(i)}}class ly extends ld{constructor(e){if(super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!iF(e.func))throw Error("RunnableTraceable requires a function that is wrapped in traceable higher-order function");this.func=e.func}async invoke(e,t){let[r]=this._getOptionsList(t??{},1),a=await sM(r);return sq(this.func(sF(r,{callbacks:a}),e),r?.signal)}async *_streamIterator(e,t){let[r]=this._getOptionsList(t??{},1),a=await this.invoke(e,t);if(lo(a)){for await(let e of a)r?.signal?.throwIfAborted(),yield e;return}if(null!=a&&"object"==typeof a&&"next"in a&&"function"==typeof a.next){for(;;){r?.signal?.throwIfAborted();let e=a.next();if(e.done)break;yield e.value}return}yield a}static from(e){return new ly({func:e})}}class lb extends ld{static lc_name(){return"RunnableLambda"}constructor(e){if(iF(e.func))return ly.from(e.func);if(super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),iF(e.func))throw Error("RunnableLambda requires a function that is not wrapped in traceable higher-order function. This shouldn't happen.");this.func=e.func}static from(e){return new lb({func:e})}async _invoke(e,t,r){return new Promise((a,i)=>{let n=sF(t,{callbacks:r?.getChild(),recursionLimit:(t?.recursionLimit??25)-1});sL.runWithConfig(sB(n),async()=>{try{let r=await this.func(e,{...n});if(r&&ld.isRunnable(r)){if(t?.recursionLimit===0)throw Error("Recursion limit reached.");r=await r.invoke(e,{...n,recursionLimit:(n.recursionLimit??25)-1})}else if(lo(r)){let e;for await(let a of lu(n,r))if(t?.signal?.throwIfAborted(),void 0===e)e=a;else try{e=this._concatOutputChunks(e,a)}catch(t){e=a}r=e}else if(ls(r)){let e;for(let a of ll(n,r))if(t?.signal?.throwIfAborted(),void 0===e)e=a;else try{e=this._concatOutputChunks(e,a)}catch(t){e=a}r=e}a(r)}catch(e){i(e)}})})}async invoke(e,t){return this._callWithConfig(this._invoke.bind(this),e,t)}async *_transform(e,t,r){let a;for await(let t of e)if(void 0===a)a=t;else try{a=this._concatOutputChunks(a,t)}catch(e){a=t}let i=sF(r,{callbacks:t?.getChild(),recursionLimit:(r?.recursionLimit??25)-1}),n=await new Promise((e,t)=>{sL.runWithConfig(sB(i),async()=>{try{let t=await this.func(a,{...i,config:i});e(t)}catch(e){t(e)}})});if(n&&ld.isRunnable(n)){if(r?.recursionLimit===0)throw Error("Recursion limit reached.");for await(let e of(await n.stream(a,i)))yield e}else if(lo(n))for await(let e of lu(i,n))r?.signal?.throwIfAborted(),yield e;else if(ls(n))for(let e of ll(i,n))r?.signal?.throwIfAborted(),yield e;else yield n}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=sz(t),i=new sG({generator:this.transform(r(),a),config:a});return await i.setup,sH.fromAsyncGenerator(i)}}class l_ extends ld{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){for(let e of(yield this.runnable,this.fallbacks))yield e}async invoke(e,t){let r=sz(t),a=await sM(r),{runId:i,...n}=r,s=await a?.handleChainStart(this.toJSON(),lc(e,"input"),i,void 0,void 0,void 0,n?.runName),o=sF(n,{callbacks:s?.getChild()});return await sL.runWithConfig(o,async()=>{let t;for(let a of this.runnables()){r?.signal?.throwIfAborted();try{let t=await a.invoke(e,o);return await s?.handleChainEnd(lc(t,"output")),t}catch(e){void 0===t&&(t=e)}}if(void 0===t)throw Error("No error stored at end of fallback.");throw await s?.handleChainError(t),t})}async *_streamIterator(e,t){let r,a,i,n=sz(t),s=await sM(n),{runId:o,...l}=n,u=await s?.handleChainStart(this.toJSON(),lc(e,"input"),o,void 0,void 0,void 0,l?.runName);for(let t of this.runnables()){n?.signal?.throwIfAborted();let i=sF(l,{callbacks:u?.getChild()});try{let r=await t.stream(e,i);a=lu(i,r);break}catch(e){void 0===r&&(r=e)}}if(void 0===a){let e=r??Error("No error stored at end of fallback.");throw await u?.handleChainError(e),e}try{for await(let e of a){yield e;try{i=void 0===i?i:this._concatOutputChunks(i,e)}catch(e){i=void 0}}}catch(e){throw await u?.handleChainError(e),e}await u?.handleChainEnd(lc(i,"output"))}async batch(e,t,r){let a;if(r?.returnExceptions)throw Error("Not implemented.");let i=this._getOptionsList(t??{},e.length),n=await Promise.all(i.map(e=>sM(e))),s=await Promise.all(n.map(async(t,r)=>{let a=await t?.handleChainStart(this.toJSON(),lc(e[r],"input"),i[r].runId,void 0,void 0,void 0,i[r].runName);return delete i[r].runId,a}));for(let t of this.runnables()){i[0].signal?.throwIfAborted();try{let a=await t.batch(e,s.map((e,t)=>sF(i[t],{callbacks:e?.getChild()})),r);return await Promise.all(s.map((e,t)=>e?.handleChainEnd(lc(a[t],"output")))),a}catch(e){void 0===a&&(a=e)}}if(!a)throw Error("No error stored at end of fallbacks.");throw await Promise.all(s.map(e=>e?.handleChainError(a))),a}}function lw(e){if("function"==typeof e)return new lb({func:e});if(ld.isRunnable(e))return e;if(Array.isArray(e)||"object"!=typeof e)throw Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`);{let t={};for(let[r,a]of Object.entries(e))t[r]=lw(a);return new lg({steps:t})}}class lv extends ld{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof lg&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async *_transform(e,t,r){let a=this.mapper.getStepsKeys(),[i,n]=sW(e),s=this.mapper.transform(n,sF(r,{callbacks:t?.getChild()})),o=s.next();for await(let e of i){if("object"!=typeof e||Array.isArray(e))throw Error(`RunnableAssign can only be used with objects as input, got ${typeof e}`);let t=Object.fromEntries(Object.entries(e).filter(([e])=>!a.includes(e)));Object.keys(t).length>0&&(yield t)}for await(let e of(yield(await o).value,s))yield e}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=sz(t),i=new sG({generator:this.transform(r(),a),config:a});return await i.setup,sH.fromAsyncGenerator(i)}}class lE extends ld{static lc_name(){return"RunnablePick"}constructor(e){("string"==typeof e||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if("string"==typeof this.keys)return e[this.keys];{let t=this.keys.map(t=>[t,e[t]]).filter(e=>void 0!==e[1]);return 0===t.length?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async *_transform(e){for await(let t of e){let e=await this._pick(t);void 0!==e&&(yield e)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=sz(t),i=new sG({generator:this.transform(r(),a),config:a});return await i.setup,sH.fromAsyncGenerator(i)}}class lO extends lh{constructor(e){super({bound:lm.from([lb.from(async e=>{let t;if(iS(e))try{t=await o8(this.schema,e.args)}catch(t){throw new ix("Received tool input did not match expected schema",JSON.stringify(e.args))}else t=e;return t}).withConfig({runName:`${e.name}:parse_input`}),e.bound]).withConfig({runName:e.name}),config:e.config??{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.description=e.description,this.schema=e.schema}static lc_name(){return"RunnableToolLike"}}var lk="object"==typeof window?window:{},lS="0123456789abcdef".split(""),lx=[-0x80000000,8388608,32768,128],l$=[24,16,8,0],lI=[];function lA(e){e?(lI[0]=lI[16]=lI[1]=lI[2]=lI[3]=lI[4]=lI[5]=lI[6]=lI[7]=lI[8]=lI[9]=lI[10]=lI[11]=lI[12]=lI[13]=lI[14]=lI[15]=0,this.blocks=lI):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=0x67452301,this.h1=0xefcdab89,this.h2=0x98badcfe,this.h3=0x10325476,this.h4=0xc3d2e1f0,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}lA.prototype.update=function(e){if(!this.finalized){var t="string"!=typeof e;t&&e.constructor===lk.ArrayBuffer&&(e=new Uint8Array(e));for(var r,a,i=0,n=e.length||0,s=this.blocks;i<n;){if(this.hashed&&(this.hashed=!1,s[0]=this.block,s[16]=s[1]=s[2]=s[3]=s[4]=s[5]=s[6]=s[7]=s[8]=s[9]=s[10]=s[11]=s[12]=s[13]=s[14]=s[15]=0),t)for(a=this.start;i<n&&a<64;++i)s[a>>2]|=e[i]<<l$[3&a++];else for(a=this.start;i<n&&a<64;++i)(r=e.charCodeAt(i))<128?s[a>>2]|=r<<l$[3&a++]:(r<2048?s[a>>2]|=(192|r>>6)<<l$[3&a++]:(r<55296||r>=57344?s[a>>2]|=(224|r>>12)<<l$[3&a++]:(r=65536+((1023&r)<<10|1023&e.charCodeAt(++i)),s[a>>2]|=(240|r>>18)<<l$[3&a++],s[a>>2]|=(128|r>>12&63)<<l$[3&a++]),s[a>>2]|=(128|r>>6&63)<<l$[3&a++]),s[a>>2]|=(128|63&r)<<l$[3&a++]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=s[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>0xffffffff&&(this.hBytes+=this.bytes/0x100000000|0,this.bytes=this.bytes%0x100000000),this}},lA.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>2]|=lx[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},lA.prototype.hash=function(){var e,t,r,a=this.h0,i=this.h1,n=this.h2,s=this.h3,o=this.h4,l=this.blocks;for(t=16;t<80;++t)r=l[t-3]^l[t-8]^l[t-14]^l[t-16],l[t]=r<<1|r>>>31;for(t=0;t<20;t+=5)e=i&n|~i&s,o=(r=a<<5|a>>>27)+e+o+0x5a827999+l[t]|0,e=a&(i=i<<30|i>>>2)|~a&n,s=(r=o<<5|o>>>27)+e+s+0x5a827999+l[t+1]|0,e=o&(a=a<<30|a>>>2)|~o&i,n=(r=s<<5|s>>>27)+e+n+0x5a827999+l[t+2]|0,e=s&(o=o<<30|o>>>2)|~s&a,i=(r=n<<5|n>>>27)+e+i+0x5a827999+l[t+3]|0,e=n&(s=s<<30|s>>>2)|~n&o,a=(r=i<<5|i>>>27)+e+a+0x5a827999+l[t+4]|0,n=n<<30|n>>>2;for(;t<40;t+=5)e=i^n^s,o=(r=a<<5|a>>>27)+e+o+0x6ed9eba1+l[t]|0,e=a^(i=i<<30|i>>>2)^n,s=(r=o<<5|o>>>27)+e+s+0x6ed9eba1+l[t+1]|0,e=o^(a=a<<30|a>>>2)^i,n=(r=s<<5|s>>>27)+e+n+0x6ed9eba1+l[t+2]|0,e=s^(o=o<<30|o>>>2)^a,i=(r=n<<5|n>>>27)+e+i+0x6ed9eba1+l[t+3]|0,e=n^(s=s<<30|s>>>2)^o,a=(r=i<<5|i>>>27)+e+a+0x6ed9eba1+l[t+4]|0,n=n<<30|n>>>2;for(;t<60;t+=5)e=i&n|i&s|n&s,o=(r=a<<5|a>>>27)+e+o-0x70e44324+l[t]|0,e=a&(i=i<<30|i>>>2)|a&n|i&n,s=(r=o<<5|o>>>27)+e+s-0x70e44324+l[t+1]|0,e=o&(a=a<<30|a>>>2)|o&i|a&i,n=(r=s<<5|s>>>27)+e+n-0x70e44324+l[t+2]|0,e=s&(o=o<<30|o>>>2)|s&a|o&a,i=(r=n<<5|n>>>27)+e+i-0x70e44324+l[t+3]|0,e=n&(s=s<<30|s>>>2)|n&o|s&o,a=(r=i<<5|i>>>27)+e+a-0x70e44324+l[t+4]|0,n=n<<30|n>>>2;for(;t<80;t+=5)e=i^n^s,o=(r=a<<5|a>>>27)+e+o-0x359d3e2a+l[t]|0,e=a^(i=i<<30|i>>>2)^n,s=(r=o<<5|o>>>27)+e+s-0x359d3e2a+l[t+1]|0,e=o^(a=a<<30|a>>>2)^i,n=(r=s<<5|s>>>27)+e+n-0x359d3e2a+l[t+2]|0,e=s^(o=o<<30|o>>>2)^a,i=(r=n<<5|n>>>27)+e+i-0x359d3e2a+l[t+3]|0,e=n^(s=s<<30|s>>>2)^o,a=(r=i<<5|i>>>27)+e+a-0x359d3e2a+l[t+4]|0,n=n<<30|n>>>2;this.h0=this.h0+a|0,this.h1=this.h1+i|0,this.h2=this.h2+n|0,this.h3=this.h3+s|0,this.h4=this.h4+o|0},lA.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,a=this.h3,i=this.h4;return lS[e>>28&15]+lS[e>>24&15]+lS[e>>20&15]+lS[e>>16&15]+lS[e>>12&15]+lS[e>>8&15]+lS[e>>4&15]+lS[15&e]+lS[t>>28&15]+lS[t>>24&15]+lS[t>>20&15]+lS[t>>16&15]+lS[t>>12&15]+lS[t>>8&15]+lS[t>>4&15]+lS[15&t]+lS[r>>28&15]+lS[r>>24&15]+lS[r>>20&15]+lS[r>>16&15]+lS[r>>12&15]+lS[r>>8&15]+lS[r>>4&15]+lS[15&r]+lS[a>>28&15]+lS[a>>24&15]+lS[a>>20&15]+lS[a>>16&15]+lS[a>>12&15]+lS[a>>8&15]+lS[a>>4&15]+lS[15&a]+lS[i>>28&15]+lS[i>>24&15]+lS[i>>20&15]+lS[i>>16&15]+lS[i>>12&15]+lS[i>>8&15]+lS[i>>4&15]+lS[15&i]},lA.prototype.toString=lA.prototype.hex,lA.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,a=this.h3,i=this.h4;return[e>>24&255,e>>16&255,e>>8&255,255&e,t>>24&255,t>>16&255,t>>8&255,255&t,r>>24&255,r>>16&255,r>>8&255,255&r,a>>24&255,a>>16&255,a>>8&255,255&a,i>>24&255,i>>16&255,i>>8&255,255&i]},lA.prototype.array=lA.prototype.digest,lA.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(20),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),e};let lT=!1;var lP="0123456789abcdef".split(""),lj=[-0x80000000,8388608,32768,128],lN=[24,16,8,0],lR=[0x428a2f98,0x71374491,0xb5c0fbcf,0xe9b5dba5,0x3956c25b,0x59f111f1,0x923f82a4,0xab1c5ed5,0xd807aa98,0x12835b01,0x243185be,0x550c7dc3,0x72be5d74,0x80deb1fe,0x9bdc06a7,0xc19bf174,0xe49b69c1,0xefbe4786,0xfc19dc6,0x240ca1cc,0x2de92c6f,0x4a7484aa,0x5cb0a9dc,0x76f988da,0x983e5152,0xa831c66d,0xb00327c8,0xbf597fc7,0xc6e00bf3,0xd5a79147,0x6ca6351,0x14292967,0x27b70a85,0x2e1b2138,0x4d2c6dfc,0x53380d13,0x650a7354,0x766a0abb,0x81c2c92e,0x92722c85,0xa2bfe8a1,0xa81a664b,0xc24b8b70,0xc76c51a3,0xd192e819,0xd6990624,0xf40e3585,0x106aa070,0x19a4c116,0x1e376c08,0x2748774c,0x34b0bcb5,0x391c0cb3,0x4ed8aa4a,0x5b9cca4f,0x682e6ff3,0x748f82ee,0x78a5636f,0x84c87814,0x8cc70208,0x90befffa,0xa4506ceb,0xbef9a3f7,0xc67178f2],lC=[];function lL(e,t){t?(lC[0]=lC[16]=lC[1]=lC[2]=lC[3]=lC[4]=lC[5]=lC[6]=lC[7]=lC[8]=lC[9]=lC[10]=lC[11]=lC[12]=lC[13]=lC[14]=lC[15]=0,this.blocks=lC):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e?(this.h0=0xc1059ed8,this.h1=0x367cd507,this.h2=0x3070dd17,this.h3=0xf70e5939,this.h4=0xffc00b31,this.h5=0x68581511,this.h6=0x64f98fa7,this.h7=0xbefa4fa4):(this.h0=0x6a09e667,this.h1=0xbb67ae85,this.h2=0x3c6ef372,this.h3=0xa54ff53a,this.h4=0x510e527f,this.h5=0x9b05688c,this.h6=0x1f83d9ab,this.h7=0x5be0cd19),this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0,this.is224=e}lL.prototype.update=function(e){if(!this.finalized){var t,r=typeof e;if("string"!==r){if("object"===r){if(null===e)throw Error(ERROR);else if(ARRAY_BUFFER&&e.constructor===ArrayBuffer)e=new Uint8Array(e);else if(!Array.isArray(e)&&(!ARRAY_BUFFER||!ArrayBuffer.isView(e)))throw Error(ERROR)}else throw Error(ERROR);t=!0}for(var a,i,n=0,s=e.length,o=this.blocks;n<s;){if(this.hashed&&(this.hashed=!1,o[0]=this.block,this.block=o[16]=o[1]=o[2]=o[3]=o[4]=o[5]=o[6]=o[7]=o[8]=o[9]=o[10]=o[11]=o[12]=o[13]=o[14]=o[15]=0),t)for(i=this.start;n<s&&i<64;++n)o[i>>>2]|=e[n]<<lN[3&i++];else for(i=this.start;n<s&&i<64;++n)(a=e.charCodeAt(n))<128?o[i>>>2]|=a<<lN[3&i++]:(a<2048?o[i>>>2]|=(192|a>>>6)<<lN[3&i++]:(a<55296||a>=57344?o[i>>>2]|=(224|a>>>12)<<lN[3&i++]:(a=65536+((1023&a)<<10|1023&e.charCodeAt(++n)),o[i>>>2]|=(240|a>>>18)<<lN[3&i++],o[i>>>2]|=(128|a>>>12&63)<<lN[3&i++]),o[i>>>2]|=(128|a>>>6&63)<<lN[3&i++]),o[i>>>2]|=(128|63&a)<<lN[3&i++]);this.lastByteIndex=i,this.bytes+=i-this.start,i>=64?(this.block=o[16],this.start=i-64,this.hash(),this.hashed=!0):this.start=i}return this.bytes>0xffffffff&&(this.hBytes+=this.bytes/0x100000000|0,this.bytes=this.bytes%0x100000000),this}},lL.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var e=this.blocks,t=this.lastByteIndex;e[16]=this.block,e[t>>>2]|=lj[3&t],this.block=e[16],t>=56&&(this.hashed||this.hash(),e[0]=this.block,e[16]=e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=e[7]=e[8]=e[9]=e[10]=e[11]=e[12]=e[13]=e[14]=e[15]=0),e[14]=this.hBytes<<3|this.bytes>>>29,e[15]=this.bytes<<3,this.hash()}},lL.prototype.hash=function(){var e,t,r,a,i,n,s,o,l,u,c=this.h0,d=this.h1,h=this.h2,p=this.h3,f=this.h4,m=this.h5,g=this.h6,y=this.h7,b=this.blocks;for(e=16;e<64;++e)t=((i=b[e-15])>>>7|i<<25)^(i>>>18|i<<14)^i>>>3,r=((i=b[e-2])>>>17|i<<15)^(i>>>19|i<<13)^i>>>10,b[e]=b[e-16]+t+b[e-7]+r|0;for(e=0,u=d&h;e<64;e+=4)this.first?(this.is224?(s=300032,y=(i=b[0]-0x543c9a5b)-0x8f1a6c7|0,p=i+0x170e9b5|0):(s=0x2a01a605,y=(i=b[0]-0xc881298)-0x5ab00ac6|0,p=i+0x8909ae5|0),this.first=!1):(t=(c>>>2|c<<30)^(c>>>13|c<<19)^(c>>>22|c<<10),r=(f>>>6|f<<26)^(f>>>11|f<<21)^(f>>>25|f<<7),a=(s=c&d)^c&h^u,i=y+r+(f&m^~f&g)+lR[e]+b[e],n=t+a,y=p+i|0,p=i+n|0),t=(p>>>2|p<<30)^(p>>>13|p<<19)^(p>>>22|p<<10),r=(y>>>6|y<<26)^(y>>>11|y<<21)^(y>>>25|y<<7),a=(o=p&c)^p&d^s,i=m+r+(g&y^~g&f)+lR[e+1]+b[e+1],n=t+a,g=h+i|0,t=((h=i+n|0)>>>2|h<<30)^(h>>>13|h<<19)^(h>>>22|h<<10),r=(g>>>6|g<<26)^(g>>>11|g<<21)^(g>>>25|g<<7),a=(l=h&p)^h&c^o,i=f+r+(m&g^~m&y)+lR[e+2]+b[e+2],n=t+a,m=d+i|0,t=((d=i+n|0)>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10),r=(m>>>6|m<<26)^(m>>>11|m<<21)^(m>>>25|m<<7),a=(u=d&h)^d&p^l,i=f+r+(m&g^~m&y)+lR[e+3]+b[e+3],n=t+a,f=c+i|0,c=i+n|0,this.chromeBugWorkAround=!0;this.h0=this.h0+c|0,this.h1=this.h1+d|0,this.h2=this.h2+h|0,this.h3=this.h3+p|0,this.h4=this.h4+f|0,this.h5=this.h5+m|0,this.h6=this.h6+g|0,this.h7=this.h7+y|0},lL.prototype.hex=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,a=this.h3,i=this.h4,n=this.h5,s=this.h6,o=this.h7,l=lP[e>>>28&15]+lP[e>>>24&15]+lP[e>>>20&15]+lP[e>>>16&15]+lP[e>>>12&15]+lP[e>>>8&15]+lP[e>>>4&15]+lP[15&e]+lP[t>>>28&15]+lP[t>>>24&15]+lP[t>>>20&15]+lP[t>>>16&15]+lP[t>>>12&15]+lP[t>>>8&15]+lP[t>>>4&15]+lP[15&t]+lP[r>>>28&15]+lP[r>>>24&15]+lP[r>>>20&15]+lP[r>>>16&15]+lP[r>>>12&15]+lP[r>>>8&15]+lP[r>>>4&15]+lP[15&r]+lP[a>>>28&15]+lP[a>>>24&15]+lP[a>>>20&15]+lP[a>>>16&15]+lP[a>>>12&15]+lP[a>>>8&15]+lP[a>>>4&15]+lP[15&a]+lP[i>>>28&15]+lP[i>>>24&15]+lP[i>>>20&15]+lP[i>>>16&15]+lP[i>>>12&15]+lP[i>>>8&15]+lP[i>>>4&15]+lP[15&i]+lP[n>>>28&15]+lP[n>>>24&15]+lP[n>>>20&15]+lP[n>>>16&15]+lP[n>>>12&15]+lP[n>>>8&15]+lP[n>>>4&15]+lP[15&n]+lP[s>>>28&15]+lP[s>>>24&15]+lP[s>>>20&15]+lP[s>>>16&15]+lP[s>>>12&15]+lP[s>>>8&15]+lP[s>>>4&15]+lP[15&s];return this.is224||(l+=lP[o>>>28&15]+lP[o>>>24&15]+lP[o>>>20&15]+lP[o>>>16&15]+lP[o>>>12&15]+lP[o>>>8&15]+lP[o>>>4&15]+lP[15&o]),l},lL.prototype.toString=lL.prototype.hex,lL.prototype.digest=function(){this.finalize();var e=this.h0,t=this.h1,r=this.h2,a=this.h3,i=this.h4,n=this.h5,s=this.h6,o=this.h7,l=[e>>>24&255,e>>>16&255,e>>>8&255,255&e,t>>>24&255,t>>>16&255,t>>>8&255,255&t,r>>>24&255,r>>>16&255,r>>>8&255,255&r,a>>>24&255,a>>>16&255,a>>>8&255,255&a,i>>>24&255,i>>>16&255,i>>>8&255,255&i,n>>>24&255,n>>>16&255,n>>>8&255,255&n,s>>>24&255,s>>>16&255,s>>>8&255,255&s];return this.is224||l.push(o>>>24&255,o>>>16&255,o>>>8&255,255&o),l},lL.prototype.array=lL.prototype.digest,lL.prototype.arrayBuffer=function(){this.finalize();var e=new ArrayBuffer(this.is224?28:32),t=new DataView(e);return t.setUint32(0,this.h0),t.setUint32(4,this.h1),t.setUint32(8,this.h2),t.setUint32(12,this.h3),t.setUint32(16,this.h4),t.setUint32(20,this.h5),t.setUint32(24,this.h6),this.is224||t.setUint32(28,this.h7),e};let lM=(...e)=>{var t;return t=e.join("_"),lT||(console.warn(`The default method for hashing keys is insecure and will be replaced in a future version,
but hasn't been replaced yet as to not break existing caches. It's recommended that you use
a more secure hashing algorithm to avoid cache poisoning.

See this page for more information:
|
> https://js.langchain.com/docs/troubleshooting/warnings/insecure-cache-algorithm`),lT=!0),new lA(!0).update(t).hex()};class lU{constructor(){Object.defineProperty(this,"keyEncoder",{enumerable:!0,configurable:!0,writable:!0,value:lM})}makeDefaultKeyEncoder(e){this.keyEncoder=e}}let lD=new Map;class lz extends lU{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(this.keyEncoder(e,t))??null)}async update(e,t,r){this.cache.set(this.keyEncoder(e,t),r)}static global(){return new lz(lD)}}class lF extends a8{}class lB extends lF{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new iw(this.value)]}}class lq extends lF{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return iT(this.messages)}toChatMessages(){return this.messages}}var lH=r(67526),lW=Object.defineProperty,lJ=class{specialTokens;inverseSpecialTokens;patStr;textEncoder=new TextEncoder;textDecoder=new TextDecoder("utf-8");rankMap=new Map;textMap=new Map;constructor(e,t){for(let[t,r]of(this.patStr=e.pat_str,Object.entries(e.bpe_ranks.split("\n").filter(Boolean).reduce((e,t)=>{let[r,a,...i]=t.split(" "),n=Number.parseInt(a,10);return i.forEach((t,r)=>e[t]=n+r),e},{})))){let e=lH.toByteArray(t);this.rankMap.set(e.join(","),r),this.textMap.set(r,e)}this.specialTokens={...e.special_tokens,...t},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((e,[t,r])=>(e[r]=this.textEncoder.encode(t),e),{})}encode(e,t=[],r="all"){let a=RegExp(this.patStr,"ug"),i=lJ.specialTokenRegex(Object.keys(this.specialTokens)),n=[],s=new Set("all"===t?Object.keys(this.specialTokens):t),o=new Set("all"===r?Object.keys(this.specialTokens).filter(e=>!s.has(e)):r);if(o.size>0){let t=lJ.specialTokenRegex([...o]),r=e.match(t);if(null!=r)throw Error(`The text contains a special token that is not allowed: ${r[0]}`)}let l=0;for(;;){let t=null,r=l;for(;i.lastIndex=r,!(null==(t=i.exec(e))||s.has(t[0]));)r=t.index+1;let o=t?.index??e.length;for(let t of e.substring(l,o).matchAll(a)){let e=this.textEncoder.encode(t[0]),r=this.rankMap.get(e.join(","));if(null!=r){n.push(r);continue}n.push(...function(e,t){return 1===e.length?[t.get(e.join(","))]:(function(e,t){let r=Array.from({length:e.length},(e,t)=>({start:t,end:t+1}));for(;r.length>1;){let a=null;for(let i=0;i<r.length-1;i++){let n=e.slice(r[i].start,r[i+1].end),s=t.get(n.join(","));null!=s&&(null==a||s<a[0])&&(a=[s,i])}if(null!=a){let e=a[1];r[e]={start:r[e].start,end:r[e+1].end},r.splice(e+1,1)}else break}return r})(e,t).map(r=>t.get(e.slice(r.start,r.end).join(","))).filter(e=>null!=e)}(e,this.rankMap))}if(null==t)break;let u=this.specialTokens[t[0]];n.push(u),l=t.index+t[0].length}return n}decode(e){let t=[],r=0;for(let a=0;a<e.length;++a){let i=e[a],n=this.textMap.get(i)??this.inverseSpecialTokens[i];null!=n&&(t.push(n),r+=n.length)}let a=new Uint8Array(r),i=0;for(let e of t)a.set(e,i),i+=e.length;return this.textDecoder.decode(a)}};b="specialTokenRegex",_=e=>RegExp(e.map(e=>e.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")).join("|"),"g"),(g="symbol"!=typeof b?b+"":b)in lJ?lW(lJ,g,{enumerable:!0,configurable:!0,writable:!0,value:_}):lJ[g]=_;let lG={},lZ=new s7({});async function lV(e){return e in lG||(lG[e]=lZ.fetch(`https://tiktoken.pages.dev/js/${e}.json`).then(e=>e.json()).then(e=>new lJ(e)).catch(t=>{throw delete lG[e],t})),await lG[e]}async function lY(e){return lV(function(e){switch(e){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo":case"gpt-4-turbo-2024-04-09":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":case"text-embedding-3-small":case"text-embedding-3-large":return"cl100k_base";case"gpt-4o":case"gpt-4o-2024-05-13":case"gpt-4o-2024-08-06":case"gpt-4o-2024-11-20":case"gpt-4o-mini-2024-07-18":case"gpt-4o-mini":case"gpt-4o-search-preview":case"gpt-4o-search-preview-2025-03-11":case"gpt-4o-mini-search-preview":case"gpt-4o-mini-search-preview-2025-03-11":case"gpt-4o-audio-preview":case"gpt-4o-audio-preview-2024-12-17":case"gpt-4o-audio-preview-2024-10-01":case"gpt-4o-mini-audio-preview":case"gpt-4o-mini-audio-preview-2024-12-17":case"o1":case"o1-2024-12-17":case"o1-mini":case"o1-mini-2024-09-12":case"o1-preview":case"o1-preview-2024-09-12":case"o1-pro":case"o1-pro-2025-03-19":case"o3":case"o3-2025-04-16":case"o3-mini":case"o3-mini-2025-01-31":case"o4-mini":case"o4-mini-2025-04-16":case"chatgpt-4o-latest":case"gpt-4o-realtime":case"gpt-4o-realtime-preview-2024-10-01":case"gpt-4o-realtime-preview-2024-12-17":case"gpt-4o-mini-realtime-preview":case"gpt-4o-mini-realtime-preview-2024-12-17":case"gpt-4.1":case"gpt-4.1-2025-04-14":case"gpt-4.1-mini":case"gpt-4.1-mini-2025-04-14":case"gpt-4.1-nano":case"gpt-4.1-nano-2025-04-14":case"gpt-4.5-preview":case"gpt-4.5-preview-2025-02-27":case"gpt-5":case"gpt-5-2025-08-07":case"gpt-5-nano":case"gpt-5-nano-2025-08-07":case"gpt-5-mini":case"gpt-5-mini-2025-08-07":case"gpt-5-chat-latest":return"o200k_base";default:throw Error("Unknown model")}}(e))}function lK(e){return"object"==typeof e&&!!e&&("type"in e&&"function"===e.type&&"function"in e&&"object"==typeof e.function&&!!e.function&&"name"in e.function&&"parameters"in e.function||!1)}class lX extends ld{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??!1,this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class lQ extends lX{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){let{cache:a,...i}=r;super({callbacks:e??t,...i}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),"object"==typeof a?this.cache=a:a?this.cache=lz.global():this.cache=void 0,this.caller=new s7(r??{})}async getNumTokens(e){let t,r=Math.ceil((t="string"==typeof e?e:e.map(e=>"string"==typeof e?e:"text"===e.type&&"text"in e?e.text:"").join("")).length/4);if(!this._encoding)try{var a;this._encoding=await lY("modelName"in this?(a=this.modelName).startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":a.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":a.startsWith("gpt-4-32k")?"gpt-4-32k":a.startsWith("gpt-4-")?"gpt-4":a.startsWith("gpt-4o")?"gpt-4o":a:"gpt2")}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}if(this._encoding)try{r=this._encoding.encode(t).length}catch(e){console.warn("Failed to calculate number of tokens, falling back to approximate count",e)}return r}static _convertInputToPromptValue(e){return"string"==typeof e?new lB(e):Array.isArray(e)?new lq(e.map(iA)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall({config:e,...t}){return Object.entries({...this._identifyingParams(),...t,_type:this._llmType(),_model:this._modelType()}).filter(([e,t])=>void 0!==t).map(([e,t])=>`${e}:${JSON.stringify(t)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw Error("Use .toJSON() instead")}}class l0 extends ld{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=sz(t);return this.func&&await this.func(e,r),this._callWithConfig(e=>Promise.resolve(e),e,r)}async *transform(e,t){let r,a=sz(t),i=!0;for await(let t of this._transformStreamWithConfig(e,e=>e,a))if(yield t,i)if(void 0===r)r=t;else try{r=sJ(r,t)}catch{r=void 0,i=!1}this.func&&void 0!==r&&await this.func(r,a)}static assign(e){return new lv(new lg({steps:e}))}}function l1(e){let t=[];for(let r of e){let e=r;if(Array.isArray(r.content))for(let t=0;t<r.content.length;t++){let a=r.content[t];(a7(a)&&"url"===a.source_type&&"url"in a&&"string"==typeof a.url||a7(a)&&"base64"===a.source_type&&"data"in a&&"string"==typeof a.data)&&e===r&&(e=new r.constructor({...e,content:[...r.content.slice(0,t),function(e){if(a7(e)){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url}};if("base64"===e.source_type){if(!e.mime_type)throw Error("mime_type key is required for base64 data.");let t=e.mime_type;return{type:"image_url",image_url:{url:`data:${t};base64,${e.data}`}}}}throw Error("Unsupported source type. Only 'url' and 'base64' are supported.")}(a),...r.content.slice(t+1)]}))}t.push(e)}return t}class l2 extends lQ{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]}),Object.defineProperty(this,"disableStreaming",{enumerable:!0,configurable:!0,writable:!0,value:!1})}_separateRunnableConfigFromCallOptionsCompat(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r.signal=t.signal,[t,r]}async invoke(e,t){let r=l2._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t?.callbacks)).generations[0][0].message}async *_streamResponseChunks(e,t,r){throw Error("Not implemented.")}async *_streamIterator(e,t){if(this._streamResponseChunks===l2.prototype._streamResponseChunks||this.disableStreaming)yield this.invoke(e,t);else{let r,a,i=l2._convertInputToPromptValue(e).toChatMessages(),[n,s]=this._separateRunnableConfigFromCallOptionsCompat(t),o={...n.metadata,...this.getLsParams(s)},l=await sj.configure(n.callbacks,this.callbacks,n.tags,this.tags,o,this.metadata,{verbose:this.verbose}),u={options:s,invocation_params:this?.invocationParams(s),batch_size:1},c=await l?.handleChatModelStart(this.toJSON(),[l1(i)],n.runId,void 0,u,void 0,void 0,n.runName);try{for await(let e of this._streamResponseChunks(i,s,c?.[0])){if(null==e.message.id){let t=c?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata},yield e.message,r=r?r.concat(e):e,im(e.message)&&void 0!==e.message.usage_metadata&&(a={tokenUsage:{promptTokens:e.message.usage_metadata.input_tokens,completionTokens:e.message.usage_metadata.output_tokens,totalTokens:e.message.usage_metadata.total_tokens}})}}catch(e){throw await Promise.all((c??[]).map(t=>t?.handleLLMError(e))),e}await Promise.all((c??[]).map(e=>e?.handleLLMEnd({generations:[[r]],llmOutput:a})))}}getLsParams(e){let t=this.getName().startsWith("Chat")?this.getName().replace("Chat",""):this.getName();return{ls_model_type:"chat",ls_stop:e.stop,ls_provider:t}}async _generateUncached(e,t,r,a){let i,n=e.map(e=>e.map(iA));if(void 0!==a&&a.length===n.length)i=a;else{let e={...r.metadata,...this.getLsParams(t)},a=await sj.configure(r.callbacks,this.callbacks,r.tags,this.tags,e,this.metadata,{verbose:this.verbose}),s={options:t,invocation_params:this?.invocationParams(t),batch_size:1};i=await a?.handleChatModelStart(this.toJSON(),n.map(l1),r.runId,void 0,s,void 0,void 0,r.runName)}let s=[],o=[];if(i?.[0].handlers.find(ss)&&!this.disableStreaming&&1===n.length&&this._streamResponseChunks!==l2.prototype._streamResponseChunks)try{let e,r;for await(let a of(await this._streamResponseChunks(n[0],t,i?.[0]))){if(null==a.message.id){let e=i?.at(0)?.runId;null!=e&&a.message._updateId(`run-${e}`)}e=void 0===e?a:sJ(e,a),im(a.message)&&void 0!==a.message.usage_metadata&&(r={tokenUsage:{promptTokens:a.message.usage_metadata.input_tokens,completionTokens:a.message.usage_metadata.output_tokens,totalTokens:a.message.usage_metadata.total_tokens}})}if(void 0===e)throw Error("Received empty response from chat model call.");s.push([e]),await i?.[0].handleLLMEnd({generations:s,llmOutput:r})}catch(e){throw await i?.[0].handleLLMError(e),e}else{let e=await Promise.allSettled(n.map((e,r)=>this._generate(e,{...t,promptIndex:r},i?.[r])));await Promise.all(e.map(async(e,t)=>{if("fulfilled"!==e.status)return await i?.[t]?.handleLLMError(e.reason),Promise.reject(e.reason);{let r=e.value;for(let e of r.generations){if(null==e.message.id){let t=i?.at(0)?.runId;null!=t&&e.message._updateId(`run-${t}`)}e.message.response_metadata={...e.generationInfo,...e.message.response_metadata}}return 1===r.generations.length&&(r.generations[0].message.response_metadata={...r.llmOutput,...r.generations[0].message.response_metadata}),s[t]=r.generations,o[t]=r.llmOutput,i?.[t]?.handleLLMEnd({generations:[r.generations],llmOutput:r.llmOutput})}}))}let l={generations:s,llmOutput:o.length?this._combineLLMOutput?.(...o):void 0};return Object.defineProperty(l,s1,{value:i?{runIds:i?.map(e=>e.runId)}:void 0,configurable:!0}),l}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:i}){let n=e.map(e=>e.map(iA)),s={...i.metadata,...this.getLsParams(a)},o=await sj.configure(i.callbacks,this.callbacks,i.tags,this.tags,s,this.metadata,{verbose:this.verbose}),l={options:a,invocation_params:this?.invocationParams(a),batch_size:1},u=await o?.handleChatModelStart(this.toJSON(),n.map(l1),i.runId,void 0,l,void 0,void 0,i.runName),c=[],d=(await Promise.allSettled(n.map(async(e,a)=>{let i=l2._convertInputToPromptValue(e).toString(),n=await t.lookup(i,r);return null==n&&c.push(a),n}))).map((e,t)=>({result:e,runManager:u?.[t]})).filter(({result:e})=>"fulfilled"===e.status&&null!=e.value||"rejected"===e.status),h=[];await Promise.all(d.map(async({result:e,runManager:t},r)=>{if("fulfilled"!==e.status)return await t?.handleLLMError(e.reason,void 0,void 0,void 0,{cached:!0}),Promise.reject(e.reason);{let a=e.value;return h[r]=a.map(e=>("message"in e&&iu(e.message)&&ip(e.message)&&(e.message.usage_metadata={input_tokens:0,output_tokens:0,total_tokens:0}),e.generationInfo={...e.generationInfo,tokenUsage:{}},e)),a.length&&await t?.handleLLMNewToken(a[0].text),t?.handleLLMEnd({generations:[a]},void 0,void 0,void 0,{cached:!0})}}));let p={generations:h,missingPromptIndices:c,startedRunManagers:u};return Object.defineProperty(p,s1,{value:u?{runIds:u?.map(e=>e.runId)}:void 0,configurable:!0}),p}async generate(e,t,r){let a;a=Array.isArray(t)?{stop:t}:t;let i=e.map(e=>e.map(iA)),[n,s]=this._separateRunnableConfigFromCallOptionsCompat(a);if(n.callbacks=n.callbacks??r,!this.cache)return this._generateUncached(i,s,n);let{cache:o}=this,l=this._getSerializedCacheKeyParametersForCall(s),{generations:u,missingPromptIndices:c,startedRunManagers:d}=await this._generateCached({messages:i,cache:o,llmStringKey:l,parsedOptions:s,handledOptions:n}),h={};if(c.length>0){let e=await this._generateUncached(c.map(e=>i[e]),s,n,void 0!==d?c.map(e=>d?.[e]):void 0);await Promise.all(e.generations.map(async(e,t)=>{let r=c[t];u[r]=e;let a=l2._convertInputToPromptValue(i[r]).toString();return o.update(a,l,e)})),h=e.llmOutput??{}}return{generations:u,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let a=e.map(e=>e.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(iA)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new iw(e),i=await this.call([a],t,r);if("string"!=typeof i.content)throw Error("Cannot use predict when output is not a string.");return i.content}withStructuredOutput(e,t){let r;if("function"!=typeof this.bindTools)throw Error('Chat model must implement ".bindTools()" to use withStructuredOutput.');if(t?.strict)throw Error('"strict" mode is not supported for this model by default.');let a=t?.name,i=o7(e)??"A function available to call.",n=t?.method,s=t?.includeRaw;if("jsonMode"===n)throw Error('Base withStructuredOutput implementation only supports "functionCalling" as a method.');let o=a??"extract";o3(e)?r=[{type:"function",function:{name:o,description:i,parameters:lr(e)}}]:("name"in e&&(o=e.name),r=[{type:"function",function:{name:o,description:i,parameters:e}}]);let l=this.bindTools(r),u=lb.from(e=>{if(!e.tool_calls||0===e.tool_calls.length)throw Error("No tool calls found in the response.");let t=e.tool_calls.find(e=>e.name===o);if(!t)throw Error(`No tool call found with name ${o}.`);return t.args});if(!s)return l.pipe(u).withConfig({runName:"StructuredOutput"});let c=l0.assign({parsed:(e,t)=>u.invoke(e.raw,t)}),d=l0.assign({parsed:()=>null}),h=c.withFallbacks({fallbacks:[d]});return lm.from([{raw:l},h]).withConfig({runName:"StructuredOutputRunnable"})}}class l5 extends ld{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return"string"==typeof e.content?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return"string"==typeof e?this._callWithConfig(async(e,t)=>this.parseResult([{text:e}],t?.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(e,t)=>this.parseResult([{message:e,text:this._baseMessageToString(e)}],t?.callbacks),e,{...t,runType:"parser"})}}class l4 extends l5{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw Error("_type not implemented")}}class l9 extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(void 0===r||void 0===t))throw Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true");ik(this,"OUTPUT_PARSING_FAILURE")}}class l3 extends l4{async *_transform(e){for await(let t of e)"string"==typeof t?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async *transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class l6 extends l3{constructor(e){super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=e?.diff??this.diff}async *_transform(e){let t,r;for await(let a of e){let e;if("string"!=typeof a&&"string"!=typeof a.content)throw Error("Cannot handle non-string output.");if(iu(a)&&"function"==typeof a.concat){if("string"!=typeof a.content)throw Error("Cannot handle non-string message output.");e=new s5({message:a,text:a.content})}else if(iu(a)){if("string"!=typeof a.content)throw Error("Cannot handle non-string message output.");e=new s5({message:function(e){let t=e._getType();if("human"===t)return new iv({...e});if("ai"===t){let t={...e};return"tool_calls"in t&&(t={...t,tool_call_chunks:t.tool_calls?.map(e=>({...e,type:"tool_call_chunk",index:void 0,args:JSON.stringify(e.args)}))}),new ig({...t})}if("system"===t)return new iO({...e});if("function"===t)return new i_({...e});if(iy.isInstance(e))return new ib({...e});else throw Error("Unknown message type.")}(a),text:a.content})}else e=new s2({text:a});r=void 0===r?e:r.concat(e);let i=await this.parsePartialResult([r]);null==i||oU(i,t)||(this.diff?yield this._diff(t,i):yield i,t=i)}}getFormatInstructions(){return""}}class l8 extends l4{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){return new this(iP.Ik(Object.fromEntries(Object.entries(e).map(([e,t])=>[e,iP.Yj().describe(t)]))))}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(lr(this.schema))}
\`\`\`
`}async parse(e){try{let t=(e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim()).replace(/"([^"\\]*(\\.[^"\\]*)*)"/g,(e,t)=>{let r=t.replace(/\n/g,"\\n");return`"${r}"`}).replace(/\n/g,"");return await o8(this.schema,JSON.parse(t))}catch(t){throw new l9(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}}class l7 extends l6{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_concatOutputChunks(e,t){return this.diff?super._concatOutputChunks(e,t):t}_diff(e,t){if(t)return e?function(e,t,r=!1){var a=[];return!function e(t,r,a,i,n){if(r!==t){"function"==typeof r.toJSON&&(r=r.toJSON());for(var s=iH(r),o=iH(t),l=!1,u=o.length-1;u>=0;u--){var c=o[u],d=t[c];if(iq(r,c)&&(void 0!==r[c]||void 0===d||!1!==Array.isArray(r))){var h=r[c];"object"==typeof d&&null!=d&&"object"==typeof h&&null!=h&&Array.isArray(d)===Array.isArray(h)?e(d,h,a,i+"/"+iG(c),n):d!==h&&(n&&a.push({op:"test",path:i+"/"+iG(c),value:iW(d)}),a.push({op:"replace",path:i+"/"+iG(c),value:iW(h)}))}else Array.isArray(t)===Array.isArray(r)?(n&&a.push({op:"test",path:i+"/"+iG(c),value:iW(d)}),a.push({op:"remove",path:i+"/"+iG(c)}),l=!0):(n&&a.push({op:"test",path:i,value:t}),a.push({op:"replace",path:i,value:r}))}if(l||s.length!=o.length)for(var u=0;u<s.length;u++){var c=s[u];iq(t,c)||void 0===r[c]||a.push({op:"add",path:i+"/"+iG(c),value:iW(r[c])})}}}(e,t,a,"",r),a}(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return a2(e[0].text)}async parse(e){return a2(e,JSON.parse)}getFormatInstructions(){return""}}let ue=e=>{if(0===Object.keys(e).length)return{};let t={};return e.children.length>0?t[e.name]=e.children.map(ue):t[e.name]=e.text??void 0,t};function ut(e,t){let r;if(void 0===e.function)return;if(t?.partial)try{r=a5(e.function.arguments??"{}")}catch(e){return}else try{r=JSON.parse(e.function.arguments)}catch(t){throw new l9([`Function "${e.function.name}" arguments:`,"",e.function.arguments,"\nare not valid JSON.",`Error: ${t.message}`].join("\n"))}let a={name:e.function.name,args:r,type:"tool_call"};return t?.returnId&&(a.id=e.id),a}function ur(e){if(void 0===e.id)throw Error('All OpenAI tool calls must have an "id" field.');return{id:e.id,type:"function",function:{name:e.name,arguments:JSON.stringify(e.args)}}}function ua(e,t){return{name:e.function?.name,args:e.function?.arguments,id:e.id,error:t,type:"invalid_tool_call"}}class ui extends l6{static lc_name(){return"JsonOutputToolsParser"}constructor(e){super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=e?.returnId??this.returnId}_diff(){throw Error("Not supported.")}async parse(){throw Error("Not implemented.")}async parseResult(e){return await this.parsePartialResult(e,!1)}async parsePartialResult(e,t=!0){let r,a=e[0].message;if(ip(a)&&a.tool_calls?.length?r=a.tool_calls.map(e=>{let{id:t,...r}=e;return this.returnId?{id:t,...r}:r}):void 0!==a.additional_kwargs.tool_calls&&(r=JSON.parse(JSON.stringify(a.additional_kwargs.tool_calls)).map(e=>ut(e,{returnId:this.returnId,partial:t}))),!r)return[];let i=[];for(let e of r)if(void 0!==e){let t={type:e.name,args:e.args,id:e.id};i.push(t)}return i}}class un extends ui{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=e.returnSingle??this.returnSingle,this.zodSchema=e.zodSchema}async _validateResult(e){if(void 0===this.zodSchema)return e;let t=await o6(this.zodSchema,e);if(t.success)return t.data;throw new l9(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error?.issues)}`,JSON.stringify(e,null,2))}async parsePartialResult(e){let t=(await super.parsePartialResult(e)).filter(e=>e.type===this.keyName),r=t;if(t.length)return(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)?r[0]:r}async parseResult(e){let t=(await super.parsePartialResult(e,!1)).filter(e=>e.type===this.keyName),r=t;return t.length?(this.returnId||(r=t.map(e=>e.args)),this.returnSingle)?this._validateResult(r[0]):await Promise.all(r.map(e=>this._validateResult(e))):void 0}}let us=Symbol("Let zodToJsonSchema decide on which parser to use"),uo={name:void 0,$refStrategy:"root",effectStrategy:"input",pipeStrategy:"all",dateStrategy:"format:date-time",mapStrategy:"entries",nullableStrategy:"from-target",removeAdditionalStrategy:"passthrough",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",applyRegexFlags:!1,emailStrategy:"format:email",base64Strategy:"contentEncoding:base64",nameStrategy:"ref"},ul=e=>"_def"in e?e._def:e;function uu(e,t,r,a){a?.errorMessages&&r&&(e.errorMessage={...e.errorMessage,[t]:r})}function uc(e,t,r,a,i){e[t]=r,uu(e,t,a,i)}let ud=/^[cC][^\s-]{8,}$/,uh=/^[0-9a-z]+$/,up=/^[0-9A-HJKMNP-TV-Z]{26}$/,uf=/^(?!\.)(?!.*\.\.)([a-zA-Z0-9_'+\-\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\-]*\.)+[a-zA-Z]{2,}$/,um=()=>(void 0===f&&(f=RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),f),ug=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,uy=/^[a-zA-Z0-9_-]{21}$/;function ub(e,t){let r={type:"string"};function a(e){return"escape"===t.patternStrategy?u_(e):e}if(e.checks)for(let i of e.checks)switch(i.kind){case"min":uc(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,i.value):i.value,i.message,t);break;case"max":uc(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,i.value):i.value,i.message,t);break;case"email":switch(t.emailStrategy){case"format:email":uw(r,"email",i.message,t);break;case"format:idn-email":uw(r,"idn-email",i.message,t);break;case"pattern:zod":uv(r,uf,i.message,t)}break;case"url":uw(r,"uri",i.message,t);break;case"uuid":uw(r,"uuid",i.message,t);break;case"regex":uv(r,i.regex,i.message,t);break;case"cuid":uv(r,ud,i.message,t);break;case"cuid2":uv(r,uh,i.message,t);break;case"startsWith":uv(r,RegExp(`^${a(i.value)}`),i.message,t);break;case"endsWith":uv(r,RegExp(`${a(i.value)}$`),i.message,t);break;case"datetime":uw(r,"date-time",i.message,t);break;case"date":uw(r,"date",i.message,t);break;case"time":uw(r,"time",i.message,t);break;case"duration":uw(r,"duration",i.message,t);break;case"length":uc(r,"minLength","number"==typeof r.minLength?Math.max(r.minLength,i.value):i.value,i.message,t),uc(r,"maxLength","number"==typeof r.maxLength?Math.min(r.maxLength,i.value):i.value,i.message,t);break;case"includes":uv(r,RegExp(a(i.value)),i.message,t);break;case"ip":"v6"!==i.version&&uw(r,"ipv4",i.message,t),"v4"!==i.version&&uw(r,"ipv6",i.message,t);break;case"emoji":uv(r,um,i.message,t);break;case"ulid":uv(r,up,i.message,t);break;case"base64":switch(t.base64Strategy){case"format:binary":uw(r,"binary",i.message,t);break;case"contentEncoding:base64":uc(r,"contentEncoding","base64",i.message,t);break;case"pattern:zod":uv(r,ug,i.message,t)}break;case"nanoid":uv(r,uy,i.message,t)}return r}let u_=e=>Array.from(e).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),uw=(e,t,r,a)=>{e.format||e.anyOf?.some(e=>e.format)?(e.anyOf||(e.anyOf=[]),e.format&&(e.anyOf.push({format:e.format,...e.errorMessage&&a.errorMessages&&{errorMessage:{format:e.errorMessage.format}}}),delete e.format,e.errorMessage&&(delete e.errorMessage.format,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.anyOf.push({format:t,...r&&a.errorMessages&&{errorMessage:{format:r}}})):uc(e,"format",t,r,a)},uv=(e,t,r,a)=>{e.pattern||e.allOf?.some(e=>e.pattern)?(e.allOf||(e.allOf=[]),e.pattern&&(e.allOf.push({pattern:e.pattern,...e.errorMessage&&a.errorMessages&&{errorMessage:{pattern:e.errorMessage.pattern}}}),delete e.pattern,e.errorMessage&&(delete e.errorMessage.pattern,0===Object.keys(e.errorMessage).length&&delete e.errorMessage)),e.allOf.push({pattern:uE(t,a),...r&&a.errorMessages&&{errorMessage:{pattern:r}}})):uc(e,"pattern",uE(t,a),r,a)},uE=(e,t)=>{let r="function"==typeof e?e():e;if(!t.applyRegexFlags||!r.flags)return r.source;let a={i:r.flags.includes("i"),m:r.flags.includes("m"),s:r.flags.includes("s")},i=a.i?r.source.toLowerCase():r.source,n="",s=!1,o=!1,l=!1;for(let e=0;e<i.length;e++){if(s){n+=i[e],s=!1;continue}if(a.i){if(o){if(i[e].match(/[a-z]/)){l?(n+=i[e],n+=`${i[e-2]}-${i[e]}`.toUpperCase(),l=!1):"-"===i[e+1]&&i[e+2]?.match(/[a-z]/)?(n+=i[e],l=!0):n+=`${i[e]}${i[e].toUpperCase()}`;continue}}else if(i[e].match(/[a-z]/)){n+=`[${i[e]}${i[e].toUpperCase()}]`;continue}}if(a.m){if("^"===i[e]){n+=`(^|(?<=[\r
]))`;continue}else if("$"===i[e]){n+=`($|(?=[\r
]))`;continue}}if(a.s&&"."===i[e]){n+=o?`${i[e]}\r
`:`[${i[e]}\r
]`;continue}n+=i[e],"\\"===i[e]?s=!0:o&&"]"===i[e]?o=!1:o||"["!==i[e]||(o=!0)}try{new RegExp(n)}catch{return console.warn(`Could not convert regex pattern at ${t.currentPath.join("/")} to a flag-independent form! Falling back to the flag-ignorant source`),r.source}return n};function uO(e,t){if("openApi3"===t.target&&e.keyType?._def.typeName===iP.kY.ZodEnum)return{type:"object",required:e.keyType._def.values,properties:e.keyType._def.values.reduce((r,a)=>({...r,[a]:ux(e.valueType._def,{...t,currentPath:[...t.currentPath,"properties",a]})??{}}),{}),additionalProperties:!1};let r={type:"object",additionalProperties:ux(e.valueType._def,{...t,currentPath:[...t.currentPath,"additionalProperties"]})??{}};if("openApi3"===t.target)return r;if(e.keyType?._def.typeName===iP.kY.ZodString&&e.keyType._def.checks?.length){let a=Object.entries(ub(e.keyType._def,t)).reduce((e,[t,r])=>"type"===t?e:{...e,[t]:r},{});return{...r,propertyNames:a}}return e.keyType?._def.typeName===iP.kY.ZodEnum?{...r,propertyNames:{enum:e.keyType._def.values}}:r}let uk={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"},uS=(e,t)=>{let r=(e.options instanceof Map?Array.from(e.options.values()):e.options).map((e,r)=>ux(e._def,{...t,currentPath:[...t.currentPath,"anyOf",`${r}`]})).filter(e=>!!e&&(!t.strictUnions||"object"==typeof e&&Object.keys(e).length>0));return r.length?{anyOf:r}:void 0};function ux(e,t,r=!1){let a=t.seen.get(e);if(t.override){let i=t.override?.(e,t,a,r);if(i!==us)return i}if(a&&!r){let e=u$(a,t);if(void 0!==e)return"$ref"in e&&t.seenRefs.add(e.$ref),e}let i={def:e,path:t.currentPath,jsonSchema:void 0};t.seen.set(e,i);let n=uA(e,e.typeName,t,r);return n&&uT(e,t,n),i.jsonSchema=n,n}let u$=(e,t)=>{switch(t.$refStrategy){case"root":return{$ref:e.path.join("/")};case"extract-to-root":let r=e.path.slice(t.basePath.length+1).join("_");return r!==t.name&&"duplicate-ref"===t.nameStrategy&&(t.definitions[r]=e.def),{$ref:[...t.basePath,t.definitionPath,r].join("/")};case"relative":return{$ref:uI(t.currentPath,e.path)};case"none":case"seen":if(e.path.length<t.currentPath.length&&e.path.every((e,r)=>t.currentPath[r]===e))return console.warn(`Recursive reference detected at ${t.currentPath.join("/")}! Defaulting to any`),{};return"seen"===t.$refStrategy?{}:void 0}},uI=(e,t)=>{let r=0;for(;r<e.length&&r<t.length&&e[r]===t[r];r++);return[(e.length-r).toString(),...t.slice(r)].join("/")},uA=(e,t,r,a)=>{switch(t){case iP.kY.ZodString:return ub(e,r);case iP.kY.ZodNumber:let i={type:"number"};if(!e.checks)return i;for(let t of e.checks)switch(t.kind){case"int":i.type="integer",uu(i,"type",t.message,r);break;case"min":"jsonSchema7"===r.target?t.inclusive?uc(i,"minimum",t.value,t.message,r):uc(i,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(i.exclusiveMinimum=!0),uc(i,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?uc(i,"maximum",t.value,t.message,r):uc(i,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(i.exclusiveMaximum=!0),uc(i,"maximum",t.value,t.message,r));break;case"multipleOf":uc(i,"multipleOf",t.value,t.message,r)}return i;case iP.kY.ZodObject:let n={type:"object",...Object.entries(e.shape()).reduce((e,[t,a])=>{if(void 0===a||void 0===a._def)return e;let i=[...r.currentPath,"properties",t],n=ux(a._def,{...r,currentPath:i,propertyPath:i});if(void 0===n)return e;if(r.openaiStrictMode&&a.isOptional()&&!a.isNullable()&&void 0===a._def?.defaultValue)throw Error(`Zod field at \`${i.join("/")}\` uses \`.optional()\` without \`.nullable()\` which is not supported by the API. See: https://platform.openai.com/docs/guides/structured-outputs?api-mode=responses#all-fields-must-be-required`);return{properties:{...e.properties,[t]:n},required:a.isOptional()&&!r.openaiStrictMode?e.required:[...e.required,t]}},{properties:{},required:[]}),additionalProperties:"strict"===r.removeAdditionalStrategy?"ZodNever"===e.catchall._def.typeName?"strict"!==e.unknownKeys:ux(e.catchall._def,{...r,currentPath:[...r.currentPath,"additionalProperties"]})??!0:"ZodNever"===e.catchall._def.typeName?"passthrough"===e.unknownKeys:ux(e.catchall._def,{...r,currentPath:[...r.currentPath,"additionalProperties"]})??!0};return n.required.length||delete n.required,n;case iP.kY.ZodBigInt:let s={type:"integer",format:"int64"};if(!e.checks)return s;for(let t of e.checks)switch(t.kind){case"min":"jsonSchema7"===r.target?t.inclusive?uc(s,"minimum",t.value,t.message,r):uc(s,"exclusiveMinimum",t.value,t.message,r):(t.inclusive||(s.exclusiveMinimum=!0),uc(s,"minimum",t.value,t.message,r));break;case"max":"jsonSchema7"===r.target?t.inclusive?uc(s,"maximum",t.value,t.message,r):uc(s,"exclusiveMaximum",t.value,t.message,r):(t.inclusive||(s.exclusiveMaximum=!0),uc(s,"maximum",t.value,t.message,r));break;case"multipleOf":uc(s,"multipleOf",t.value,t.message,r)}return s;case iP.kY.ZodBoolean:return{type:"boolean"};case iP.kY.ZodDate:return function e(t,r,a){let i=a??r.dateStrategy;if(Array.isArray(i))return{anyOf:i.map((a,i)=>e(t,r,a))};switch(i){case"string":case"format:date-time":return{type:"string",format:"date-time"};case"format:date":return{type:"string",format:"date"};case"integer":var n=t,s=r;let o={type:"integer",format:"unix-time"};if("openApi3"===s.target)return o;for(let e of n.checks)switch(e.kind){case"min":uc(o,"minimum",e.value,e.message,s);break;case"max":uc(o,"maximum",e.value,e.message,s)}return o}}(e,r);case iP.kY.ZodUndefined:return{not:{}};case iP.kY.ZodNull:return"openApi3"===r.target?{enum:["null"],nullable:!0}:{type:"null"};case iP.kY.ZodArray:let o={type:"array"};return e.type?._def?.typeName!==iP.kY.ZodAny&&(o.items=ux(e.type._def,{...r,currentPath:[...r.currentPath,"items"]})),e.minLength&&uc(o,"minItems",e.minLength.value,e.minLength.message,r),e.maxLength&&uc(o,"maxItems",e.maxLength.value,e.maxLength.message,r),e.exactLength&&(uc(o,"minItems",e.exactLength.value,e.exactLength.message,r),uc(o,"maxItems",e.exactLength.value,e.exactLength.message,r)),o;case iP.kY.ZodUnion:case iP.kY.ZodDiscriminatedUnion:if("openApi3"===r.target)return uS(e,r);let l=e.options instanceof Map?Array.from(e.options.values()):e.options;if(l.every(e=>e._def.typeName in uk&&(!e._def.checks||!e._def.checks.length))){let e=l.reduce((e,t)=>{let r=uk[t._def.typeName];return r&&!e.includes(r)?[...e,r]:e},[]);return{type:e.length>1?e:e[0]}}if(l.every(e=>"ZodLiteral"===e._def.typeName&&!e.description)){let e=l.reduce((e,t)=>{let r=typeof t._def.value;switch(r){case"string":case"number":case"boolean":return[...e,r];case"bigint":return[...e,"integer"];case"object":if(null===t._def.value)return[...e,"null"];default:return e}},[]);if(e.length===l.length){let t=e.filter((e,t,r)=>r.indexOf(e)===t);return{type:t.length>1?t:t[0],enum:l.reduce((e,t)=>e.includes(t._def.value)?e:[...e,t._def.value],[])}}}else if(l.every(e=>"ZodEnum"===e._def.typeName))return{type:"string",enum:l.reduce((e,t)=>[...e,...t._def.values.filter(t=>!e.includes(t))],[])};return uS(e,r);case iP.kY.ZodIntersection:let u=[ux(e.left._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),ux(e.right._def,{...r,currentPath:[...r.currentPath,"allOf","1"]})].filter(e=>!!e),c="jsonSchema2019-09"===r.target?{unevaluatedProperties:!1}:void 0,d=[];return u.forEach(e=>{if((!("type"in e)||"string"!==e.type)&&"allOf"in e)d.push(...e.allOf),void 0===e.unevaluatedProperties&&(c=void 0);else{let t=e;if("additionalProperties"in e&&!1===e.additionalProperties){let{additionalProperties:r,...a}=e;t=a}else c=void 0;d.push(t)}}),d.length?{allOf:d,...c}:void 0;case iP.kY.ZodTuple:return e.rest?{type:"array",minItems:e.items.length,items:e.items.map((e,t)=>ux(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[]),additionalItems:ux(e.rest._def,{...r,currentPath:[...r.currentPath,"additionalItems"]})}:{type:"array",minItems:e.items.length,maxItems:e.items.length,items:e.items.map((e,t)=>ux(e._def,{...r,currentPath:[...r.currentPath,"items",`${t}`]})).reduce((e,t)=>void 0===t?e:[...e,t],[])};case iP.kY.ZodRecord:return uO(e,r);case iP.kY.ZodLiteral:let h=typeof e.value;return"bigint"!==h&&"number"!==h&&"boolean"!==h&&"string"!==h?{type:Array.isArray(e.value)?"array":"object"}:"openApi3"===r.target?{type:"bigint"===h?"integer":h,enum:[e.value]}:{type:"bigint"===h?"integer":h,const:e.value};case iP.kY.ZodEnum:return{type:"string",enum:[...e.values]};case iP.kY.ZodNativeEnum:let p=e.values,f=Object.keys(e.values).filter(e=>"number"!=typeof p[p[e]]).map(e=>p[e]),m=Array.from(new Set(f.map(e=>typeof e)));return{type:1===m.length?"string"===m[0]?"string":"number":["string","number"],enum:f};case iP.kY.ZodNullable:if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(e.innerType._def.typeName)&&(!e.innerType._def.checks||!e.innerType._def.checks.length))return"openApi3"===r.target||"property"===r.nullableStrategy?{type:uk[e.innerType._def.typeName],nullable:!0}:{type:[uk[e.innerType._def.typeName],"null"]};if("openApi3"===r.target){let t=ux(e.innerType._def,{...r,currentPath:[...r.currentPath]});return t&&"$ref"in t?{allOf:[t],nullable:!0}:t&&{...t,nullable:!0}}let g=ux(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","0"]});return g&&{anyOf:[g,{type:"null"}]};case iP.kY.ZodOptional:if(r.propertyPath&&r.currentPath.slice(0,r.propertyPath.length).toString()===r.propertyPath.toString())return ux(e.innerType._def,{...r,currentPath:r.currentPath});let y=ux(e.innerType._def,{...r,currentPath:[...r.currentPath,"anyOf","1"]});return y?{anyOf:[{not:{}},y]}:{};case iP.kY.ZodMap:if("record"===r.mapStrategy)return uO(e,r);return{type:"array",maxItems:125,items:{type:"array",items:[ux(e.keyType._def,{...r,currentPath:[...r.currentPath,"items","items","0"]})||{},ux(e.valueType._def,{...r,currentPath:[...r.currentPath,"items","items","1"]})||{}],minItems:2,maxItems:2}};case iP.kY.ZodSet:let b={type:"array",uniqueItems:!0,items:ux(e.valueType._def,{...r,currentPath:[...r.currentPath,"items"]})};return e.minSize&&uc(b,"minItems",e.minSize.value,e.minSize.message,r),e.maxSize&&uc(b,"maxItems",e.maxSize.value,e.maxSize.message,r),b;case iP.kY.ZodLazy:return ux(e.getter()._def,r);case iP.kY.ZodPromise:return ux(e.type._def,r);case iP.kY.ZodNaN:case iP.kY.ZodNever:return{not:{}};case iP.kY.ZodEffects:return"input"===r.effectStrategy?ux(e.schema._def,r,a):{};case iP.kY.ZodAny:case iP.kY.ZodUnknown:return{};case iP.kY.ZodDefault:return{...ux(e.innerType._def,r),default:e.defaultValue()};case iP.kY.ZodBranded:return ux(e.type._def,r);case iP.kY.ZodReadonly:case iP.kY.ZodCatch:return ux(e.innerType._def,r);case iP.kY.ZodPipeline:if("input"===r.pipeStrategy)return ux(e.in._def,r);if("output"===r.pipeStrategy)return ux(e.out._def,r);let _=ux(e.in._def,{...r,currentPath:[...r.currentPath,"allOf","0"]}),w=ux(e.out._def,{...r,currentPath:[...r.currentPath,"allOf",_?"1":"0"]});return{allOf:[_,w].filter(e=>void 0!==e)};case iP.kY.ZodFunction:case iP.kY.ZodVoid:case iP.kY.ZodSymbol:default:return}},uT=(e,t,r)=>(e.description&&(r.description=e.description,t.markdownDescription&&(r.markdownDescription=e.description)),r);function uP(e){return!!e&&"object"==typeof e&&"name"in e&&"schema"in e&&(o3(e.schema)||null!=e.schema&&"object"==typeof e.schema&&"type"in e.schema&&"string"==typeof e.schema.type&&["null","boolean","object","array","number","string"].includes(e.schema.type))||void 0!==e&&ld.isRunnable(e)&&"lc_name"in e.constructor&&"function"==typeof e.constructor.lc_name&&"RunnableToolLike"===e.constructor.lc_name()||void 0!==e&&Array.isArray(e.lc_namespace)}function uj(e,t){return e.lc_error_code=t,e.message=`${e.message}

Troubleshooting URL: https://js.langchain.com/docs/troubleshooting/errors/${t}/
`,e}function uN(e){let t;return e.constructor.name===td.name?(t=Error(e.message)).name="TimeoutError":e.constructor.name===tu.name?(t=Error(e.message)).name="AbortError":t=400===e.status&&e.message.includes("tool_calls")?uj(e,"INVALID_TOOL_RESULTS"):401===e.status?uj(e,"MODEL_AUTHENTICATION"):429===e.status?uj(e,"MODEL_RATE_LIMIT"):404===e.status?uj(e,"MODEL_NOT_FOUND"):e,t}function uR(e){if(e){if("any"===e||"required"===e)return"required";if("auto"===e)return"auto";if("none"===e)return"none";else if("string"==typeof e)return{type:"function",function:{name:e}};else return e}}function uC(e,t){let r=[];for(let[a,i]of Object.entries(e.properties??{}))i.description&&t<2&&r.push(`// ${i.description}`),e.required?.includes(a)?r.push(`${a}: ${uL(i,t)},`):r.push(`${a}?: ${uL(i,t)},`);return r.map(e=>" ".repeat(t)+e).join("\n")}function uL(e,t){if(void 0!==e.anyOf&&Array.isArray(e.anyOf))return e.anyOf.map(e=>uL(e,t)).join(" | ");switch(e.type){case"string":if(e.enum)return e.enum.map(e=>`"${e}"`).join(" | ");return"string";case"number":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"integer":if(e.enum)return e.enum.map(e=>`${e}`).join(" | ");return"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",uC(e,t+2),"}"].join("\n");case"array":if(e.items)return`${uL(e.items,t)}[]`;return"any[]";default:return""}}function uM(e){let t=e._getType();switch(t){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":if(!iy.isInstance(e))throw Error("Invalid generic chat message");return"system"!==e.role&&"developer"!==e.role&&"assistant"!==e.role&&"user"!==e.role&&"function"!==e.role&&"tool"!==e.role&&console.warn(`Unknown message role: ${e.role}`),e.role;default:throw Error(`Unknown message type: ${t}`)}}let uU={providerName:"ChatOpenAI",fromStandardTextBlock:e=>({type:"text",text:e.text}),fromStandardImageBlock(e){if("url"===e.source_type)return{type:"image_url",image_url:{url:e.url,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};if("base64"===e.source_type)return{type:"image_url",image_url:{url:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.detail?{detail:e.metadata.detail}:{}}};throw Error(`Image content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardAudioBlock(e){if("url"===e.source_type){let t,r=it({dataUrl:e.url});if(!r)throw Error(`URL audio blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);let a=r.mime_type||e.mime_type||"";try{t=ie(a)}catch{throw Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if("audio"!==t.type||"wav"!==t.subtype&&"mp3"!==t.subtype)throw Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:t.subtype,data:r.data}}}if("base64"===e.source_type){let t;try{t=ie(e.mime_type??"")}catch{throw Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`)}if("audio"!==t.type||"wav"!==t.subtype&&"mp3"!==t.subtype)throw Error(`Audio blocks with source_type ${e.source_type} must have mime type of audio/wav or audio/mp3`);return{type:"input_audio",input_audio:{format:t.subtype,data:e.data}}}throw Error(`Audio content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)},fromStandardFileBlock(e){if("url"===e.source_type){if(!it({dataUrl:e.url}))throw Error(`URL file blocks with source_type ${e.source_type} must be formatted as a data URL for ChatOpenAI`);return{type:"file",file:{file_data:e.url,...e.metadata?.filename||e.metadata?.name?{filename:e.metadata?.filename||e.metadata?.name}:{}}}}if("base64"===e.source_type)return{type:"file",file:{file_data:`data:${e.mime_type??""};base64,${e.data}`,...e.metadata?.filename||e.metadata?.name||e.metadata?.title?{filename:e.metadata?.filename||e.metadata?.name||e.metadata?.title}:{}}};if("id"===e.source_type)return{type:"file",file:{file_id:e.id}};throw Error(`File content blocks with source_type ${e.source_type} are not supported for ChatOpenAI`)}};function uD(e,t){return e.flatMap(e=>{let r=uM(e);"system"===r&&uW(t)&&(r="developer");let a={role:r,content:"string"==typeof e.content?e.content:e.content.map(e=>a7(e)?ir(e,uU):e)};return(null!=e.name&&(a.name=e.name),null!=e.additional_kwargs.function_call&&(a.function_call=e.additional_kwargs.function_call,a.content=""),ip(e)&&e.tool_calls?.length?(a.tool_calls=e.tool_calls.map(ur),a.content=""):(null!=e.additional_kwargs.tool_calls&&(a.tool_calls=e.additional_kwargs.tool_calls),null!=e.tool_call_id&&(a.tool_call_id=e.tool_call_id)),e.additional_kwargs.audio&&"object"==typeof e.additional_kwargs.audio&&"id"in e.additional_kwargs.audio)?[a,{role:"assistant",audio:{id:e.additional_kwargs.audio.id}}]:a})}let uz="__openai_function_call_ids__";function uF(e,t,r){return e.flatMap(e=>{let a=e.additional_kwargs,i=uM(e);if("system"===i&&uW(t)&&(i="developer"),"function"===i)throw Error("Function messages are not supported in Responses API");if("tool"===i)return a?.type==="computer_call_output"?{type:"computer_call_output",output:(()=>{if("string"==typeof e.content)return{type:"computer_screenshot",image_url:e.content};if(Array.isArray(e.content)){let t=e.content.find(e=>"computer_screenshot"===e.type);if(t)return t;let r=e.content.find(e=>"image_url"===e.type);if(r)return{type:"computer_screenshot",image_url:"string"==typeof r.image_url?r.image_url:r.image_url.url}}throw Error("Invalid computer call output")})(),call_id:e.tool_call_id}:{type:"function_call_output",call_id:e.tool_call_id,id:e.id?.startsWith("fc_")?e.id:void 0,output:"string"!=typeof e.content?JSON.stringify(e.content):e.content};if("assistant"===i){if(!r&&null!=e.response_metadata.output&&Array.isArray(e.response_metadata.output)&&e.response_metadata.output.length>0&&e.response_metadata.output.every(e=>"type"in e))return e.response_metadata.output;let t=[];if(a?.reasoning&&!r){let e=function(e){let t=(e.summary.length>1?e.summary.reduce((e,t)=>{let r=e.at(-1);return r.index===t.index?r.text+=t.text:e.push(t),e},[{...e.summary[0]}]):e.summary).map(e=>Object.fromEntries(Object.entries(e).filter(([e])=>"index"!==e)));return{...e,summary:t}}(a.reasoning);t.push(e)}let{content:i}=e;a?.refusal&&("string"==typeof i&&(i=[{type:"output_text",text:i,annotations:[]}]),i=[...i,{type:"refusal",refusal:a.refusal}]),t.push({type:"message",role:"assistant",...e.id&&!r&&e.id.startsWith("msg_")?{id:e.id}:{},content:"string"==typeof i?i:i.flatMap(e=>"text"===e.type?{type:"output_text",text:e.text,annotations:e.annotations??[]}:"output_text"===e.type||"refusal"===e.type?e:[])});let n=a?.[uz];ip(e)&&e.tool_calls?.length?t.push(...e.tool_calls.map(e=>({type:"function_call",name:e.name,arguments:JSON.stringify(e.args),call_id:e.id,...r?{id:n?.[e.id]}:{}}))):a?.tool_calls&&t.push(...a.tool_calls.map(e=>({type:"function_call",name:e.function.name,call_id:e.id,arguments:e.function.arguments,...r?{id:n?.[e.id]}:{}})));let s=e.response_metadata.output?.length?e.response_metadata.output:a.tool_outputs,o=["computer_call","mcp_call","code_interpreter_call","image_generation_call"];if(null!=s){let e=s?.filter(e=>o.includes(e.type));e.length>0&&t.push(...e)}return t}if("user"===i||"system"===i||"developer"===i){if("string"==typeof e.content)return{type:"message",role:i,content:e.content};let t=[],r=e.content.flatMap(e=>("mcp_approval_response"===e.type&&t.push({type:"mcp_approval_response",approval_request_id:e.approval_request_id,approve:e.approve}),a7(e))?ir(e,uU):"text"===e.type?{type:"input_text",text:e.text}:"image_url"===e.type?{type:"input_image",image_url:"string"==typeof e.image_url?e.image_url:e.image_url.url,detail:"string"==typeof e.image_url?"auto":e.image_url.detail}:"input_text"===e.type||"input_image"===e.type||"input_file"===e.type?e:[]);return r.length>0&&t.push({type:"message",role:i,content:r}),t}return console.warn(`Unsupported role found when converting to OpenAI Responses API: ${i}`),[]})}function uB(e){let t;if(e.error){let t=Error(e.error.message);throw t.name=e.error.code,t}let r=[],a=[],i=[],n={model:e.model,created_at:e.created_at,id:e.id,incomplete_details:e.incomplete_details,metadata:e.metadata,object:e.object,status:e.status,user:e.user,service_tier:e.service_tier,model_name:e.model},s={};for(let n of e.output)if("message"===n.type)t=n.id,r.push(...n.content.flatMap(e=>"output_text"===e.type?("parsed"in e&&null!=e.parsed&&(s.parsed=e.parsed),{type:"text",text:e.text,annotations:e.annotations}):"refusal"===e.type?(s.refusal=e.refusal,[]):e));else if("function_call"===n.type){let e={function:{name:n.name,arguments:n.arguments},id:n.call_id};try{a.push(ut(e,{returnId:!0}))}catch(r){let t;"object"==typeof r&&null!=r&&"message"in r&&"string"==typeof r.message&&(t=r.message),i.push(ua(e,t))}s[uz]??={},n.id&&(s[uz][n.call_id]=n.id)}else"reasoning"===n.type?s.reasoning=n:(s.tool_outputs??=[],s.tool_outputs.push(n));return new ih({id:t,content:r,tool_calls:a,invalid_tool_calls:i,usage_metadata:e.usage,additional_kwargs:s,response_metadata:n})}function uq(e){return"type"in e&&"function"!==e.type}function uH(e,t){var r,a,i,n;let s,o;if(lK(e))return t?.strict!==void 0?{...e,function:{...e.function,strict:t.strict}}:e;return s=uP(e)?(o=uP(r=e)?{type:"function",function:{name:(i=r).name,description:i.description,parameters:lr(i.schema),...{}}}:r,o):e,t?.strict!==void 0&&(s.function.strict=t.strict),s}function uW(e){return e&&/^o\d/.test(e)}class uJ extends l2{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed","reasoning_effort","service_tier"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",apiKey:"OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",apiKey:"openai_api_key"}}get lc_serializable_keys(){return["configuration","logprobs","topLogprobs","prefixMessages","supportsStrictToolCalling","modalities","audio","reasoningEffort","temperature","maxTokens","topP","frequencyPenalty","presencePenalty","n","logitBias","user","streaming","streamUsage","modelName","model","modelKwargs","stop","stopSequences","timeout","openAIApiKey","apiKey","cache","maxConcurrency","maxRetries","verbose","callbacks","tags","metadata","disableStreaming","useResponsesApi","zdrEnabled","reasoning"]}constructor(e){super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"streamUsage",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"__includeRawResponse",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"supportsStrictToolCalling",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"audio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modalities",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoningEffort",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reasoning",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"useResponsesApi",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"zdrEnabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"service_tier",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=e?.apiKey??e?.openAIApiKey??e?.configuration?.apiKey??si("OPENAI_API_KEY"),this.apiKey=this.openAIApiKey,this.organization=e?.configuration?.organization??si("OPENAI_ORGANIZATION"),this.model=e?.model??e?.modelName??this.model,this.modelName=this.model,this.modelKwargs=e?.modelKwargs??{},this.timeout=e?.timeout,this.temperature=e?.temperature??this.temperature,this.topP=e?.topP??this.topP,this.frequencyPenalty=e?.frequencyPenalty??this.frequencyPenalty,this.presencePenalty=e?.presencePenalty??this.presencePenalty,this.logprobs=e?.logprobs,this.topLogprobs=e?.topLogprobs,this.n=e?.n??this.n,this.logitBias=e?.logitBias,this.stop=e?.stopSequences??e?.stop,this.stopSequences=this.stop,this.user=e?.user,this.__includeRawResponse=e?.__includeRawResponse,this.audio=e?.audio,this.modalities=e?.modalities,this.reasoningEffort=e?.reasoningEffort??e?.reasoning?.effort,this.reasoning=e?.reasoning??(e?.reasoningEffort?{effort:e.reasoningEffort}:void 0),this.maxTokens=e?.maxCompletionTokens??e?.maxTokens,this.useResponsesApi=e?.useResponsesApi??this.useResponsesApi,this.disableStreaming=e?.disableStreaming??this.disableStreaming,this.streaming=e?.streaming??!1,this.disableStreaming&&(this.streaming=!1),this.streamUsage=e?.streamUsage??this.streamUsage,this.disableStreaming&&(this.streamUsage=!1),this.clientConfig={apiKey:this.apiKey,organization:this.organization,dangerouslyAllowBrowser:!0,...e?.configuration},e?.supportsStrictToolCalling!==void 0&&(this.supportsStrictToolCalling=e.supportsStrictToolCalling),e?.service_tier!==void 0&&(this.service_tier=e.service_tier),this.zdrEnabled=e?.zdrEnabled??!1}getLsParams(e){let t=this.invocationParams(e);return{ls_provider:"openai",ls_model_name:this.model,ls_model_type:"chat",ls_temperature:t.temperature??void 0,ls_max_tokens:t.max_tokens??void 0,ls_stop:e.stop}}bindTools(e,t){let r;return t?.strict!==void 0?r=t.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling),this.withConfig({tools:e.map(e=>uq(e)?e:uH(e,{strict:r})),...t})}createResponseFormat(e){return e&&"json_schema"===e.type&&e.json_schema.schema&&o3(e.json_schema.schema)?function(e,t,r){if(o9(e))return function(e,t){let r={...e};return Object.defineProperties(r,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t,enumerable:!1}}),r}({type:"json_schema",json_schema:{...r,name:t,strict:!0,schema:((e,t)=>{let r=(e=>{let t="string"==typeof e?{...uo,basePath:["#"],definitions:{},name:e}:{...uo,basePath:["#"],definitions:{},...e},r=void 0!==t.name?[...t.basePath,t.definitionPath,t.name]:t.basePath;return{...t,currentPath:r,propertyPath:void 0,seenRefs:new Set,seen:new Map(Object.entries(t.definitions).map(([e,r])=>[ul(r),{def:ul(r),path:[...t.basePath,t.definitionPath,e],jsonSchema:void 0}]))}})(t),a="string"==typeof t?t:t?.nameStrategy==="title"?void 0:t?.name,i=ux(e._def,void 0===a?r:{...r,currentPath:[...r.basePath,r.definitionPath,a]},!1)??{},n="object"==typeof t&&void 0!==t.name&&"title"===t.nameStrategy?t.name:void 0;void 0!==n&&(i.title=n);let s=(()=>{if(function(e){if(!e)return!0;for(let t in e)return!1;return!0}(r.definitions))return;let e={},t=new Set;for(let a=0;a<500;a++){let a=Object.entries(r.definitions).filter(([e])=>!t.has(e));if(0===a.length)break;for(let[i,n]of a)e[i]=ux(ul(n),{...r,currentPath:[...r.basePath,r.definitionPath,i]},!0)??{},t.add(i)}return e})(),o=void 0===a?s?{...i,[r.definitionPath]:s}:i:"duplicate-ref"===r.nameStrategy?{...i,...s||r.seenRefs.size?{[r.definitionPath]:{...s,...r.seenRefs.size?{[a]:i}:void 0}}:void 0}:{$ref:[..."relative"===r.$refStrategy?[]:r.basePath,r.definitionPath,a].join("/"),[r.definitionPath]:{...s,[a]:i}};return"jsonSchema7"===r.target?o.$schema="http://json-schema.org/draft-07/schema#":"jsonSchema2019-09"===r.target&&(o.$schema="https://json-schema.org/draft/2019-09/schema#"),o})(e,{openaiStrictMode:!0,name:{name:t}.name,nameStrategy:"duplicate-ref",$refStrategy:"extract-to-root",nullableStrategy:"property"})}},t=>e.parse(JSON.parse(t)));if(o4(e))return function(e,t){let r={...e};return Object.defineProperties(r,{$brand:{value:"auto-parseable-response-format",enumerable:!1},$parseRaw:{value:t,enumerable:!1}}),r}({type:"json_schema",json_schema:{...r,name:t,strict:!0,schema:aH(e,{cycles:"ref",reused:"ref",override(e){e.jsonSchema.title=t}})}},t=>aX(e,JSON.parse(t)));throw Error("Unsupported schema response format")}(e.json_schema.schema,e.json_schema.name,{description:e.json_schema.description}):e}getReasoningParams(e){let t;if(uW(this.model))return void 0!==this.reasoningEffort&&(t={effort:this.reasoningEffort}),void 0!==this.reasoning&&(t={...t,...this.reasoning}),e?.reasoning_effort!==void 0&&(t={...t,effort:e.reasoning_effort}),e?.reasoning!==void 0&&(t={...t,...e.reasoning}),t}invocationParams(e,t){let r;if(e?.strict!==void 0?r=e.strict:void 0!==this.supportsStrictToolCalling&&(r=this.supportsStrictToolCalling),this._useResponseApi(e)){var a;let t={model:this.model,temperature:this.temperature,top_p:this.topP,user:this.user,stream:this.streaming,previous_response_id:e?.previous_response_id,truncation:e?.truncation,include:e?.include,tools:e?.tools?.length?function(e,t){let r=[];for(let a of e)uq(a)?("image_generation"===a.type&&t?.stream&&(a.partial_images=1),r.push(a)):lK(a)&&r.push({type:"function",name:a.function.name,parameters:a.function.parameters,description:a.function.description,strict:t?.strict??null});return r}(e.tools,{stream:this.streaming,strict:r}):void 0,tool_choice:null!=(a=e?.tool_choice)&&"object"==typeof a&&"type"in a&&"function"!==a.type?e?.tool_choice:(()=>{let t=uR(e?.tool_choice);return"object"==typeof t&&"type"in t?{type:"function",name:t.function.name}:void 0})(),text:(()=>{if(e?.text)return e.text;let t=this.createResponseFormat(e?.response_format);return t?.type==="json_schema"?null!=t.json_schema.schema?{format:{type:"json_schema",schema:t.json_schema.schema,description:t.json_schema.description,name:t.json_schema.name,strict:t.json_schema.strict}}:void 0:{format:t}})(),parallel_tool_calls:e?.parallel_tool_calls,max_output_tokens:-1===this.maxTokens?void 0:this.maxTokens,...this.zdrEnabled?{store:!1}:{},...this.modelKwargs},i=this.getReasoningParams(e);return void 0!==i&&(t.reasoning=i),t}let i={};e?.stream_options!==void 0?i={stream_options:e.stream_options}:this.streamUsage&&(this.streaming||t?.streaming)&&(i={stream_options:{include_usage:!0}});let n={model:this.model,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:e?.stop??this.stopSequences,user:this.user,stream:this.streaming,functions:e?.functions,function_call:e?.function_call,tools:e?.tools?.length?e.tools.map(e=>uH(e,{strict:r})):void 0,tool_choice:uR(e?.tool_choice),response_format:this.createResponseFormat(e?.response_format),seed:e?.seed,...i,parallel_tool_calls:e?.parallel_tool_calls,...this.audio||e?.audio?{audio:this.audio||e?.audio}:{},...this.modalities||e?.modalities?{modalities:this.modalities||e?.modalities}:{},...this.modelKwargs};e?.prediction!==void 0&&(n.prediction=e.prediction),void 0!==this.service_tier&&(n.service_tier=this.service_tier),e?.service_tier!==void 0&&(n.service_tier=e.service_tier);let s=this.getReasoningParams(e);return void 0!==s&&void 0!==s.effort&&(n.reasoning_effort=s.effort),uW(n.model)?n.max_completion_tokens=-1===this.maxTokens?void 0:this.maxTokens:n.max_tokens=-1===this.maxTokens?void 0:this.maxTokens,n}_convertOpenAIChatCompletionMessageToBaseMessage(e,t){let r=e.tool_calls;if("assistant"!==e.role)return new iy(e.content||"",e.role??"unknown");{let a=[],i=[];for(let e of r??[])try{a.push(ut(e,{returnId:!0}))}catch(t){i.push(ua(e,t.message))}let n={function_call:e.function_call,tool_calls:r};void 0!==this.__includeRawResponse&&(n.__raw_response=t);let s={model_name:t.model,...t.system_fingerprint?{usage:{...t.usage},system_fingerprint:t.system_fingerprint}:{}};return e.audio&&(n.audio=e.audio),new ih({content:e.content||"",tool_calls:a,invalid_tool_calls:i,additional_kwargs:n,response_metadata:s,id:t.id})}}_convertOpenAIDeltaToBaseMessageChunk(e,t,r){let a,i=e.role??r,n=e.content??"";a=e.function_call?{function_call:e.function_call}:e.tool_calls?{tool_calls:e.tool_calls}:{},this.__includeRawResponse&&(a.__raw_response=t),e.audio&&(a.audio={...e.audio,index:t.choices[0].index});let s={usage:{...t.usage}};if("user"===i)return new iv({content:n,response_metadata:s});if("assistant"===i){let r=[];if(Array.isArray(e.tool_calls))for(let t of e.tool_calls)r.push({name:t.function?.name,args:t.function?.arguments,id:t.id,index:t.index,type:"tool_call_chunk"});return new ig({content:n,tool_call_chunks:r,additional_kwargs:a,id:t.id,response_metadata:s})}if("system"===i)return new iO({content:n,response_metadata:s});if("developer"===i)return new iO({content:n,response_metadata:s,additional_kwargs:{__openai_role__:"developer"}});if("function"===i)return new i_({content:n,additional_kwargs:a,name:e.name,response_metadata:s});else if("tool"===i)return new id({content:n,additional_kwargs:a,tool_call_id:e.tool_call_id,response_metadata:s});else return new ib({content:n,role:i,response_metadata:s})}_identifyingParams(){return{model_name:this.model,...this.invocationParams(),...this.clientConfig}}async *_streamResponseChunks(e,t,r){let a,i;if(this._useResponseApi(t)){for await(let r of(await this.responseApiWithRetry({...this.invocationParams(t,{streaming:!0}),input:uF(e,this.model,this.zdrEnabled),stream:!0},t))){let e=function(e){let t,r,a=[],i={},n=[],s={},o={};if("response.output_text.delta"===e.type)a.push({type:"text",text:e.delta,index:e.content_index});else if("response.output_text_annotation.added"===e.type)a.push({type:"text",text:"",annotations:[e.annotation],index:e.content_index});else if("response.output_item.added"===e.type&&"message"===e.item.type)r=e.item.id;else if("response.output_item.added"===e.type&&"function_call"===e.item.type)n.push({type:"tool_call_chunk",name:e.item.name,args:e.item.arguments,id:e.item.call_id,index:e.output_index}),o[uz]={[e.item.call_id]:e.item.id};else if("response.output_item.done"===e.type&&["web_search_call","file_search_call","computer_call","code_interpreter_call","mcp_call","mcp_list_tools","mcp_approval_request","image_generation_call"].includes(e.item.type))o.tool_outputs=[e.item];else if("response.created"===e.type)s.id=e.response.id,s.model_name=e.response.model,s.model=e.response.model;else if("response.completed"===e.type){let r=uB(e.response);for(let[a,i]of(t=e.response.usage,e.response.text?.format?.type==="json_schema"&&(o.parsed??=JSON.parse(r.text)),Object.entries(e.response)))"id"!==a&&(s[a]=i)}else if("response.function_call_arguments.delta"===e.type)n.push({type:"tool_call_chunk",args:e.delta,index:e.output_index});else if("response.web_search_call.completed"===e.type||"response.file_search_call.completed"===e.type)i={tool_outputs:{id:e.item_id,type:e.type.replace("response.","").replace(".completed",""),status:"completed"}};else if("response.refusal.done"===e.type)o.refusal=e.refusal;else if("response.output_item.added"===e.type&&"item"in e&&"reasoning"===e.item.type){let t=e.item.summary?e.item.summary.map((e,t)=>({...e,index:t})):void 0;o.reasoning={id:e.item.id,type:e.item.type,...t?{summary:t}:{}}}else if("response.reasoning_summary_part.added"===e.type)o.reasoning={type:"reasoning",summary:[{...e.part,index:e.summary_index}]};else if("response.reasoning_summary_text.delta"===e.type)o.reasoning={type:"reasoning",summary:[{text:e.delta,type:"summary_text",index:e.summary_index}]};else if("response.image_generation_call.partial_image"===e.type)return null;else return null;return new s5({text:a.map(e=>e.text).join(""),message:new ig({id:r,content:a,tool_call_chunks:n,usage_metadata:t,additional_kwargs:o,response_metadata:s}),generationInfo:i})}(r);null!=e&&(yield e)}return}let n=uD(e,this.model),s={...this.invocationParams(t,{streaming:!0}),messages:n,stream:!0};for await(let e of(await this.completionWithRetry(s,t))){let n=e?.choices?.[0];if(e.usage&&(i=e.usage),!n)continue;let{delta:s}=n;if(!s)continue;let o=this._convertOpenAIDeltaToBaseMessageChunk(s,e,a);a=s.role??a;let l={prompt:t.promptIndex??0,completion:n.index??0};if("string"!=typeof o.content){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let u={...l};null!=n.finish_reason&&(u.finish_reason=n.finish_reason,u.system_fingerprint=e.system_fingerprint,u.model_name=e.model,u.service_tier=e.service_tier),this.logprobs&&(u.logprobs=n.logprobs);let c=new s5({message:o,text:o.content,generationInfo:u});yield c,await r?.handleLLMNewToken(c.text??"",l,void 0,void 0,void 0,{chunk:c})}if(i){let e={...i.prompt_tokens_details?.audio_tokens!==null&&{audio:i.prompt_tokens_details?.audio_tokens},...i.prompt_tokens_details?.cached_tokens!==null&&{cache_read:i.prompt_tokens_details?.cached_tokens}},t={...i.completion_tokens_details?.audio_tokens!==null&&{audio:i.completion_tokens_details?.audio_tokens},...i.completion_tokens_details?.reasoning_tokens!==null&&{reasoning:i.completion_tokens_details?.reasoning_tokens}},r=new s5({message:new ig({content:"",response_metadata:{usage:{...i}},usage_metadata:{input_tokens:i.prompt_tokens,output_tokens:i.completion_tokens,total_tokens:i.total_tokens,...Object.keys(e).length>0&&{input_token_details:e},...Object.keys(t).length>0&&{output_token_details:t}}}),text:""});yield r}if(t.signal?.aborted)throw Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _responseApiGenerate(e,t,r){let a=this.invocationParams(t);if(a.stream){let a;for await(let i of this._streamResponseChunks(e,t,r))i.message.response_metadata={...i.generationInfo,...i.message.response_metadata},a=a?.concat(i)??i;return{generations:a?[a]:[],llmOutput:{estimatedTokenUsage:a?.message?.usage_metadata}}}let i=uF(e,this.model,this.zdrEnabled),n=await this.responseApiWithRetry({input:i,...a},{signal:t?.signal,...t?.options});return{generations:[{text:n.output_text,message:uB(n)}],llmOutput:{id:n.id,estimatedTokenUsage:n.usage?{promptTokens:n.usage.input_tokens,completionTokens:n.usage.output_tokens,totalTokens:n.usage.total_tokens}:void 0}}}_useResponseApi(e){let t=e?.tools?.some(uq),r=e?.previous_response_id!=null||e?.text!=null||e?.truncation!=null||e?.include!=null||e?.reasoning?.summary!=null||this.reasoning?.summary!=null;return this.useResponsesApi||t||r}async _generate(e,t,r){if(this._useResponseApi(t))return this._responseApiGenerate(e,t,r);let a={},i=this.invocationParams(t),n=uD(e,this.model);if(i.stream){let i=this._streamResponseChunks(e,t,r),n={};for await(let e of i){e.message.response_metadata={...e.generationInfo,...e.message.response_metadata};let t=e.generationInfo?.completion??0;void 0===n[t]?n[t]=e:n[t]=n[t].concat(e)}let s=Object.entries(n).sort(([e],[t])=>parseInt(e,10)-parseInt(t,10)).map(([e,t])=>t),{functions:o,function_call:l}=this.invocationParams(t),u=await this.getEstimatedTokenCountFromPrompt(e,o,l),c=await this.getNumTokensFromGenerations(s);return a.input_tokens=u,a.output_tokens=c,a.total_tokens=u+c,{generations:s,llmOutput:{estimatedTokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}{let e;e=t.response_format&&"json_schema"===t.response_format.type?await this.betaParsedCompletionWithRetry({...i,stream:!1,messages:n},{signal:t?.signal,...t?.options}):await this.completionWithRetry({...i,stream:!1,messages:n},{signal:t?.signal,...t?.options});let{completion_tokens:r,prompt_tokens:s,total_tokens:o,prompt_tokens_details:l,completion_tokens_details:u}=e?.usage??{};r&&(a.output_tokens=(a.output_tokens??0)+r),s&&(a.input_tokens=(a.input_tokens??0)+s),o&&(a.total_tokens=(a.total_tokens??0)+o),(l?.audio_tokens!==null||l?.cached_tokens!==null)&&(a.input_token_details={...l?.audio_tokens!==null&&{audio:l?.audio_tokens},...l?.cached_tokens!==null&&{cache_read:l?.cached_tokens}}),(u?.audio_tokens!==null||u?.reasoning_tokens!==null)&&(a.output_token_details={...u?.audio_tokens!==null&&{audio:u?.audio_tokens},...u?.reasoning_tokens!==null&&{reasoning:u?.reasoning_tokens}});let c=[];for(let t of e?.choices??[]){let r={text:t.message?.content??"",message:this._convertOpenAIChatCompletionMessageToBaseMessage(t.message??{role:"assistant"},e)};r.generationInfo={...t.finish_reason?{finish_reason:t.finish_reason}:{},...t.logprobs?{logprobs:t.logprobs}:{}},ip(r.message)&&(r.message.usage_metadata=a),r.message=new ih(Object.fromEntries(Object.entries(r.message).filter(([e])=>!e.startsWith("lc_")))),c.push(r)}return{generations:c,llmOutput:{tokenUsage:{promptTokens:a.input_tokens,completionTokens:a.output_tokens,totalTokens:a.total_tokens}}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&"auto"!==r){let e=function(e){let t=["namespace functions {",""];for(let r of e)r.description&&t.push(`// ${r.description}`),Object.keys(r.parameters.properties??{}).length>0?(t.push(`type ${r.name} = (_: {`),t.push(uC(r.parameters,0)),t.push("}) => any;")):t.push(`type ${r.name} = () => any;`),t.push("");return t.push("} // namespace functions"),t.join("\n")}(t);a+=await this.getNumTokens(e),a+=9}return t&&e.find(e=>"system"===e._getType())&&(a-=4),"none"===r?a+=1:"object"==typeof r&&(a+=await this.getNumTokens(r.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async e=>e.message.additional_kwargs?.function_call?(await this.getNumTokensFromMessages([e.message])).countPerMessage[0]:await this.getNumTokens(e.message.content)))).reduce((e,t)=>e+t,0)}async getNumTokensFromMessages(e){let t=0,r=0,a=0;"gpt-3.5-turbo-0301"===this.model?(r=4,a=-1):(r=3,a=1);let i=await Promise.all(e.map(async e=>{let i=await this.getNumTokens(e.content),n=await this.getNumTokens(uM(e)),s=void 0!==e.name?a+await this.getNumTokens(e.name):0,o=i+r+n+s;if("function"===e._getType()&&(o-=2),e.additional_kwargs?.function_call&&(o+=3),e?.additional_kwargs.function_call?.name&&(o+=await this.getNumTokens(e.additional_kwargs.function_call?.name)),e.additional_kwargs.function_call?.arguments)try{o+=await this.getNumTokens(JSON.stringify(JSON.parse(e.additional_kwargs.function_call?.arguments)))}catch(t){console.error("Error parsing function arguments",t,JSON.stringify(e.additional_kwargs.function_call)),o+=await this.getNumTokens(e.additional_kwargs.function_call?.arguments)}return t+=o,o}));return{totalCount:t+=3,countPerMessage:i}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(e){throw uN(e)}})}async responseApiWithRetry(e,t){return this.caller.call(async()=>{let r=this._getClientOptions(t);try{if(e.text?.format?.type==="json_schema"&&!e.stream)return await this.client.responses.parse(e,r);return await this.client.responses.create(e,r)}catch(e){throw uN(e)}})}async betaParsedCompletionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.parse(e,r)}catch(e){throw uN(e)}})}_getClientOptions(e){if(!this.client){let e=function(e){let{azureOpenAIApiDeploymentName:t,azureOpenAIApiInstanceName:r,azureOpenAIApiKey:a,azureOpenAIBasePath:i,baseURL:n,azureADTokenProvider:s,azureOpenAIEndpoint:o}=e;if((a||s)&&i&&t)return`${i}/${t}`;if((a||s)&&o&&t)return`${o}/openai/deployments/${t}`;if(a||s){if(!r)throw Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!t)throw Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${r}.openai.azure.com/openai/deployments/${t}`}return n}({baseURL:this.clientConfig.baseURL}),t={...this.clientConfig,baseURL:e,timeout:this.timeout,maxRetries:0};t.baseURL||delete t.baseURL,this.client=new aR(t)}return{...this.clientConfig,...e}}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((e,t)=>(t&&t.tokenUsage&&(e.tokenUsage.completionTokens+=t.tokenUsage.completionTokens??0,e.tokenUsage.promptTokens+=t.tokenUsage.promptTokens??0,e.tokenUsage.totalTokens+=t.tokenUsage.totalTokens??0),e),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){var r;let a,i,n,s,o,l;if(void 0!==(r=e)&&"object"==typeof r.schema?(a=e.schema,i=e.name,n=e.method,s=e.includeRaw):(a=e,i=t?.name,n=t?.method,s=t?.includeRaw),t?.strict!==void 0&&"jsonMode"===n)throw Error("Argument `strict` is only supported for `method` = 'function_calling'");if(this.model.startsWith("gpt-3")||this.model.startsWith("gpt-4-")||"gpt-4"===this.model?"jsonSchema"===n&&console.warn(`[WARNING]: JSON Schema is not supported for model "${this.model}". Falling back to tool calling.`):void 0===n&&(n="jsonSchema"),"jsonMode"===n){let e;o3(a)?(l=l8.fromZodSchema(a),e=lr(a)):l=new l7,o=this.withConfig({response_format:{type:"json_object"},ls_structured_output_format:{kwargs:{method:"jsonMode"},schema:e}})}else if("jsonSchema"===n)if(o=this.withConfig({response_format:{type:"json_schema",json_schema:{name:i??"extract",description:o7(a),schema:a,strict:t?.strict}},ls_structured_output_format:{kwargs:{method:"jsonSchema"},schema:lr(a)}}),o3(a)){let e=l8.fromZodSchema(a);l=lb.from(t=>"parsed"in t.additional_kwargs?t.additional_kwargs.parsed:e)}else l=new l7;else{let e=i??"extract";if(o3(a)){let r=lr(a);o=this.withConfig({tools:[{type:"function",function:{name:e,description:r.description,parameters:r}}],tool_choice:{type:"function",function:{name:e}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:r},...t?.strict!==void 0?{strict:t.strict}:{}}),l=new un({returnSingle:!0,keyName:e,zodSchema:a})}else{let r;"string"==typeof a.name&&"object"==typeof a.parameters&&null!=a.parameters?(r=a,e=a.name):r={name:e=a.title??e,description:a.description??"",parameters:a},o=this.withConfig({tools:[{type:"function",function:r}],tool_choice:{type:"function",function:{name:e}},ls_structured_output_format:{kwargs:{method:"functionCalling"},schema:lr(a)},...t?.strict!==void 0?{strict:t.strict}:{}}),l=new un({returnSingle:!0,keyName:e})}}if(!s)return o.pipe(l);let u=l0.assign({parsed:(e,t)=>l.invoke(e.raw,t)}),c=l0.assign({parsed:()=>null}),d=u.withFallbacks({fallbacks:[c]});return lm.from([{raw:o},d])}}class uG extends lX{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e??{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"verboseParsingErrors",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"content"}),Object.defineProperty(this,"defaultConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verboseParsingErrors=e?.verboseParsingErrors??this.verboseParsingErrors,this.responseFormat=e?.responseFormat??this.responseFormat,this.defaultConfig=e?.defaultConfig??this.defaultConfig,this.metadata=e?.metadata??this.metadata}async invoke(e,t){let r,a=sz(sU(this.defaultConfig,t));return iS(e)?(r=e.args,a={...a,toolCall:e}):r=e,this.call(r,a)}async call(e,t,r){let a,i,n,s,o,l=iS(e)?e.args:e;if(o3(this.schema))try{a=await o8(this.schema,l)}catch(r){let t="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(t=`${t}
Details: ${r.message}`),new ix(t,JSON.stringify(e))}else{let t=function e(t,r,a="2019-09",i=function e(t,r=Object.create(null),a=oq,i=""){if(t&&"object"==typeof t&&!Array.isArray(t)){let n=t.$id||t.id;if(n){let s=new URL(n,a.href);s.hash.length>1?r[s.href]=t:(s.hash="",""===i?a=s:e(t,r,a))}}else if(!0!==t&&!1!==t)return r;let n=a.href+(i?"#"+i:"");if(void 0!==r[n])throw Error(`Duplicate schema URI "${n}".`);if(r[n]=t,!0===t||!1===t)return r;if(void 0===t.__absolute_uri__&&Object.defineProperty(t,"__absolute_uri__",{enumerable:!1,value:n}),t.$ref&&void 0===t.__absolute_ref__){let e=new URL(t.$ref,a.href);e.hash=e.hash,Object.defineProperty(t,"__absolute_ref__",{enumerable:!1,value:e.href})}if(t.$recursiveRef&&void 0===t.__absolute_recursive_ref__){let e=new URL(t.$recursiveRef,a.href);e.hash=e.hash,Object.defineProperty(t,"__absolute_recursive_ref__",{enumerable:!1,value:e.href})}for(let n in t.$anchor&&(r[new URL("#"+t.$anchor,a.href).href]=t),t){if(oB[n])continue;let s=`${i}/${oD(n)}`,o=t[n];if(Array.isArray(o)){if(oz[n]){let t=o.length;for(let i=0;i<t;i++)e(o[i],r,a,`${s}/${i}`)}}else if(oF[n])for(let t in o)e(o[t],r,a,`${s}/${oD(t)}`);else e(o,r,a,s)}return r}(r),n=!0,s=null,o="#",l="#",u=Object.create(null)){let c;if(!0===r)return{valid:!0,errors:[]};if(!1===r)return{valid:!1,errors:[{instanceLocation:o,keyword:"false",keywordLocation:o,error:"False boolean schema."}]};let d=typeof t;switch(d){case"boolean":case"number":case"string":c=d;break;case"object":c=null===t?"null":Array.isArray(t)?"array":"object";break;default:throw Error(`Instances of "${d}" type are not supported.`)}let{$ref:h,$recursiveRef:p,$recursiveAnchor:f,type:m,const:g,enum:y,required:b,not:_,anyOf:w,allOf:v,oneOf:E,if:O,then:k,else:S,format:x,properties:$,patternProperties:I,additionalProperties:A,unevaluatedProperties:T,minProperties:P,maxProperties:j,propertyNames:N,dependentRequired:R,dependentSchemas:C,dependencies:L,prefixItems:M,items:U,additionalItems:D,unevaluatedItems:z,contains:F,minContains:B,maxContains:q,minItems:H,maxItems:W,uniqueItems:J,minimum:G,maximum:Z,exclusiveMinimum:V,exclusiveMaximum:Y,multipleOf:K,minLength:X,maxLength:Q,pattern:ee,__absolute_ref__:et,__absolute_recursive_ref__:er}=r,ea=[];if(!0===f&&null===s&&(s=r),"#"===p){let c=null===s?i[er]:s,d=`${l}/$recursiveRef`,h=e(t,null===s?r:s,a,i,n,c,o,d,u);h.valid||ea.push({instanceLocation:o,keyword:"$recursiveRef",keywordLocation:d,error:"A subschema had errors."},...h.errors)}if(void 0!==h){let r=i[et||h];if(void 0===r){let e=`Unresolved $ref "${h}".`;throw et&&et!==h&&(e+=`  Absolute URI "${et}".`),Error(e+=`
Known schemas:
- ${Object.keys(i).join("\n- ")}`)}let c=`${l}/$ref`,d=e(t,r,a,i,n,s,o,c,u);if(d.valid||ea.push({instanceLocation:o,keyword:"$ref",keywordLocation:c,error:"A subschema had errors."},...d.errors),"4"===a||"7"===a)return{valid:0===ea.length,errors:ea}}if(Array.isArray(m)){let e=m.length,r=!1;for(let a=0;a<e;a++)if(c===m[a]||"integer"===m[a]&&"number"===c&&t%1==0&&t==t){r=!0;break}r||ea.push({instanceLocation:o,keyword:"type",keywordLocation:`${l}/type`,error:`Instance type "${c}" is invalid. Expected "${m.join('", "')}".`})}else"integer"===m?("number"!==c||t%1||t!=t)&&ea.push({instanceLocation:o,keyword:"type",keywordLocation:`${l}/type`,error:`Instance type "${c}" is invalid. Expected "${m}".`}):void 0!==m&&c!==m&&ea.push({instanceLocation:o,keyword:"type",keywordLocation:`${l}/type`,error:`Instance type "${c}" is invalid. Expected "${m}".`});if(void 0!==g&&("object"===c||"array"===c?oU(t,g)||ea.push({instanceLocation:o,keyword:"const",keywordLocation:`${l}/const`,error:`Instance does not match ${JSON.stringify(g)}.`}):t!==g&&ea.push({instanceLocation:o,keyword:"const",keywordLocation:`${l}/const`,error:`Instance does not match ${JSON.stringify(g)}.`})),void 0!==y&&("object"===c||"array"===c?y.some(e=>oU(t,e))||ea.push({instanceLocation:o,keyword:"enum",keywordLocation:`${l}/enum`,error:`Instance does not match any of ${JSON.stringify(y)}.`}):y.some(e=>t===e)||ea.push({instanceLocation:o,keyword:"enum",keywordLocation:`${l}/enum`,error:`Instance does not match any of ${JSON.stringify(y)}.`})),void 0!==_){let r=`${l}/not`;e(t,_,a,i,n,s,o,r).valid&&ea.push({instanceLocation:o,keyword:"not",keywordLocation:r,error:'Instance matched "not" schema.'})}let ei=[];if(void 0!==w){let r=`${l}/anyOf`,c=ea.length,d=!1;for(let l=0;l<w.length;l++){let c=w[l],h=Object.create(u),p=e(t,c,a,i,n,!0===f?s:null,o,`${r}/${l}`,h);ea.push(...p.errors),d=d||p.valid,p.valid&&ei.push(h)}d?ea.length=c:ea.splice(c,0,{instanceLocation:o,keyword:"anyOf",keywordLocation:r,error:"Instance does not match any subschemas."})}if(void 0!==v){let r=`${l}/allOf`,c=ea.length,d=!0;for(let l=0;l<v.length;l++){let c=v[l],h=Object.create(u),p=e(t,c,a,i,n,!0===f?s:null,o,`${r}/${l}`,h);ea.push(...p.errors),d=d&&p.valid,p.valid&&ei.push(h)}d?ea.length=c:ea.splice(c,0,{instanceLocation:o,keyword:"allOf",keywordLocation:r,error:"Instance does not match every subschema."})}if(void 0!==E){let r=`${l}/oneOf`,c=ea.length,d=E.filter((l,c)=>{let d=Object.create(u),h=e(t,l,a,i,n,!0===f?s:null,o,`${r}/${c}`,d);return ea.push(...h.errors),h.valid&&ei.push(d),h.valid}).length;1===d?ea.length=c:ea.splice(c,0,{instanceLocation:o,keyword:"oneOf",keywordLocation:r,error:`Instance does not match exactly one subschema (${d} matches).`})}if(("object"===c||"array"===c)&&Object.assign(u,...ei),void 0!==O){let r=`${l}/if`;if(e(t,O,a,i,n,s,o,r,u).valid){if(void 0!==k){let c=e(t,k,a,i,n,s,o,`${l}/then`,u);c.valid||ea.push({instanceLocation:o,keyword:"if",keywordLocation:r,error:'Instance does not match "then" schema.'},...c.errors)}}else if(void 0!==S){let c=e(t,S,a,i,n,s,o,`${l}/else`,u);c.valid||ea.push({instanceLocation:o,keyword:"if",keywordLocation:r,error:'Instance does not match "else" schema.'},...c.errors)}}if("object"===c){if(void 0!==b)for(let e of b)e in t||ea.push({instanceLocation:o,keyword:"required",keywordLocation:`${l}/required`,error:`Instance does not have required property "${e}".`});let r=Object.keys(t);if(void 0!==P&&r.length<P&&ea.push({instanceLocation:o,keyword:"minProperties",keywordLocation:`${l}/minProperties`,error:`Instance does not have at least ${P} properties.`}),void 0!==j&&r.length>j&&ea.push({instanceLocation:o,keyword:"maxProperties",keywordLocation:`${l}/maxProperties`,error:`Instance does not have at least ${j} properties.`}),void 0!==N){let r=`${l}/propertyNames`;for(let l in t){let t=`${o}/${oD(l)}`,u=e(l,N,a,i,n,s,t,r);u.valid||ea.push({instanceLocation:o,keyword:"propertyNames",keywordLocation:r,error:`Property name "${l}" does not match schema.`},...u.errors)}}if(void 0!==R){let e=`${l}/dependantRequired`;for(let r in R)if(r in t)for(let a of R[r])a in t||ea.push({instanceLocation:o,keyword:"dependentRequired",keywordLocation:e,error:`Instance has "${r}" but does not have "${a}".`})}if(void 0!==C)for(let r in C){let c=`${l}/dependentSchemas`;if(r in t){let l=e(t,C[r],a,i,n,s,o,`${c}/${oD(r)}`,u);l.valid||ea.push({instanceLocation:o,keyword:"dependentSchemas",keywordLocation:c,error:`Instance has "${r}" but does not match dependant schema.`},...l.errors)}}if(void 0!==L){let r=`${l}/dependencies`;for(let l in L)if(l in t){let u=L[l];if(Array.isArray(u))for(let e of u)e in t||ea.push({instanceLocation:o,keyword:"dependencies",keywordLocation:r,error:`Instance has "${l}" but does not have "${e}".`});else{let c=e(t,u,a,i,n,s,o,`${r}/${oD(l)}`);c.valid||ea.push({instanceLocation:o,keyword:"dependencies",keywordLocation:r,error:`Instance has "${l}" but does not match dependant schema.`},...c.errors)}}}let c=Object.create(null),d=!1;if(void 0!==$){let r=`${l}/properties`;for(let l in $){if(!(l in t))continue;let h=`${o}/${oD(l)}`,p=e(t[l],$[l],a,i,n,s,h,`${r}/${oD(l)}`);if(p.valid)u[l]=c[l]=!0;else if(d=n,ea.push({instanceLocation:o,keyword:"properties",keywordLocation:r,error:`Property "${l}" does not match schema.`},...p.errors),d)break}}if(!d&&void 0!==I){let r=`${l}/patternProperties`;for(let l in I){let h=RegExp(l,"u"),p=I[l];for(let f in t){if(!h.test(f))continue;let m=`${o}/${oD(f)}`,g=e(t[f],p,a,i,n,s,m,`${r}/${oD(l)}`);g.valid?u[f]=c[f]=!0:(d=n,ea.push({instanceLocation:o,keyword:"patternProperties",keywordLocation:r,error:`Property "${f}" matches pattern "${l}" but does not match associated schema.`},...g.errors))}}}if(d||void 0===A){if(!d&&void 0!==T){let r=`${l}/unevaluatedProperties`;for(let l in t)if(!u[l]){let c=`${o}/${oD(l)}`,d=e(t[l],T,a,i,n,s,c,r);d.valid?u[l]=!0:ea.push({instanceLocation:o,keyword:"unevaluatedProperties",keywordLocation:r,error:`Property "${l}" does not match unevaluated properties schema.`},...d.errors)}}}else{let r=`${l}/additionalProperties`;for(let l in t){if(c[l])continue;let h=`${o}/${oD(l)}`,p=e(t[l],A,a,i,n,s,h,r);p.valid?u[l]=!0:(d=n,ea.push({instanceLocation:o,keyword:"additionalProperties",keywordLocation:r,error:`Property "${l}" does not match additional properties schema.`},...p.errors))}}}else if("array"===c){void 0!==W&&t.length>W&&ea.push({instanceLocation:o,keyword:"maxItems",keywordLocation:`${l}/maxItems`,error:`Array has too many items (${t.length} > ${W}).`}),void 0!==H&&t.length<H&&ea.push({instanceLocation:o,keyword:"minItems",keywordLocation:`${l}/minItems`,error:`Array has too few items (${t.length} < ${H}).`});let r=t.length,c=0,d=!1;if(void 0!==M){let h=`${l}/prefixItems`,p=Math.min(M.length,r);for(;c<p;c++){let r=e(t[c],M[c],a,i,n,s,`${o}/${c}`,`${h}/${c}`);if(u[c]=!0,!r.valid&&(d=n,ea.push({instanceLocation:o,keyword:"prefixItems",keywordLocation:h,error:"Items did not match schema."},...r.errors),d))break}}if(void 0!==U){let h=`${l}/items`;if(Array.isArray(U)){let l=Math.min(U.length,r);for(;c<l;c++){let r=e(t[c],U[c],a,i,n,s,`${o}/${c}`,`${h}/${c}`);if(u[c]=!0,!r.valid&&(d=n,ea.push({instanceLocation:o,keyword:"items",keywordLocation:h,error:"Items did not match schema."},...r.errors),d))break}}else for(;c<r;c++){let r=e(t[c],U,a,i,n,s,`${o}/${c}`,h);if(u[c]=!0,!r.valid&&(d=n,ea.push({instanceLocation:o,keyword:"items",keywordLocation:h,error:"Items did not match schema."},...r.errors),d))break}if(!d&&void 0!==D){let h=`${l}/additionalItems`;for(;c<r;c++){let r=e(t[c],D,a,i,n,s,`${o}/${c}`,h);u[c]=!0,r.valid||(d=n,ea.push({instanceLocation:o,keyword:"additionalItems",keywordLocation:h,error:"Items did not match additional items schema."},...r.errors))}}}if(void 0!==F)if(0===r&&void 0===B)ea.push({instanceLocation:o,keyword:"contains",keywordLocation:`${l}/contains`,error:"Array is empty. It must contain at least one item matching the schema."});else if(void 0!==B&&r<B)ea.push({instanceLocation:o,keyword:"minContains",keywordLocation:`${l}/minContains`,error:`Array has less items (${r}) than minContains (${B}).`});else{let c=`${l}/contains`,d=ea.length,h=0;for(let l=0;l<r;l++){let r=e(t[l],F,a,i,n,s,`${o}/${l}`,c);r.valid?(u[l]=!0,h++):ea.push(...r.errors)}h>=(B||0)&&(ea.length=d),void 0===B&&void 0===q&&0===h?ea.splice(d,0,{instanceLocation:o,keyword:"contains",keywordLocation:c,error:"Array does not contain item matching schema."}):void 0!==B&&h<B?ea.push({instanceLocation:o,keyword:"minContains",keywordLocation:`${l}/minContains`,error:`Array must contain at least ${B} items matching schema. Only ${h} items were found.`}):void 0!==q&&h>q&&ea.push({instanceLocation:o,keyword:"maxContains",keywordLocation:`${l}/maxContains`,error:`Array may contain at most ${q} items matching schema. ${h} items were found.`})}if(!d&&void 0!==z){let d=`${l}/unevaluatedItems`;for(;c<r;c++){if(u[c])continue;let r=e(t[c],z,a,i,n,s,`${o}/${c}`,d);u[c]=!0,r.valid||ea.push({instanceLocation:o,keyword:"unevaluatedItems",keywordLocation:d,error:"Items did not match unevaluated items schema."},...r.errors)}}if(J)for(let e=0;e<r;e++){let a=t[e],i="object"==typeof a&&null!==a;for(let n=0;n<r;n++){if(e===n)continue;let r=t[n],s="object"==typeof r&&null!==r;(a===r||i&&s&&oU(a,r))&&(ea.push({instanceLocation:o,keyword:"uniqueItems",keywordLocation:`${l}/uniqueItems`,error:`Duplicate items at indexes ${e} and ${n}.`}),e=Number.MAX_SAFE_INTEGER,n=Number.MAX_SAFE_INTEGER)}}}else if("number"===c){if("4"===a?(void 0!==G&&(!0===V&&t<=G||t<G)&&ea.push({instanceLocation:o,keyword:"minimum",keywordLocation:`${l}/minimum`,error:`${t} is less than ${V?"or equal to ":""} ${G}.`}),void 0!==Z&&(!0===Y&&t>=Z||t>Z)&&ea.push({instanceLocation:o,keyword:"maximum",keywordLocation:`${l}/maximum`,error:`${t} is greater than ${Y?"or equal to ":""} ${Z}.`})):(void 0!==G&&t<G&&ea.push({instanceLocation:o,keyword:"minimum",keywordLocation:`${l}/minimum`,error:`${t} is less than ${G}.`}),void 0!==Z&&t>Z&&ea.push({instanceLocation:o,keyword:"maximum",keywordLocation:`${l}/maximum`,error:`${t} is greater than ${Z}.`}),void 0!==V&&t<=V&&ea.push({instanceLocation:o,keyword:"exclusiveMinimum",keywordLocation:`${l}/exclusiveMinimum`,error:`${t} is less than ${V}.`}),void 0!==Y&&t>=Y&&ea.push({instanceLocation:o,keyword:"exclusiveMaximum",keywordLocation:`${l}/exclusiveMaximum`,error:`${t} is greater than or equal to ${Y}.`})),void 0!==K){let e=t%K;Math.abs(0-e)>=11920929e-14&&Math.abs(K-e)>=11920929e-14&&ea.push({instanceLocation:o,keyword:"multipleOf",keywordLocation:`${l}/multipleOf`,error:`${t} is not a multiple of ${K}.`})}}else if("string"===c){let e=void 0===X&&void 0===Q?0:function(e){let t,r=0,a=e.length,i=0;for(;i<a;)r++,(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<a&&(64512&(t=e.charCodeAt(i)))==56320&&i++;return r}(t);void 0!==X&&e<X&&ea.push({instanceLocation:o,keyword:"minLength",keywordLocation:`${l}/minLength`,error:`String is too short (${e} < ${X}).`}),void 0!==Q&&e>Q&&ea.push({instanceLocation:o,keyword:"maxLength",keywordLocation:`${l}/maxLength`,error:`String is too long (${e} > ${Q}).`}),void 0===ee||RegExp(ee,"u").test(t)||ea.push({instanceLocation:o,keyword:"pattern",keywordLocation:`${l}/pattern`,error:"String does not match pattern."}),void 0!==x&&oZ[x]&&!oZ[x](t)&&ea.push({instanceLocation:o,keyword:"format",keywordLocation:`${l}/format`,error:`String does not match format "${x}".`})}return{valid:0===ea.length,errors:ea}}(l,this.schema);if(!t.valid){let r="Received tool input did not match expected schema";throw this.verboseParsingErrors&&(r=`${r}
Details: ${t.errors.map(e=>`${e.keywordLocation}: ${e.error}`).join("\n")}`),new ix(r,JSON.stringify(e))}a=l}let u=t?Array.isArray(t)||"name"in t?{callbacks:t}:t:{},c=sj.configure(u.callbacks,this.callbacks,u.tags||r,this.tags,u.metadata,this.metadata,{verbose:this.verbose}),d=await c?.handleToolStart(this.toJSON(),"string"==typeof e?e:JSON.stringify(e),u.runId,void 0,void 0,void 0,u.runName);delete u.runId;try{i=await this._call(a,d,u)}catch(e){throw await d?.handleToolError(e),e}if("content_and_artifact"===this.responseFormat)if(Array.isArray(i)&&2===i.length)[n,s]=i;else throw Error(`Tool response format is "content_and_artifact" but the output was not a two-tuple.
Result: ${JSON.stringify(i)}`);else n=i;iS(e)&&(o=e.id),!o&&u&&"object"==typeof u&&"toolCall"in u&&null!=u.toolCall&&"object"==typeof u.toolCall&&"id"in u.toolCall&&"string"==typeof u.toolCall.id&&(o=u.toolCall.id);let h=function(e){let{content:t,artifact:r,toolCallId:a,metadata:i}=e;return!a||null!=t&&"object"==typeof t&&"lc_direct_tool_output"in t&&!0===t.lc_direct_tool_output?t:new ic("string"==typeof t||Array.isArray(t)&&t.every(e=>"object"==typeof e)?{status:"success",content:t,artifact:r,tool_call_id:a,name:e.name,metadata:i}:{status:"success",content:function(e){try{return JSON.stringify(e,null,2)??""}catch(t){return`${e}`}}(t),artifact:r,tool_call_id:a,name:e.name,metadata:i})}({content:n,artifact:s,toolCallId:o,name:this.name,metadata:this.metadata});return await d?.handleToolEnd(h),h}}class uZ extends uG{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:iP.Ik({input:iP.Yj().optional()}).transform(e=>e.input)})}call(e,t){return super.call("string"==typeof e||null==e?{input:e}:e,t)}}Object.defineProperty(class extends uZ{static lc_name(){return"DallEAPIWrapper"}constructor(e){e?.responseFormat!==void 0&&["url","b64_json"].includes(e.responseFormat)&&(e.dallEResponseFormat=e.responseFormat,e.responseFormat="content"),super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"model",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"dallEResponseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t={apiKey:e?.apiKey??e?.openAIApiKey??si("OPENAI_API_KEY"),organization:e?.organization??si("OPENAI_ORGANIZATION"),dangerouslyAllowBrowser:!0,baseURL:e?.baseUrl};this.client=new aR(t),this.model=e?.model??e?.modelName??this.model,this.style=e?.style??this.style,this.quality=e?.quality??this.quality,this.n=e?.n??this.n,this.size=e?.size??this.size,this.dallEResponseFormat=e?.dallEResponseFormat??this.dallEResponseFormat,this.user=e?.user}processMultipleGeneratedUrls(e){return"url"===this.dallEResponseFormat?e.flatMap(e=>e.data?.flatMap(e=>e.url?{type:"image_url",image_url:e.url}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"string"==typeof e.image_url&&void 0!==e.image_url)??[]):e.flatMap(e=>e.data?.flatMap(e=>e.b64_json?{type:"image_url",image_url:{url:e.b64_json}}:[]).filter(e=>void 0!==e&&"image_url"===e.type&&"object"==typeof e.image_url&&"url"in e.image_url&&"string"==typeof e.image_url.url&&void 0!==e.image_url.url)??[])}async _call(e){let t={model:this.model,prompt:e,n:1,size:this.size,response_format:this.dallEResponseFormat,style:this.style,quality:this.quality,user:this.user};if(this.n>1){let e=await Promise.all(Array.from({length:this.n}).map(()=>this.client.images.generate(t)));return this.processMultipleGeneratedUrls(e)}let r=await this.client.images.generate(t),a="";return"url"===this.dallEResponseFormat?[a]=r.data?.map(e=>e.url).filter(e=>"undefined"!==e)??[]:[a]=r.data?.map(e=>e.b64_json).filter(e=>"undefined"!==e)??[],a}},"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var uV=r(58247),uY=function(){try{var e=(0,uV.A)(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();let uK=function(e,t,r){"__proto__"==t&&uY?uY(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r};var uX=r(75952),uQ=Object.prototype.hasOwnProperty;let u0=function(e,t,r){var a=e[t];uQ.call(e,t)&&(0,uX.A)(a,r)&&(void 0!==r||t in e)||uK(e,t,r)};var u1=r(17993),u2=r(48466),u5=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,u4=/^\w*$/;let u9=function(e,t){if((0,u1.A)(e))return!1;var r=typeof e;return!!("number"==r||"symbol"==r||"boolean"==r||null==e||(0,u2.A)(e))||u4.test(e)||!u5.test(e)||null!=t&&e in Object(t)};var u3=r(24928);function u6(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw TypeError("Expected a function");var r=function(){var a=arguments,i=t?t.apply(this,a):a[0],n=r.cache;if(n.has(i))return n.get(i);var s=e.apply(this,a);return r.cache=n.set(i,s)||n,s};return r.cache=new(u6.Cache||u3.A),r}u6.Cache=u3.A;var u8=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,u7=/\\(\\)?/g,ce=(v=(w=u6(function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(u8,function(e,r,a,i){t.push(a?i.replace(u7,"$1"):r||e)}),t},function(e){return 500===v.size&&v.clear(),e})).cache,w),ct=r(99225);let cr=function(e,t){for(var r=-1,a=null==e?0:e.length,i=Array(a);++r<a;)i[r]=t(e[r],r,e);return i};var ca=1/0,ci=ct.A?ct.A.prototype:void 0,cn=ci?ci.toString:void 0;let cs=function e(t){if("string"==typeof t)return t;if((0,u1.A)(t))return cr(t,e)+"";if((0,u2.A)(t))return cn?cn.call(t):"";var r=t+"";return"0"==r&&1/t==-ca?"-0":r},co=function(e,t){return(0,u1.A)(e)?e:u9(e,t)?[e]:ce(null==e?"":cs(e))};var cl=r(71873),cu=r(26693),cc=1/0;let cd=function(e){if("string"==typeof e||(0,u2.A)(e))return e;var t=e+"";return"0"==t&&1/e==-cc?"-0":t},ch=function(e,t,r,a){if(!(0,cu.A)(e))return e;t=co(t,e);for(var i=-1,n=t.length,s=n-1,o=e;null!=o&&++i<n;){var l=cd(t[i]),u=r;if("__proto__"===l||"constructor"===l||"prototype"===l)break;if(i!=s){var c=o[l];void 0===(u=a?a(c,l,o):void 0)&&(u=(0,cu.A)(c)?c:(0,cl.A)(t[i+1])?[]:{})}u0(o,l,u),o=o[l]}return e},cp=function(e,t){t=co(t,e);for(var r=0,a=t.length;null!=e&&r<a;)e=e[cd(t[r++])];return r&&r==a?e:void 0},cf=function(e,t,r){var a=null==e?void 0:cp(e,t);return void 0===a?r:a};var cm=e6.Ay.record(e6.Ay.string(),e6.Ay.any()),cg=e6.Ay.object({id:e6.Ay.string(),nodeID:e6.Ay.string(),inputs:cm,outputs:cm.optional(),data:cm,branch:e6.Ay.string().optional()}),cy={status:e6.Ay.string(),terminated:e6.Ay.boolean(),startTime:e6.Ay.number(),endTime:e6.Ay.number().optional(),timeCost:e6.Ay.number()},cb=e6.Ay.object(cy),c_=e6.Ay.object({id:e6.Ay.string(),...cy,snapshots:e6.Ay.array(cg)}),cw=e6.Ay.record(e6.Ay.string(),c_),cv=e6.Ay.object({id:e6.Ay.string(),type:e6.Ay.enum(["log","info","debug","error","warning"]),message:e6.Ay.string(),nodeID:e6.Ay.string().optional(),timestamp:e6.Ay.number()}),cE=e6.Ay.record(e6.Ay.enum(["log","info","debug","error","warning"]),e6.Ay.array(cv)),cO=((E=cO||{}).ServerInfo="ServerInfo",E.TaskRun="TaskRun",E.TaskReport="TaskReport",E.TaskResult="TaskResult",E.TaskCancel="TaskCancel",E.TaskValidate="TaskValidate",E),ck=(e6.Ay.object({schema:e6.Ay.string(),inputs:cm}),e6.Ay.object({valid:e6.Ay.boolean(),errors:e6.Ay.array(e6.Ay.string()).optional()}),e6.Ay.object({schema:e6.Ay.string(),inputs:cm}),e6.Ay.object({taskID:e6.Ay.string()}),e6.Ay.object({taskID:e6.Ay.string()}),{name:"TaskReport",method:"GET",path:"/task/report",module:"Task",schema:{input:e6.Ay.object({taskID:e6.Ay.string()}),output:e6.Ay.object({id:e6.Ay.string(),inputs:cm,outputs:cm,workflowStatus:cb,reports:cw,messages:cE})}}),cS=(e6.Ay.object({taskID:e6.Ay.string()}),e6.Ay.object({success:e6.Ay.boolean()}),e6.Ay.undefined(),e6.Ay.object({name:e6.Ay.string(),runtime:e6.Ay.string(),version:e6.Ay.string(),time:e6.Ay.string()}),(O=cS||{}).Input="input",O.Output="output",O),cx=((k=cx||{}).String="string",k.Integer="integer",k.Number="number",k.Boolean="boolean",k.Object="object",k.Array="array",k.Null="null",k),c$=((S=c$||{}).Root="root",S.Start="start",S.End="end",S.LLM="llm",S.Code="code",S.Condition="condition",S.Loop="loop",S.Comment="comment",S.Group="group",S.BlockStart="block-start",S.BlockEnd="block-end",S.HTTP="http",S.Break="break",S.Continue="continue",S),cI=((x=cI||{}).EQ="eq",x.NEQ="neq",x.GT="gt",x.GTE="gte",x.LT="lt",x.LTE="lte",x.IN="in",x.NIN="nin",x.CONTAINS="contains",x.NOT_CONTAINS="not_contains",x.IS_EMPTY="is_empty",x.IS_NOT_EMPTY="is_not_empty",x.IS_TRUE="is_true",x.IS_FALSE="is_false",x),cA=(($=cA||{}).None="none",$.FormData="form-data",$.XWwwFormUrlencoded="x-www-form-urlencoded",$.RawText="raw-text",$.JSON="JSON",$.Binary="binary",$),cT=Symbol.for("Engine"),cP=Symbol.for("Executor"),cj=((I=cj||{}).Pending="pending",I.Processing="processing",I.Succeeded="succeeded",I.Failed="failed",I.Canceled="canceled",I),cN=Symbol.for("Validation"),cR=((A=cR||{}).Log="log",A.Info="info",A.Debug="debug",A.Error="error",A.Warn="warning",A),cC=class{constructor(){this.type=c$.Start}async execute(e){return{outputs:e.runtime.ioCenter.inputs}}},cL=function(e,t,r){if(e7&&!t&&!e)return e7();let i=(e=e||{}).random||(e.rng||function(){if(!a&&!(a="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return a(te)})();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=i[e];return t}return function(e,t=0){return tt[e[t+0]]+tt[e[t+1]]+tt[e[t+2]]+tt[e[t+3]]+"-"+tt[e[t+4]]+tt[e[t+5]]+"-"+tt[e[t+6]]+tt[e[t+7]]+"-"+tt[e[t+8]]+tt[e[t+9]]+"-"+tt[e[t+10]]+tt[e[t+11]]+tt[e[t+12]]+tt[e[t+13]]+tt[e[t+14]]+tt[e[t+15]]}(i)};function cM(e,t){let r=new Set,a=[],i=e=>{for(let n of t(e))r.has(n.id)||(r.add(n.id),a.push(n),i(n))};return i(e),a}(T=e2||(e2={})).getWorkflowType=e=>null==e?cx.Null:"string"==typeof e?cx.String:"boolean"==typeof e?cx.Boolean:"number"==typeof e?Number.isInteger(e)?cx.Integer:cx.Number:Array.isArray(e)?cx.Array:"object"==typeof e?cx.Object:null,T.isMatchWorkflowType=(e,t)=>{let r=(0,T.getWorkflowType)(e);return!!r&&r===t},T.isTypeEqual=(e,t)=>e===cx.Number&&t===cx.Integer||e===cx.Integer&&t===cx.Number||e===t,T.getArrayItemsType=e=>{let t=e[0];return e.forEach(e=>{if(e!==t)throw Error(`Array items type must be same, expect ${t}, but got ${e}`)}),t};var cU="root",cD=e=>e===cU,cz=(e,t,r)=>{if(t.$ref)return{result:!0};if(t.enum&&t.enum.length>0&&!t.enum.includes(e))return{result:!1,errorMessage:`Value at ${r} must be one of: ${t.enum.join(", ")}, but got: ${JSON.stringify(e)}`};switch(t.type){case"boolean":return cF(e,r);case"string":return cB(e,r);case"integer":return cq(e,r);case"number":return cH(e,r);case"object":return cW(e,t,r);case"array":return cJ(e,t,r);case"map":return cG(e,t,r);default:return{result:!1,errorMessage:`Unknown type "${t.type}" at ${r}`}}},cF=(e,t)=>"boolean"!=typeof e?{result:!1,errorMessage:`Expected boolean at ${t}, but got: ${typeof e}`}:{result:!0},cB=(e,t)=>"string"!=typeof e?{result:!1,errorMessage:`Expected string at ${t}, but got: ${typeof e}`}:{result:!0},cq=(e,t)=>Number.isInteger(e)?{result:!0}:{result:!1,errorMessage:`Expected integer at ${t}, but got: ${JSON.stringify(e)}`},cH=(e,t)=>"number"!=typeof e||isNaN(e)?{result:!1,errorMessage:`Expected number at ${t}, but got: ${JSON.stringify(e)}`}:{result:!0},cW=(e,t,r)=>{if(null==e)return{result:!1,errorMessage:`Expected object at ${r}, but got: ${e}`};if("object"!=typeof e||Array.isArray(e))return{result:!1,errorMessage:`Expected object at ${r}, but got: ${Array.isArray(e)?"array":typeof e}`};if(t.required&&t.required.length>0){for(let a of t.required)if(!(a in e))return{result:!1,errorMessage:`Missing required property "${a}" at ${r}`}}if(t.properties){for(let[a]of Object.entries(t.properties))if(t.required?.includes(a)&&!(a in e))return{result:!1,errorMessage:`Missing required property "${a}" at ${r}`}}if(t.properties){for(let[a,i]of Object.entries(t.properties))if(a in e){let t=cD(r)?a:`${r}.${a}`,n=cz(e[a],i,t);if(!n.result)return n}}if(t.additionalProperties){let a=new Set(Object.keys(t.properties||{}));for(let[i,n]of Object.entries(e))if(!a.has(i)){let e=cD(r)?i:`${r}.${i}`,a=cz(n,t.additionalProperties,e);if(!a.result)return a}}return{result:!0}},cJ=(e,t,r)=>{if(!Array.isArray(e))return{result:!1,errorMessage:`Expected array at ${r}, but got: ${typeof e}`};if(t.items)for(let[a,i]of e.entries()){let e=`${r}[${a}]`,n=cz(i,t.items,e);if(!n.result)return n}return{result:!0}},cG=(e,t,r)=>{if(null==e)return{result:!1,errorMessage:`Expected map at ${r}, but got: ${e}`};if("object"!=typeof e||Array.isArray(e))return{result:!1,errorMessage:`Expected map at ${r}, but got: ${Array.isArray(e)?"array":typeof e}`};if(t.additionalProperties)for(let[a,i]of Object.entries(e)){let e=cD(r)?a:`${r}.${a}`,n=cz(i,t.additionalProperties,e);if(!n.result)return n}return{result:!0}},cZ=class{constructor(){this.type=c$.Loop}async execute(e){let t=e.node.id,r=e.container.get(cT),{value:a,itemsType:i}=this.getLoopArrayVariable(e),n=e.node.children.find(e=>e.type===c$.BlockStart);if(!n)throw Error("Loop block start node not found");let s=[];for(let o=0;o<a.length;o++){let l=a[o],u=e.runtime.sub();u.variableStore.setVariable({nodeID:`${t}_locals`,key:"item",type:i,value:l}),u.variableStore.setVariable({nodeID:`${t}_locals`,key:"index",type:cx.Number,value:o});try{await r.executeNode({context:u,node:n})}catch(e){throw Error("Loop block execute error")}if(this.isBreak(u))break;if(this.isContinue(u))continue;let c=this.getBlockOutput(e,u);s.push(c)}return this.setLoopNodeOutputs(e,s),{outputs:this.combineBlockOutputs(e,s)}}getLoopArrayVariable(e){let t=e.node.data,r=e.runtime.state.parseRef(t.loopFor);return this.checkLoopArray(r),r}checkLoopArray(e){let t=e?.value;if(!t||e8(t)||!Array.isArray(t))throw Error('Loop "loopFor" is required');if(e.type!==cx.Array)throw Error('Loop "loopFor" must be an array');if(e8(e.itemsType))throw Error('Loop "loopFor.items" must be array items')}getBlockOutput(e,t){return Object.entries(this.getLoopOutputsDeclare(e)).reduce((e,[r,a])=>{let i=t.state.parseRef(a);return i?{...e,[r]:i}:e},{})}setLoopNodeOutputs(e,t){let r=e.node;Object.keys(this.getLoopOutputsDeclare(e)).forEach(a=>{let i=t.map(e=>e[a]),n=i.map(e=>e.type),s=e2.getArrayItemsType(n),o=i.map(e=>e.value);e.runtime.variableStore.setVariable({nodeID:r.id,key:a,type:cx.Array,itemsType:s,value:o})})}combineBlockOutputs(e,t){return Object.keys(this.getLoopOutputsDeclare(e)).reduce((e,r)=>({...e,[r]:t.map(e=>e[r].value)}),{})}getLoopOutputsDeclare(e){return e.node.data.loopOutputs??{}}isBreak(e){return!0===e.cache.get("loop-break")}isContinue(e){return!0===e.cache.get("loop-continue")}},cV=class{constructor(){this.type=c$.LLM}async execute(e){let t,r=e.inputs;this.checkInputs(r);let{modelName:a,temperature:i,apiKey:n,apiHost:s,systemPrompt:o,prompt:l}=r,u=new uJ({modelName:a,temperature:i,apiKey:n,configuration:{baseURL:s},maxRetries:3}),c=[];o&&c.push(new iE(o)),c.push(new iw(l));try{t=await u.invoke(c)}catch(e){if("Connection error."===e?.message)throw Error(`Network error: unreachable api "${s}"`);throw e}return{outputs:{result:t.content}}}checkInputs(e){let{modelName:t,temperature:r,apiKey:a,apiHost:i,prompt:n}=e,s=[];if(t||s.push("modelName"),e8(r)&&s.push("temperature"),a||s.push("apiKey"),i||s.push("apiHost"),n||s.push("prompt"),s.length>0)throw Error(`LLM node missing required inputs: "${s.join('", "')}"`);this.checkApiHost(i)}checkApiHost(e){if(!e||"string"!=typeof e)throw Error(`Invalid API host format - ${e}`);let t=new URL(e);if("http:"!==t.protocol&&"https:"!==t.protocol)throw Error(`Invalid API host protocol - ${t.protocol}`)}},cY=class{constructor(){this.type=c$.HTTP}async execute(e){let t=this.parseInputs(e),r=await this.request(t),a={};r.headers.forEach((e,t)=>{a[t]=e});let i=await r.text();return{outputs:{headers:a,statusCode:r.status,body:i}}}async request(e){let{method:t,url:r,headers:a,params:i,bodyType:n,body:s,retryTimes:o,timeout:l}=e,u=this.buildUrlWithParams(r,i),c={method:t,headers:this.prepareHeaders(a,n),signal:AbortSignal.timeout(l)};"GET"!==t&&"HEAD"!==t&&s&&(c.body=this.prepareBody(s,n));let d=null;for(let e=0;e<=o;e++)try{return await fetch(u,c)}catch(t){d=t,e<o&&await new Promise(t=>setTimeout(t,1e3*Math.pow(2,e)))}throw d||Error("HTTP request failed after all retry attempts")}parseInputs(e){let t=e.node,r=t.data.api.method,a=e.runtime.state.parseTemplate(t.data.api.url);if(!a)throw Error("HTTP url is required");let i=a.value,n=e.runtime.state.parseInputs({values:t.data.headersValues,declare:t.data.headers}),s=e.runtime.state.parseInputs({values:t.data.paramsValues,declare:t.data.params}),o=this.parseBody(e),l=t.data.timeout.retryTimes,u=t.data.timeout.timeout,c={method:r,url:i,headers:n,params:s,bodyType:o.bodyType,body:o.body,retryTimes:l,timeout:u};return e.snapshot.update({inputs:JSON.parse(JSON.stringify(c))}),c}parseBody(e){let t=e.node,r=t.data.body.bodyType;if(r===cA.None)return{bodyType:r,body:""};if(r===cA.JSON){if(!t.data.body.json)throw Error("HTTP json body is required");let a=e.runtime.state.parseTemplate(t.data.body.json);if(!a)throw Error("HTTP json body is required");return{bodyType:r,body:a.value}}if(r===cA.FormData){if(!t.data.body.formData||!t.data.body.formDataValues)throw Error("HTTP form-data body is required");return{bodyType:r,body:JSON.stringify(e.runtime.state.parseInputs({values:t.data.body.formDataValues,declare:t.data.body.formData}))}}if(r===cA.RawText){if(!t.data.body.json)throw Error("HTTP json body is required");let a=e.runtime.state.parseTemplate(t.data.body.json);if(!a)throw Error("HTTP json body is required");return{bodyType:r,body:a.value}}if(r===cA.Binary){if(!t.data.body.binary)throw Error("HTTP binary body is required");let a=e.runtime.state.parseTemplate(t.data.body.binary);if(!a)throw Error("HTTP binary body is required");return{bodyType:r,body:a.value}}if(r===cA.XWwwFormUrlencoded){if(!t.data.body.xWwwFormUrlencoded||!t.data.body.xWwwFormUrlencodedValues)throw Error("HTTP x-www-form-urlencoded body is required");return{bodyType:r,body:JSON.stringify(e.runtime.state.parseInputs({values:t.data.body.xWwwFormUrlencodedValues,declare:t.data.body.xWwwFormUrlencoded}))}}throw Error(`HTTP invalid body type "${r}"`)}buildUrlWithParams(e,t){let r=new URL(e);return Object.entries(t).forEach(([e,t])=>{null!=t&&""!==t&&r.searchParams.set(e,t)}),r.toString()}prepareHeaders(e,t){let r={...e};if(!r["Content-Type"]&&!r["content-type"])switch(t){case cA.JSON:r["Content-Type"]="application/json";break;case cA.FormData:break;case cA.XWwwFormUrlencoded:r["Content-Type"]="application/x-www-form-urlencoded";break;case cA.RawText:r["Content-Type"]="text/plain";break;case cA.Binary:r["Content-Type"]="application/octet-stream"}return r}prepareBody(e,t){switch(t){case cA.JSON:return e;case cA.FormData:let r=new FormData;try{let t=JSON.parse(e);Object.entries(t).forEach(([e,t])=>{r.append(e,String(t))})}catch(e){throw Error("Invalid FormData body format")}return r;case cA.XWwwFormUrlencoded:try{let t=JSON.parse(e),r=new URLSearchParams;return Object.entries(t).forEach(([e,t])=>{r.append(e,String(t))}),r.toString()}catch(e){throw Error("Invalid x-www-form-urlencoded body format")}case cA.RawText:case cA.Binary:default:return e}}},cK=class{constructor(){this.type=c$.End}async execute(e){return e.runtime.ioCenter.setOutputs(e.inputs),{outputs:e.inputs}}},cX=class{constructor(){this.type=c$.BlockStart}async execute(e){return{outputs:{}}}},cQ=class{constructor(){this.type=c$.BlockEnd}async execute(e){return{outputs:{}}}},c0=class{constructor(){this.type=c$.Continue}async execute(e){return e.runtime.cache.set("loop-continue",!0),{outputs:{}}}},c1={[cx.String]:{[cI.EQ]:cx.String,[cI.NEQ]:cx.String,[cI.CONTAINS]:cx.String,[cI.NOT_CONTAINS]:cx.String,[cI.IN]:cx.Array,[cI.NIN]:cx.Array,[cI.IS_EMPTY]:cx.String,[cI.IS_NOT_EMPTY]:cx.String},[cx.Number]:{[cI.EQ]:cx.Number,[cI.NEQ]:cx.Number,[cI.GT]:cx.Number,[cI.GTE]:cx.Number,[cI.LT]:cx.Number,[cI.LTE]:cx.Number,[cI.IN]:cx.Array,[cI.NIN]:cx.Array,[cI.IS_EMPTY]:cx.Null,[cI.IS_NOT_EMPTY]:cx.Null},[cx.Integer]:{[cI.EQ]:cx.Integer,[cI.NEQ]:cx.Integer,[cI.GT]:cx.Integer,[cI.GTE]:cx.Integer,[cI.LT]:cx.Integer,[cI.LTE]:cx.Integer,[cI.IN]:cx.Array,[cI.NIN]:cx.Array,[cI.IS_EMPTY]:cx.Null,[cI.IS_NOT_EMPTY]:cx.Null},[cx.Boolean]:{[cI.EQ]:cx.Boolean,[cI.NEQ]:cx.Boolean,[cI.IS_TRUE]:cx.Null,[cI.IS_FALSE]:cx.Null,[cI.IN]:cx.Array,[cI.NIN]:cx.Array,[cI.IS_EMPTY]:cx.Null,[cI.IS_NOT_EMPTY]:cx.Null},[cx.Object]:{[cI.IS_EMPTY]:cx.Null,[cI.IS_NOT_EMPTY]:cx.Null},[cx.Array]:{[cI.IS_EMPTY]:cx.Null,[cI.IS_NOT_EMPTY]:cx.Null},[cx.Null]:{[cI.EQ]:cx.Null,[cI.IS_EMPTY]:cx.Null,[cI.IS_NOT_EMPTY]:cx.Null}},c2=e=>{let{operator:t}=e,r=e.leftValue;return t===cI.EQ?r===e.rightValue:t===cI.NEQ?r!==e.rightValue:t===cI.GT?r>e.rightValue:t===cI.GTE?r>=e.rightValue:t===cI.LT?r<e.rightValue:t===cI.LTE?r<=e.rightValue:t===cI.IN?e.rightValue.includes(r):t===cI.NIN?!e.rightValue.includes(r):t===cI.IS_EMPTY?e8(r):t===cI.IS_NOT_EMPTY&&!e8(r)},c5={[cx.String]:e=>{let{operator:t}=e,r=e.leftValue;if(t===cI.EQ)return r===e.rightValue;if(t===cI.NEQ)return r!==e.rightValue;if(t===cI.CONTAINS){let t=e.rightValue;return r.includes(t)}if(t===cI.NOT_CONTAINS){let t=e.rightValue;return!r.includes(t)}return t===cI.IN?e.rightValue.includes(r):t===cI.NIN?!e.rightValue.includes(r):t===cI.IS_EMPTY?e8(r):t===cI.IS_NOT_EMPTY&&!e8(r)},[cx.Number]:c2,[cx.Integer]:c2,[cx.Boolean]:e=>{let{operator:t}=e,r=e.leftValue;return t===cI.EQ?r===e.rightValue:t===cI.NEQ?r!==e.rightValue:t===cI.IS_TRUE?!0===r:t===cI.IS_FALSE?!1===r:t===cI.IN?e.rightValue.includes(r):t===cI.NIN?!e.rightValue.includes(r):t===cI.IS_EMPTY?e8(r):t===cI.IS_NOT_EMPTY&&!e8(r)},[cx.Object]:e=>{let{operator:t}=e,r=e.leftValue;return t===cI.IS_EMPTY?e8(r):t===cI.IS_NOT_EMPTY&&!e8(r)},[cx.Array]:e=>{let{operator:t}=e,r=e.leftValue;return t===cI.IS_EMPTY?e8(r):t===cI.IS_NOT_EMPTY&&!e8(r)},[cx.Null]:e=>{let{operator:t}=e,r=e.leftValue;return t===cI.EQ?e8(r)&&e8(e.rightValue):t===cI.IS_EMPTY?e8(r):t===cI.IS_NOT_EMPTY&&!e8(r)}},c4=[cC,cK,cV,class{constructor(){this.type=c$.Condition}async execute(e){let t=e.node.data?.conditions;if(!t)return{outputs:{}};let r=t.map(t=>this.parseCondition(t,e)).filter(e=>this.checkCondition(e)).find(e=>this.handleCondition(e));if(!r)throw Error("No condition is activated");return{outputs:{},branch:r.key}}parseCondition(e,t){let{key:r,value:a}=e,{left:i,operator:n,right:s}=a,o=t.runtime.state.parseRef(i),l=o?.value??null,u=o?.type??cx.Null,c=s?t.runtime.state.parseValue(s):null;return{key:r,leftValue:l,leftType:u,rightValue:c?.value??null,rightType:c?.type??cx.Null,operator:n}}checkCondition(e){let t=c1[e.leftType];if(e8(t))throw Error(`Condition left type "${e.leftType}" is not supported`);let r=t[e.operator];if(e8(r))throw Error(`Condition left type "${e.leftType}" has no operator "${e.operator}"`);return!!e2.isTypeEqual(r,e.rightType)}handleCondition(e){let t=c5[e.leftType];if(!t)throw Error(`Condition left type ${e.leftType} is not supported`);return t(e)}},cZ,cX,cQ,cY,class{constructor(){this.type=c$.Code}async execute(e){let t=this.parseInputs(e);if("javascript"===t.script.language)return this.javascript(t);throw Error(`Unsupported code language "${t.script.language}"`)}parseInputs(e){let t=e.node,r=e.inputs,{language:a,content:i}=t.data.script;if(!i)throw Error("Code content is required");return{params:r,script:{language:a,content:i}}}async javascript(e){let{params:t={},script:r}=e;try{let e=Function("params",`
        'use strict';

        ${r.content}

        // Ensure main function exists
        if (typeof main !== 'function') {
          throw new Error('main function is required in the script');
        }

        // Execute main function with params
        return main({ params });
        `),a=new Promise((e,t)=>{setTimeout(()=>{t(Error("Code execution timeout: exceeded 1 minute"))},6e4)}),i=await Promise.race([e(t),a]);return{outputs:i&&"object"==typeof i&&!Array.isArray(i)?i:{result:i}}}catch(e){throw Error(`Code execution failed: ${e.message}`)}}},class{constructor(){this.type=c$.Break}async execute(e){return e.runtime.cache.set("loop-break",!0),{outputs:{}}}},c0],c9=e=>{var t;let r,{nodes:a,edges:i}=e,n=new Map,s=new Set(a.map(e=>e.id));s.forEach(e=>{n.set(e,[])}),i.forEach(e=>{let t=n.get(e.sourceNodeID);t&&t.push(e.targetNodeID)}),(t=r||(r={}))[t.Unvisited=0]="Unvisited",t[t.Visiting=1]="Visiting",t[t.Visited=2]="Visited";let o=new Map;s.forEach(e=>{o.set(e,0)});let l=e=>{for(let t of(o.set(e,1),n.get(e)||[])){let e=o.get(t);if(1===e||0===e&&l(t))return!0}return o.set(e,2),!1};for(let e of s)if(0===o.get(e)&&l(e))throw Error("Workflow schema contains a cycle, which is not allowed");a.forEach(e=>{e.blocks&&c9({nodes:e.blocks,edges:e.edges??[]})})},c3=e=>{let{blockStartNodes:t,blockEndNodes:r}=e.nodes.reduce((e,t)=>(t.type===c$.BlockStart?e.blockStartNodes.push(t):t.type===c$.BlockEnd&&e.blockEndNodes.push(t),e),{blockStartNodes:[],blockEndNodes:[]});if(!t.length&&!r.length)throw Error("Workflow block schema must have a block-start node and a block-end node");if(!t.length)throw Error("Workflow block schema must have a block-start node");if(!r.length)throw Error("Workflow block schema must have an block-end node");if(t.length>1)throw Error("Workflow block schema must have only one block-start node");if(r.length>1)throw Error("Workflow block schema must have only one block-end node");e.nodes.forEach(e=>{e.blocks&&c3({nodes:e.blocks,edges:e.edges??[]})})},c6=e=>{let{nodes:t,edges:r}=e,a=new Set(t.map(e=>e.id));r.forEach(e=>{if(!a.has(e.sourceNodeID))throw Error(`Workflow schema edge source node "${e.sourceNodeID}" not exist`);if(!a.has(e.targetNodeID))throw Error(`Workflow schema edge target node "${e.targetNodeID}" not exist`)}),t.forEach(e=>{e.blocks&&c6({nodes:e.blocks,edges:e.edges??[]})})},c8=e=>{if(!e||"object"!=typeof e)throw Error("Workflow schema must be a valid object");if(!Array.isArray(e.nodes))throw Error("Workflow schema must have a valid nodes array");if(!Array.isArray(e.edges))throw Error("Workflow schema must have a valid edges array");e.nodes.forEach((e,t)=>{c7(e,`nodes[${t}]`)}),e.edges.forEach((e,t)=>{de(e,`edges[${t}]`)}),e.nodes.forEach((e,t)=>{if(e.blocks){if(!Array.isArray(e.blocks))throw Error(`Node nodes[${t}].blocks must be an array`);c8({nodes:e.blocks,edges:e.edges||[]})}})},c7=(e,t)=>{if(!e||"object"!=typeof e)throw Error(`${t} must be a valid object`);if("string"!=typeof e.id||!e.id.trim())throw Error(`${t}.id must be a non-empty string`);if("string"!=typeof e.type||!e.type.trim())throw Error(`${t}.type must be a non-empty string`);if(!e.meta||"object"!=typeof e.meta)throw Error(`${t}.meta must be a valid object`);if(!e.data||"object"!=typeof e.data)throw Error(`${t}.data must be a valid object`);if(void 0!==e.blocks&&!Array.isArray(e.blocks))throw Error(`${t}.blocks must be an array if present`);if(void 0!==e.edges&&!Array.isArray(e.edges))throw Error(`${t}.edges must be an array if present`);if(void 0!==e.data.inputs&&("object"!=typeof e.data.inputs||null===e.data.inputs))throw Error(`${t}.data.inputs must be a valid object if present`);if(void 0!==e.data.outputs&&("object"!=typeof e.data.outputs||null===e.data.outputs))throw Error(`${t}.data.outputs must be a valid object if present`);if(void 0!==e.data.inputsValues&&("object"!=typeof e.data.inputsValues||null===e.data.inputsValues))throw Error(`${t}.data.inputsValues must be a valid object if present`);if(void 0!==e.data.title&&"string"!=typeof e.data.title)throw Error(`${t}.data.title must be a string if present`)},de=(e,t)=>{if(!e||"object"!=typeof e)throw Error(`${t} must be a valid object`);if("string"!=typeof e.sourceNodeID||!e.sourceNodeID.trim())throw Error(`${t}.sourceNodeID must be a non-empty string`);if("string"!=typeof e.targetNodeID||!e.targetNodeID.trim())throw Error(`${t}.targetNodeID must be a non-empty string`);if(void 0!==e.sourcePortID&&"string"!=typeof e.sourcePortID)throw Error(`${t}.sourcePortID must be a string if present`);if(void 0!==e.targetPortID&&"string"!=typeof e.targetPortID)throw Error(`${t}.targetPortID must be a string if present`)},dt=class{invoke(e){let{schema:t,inputs:r}=e,a=this.schema(t);if(!a.valid)return a;let i=this.inputs(this.getWorkflowInputsDeclare(t),r);return i.valid?{valid:!0}:i}schema(e){let t=[];return[()=>c8(e),()=>c9(e),()=>c6(e),()=>(e=>{let{startNodes:t,endNodes:r}=e.nodes.reduce((e,t)=>(t.type===c$.Start?e.startNodes.push(t):t.type===c$.End&&e.endNodes.push(t),e),{startNodes:[],endNodes:[]});if(!t.length&&!r.length)throw Error("Workflow schema must have a start node and an end node");if(!t.length)throw Error("Workflow schema must have a start node");if(!r.length)throw Error("Workflow schema must have an end node");if(t.length>1)throw Error("Workflow schema must have only one start node");if(r.length>1)throw Error("Workflow schema must have only one end node");e.nodes.forEach(e=>{e.blocks&&c3({nodes:e.blocks,edges:e.edges??[]})})})(e)].forEach(e=>{try{e()}catch(e){t.push(e instanceof Error?e.message:String(e))}}),{valid:0===t.length,errors:t.length>0?t:void 0}}inputs(e,t){let{result:r,errorMessage:a}=(e=>{let{schema:t,value:r}=e;try{return cz(r,t,cU)}catch(e){return{result:!1,errorMessage:`Validation error: ${e instanceof Error?e.message:String(e)}`}}})({schema:e,value:t});return r?{valid:!0}:{valid:!1,errors:[`JSON Schema validation failed: ${a}`]}}getWorkflowInputsDeclare(e){let t=e.nodes.find(e=>e.type===c$.Start);if(!t)throw Error("Workflow schema must have a start node");return t.data.outputs}},dr=class{constructor(e){this.nodeExecutors=new Map,e.forEach(e=>{this.register(new e)})}register(e){this.nodeExecutors.set(e.type,e)}async execute(e){let t=e.node.type,r=this.nodeExecutors.get(t);if(!r)throw Error(`No executor found for node type ${t}`);return await r.execute(e)}},da=class e{constructor(e){this.id=cL(),this.context=e.context,this.processing=e.processing}cancel(){this.context.statusCenter.workflow.cancel(),this.context.statusCenter.getStatusNodeIDs(cj.Processing).forEach(e=>{this.context.statusCenter.nodeStatus(e).cancel()})}static create(t){return new e(t)}};(e5||(e5={})).create=e=>{let t={id:cL(),...e};return e.timestamp||(t.timestamp=Date.now()),t};var di=class{init(){this.messages={[cR.Log]:[],[cR.Info]:[],[cR.Debug]:[],[cR.Error]:[],[cR.Warn]:[]}}dispose(){}log(e){let t=e5.create({type:cR.Log,...e});return this.messages[cR.Log].push(t),t}info(e){let t=e5.create({type:cR.Info,...e});return this.messages[cR.Info].push(t),t}debug(e){let t=e5.create({type:cR.Debug,...e});return this.messages[cR.Debug].push(t),t}error(e){let t=e5.create({type:cR.Error,...e});return this.messages[cR.Error].push(t),t}warn(e){let t=e5.create({type:cR.Warn,...e});return this.messages[cR.Warn].push(t),t}export(){return{[cR.Log]:this.messages[cR.Log].slice(),[cR.Info]:this.messages[cR.Info].slice(),[cR.Debug]:this.messages[cR.Debug].slice(),[cR.Error]:this.messages[cR.Error].slice(),[cR.Warn]:this.messages[cR.Warn].slice()}}},dn=class{init(){this.map=new Map}dispose(){this.map.clear()}get(e){return this.map.get(e)}set(e,t){return this.map.set(e,t),this}delete(e){return this.map.delete(e)}has(e){return this.map.has(e)}};(e4||(e4={})).create=e=>({id:cL(),...e});var ds=class{constructor(){this.id=cL()}init(){this.store=new Map}dispose(){this.store.clear()}setParent(e){this.parent=e}globalGet(e){let t=this.store.get(e);return!t&&this.parent?this.parent.globalGet(e):t}setVariable(e){let{nodeID:t,key:r,value:a,type:i,itemsType:n}=e;this.store.has(t)||this.store.set(t,new Map);let s=this.store.get(t),o=e4.create({nodeID:t,key:r,value:a,type:i,itemsType:n});s.set(r,o)}setValue(e){var t;let{nodeID:r,variableKey:a,variablePath:i,value:n}=e;this.store.has(r)||this.store.set(r,new Map);let s=this.store.get(r);if(!s.has(a)){let e=e4.create({nodeID:r,key:a,value:{},type:cx.Object});s.set(a,e)}let o=s.get(a);if(!i){o.value=n;return}t=o.value,null==t||ch(t,i,n)}getValue(e){let{nodeID:t,variableKey:r,variablePath:a}=e,i=this.globalGet(t)?.get(r);if(!i)return null;if(!a||0===a.length)return{value:i.value,type:i.type,itemsType:i.itemsType};let n=cf(i.value,a),s=e2.getWorkflowType(n);if(!s)return null;if(s===cx.Array&&Array.isArray(n)){let e=e2.getWorkflowType(n[0]);return e?{value:n,type:s,itemsType:e}:null}return{value:n,type:s}}},dl=class e{constructor(){this.id=cL(),this._status=cj.Pending}get status(){return this._status}get terminated(){return[cj.Succeeded,cj.Failed,cj.Canceled].includes(this.status)}get startTime(){return this._startTime}get endTime(){return this._endTime}get timeCost(){return this.startTime?this.endTime?this.endTime-this.startTime:Date.now()-this.startTime:0}process(){this._status=cj.Processing,this._startTime=Date.now(),this._endTime=void 0}success(){this.terminated||(this._status=cj.Succeeded,this._endTime=Date.now())}fail(){this.terminated||(this._status=cj.Failed,this._endTime=Date.now())}cancel(){this.terminated||(this._status=cj.Canceled,this._endTime=Date.now())}export(){return{status:this.status,terminated:this.terminated,startTime:this.startTime,endTime:this.endTime,timeCost:this.timeCost}}static create(){return new e}},du=class{init(){this._workflowStatus=dl.create(),this._nodeStatus=new Map}dispose(){}get workflow(){return this._workflowStatus}get workflowStatus(){return this._workflowStatus}nodeStatus(e){return this._nodeStatus.has(e)||this._nodeStatus.set(e,dl.create()),this._nodeStatus.get(e)}getStatusNodeIDs(e){return Array.from(this._nodeStatus.entries()).filter(([,t])=>t.status===e).map(([e])=>e)}exportNodeStatus(){return Object.fromEntries(Array.from(this._nodeStatus.entries()).map(([e,t])=>[e,t.export()]))}},dc=class{constructor(e){this.variableStore=e,this.id=cL()}init(){this.executedNodes=new Set}dispose(){this.executedNodes.clear()}getNodeInputs(e){let t=e.declare.inputs,r=e.declare.inputsValues;return this.parseInputs({values:r,declare:t})}setNodeOutputs(e){let{node:t,outputs:r}=e,a=t.declare.outputs;a&&Object.entries(r).forEach(([e,r])=>{let i=a.properties?.[e];if(!i)return;let n=i.type,s=i.items?.type;this.variableStore.setVariable({nodeID:t.id,key:e,value:r,type:n,itemsType:s})})}parseInputs(e){let{values:t,declare:r}=e;return r&&t?Object.entries(t).reduce((e,[t,a])=>{let i=r.properties?.[t];if(!i)return e;let n=i.type,s=this.parseValue(a);if(!s)return e;let{value:o,type:l}=s;return e2.isTypeEqual(l,n)&&(e[t]=o),e},{}):{}}parseRef(e){if(e?.type!=="ref")throw Error(`Invalid ref value: ${e}`);if(!e.content||e.content.length<2)return null;let[t,r,...a]=e.content,i=this.variableStore.getValue({nodeID:t,variableKey:r,variablePath:a});return i||null}parseTemplate(e){if(e?.type!=="template")throw Error(`Invalid template value: ${e}`);if(!e.content)return null;let t=e.content.replace(/\{\{([^\}]+)\}\}/g,(e,t)=>{let r=t.trim().split("."),a=this.parseRef({type:"ref",content:r});return a?a.value:""});return{type:cx.String,value:t}}parseValue(e){if(!e?.type)throw Error(`Invalid flow value type: ${e.type}`);if("constant"===e.type){let t=e.content,r=e2.getWorkflowType(t);return e8(t)||!r?null:{value:t,type:r}}if("ref"===e.type)return this.parseRef(e);if("template"===e.type)return this.parseTemplate(e);throw Error(`Unknown flow value type: ${e.type}`)}isExecutedNode(e){return this.executedNodes.has(e.id)}addExecutedNode(e){this.executedNodes.add(e.id)}},dd=class e{constructor(e){this.id=cL(),this.data=e}update(e){Object.assign(this.data,e)}validate(){return["nodeID","inputs","outputs","data"].every(e=>void 0!==this.data[e])}export(){return{id:this.id,...this.data}}static create(t){return new e(t)}},dh=class{constructor(){this.id=cL()}create(e){let t=dd.create(e);return this.snapshots.push(t),t}init(){this.snapshots=[]}dispose(){}exportAll(){return this.snapshots.slice().map(e=>e.export())}export(){let e={};return this.exportAll().forEach(t=>{e[t.nodeID]?e[t.nodeID].push(t):e[t.nodeID]=[t]}),e}};(e9||(e9={})).create=e=>({id:cL(),...e});var dp=class{constructor(e,t,r,a){this.ioCenter=e,this.snapshotCenter=t,this.statusCenter=r,this.messageCenter=a}init(){}dispose(){}export(){return e9.create({inputs:this.ioCenter.inputs,outputs:this.ioCenter.outputs,workflowStatus:this.statusCenter.workflow.export(),reports:this.nodeReports(),messages:this.messageCenter.export()})}nodeReports(){let e={},t=this.statusCenter.exportNodeStatus(),r=this.snapshotCenter.export();return Object.keys(t).forEach(a=>{let i=t[a],n=r[a]||[],s={id:a,...i,snapshots:n};e[a]=s}),e}},df=class{init(e){this.setInputs(e)}dispose(){}get inputs(){return this._inputs??{}}get outputs(){return this._outputs??{}}setInputs(e){this._inputs=e}setOutputs(e){this._outputs=e}export(){return{inputs:this._inputs,outputs:this._outputs}}},dm=class{constructor(e){let{id:t,from:r,to:a}=e;this.id=t,this.from=r,this.to=a}get fromPort(){return this._fromPort}set fromPort(e){this._fromPort=e}get toPort(){return this._toPort}set toPort(e){this._toPort=e}static createID(e){let{sourceNodeID:t,sourcePortID:r,targetNodeID:a,targetPortID:i}=e,n=r?`${t}:${r}`:t,s=i?`${a}:${i}`:a;return`${n}-${s}`}},dg=class{constructor(e){let{id:t,type:r,name:a,position:i,variable:n,data:s}=e;this.id=t,this.type=r,this.name=a,this.position=i,this.declare=n??{},this.data=s??{},this._parent=null,this._children=[],this._ports=[],this._inputEdges=[],this._outputEdges=[],this._prev=[],this._next=[]}get ports(){return{inputs:this._ports.filter(e=>e.type===cS.Input),outputs:this._ports.filter(e=>e.type===cS.Output)}}get edges(){return{inputs:this._inputEdges,outputs:this._outputEdges}}get parent(){return this._parent}set parent(e){this._parent=e}get children(){return this._children}addChild(e){this._children.push(e)}addPort(e){this._ports.push(e)}addInputEdge(e){this._inputEdges.push(e),this._prev.push(e.from)}addOutputEdge(e){this._outputEdges.push(e),this._next.push(e.to)}get prev(){return this._prev}get next(){return this._next}get successors(){return cM(this,e=>e.next)}get predecessors(){return cM(this,e=>e.prev)}get isBranch(){return this.ports.outputs.length>1}},dy=class{constructor(e){let{id:t,node:r}=e;this.id=t,this.node=r,this.type=e.type,this._edges=[]}get edges(){return this._edges}addEdge(e){this._edges.push(e)}},db=(e,t)=>{let{blocks:r,edges:a}=t;if(r){e.flattenSchema.nodes.push(...r);let a=[];r.forEach(t=>{a.push(t.id),t.blocks&&db(e,t)}),e.nodeBlocks.set(t.id,a),delete t.blocks}if(a){e.flattenSchema.edges.push(...a);let r=[];a.forEach(e=>{let t=dm.createID(e);r.push(t)}),e.nodeEdges.set(t.id,r),delete t.edges}},d_=(e,t)=>{let r=new dg(t);return e.nodes.set(r.id,r),r},dw=(e,t)=>{let r=e.ports.get(t.id);if(r)return r;let a=new dy(t);return e.ports.set(a.id,a),a},dv=class{constructor(){this.id=cL()}get root(){let e=this.getNode(c$.Root);if(!e)throw Error("Root node not found");return e}get start(){let e=this.nodes.find(e=>e.type===c$.Start);if(!e)throw Error("Start node not found");return e}get end(){let e=this.nodes.find(e=>e.type===c$.End);if(!e)throw Error("End node not found");return e}getNode(e){return this.store.nodes.get(e)??null}getEdge(e){return this.store.edges.get(e)??null}get nodes(){return Array.from(this.store.nodes.values())}get edges(){return Array.from(this.store.edges.values())}init(e){let t=((e={nodes:[],edges:[]})=>{let t=e.nodes??[],r=e.edges??[],a={flattenSchema:{nodes:[],edges:[]},nodeBlocks:new Map,nodeEdges:new Map};return db(a,{id:c$.Root,type:c$.Root,blocks:t,edges:r,meta:{position:{x:0,y:0}},data:{}}),a})(e);this.store=(e=>{let{flattenSchema:t,nodeBlocks:r}=e,{nodes:a,edges:i}=t,n={nodes:new Map,edges:new Map,ports:new Map};return d_(n,{id:c$.Root,type:c$.Root,name:c$.Root,position:{x:0,y:0}}),a.forEach(e=>{let t=e.id,r=e.type,{title:a=`${r}-${t}-untitled`,inputsValues:i,inputs:s,outputs:o,...l}=e.data??{};d_(n,{id:t,type:r,name:a,position:e.meta.position,variable:{inputsValues:i,inputs:s,outputs:o},data:l})}),r.forEach((e,t)=>{let r=n.nodes.get(t);e.map(e=>n.nodes.get(e)).filter(Boolean).forEach(e=>{e.parent=r,r.addChild(e)})}),i.forEach(e=>{let t=dm.createID(e),{sourceNodeID:r,targetNodeID:a,sourcePortID:i="defaultOutput",targetPortID:s="defaultInput"}=e,o=n.nodes.get(r),l=n.nodes.get(a);if(!o||!l)throw Error(`Invalid edge schema ID: ${t}, from: ${r}, to: ${a}`);let u=((e,t)=>{let r=new dm(t);return e.edges.set(r.id,r),r})(n,{id:t,from:o,to:l}),c=dw(n,{node:o,id:i,type:cS.Output});c.addEdge(u),u.fromPort=c,o.addPort(c),o.addOutputEdge(u);let d=dw(n,{node:l,id:s,type:cS.Input});d.addEdge(u),u.toPort=d,l.addPort(d),l.addInputEdge(u)}),n})(t)}dispose(){this.store.edges.clear(),this.store.nodes.clear(),this.store.ports.clear()}},dE=class e{constructor(e){this.subContexts=[],this.id=cL(),this.cache=e.cache,this.document=e.document,this.variableStore=e.variableStore,this.state=e.state,this.ioCenter=e.ioCenter,this.snapshotCenter=e.snapshotCenter,this.statusCenter=e.statusCenter,this.messageCenter=e.messageCenter,this.reporter=e.reporter}init(e){let{schema:t,inputs:r}=e;this.cache.init(),this.document.init(t),this.variableStore.init(),this.state.init(),this.ioCenter.init(r),this.snapshotCenter.init(),this.statusCenter.init(),this.messageCenter.init(),this.reporter.init()}dispose(){this.subContexts.forEach(e=>{e.dispose()}),this.subContexts=[],this.cache.dispose(),this.document.dispose(),this.variableStore.dispose(),this.state.dispose(),this.ioCenter.dispose(),this.snapshotCenter.dispose(),this.statusCenter.dispose(),this.messageCenter.dispose(),this.reporter.dispose()}sub(){let t=new dn,r=new ds;r.setParent(this.variableStore);let a=new dc(r),i=new e({cache:t,document:this.document,ioCenter:this.ioCenter,snapshotCenter:this.snapshotCenter,statusCenter:this.statusCenter,messageCenter:this.messageCenter,reporter:this.reporter,variableStore:r,state:a});return this.subContexts.push(i),i.cache.init(),i.variableStore.init(),i.state.init(),i}static create(){let t=new dn,r=new dv,a=new ds,i=new dc(a),n=new df,s=new dh,o=new du,l=new di,u=new dp(n,s,o,l);return new e({cache:t,document:r,variableStore:a,state:i,ioCenter:n,snapshotCenter:s,statusCenter:o,messageCenter:l,reporter:u})}},dO=class{constructor(e){this.validation=e.Validation,this.executor=e.Executor}invoke(e){let t=dE.create();if(t.init(e),!this.validate(e,t))return da.create({processing:Promise.resolve({}),context:t});let r=this.process(t);return r.then(()=>{t.dispose()}),da.create({processing:r,context:t})}async executeNode(e){let{node:t,context:r}=e;if(!this.canExecuteNode({node:t,context:r}))return;r.statusCenter.nodeStatus(t.id).process();let a=r.snapshotCenter.create({nodeID:t.id,data:t.data}),i=[];try{let e=r.state.getNodeInputs(t);a.update({inputs:e});let n=await this.executor.execute({node:t,inputs:e,runtime:r,container:dk.instance,snapshot:a});if(r.statusCenter.workflow.terminated)return;let{outputs:s,branch:o}=n;a.update({outputs:s,branch:o}),r.state.setNodeOutputs({node:t,outputs:s}),r.state.addExecutedNode(t),r.statusCenter.nodeStatus(t.id).success(),i=this.getNextNodes({node:t,branch:o,context:r})}catch(i){let e=i instanceof Error?i.message:"An unknown error occurred";throw a.update({error:e}),r.messageCenter.error({nodeID:t.id,message:e}),r.statusCenter.nodeStatus(t.id).fail(),console.error(i),i}await this.executeNext({node:t,nextNodes:i,context:r})}async process(e){let t=e.document.start;e.statusCenter.workflow.process();try{await this.executeNode({node:t,context:e});let r=e.ioCenter.outputs;return e.statusCenter.workflow.success(),r}catch(t){return e.statusCenter.workflow.fail(),{}}}validate(e,t){let{valid:r,errors:a}=this.validation.invoke(e);return!!r||(a?.forEach(e=>{t.messageCenter.error({message:e})}),t.statusCenter.workflow.fail(),!1)}canExecuteNode(e){let{node:t,context:r}=e,a=t.prev;return 0===a.length||a.every(e=>r.state.isExecutedNode(e))}getNextNodes(e){let{node:t,branch:r,context:a}=e,i=t.next;if(!r)return i;let n=t.ports.outputs.find(e=>e.id===r);if(!n)throw Error(`Engine branch ${r} not found`);let s=new Set(n.edges.map(e=>e.to.id)),o=i.filter(e=>s.has(e.id)),l=i.filter(e=>!s.has(e.id)),{uniqueToB:u}=function(e,t){let r=e.flat(),a=new Map;r.forEach(e=>{a.set(e.id,e)});let i=t.flat(),n=new Map;i.forEach(e=>{n.set(e.id,e)});let s=[],o=[],l=[];return a.forEach((e,t)=>{n.has(t)?s.push(e):o.push(e)}),n.forEach((e,t)=>{a.has(t)||l.push(e)}),{common:s,uniqueToA:o,uniqueToB:l}}(o.map(e=>[e,...e.successors]),l.map(e=>[e,...e.successors]));return u.forEach(e=>{a.state.addExecutedNode(e)}),o}async executeNext(e){let{context:t,node:r,nextNodes:a}=e;if(![c$.End,c$.BlockEnd,c$.Break,c$.Continue].includes(r.type)){if(0===a.length)throw Error(`Node ${r.id} has no next nodes`);await Promise.all(a.map(e=>this.executeNode({node:e,context:t})))}}},dk=class e{constructor(e){this.services=e}get(e){return this.services[e]}static get instance(){if(this._instance)return this._instance;let t=this.create();return this._instance=new e(t),this._instance}static create(){let e=new dt,t=new dr(c4),r=new dO({Validation:e,Executor:t});return{[cN]:e,[cP]:t,[cT]:r}}},dS=class e{constructor(){this.container=dk.instance,this.tasks=new Map}run(e){let t=this.container.get(cT).invoke(e);return this.tasks.set(t.id,t),console.log("> POST TaskRun - taskID: ",t.id),console.log(e.inputs),t.processing.then(e=>{console.log("> LOG Task finished: ",t.id),console.log(e)}),t.id}cancel(e){console.log("> PUT TaskCancel - taskID: ",e);let t=this.tasks.get(e);return!!t&&(t.cancel(),!0)}report(e){let t=this.tasks.get(e);if(console.log("> GET TaskReport - taskID: ",e),t)return t.context.reporter.export()}result(e){console.log("> GET TaskResult - taskID: ",e);let t=this.tasks.get(e);if(t&&t.context.statusCenter.workflow.terminated)return t.context.ioCenter.outputs}validate(e){let t=this.container.get(cN).invoke(e);return console.log("> POST TaskValidate - valid: ",t.valid),t}static get instance(){return this._instance||(this._instance=new e),this._instance}},dx=async e=>{let t=dS.instance,{schema:r,inputs:a}=e,i=JSON.parse(r);return t.validate({schema:i,inputs:a})},d$=async e=>{let t=dS.instance,{schema:r,inputs:a}=e,i=JSON.parse(r);return{taskID:t.run({schema:i,inputs:a})}},dI=async e=>{let t=dS.instance,{taskID:r}=e;return t.result(r)},dA=async e=>{let t=dS.instance,{taskID:r}=e,a=t.report(r);try{ck.schema.output.parse(a)}catch(e){console.log("> TaskReportAPI - output: ",JSON.stringify(a)),console.error(e)}return a},dT=async e=>{let t=dS.instance,{taskID:r}=e;return{success:t.cancel(r)}};cO.ServerInfo,cO.TaskRun,cO.TaskReport,cO.TaskResult,cO.TaskCancel,cO.TaskValidate}}]);