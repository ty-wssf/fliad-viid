import{r as e,a}from"./formRules-B2bzcXv4.js";import{c as l}from"./index-DcffTgQN.js";import{s as o}from"./smCrypto-fJLAcgxS.js";import{b as t,k as s}from"./ant-design-vendor-CRFwT3Wn.js";import{d,f as n,a1 as r,U as u,V as _,k as i,a2 as v,a6 as c,u as S,Z as f,G as m,a3 as p,Y as P,H as A}from"./vue-vendor-BzDj5Url.js";const E={key:0},O=["src"],D=d({name:"updatePassword"}),T=Object.assign(D,{emits:{successful:null},setup(d,{expose:D,emit:T}){const R=T,h=n(!1),Y=n(),w=n({}),U=n(!1),L=n({}),C=()=>{h.value=!1,L.value={},Y.value.resetFields()},F={password:[e("请输入原密码")],phone:[e("请输入手机号"),a.phone],phoneValidCode:[e("请输入手机验证码"),a.number],email:[e("请输入邮箱号"),a.email],emailValidCode:[e("请输入邮箱验证码"),a.number],newPassword:[e("请输入新密码"),{validator:(e,a)=>{if(!a)return Promise.resolve();const l=L.value.SNOWY_SYS_DEFAULT_PASSWORD_MIN_LENGTH_FOR_B,o=L.value.SNOWY_SYS_DEFAULT_PASSWORD_MAX_LENGTH_FOR_B;if(a.length<l)return Promise.reject(`密码长度不能小于${l}位`);if(a.length>o)return Promise.reject(`密码长度不能大于${o}位`);const t=L.value.SNOWY_SYS_DEFAULT_PASSWORD_NOT_ALLOW_CONTINUOUS_SAME_CHARACTER_LENGTH_FOR_B;let s=1,d=a[0],n=1;for(let c=1;c<a.length;c++)a[c]===d?(n++,s=Math.max(s,n)):(d=a[c],n=1);if(s>t)return Promise.reject(`密码中不能包含${t}个以上相同字符`);const r=L.value.SNOWY_SYS_DEFAULT_PASSWORD_COMPLEXITY_FOR_B,u=/\d/.test(a),_=/[a-z]/.test(a),i=/[A-Z]/.test(a),v=/[!@#$%^&*(),.?":{}|<>]/.test(a);switch(r){case"REG0":break;case"REG1":if(!u||!_&&!i)return Promise.reject("密码必须包含数字和字母");break;case"REG2":if(!u||!i)return Promise.reject("密码必须包含数字和大写字母");break;case"REG3":if(!(u&&i&&_&&v))return Promise.reject("密码必须包含数字、大写字母、小写字母和特殊字符");break;case"REG4":if([u,_||i,v].filter(Boolean).length<2)return Promise.reject("密码至少包含数字、字母和特殊字符中的两种");break;case"REG5":if([u,i,_,v].filter(Boolean).length<3)return Promise.reject("密码至少包含数字、大写字母、小写字母和特殊字符的三种")}return Promise.resolve()}}]};let N=n({time:60,sendBtn:!1});const W=()=>{Y.value.validateFields(["PHONE"===L.value.SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B?"phone":"email"]).then(()=>{k.value=!0,V()})},B=async()=>{Y.value.validate().then(()=>{U.value=!0;const e=t(w.value);"OLD"===L.value.SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B?(e.password=o.doSm2Encrypt(w.value.password),e.newPassword=o.doSm2Encrypt(w.value.newPassword),l.userUpdatePasswordByOld(e).then(()=>{C(),R("successful")}).finally(()=>{U.value=!1})):"PHONE"===L.value.SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B?l.userUpdatePasswordByPhone(e).then(()=>{C(),R("successful")}).finally(()=>{U.value=!1}):"EMAIL"===L.value.SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B?l.userUpdatePasswordByEmail(e).then(()=>{C(),R("successful")}).finally(()=>{U.value=!1}):(U.value=!1,s.warning("未知的修改密码方式"))}).catch(()=>{})},k=n(!1),y=n({}),I=n(),b={validCode:[e("图形验证码不能为空")]},g=n(""),V=()=>{l.userGetPicCaptcha().then(e=>{e&&(g.value=e.validCodeBase64,w.value.validCodeReqNo=e.validCodeReqNo)})},j=()=>{k.value=!1,g.value=""},G=()=>{I.value.validate().then(()=>{k.value=!1,N.value.sendBtn=!0;const e=window.setInterval(()=>{N.value.time--<=0&&(N.value.time=60,N.value.sendBtn=!1,window.clearInterval(e))},1e3),a=s.loading("验证码发送中..",0),o={validCodeReqNo:w.value.validCodeReqNo,validCode:y.value.validCode};"PHONE"===L.value.SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B?(o.phone=w.value.phone,l.userUpdatePasswordGetPhoneValidCode(o).then(e=>{w.value.validCodeReqNo=e,setTimeout(a,500)}).catch(()=>{setTimeout(a,100),clearInterval(e),N.value.sendBtn=!1}).finally(()=>{y.value.validCode=""})):"EMAIL"===L.value.SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B?(o.email=w.value.email,l.userUpdatePasswordGetEmailValidCode(o).then(e=>{w.value.validCodeReqNo=e,setTimeout(a,500)}).catch(()=>{setTimeout(a,100),clearInterval(e),N.value.sendBtn=!1}).finally(()=>{y.value.validCode=""})):s.warning("未知的发送验证码方式")})};return D({onOpen:()=>{h.value=!0,l.userGetUpdatePasswordValidConfig().then(e=>{L.value=e})}}),(e,a)=>{const l=r("a-skeleton"),o=r("a-input-password"),t=r("a-form-item"),s=r("a-input"),d=r("mail-outlined"),n=r("a-col"),D=r("a-button"),T=r("a-row"),R=r("a-form"),x=r("a-modal"),H=r("verified-outlined");return _(),u("div",null,[i(x,{title:"修改密码",width:400,open:S(h),"destroy-on-close":!0,onCancel:C},{footer:v(()=>[i(D,{class:"xn-mr8",onClick:C},{default:v(()=>a[7]||(a[7]=[m("关闭")])),_:1}),i(D,{type:"primary",loading:S(U),onClick:B},{default:v(()=>a[8]||(a[8]=[m("保存")])),_:1},8,["loading"])]),default:v(()=>[S(L)?(_(),c(R,{key:1,ref_key:"formRef",ref:Y,model:S(w),rules:F,layout:"vertical"},{default:v(()=>["OLD"===S(L).SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B?(_(),u("div",E,[i(t,{label:"旧密码：",name:"password","has-feedback":""},{default:v(()=>[i(o,{value:S(w).password,"onUpdate:value":a[0]||(a[0]=e=>S(w).password=e),placeholder:"请输入原密码","allow-clear":"",autocomplete:"off"},null,8,["value"])]),_:1})])):f("",!0),"PHONE"===S(L).SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B?(_(),c(t,{key:1,name:"phone","has-feedback":""},{default:v(()=>[i(s,{value:S(w).phone,"onUpdate:value":a[1]||(a[1]=e=>S(w).phone=e),placeholder:"请输入手机号","allow-clear":"",autocomplete:"off"},null,8,["value"])]),_:1})):f("",!0),"EMAIL"===S(L).SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B?(_(),c(t,{key:2,name:"email","has-feedback":""},{default:v(()=>[i(s,{value:S(w).email,"onUpdate:value":a[2]||(a[2]=e=>S(w).email=e),placeholder:"请输入邮箱号","allow-clear":"",autocomplete:"off"},null,8,["value"])]),_:1})):f("",!0),"PHONE"===S(L).SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B||"EMAIL"===S(L).SNOWY_SYS_DEFAULT_PASSWORD_UPDATE_VALID_TYPE_FOR_B?(_(),c(t,{key:3,name:"validCode"},{default:v(()=>[i(T,{gutter:8},{default:v(()=>[i(n,{span:17},{default:v(()=>[i(s,{value:S(w).validCode,"onUpdate:value":a[3]||(a[3]=e=>S(w).validCode=e),placeholder:"验证码"},{prefix:v(()=>[i(d,{class:"text-black text-opacity-25"})]),_:1},8,["value"])]),_:1}),i(n,{span:7},{default:v(()=>[i(D,{class:"xn-wd",onClick:W,disabled:S(N).sendBtn},{default:v(()=>[m(p(S(N).sendBtn?S(N).time+" s":"获取验证码"),1)]),_:1},8,["disabled"])]),_:1})]),_:1})]),_:1})):f("",!0),i(t,{name:"newPassword","has-feedback":""},{default:v(()=>[i(o,{value:S(w).newPassword,"onUpdate:value":a[4]||(a[4]=e=>S(w).newPassword=e),placeholder:"请输入新密码","allow-clear":"",autocomplete:"off"},null,8,["value"])]),_:1})]),_:1},8,["model"])):(_(),c(l,{key:0,active:""}))]),_:1},8,["open"]),i(x,{open:S(k),"onUpdate:open":a[6]||(a[6]=e=>A(k)?k.value=e:null),width:400,title:"验证",onCancel:j,onOk:G,"destroy-on-close":""},{default:v(()=>[i(R,{ref_key:"updatePasswordFormModalRef",ref:I,model:S(y),rules:b},{default:v(()=>[i(t,{name:"validCode"},{default:v(()=>[i(T,{gutter:8},{default:v(()=>[i(n,{span:17},{default:v(()=>[i(s,{value:S(y).validCode,"onUpdate:value":a[5]||(a[5]=e=>S(y).validCode=e),placeholder:"请输入验证码",size:"large"},{prefix:v(()=>[i(H,{class:"xn-color-00025"})]),_:1},8,["value"])]),_:1}),i(n,{span:7},{default:v(()=>[P("img",{src:S(g),class:"xn-findform-line",onClick:V},null,8,O)]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["open"])])}}});export{T as default};
